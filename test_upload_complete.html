<!DOCTYPE html>
<html>
<head>
    <title>Test Upload Complet</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #0f0; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #0f0; }
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; border-color: #0f0; }
        .warning { color: #ff0; border-color: #ff0; }
        button { padding: 10px 20px; margin: 10px; background: #0f0; color: #000; border: none; cursor: pointer; }
        button:hover { background: #0a0; }
        input[type="file"] { margin: 10px 0; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
    </style>
</head>
<body>
    <h1>üîç Test Upload Complet</h1>
    
    <div class="section">
        <h2>Configuration</h2>
        <label>API URL: <input type="text" id="apiUrl" value="http://localhost:8000" style="width: 300px; padding: 5px;"></label><br>
        <label>Token JWT: <input type="text" id="token" placeholder="Coller votre token" style="width: 500px; padding: 5px;"></label><br>
        <button onclick="loadTokenFromStorage()">Charger depuis localStorage</button>
    </div>
    
    <div class="section">
        <h2>Test 1: V√©rifier l'API</h2>
        <button onclick="testApiConnection()">Tester connexion API</button>
    </div>
    
    <div class="section">
        <h2>Test 2: Upload Fichier</h2>
        <input type="file" id="fileInput" accept=".ino">
        <button onclick="testUpload()">Tester Upload</button>
    </div>
    
    <div class="section">
        <h2>Test 3: Cr√©er fichier test</h2>
        <button onclick="createTestFile()">Cr√©er fichier .ino de test</button>
    </div>
    
    <div class="section">
        <h2>Logs</h2>
        <button onclick="clearLogs()">Effacer</button>
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
            // Auto-scroll
            div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function loadTokenFromStorage() {
            const token = localStorage.getItem('ott_token');
            if (token) {
                document.getElementById('token').value = token;
                log('‚úÖ Token charg√© depuis localStorage', 'success');
            } else {
                log('‚ùå Aucun token dans localStorage', 'error');
            }
        }

        async function testApiConnection() {
            const apiUrl = document.getElementById('apiUrl').value;
            log(`üîó Test connexion √†: ${apiUrl}`, 'info');
            
            try {
                const response = await fetch(`${apiUrl}/api.php/firmwares`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${document.getElementById('token').value}`
                    }
                });
                
                log(`üì• Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                const text = await response.text();
                log(`üì• R√©ponse: ${text.substring(0, 200)}`, 'info');
                
                if (response.ok) {
                    try {
                        const data = JSON.parse(text);
                        log(`‚úÖ API accessible - Firmwares: ${data.firmwares?.length || 0}`, 'success');
                    } catch (e) {
                        log(`‚ö†Ô∏è R√©ponse non-JSON: ${text.substring(0, 100)}`, 'warning');
                    }
                } else {
                    log(`‚ùå Erreur API: ${text.substring(0, 200)}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Erreur r√©seau: ${err.message}`, 'error');
            }
        }

        function createTestFile() {
            const inoContent = `// Test firmware OTT
#define FIRMWARE_VERSION_STR "3.0.0-test"

void setup() {
  Serial.begin(115200);
  Serial.println("OTT Firmware Test");
}

void loop() {
  delay(1000);
}`;
            
            const blob = new Blob([inoContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test_firmware.ino';
            a.click();
            URL.revokeObjectURL(url);
            log('‚úÖ Fichier test_firmware.ino cr√©√© et t√©l√©charg√©', 'success');
        }

        async function testUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Aucun fichier s√©lectionn√©', 'error');
                return;
            }
            
            if (!file.name.endsWith('.ino')) {
                log('‚ùå Le fichier doit √™tre un .ino', 'error');
                return;
            }
            
            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('token').value;
            
            if (!token) {
                log('‚ùå Token manquant!', 'error');
                return;
            }
            
            log(`üì§ D√©marrage upload: ${file.name} (${file.size} bytes)`, 'info');
            log(`üîó URL: ${apiUrl}/api.php/firmwares/upload-ino`, 'info');
            
            const formData = new FormData();
            formData.append('firmware_ino', file);
            formData.append('type', 'ino');
            
            const xhr = new XMLHttpRequest();
            xhr.timeout = 30000;
            
            // √âv√©nements
            xhr.addEventListener('loadstart', () => {
                log('üöÄ loadstart - Upload d√©marr√©', 'info');
            });
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    log(`üìä Progression: ${percent}%`, 'info');
                }
            });
            
            xhr.addEventListener('load', () => {
                log(`üì• load - Status: ${xhr.status} ${xhr.statusText}`, xhr.status === 200 ? 'success' : 'error');
                log(`üì• ReadyState: ${xhr.readyState}`, 'info');
                log(`üì• Response: ${xhr.responseText.substring(0, 500)}`, 'info');
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        log(`‚úÖ Upload r√©ussi!`, 'success');
                        log(`üìã R√©ponse: ${JSON.stringify(response, null, 2)}`, 'success');
                        
                        if (response.upload_id || response.firmware_id) {
                            const id = response.upload_id || response.firmware_id;
                            log(`üî® ID firmware: ${id} - Pr√™t pour compilation`, 'success');
                        }
                    } catch (e) {
                        log(`‚ùå Erreur parsing JSON: ${e.message}`, 'error');
                    }
                } else {
                    log(`‚ùå Erreur HTTP ${xhr.status}`, 'error');
                    try {
                        const error = JSON.parse(xhr.responseText);
                        log(`‚ùå Erreur: ${JSON.stringify(error)}`, 'error');
                    } catch (e) {
                        log(`‚ùå R√©ponse: ${xhr.responseText}`, 'error');
                    }
                }
            });
            
            xhr.addEventListener('error', (e) => {
                log(`‚ùå error - Erreur r√©seau`, 'error');
                log(`‚ùå ReadyState: ${xhr.readyState}, Status: ${xhr.status}`, 'error');
            });
            
            xhr.addEventListener('timeout', () => {
                log(`‚è±Ô∏è timeout - Timeout apr√®s 30s`, 'error');
            });
            
            xhr.addEventListener('abort', () => {
                log(`‚ö†Ô∏è abort - Upload annul√©`, 'warning');
            });
            
            xhr.addEventListener('loadend', () => {
                log(`üèÅ loadend - Upload termin√©`, 'info');
            });
            
            try {
                xhr.open('POST', `${apiUrl}/api.php/firmwares/upload-ino`);
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.send(formData);
                log('‚úÖ Requ√™te envoy√©e', 'success');
            } catch (err) {
                log(`‚ùå Exception: ${err.message}`, 'error');
            }
        }
        
        // Charger le token au chargement
        window.addEventListener('load', () => {
            loadTokenFromStorage();
        });
    </script>
</body>
</html>

