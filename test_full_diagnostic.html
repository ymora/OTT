<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Complet - Render DB vs Application</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            margin: 0;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #00d9ff; text-align: center; margin-bottom: 30px; }
        .section { 
            background: rgba(255,255,255,0.05); 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 10px;
            border: 1px solid rgba(0,217,255,0.3);
        }
        .result { 
            background: #000; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .error { color: #ff4444; }
        .success { color: #00ff88; }
        .warning { color: #ffaa00; }
        .info { color: #00d9ff; }
        button { 
            padding: 12px 24px; 
            margin: 5px; 
            cursor: pointer;
            background: linear-gradient(135deg, #00d9ff 0%, #0099ff 100%);
            border: none;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
            font-size: 14px;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }
        button:active { transform: scale(0.95); }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0;
        }
        th, td { 
            padding: 10px; 
            text-align: left; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th { 
            background: rgba(0,217,255,0.2); 
            font-weight: bold;
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Complet - Render DB vs Application</h1>
        
        <div class="section">
            <h2>üöÄ Actions Rapides</h2>
            <button onclick="fullDiagnostic()">üîç Diagnostic Complet</button>
            <button onclick="checkDevices()">üì± V√©rifier Dispositifs</button>
            <button onclick="checkPatients()">üë• V√©rifier Patients</button>
            <button onclick="checkUsers()">üë§ V√©rifier Utilisateurs</button>
            <button onclick="clearAllCache()">üóëÔ∏è Vider Cache Application</button>
        </div>

        <div id="summary" class="section" style="display:none;">
            <h2>üìä R√©sum√©</h2>
            <div id="summaryContent"></div>
        </div>

        <div id="devices" class="section" style="display:none;">
            <h2>üì± Dispositifs</h2>
            <div id="devicesContent"></div>
        </div>

        <div id="patients" class="section" style="display:none;">
            <h2>üë• Patients</h2>
            <div id="patientsContent"></div>
        </div>

        <div id="users" class="section" style="display:none;">
            <h2>üë§ Utilisateurs</h2>
            <div id="usersContent"></div>
        </div>

        <div id="alerts" class="section" style="display:none;">
            <h2>‚ö†Ô∏è Alertes</h2>
            <div id="alertsContent"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ott-jbln.onrender.com';
        let token = null;

        async function login() {
            if (token) return true; // D√©j√† connect√©
            
            try {
                const response = await fetch(`${API_URL}/api.php/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'ymora@free.fr', 
                        password: 'Ym120879' 
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erreur HTTP:', response.status, errorText);
                    return false;
                }
                
                const data = await response.json();
                console.log('R√©ponse login:', data);
                
                if (data.token) {
                    token = data.token;
                    console.log('‚úÖ Connect√© avec succ√®s');
                    return true;
                } else if (data.success === false) {
                    console.error('√âchec login:', data.error || 'Credentials invalides');
                    return false;
                }
                
                return false;
            } catch (err) {
                console.error('Exception lors du login:', err);
                return false;
            }
        }

        async function fetchAPI(endpoint) {
            if (!token) await login();
            const response = await fetch(`${API_URL}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            return await response.json();
        }

        function showSection(id) {
            document.getElementById(id).style.display = 'block';
        }

        function clearAllCache() {
            if (typeof window !== 'undefined') {
                // Vider localStorage
                localStorage.clear();
                // Vider sessionStorage
                sessionStorage.clear();
                alert('‚úÖ Cache vid√© ! Rechargez votre application Next.js pour voir les donn√©es fra√Æches.');
            }
        }

        async function fullDiagnostic() {
            document.getElementById('summary').innerHTML = '<div class="info">‚è≥ Diagnostic en cours...</div>';
            showSection('summary');

            try {
                await login();
                
                const [devicesData, patientsData, usersData, alertsData] = await Promise.all([
                    fetchAPI('/api.php/devices'),
                    fetchAPI('/api.php/patients'),
                    fetchAPI('/api.php/users'),
                    fetchAPI('/api.php/alerts')
                ]);

                const devices = devicesData.devices || [];
                const patients = patientsData.patients || [];
                const users = usersData.users || [];
                const alerts = alertsData.alerts || [];

                let html = '<div class="grid">';
                html += `<div class="result success">üì± Dispositifs: ${devices.length}</div>`;
                html += `<div class="result success">üë• Patients: ${patients.length}</div>`;
                html += `<div class="result success">üë§ Utilisateurs: ${users.length}</div>`;
                html += `<div class="result success">‚ö†Ô∏è Alertes: ${alerts.length}</div>`;
                html += '</div>';

                // Recherche OTT-8837
                const ott8837 = devices.find(d => 
                    (d.device_name && d.device_name.includes('8837')) ||
                    (d.sim_iccid && d.sim_iccid.includes('8837')) ||
                    (d.device_serial && d.device_serial.includes('8837'))
                );

                if (ott8837) {
                    html += `<div class="result success">‚úÖ OTT-8837 TROUV√â:<br>
                        ID: ${ott8837.id}<br>
                        Nom: ${ott8837.device_name}<br>
                        ICCID: ${ott8837.sim_iccid}<br>
                        Status: ${ott8837.status}</div>`;
                } else {
                    html += '<div class="result error">‚ùå OTT-8837 NON TROUV√â EN BASE RENDER</div>';
                }

                document.getElementById('summaryContent').innerHTML = html;

                // Charger les d√©tails
                displayDevices(devices);
                displayPatients(patients);
                displayUsers(users);
                displayAlerts(alerts);

            } catch (err) {
                document.getElementById('summaryContent').innerHTML = 
                    `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
        }

        async function checkDevices() {
            showSection('devices');
            document.getElementById('devicesContent').innerHTML = '<div class="info">‚è≥ Chargement...</div>';
            
            try {
                const data = await fetchAPI('/api.php/devices');
                displayDevices(data.devices || []);
            } catch (err) {
                document.getElementById('devicesContent').innerHTML = 
                    `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
        }

        function displayDevices(devices) {
            showSection('devices');
            let html = `<div class="result info">üìä Total: ${devices.length} dispositifs</div>`;
            
            if (devices.length > 0) {
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Nom</th><th>ICCID</th><th>Serial</th><th>Status</th><th>Patient</th><th>Firmware</th>';
                html += '</tr></thead><tbody>';
                
                devices.forEach(d => {
                    const highlight = (d.device_name && d.device_name.includes('8837')) || 
                                    (d.sim_iccid && d.sim_iccid.includes('8837')) ? 
                                    'style="background: rgba(0,255,136,0.1);"' : '';
                    html += `<tr ${highlight}>`;
                    html += `<td>${d.id}</td>`;
                    html += `<td>${d.device_name || '-'}</td>`;
                    html += `<td>${d.sim_iccid || '-'}</td>`;
                    html += `<td>${d.device_serial || '-'}</td>`;
                    html += `<td>${d.status || '-'}</td>`;
                    html += `<td>${d.patient_id ? '‚úÖ' : '‚ùå'}</td>`;
                    html += `<td>${d.firmware_version || '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('devicesContent').innerHTML = html;
        }

        async function checkPatients() {
            showSection('patients');
            document.getElementById('patientsContent').innerHTML = '<div class="info">‚è≥ Chargement...</div>';
            
            try {
                const data = await fetchAPI('/api.php/patients');
                displayPatients(data.patients || []);
            } catch (err) {
                document.getElementById('patientsContent').innerHTML = 
                    `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
        }

        function displayPatients(patients) {
            showSection('patients');
            let html = `<div class="result info">üìä Total: ${patients.length} patients</div>`;
            
            if (patients.length > 0) {
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Nom</th><th>Pr√©nom</th><th>Email</th><th>T√©l√©phone</th>';
                html += '</tr></thead><tbody>';
                
                patients.forEach(p => {
                    html += '<tr>';
                    html += `<td>${p.id}</td>`;
                    html += `<td>${p.last_name || '-'}</td>`;
                    html += `<td>${p.first_name || '-'}</td>`;
                    html += `<td>${p.email || '-'}</td>`;
                    html += `<td>${p.phone || '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('patientsContent').innerHTML = html;
        }

        async function checkUsers() {
            showSection('users');
            document.getElementById('usersContent').innerHTML = '<div class="info">‚è≥ Chargement...</div>';
            
            try {
                const data = await fetchAPI('/api.php/users');
                displayUsers(data.users || []);
            } catch (err) {
                document.getElementById('usersContent').innerHTML = 
                    `<div class="result error">‚ùå Erreur: ${err.message}</div>`;
            }
        }

        function displayUsers(users) {
            showSection('users');
            let html = `<div class="result info">üìä Total: ${users.length} utilisateurs</div>`;
            
            if (users.length > 0) {
                html += '<table><thead><tr>';
                html += '<th>ID</th><th>Email</th><th>Nom</th><th>R√¥le</th><th>Actif</th>';
                html += '</tr></thead><tbody>';
                
                users.forEach(u => {
                    html += '<tr>';
                    html += `<td>${u.id}</td>`;
                    html += `<td>${u.email || '-'}</td>`;
                    html += `<td>${u.name || '-'}</td>`;
                    html += `<td>${u.role_name || '-'}</td>`;
                    html += `<td>${u.is_active ? '‚úÖ' : '‚ùå'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            document.getElementById('usersContent').innerHTML = html;
        }

        function displayAlerts(alerts) {
            showSection('alerts');
            let html = `<div class="result info">üìä Total: ${alerts.length} alertes</div>`;
            document.getElementById('alertsContent').innerHTML = html;
        }

        // Auto-login au chargement
        window.onload = async () => {
            const success = await login();
            if (success) {
                console.log('‚úÖ Connect√© √† l\'API Render');
            } else {
                alert('‚ùå √âchec de connexion. V√©rifiez les credentials.');
            }
        };
    </script>
</body>
</html>

