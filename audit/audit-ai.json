{
  "timestamp": "2025-12-13T00:21:31.1409493Z",
  "project_info": {
    "name": "maxime",
    "framework": "Unknown",
    "type": "Unknown",
    "path": "C:\\Users\\ymora\\Desktop\\maxime"
  },
  "instructions": "Ce fichier contient des questions pour l'IA concernant des problèmes détectés dans le code.\r\nPour chaque question, l'IA doit:\r\n1. Analyser le code fourni\r\n2. Comprendre le contexte du projet\r\n3. Proposer une solution concrète avec code corrigé si applicable\r\n4. Indiquer un niveau de confiance (0.0 à 1.0)\r\n5. Recommander une action (delete, refactor, fix, ignore, manual_review)",
  "questions": [
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\ErrorBoundary.js",
        "content": "'use client'\r\n\r\nimport React from 'react'\r\nimport logger from '@/lib/logger'\r\n\r\n/**\r\n * Composant ErrorBoundary pour capturer les erreurs React\r\n * Affiche un message d'erreur convivial au lieu de faire planter toute l'application\r\n */\r\nclass ErrorBoundary extends React.Component {\r\n  constructor(props) {\r\n    super(props)\r\n    this.state = { hasError: false, error: null, errorInfo: null }\r\n  }\r\n\r\n  static getDerivedStateFromError(error) {\r",
        "start_line": 1,
        "end_line": 16
      },
      "severity": "high",
      "line": 1,
      "id": "q1",
      "description": "Composant non utilisé: ErrorBoundary",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\ErrorBoundary.js",
      "context": {
        "file_exists": true,
        "total_lines": 121
      },
      "question": "Ce fichier 'C:\\Users\\ymora\\Desktop\\maxime\\components\\ErrorBoundary.js' n'est utilisé/importé nulle part dans le projet.\r\n- Dois-je le supprimer ou est-il prévu pour un usage futur ?\r\n- Y a-t-il un équivalent/remplacement dans le code ?\r\n- Analyse le code et recommande une action (supprimer, garder avec documentation, refactorer).\r\n\r\nProjet: Unknown / Unknown",
      "type": "dead_code"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\page.js",
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useMemo, useState } from 'react'\r\nimport dynamicImport from 'next/dynamic'\r\nimport { useApiData, useAutoRefresh } from '@/hooks'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\n\r\n// Lazy load de la carte pour accélérer le chargement\r\nconst LeafletMap = dynamicImport(() => import('@/components/LeafletMap'), { ssr: false })\r\n\r\nexport default function DashboardPage() {\r\n  const { isConnected, usbVirtualDevice, usbDeviceInfo, usbStreamLastMeasurement } = useUsb()\r\n  \r\n  // Charger les données avec useApiData\r\n  const { data, loading, error, refetch } = useApiData(\r\n    [\r\n      '/api.php/devices',\r\n      '/api.php/alerts',\r\n      '/api.php/users',\r\n      '/api.php/patients',\r\n      '/api.php/firmwares'\r\n    ],\r\n    { requiresAuth: true }\r\n  )\r\n  \r\n  const [focusDeviceId, setFocusDeviceId] = useState(null)\r\n  \r\n  // États pour les accordéons des KPIs\r\n  const [kpiAccordions, setKpiAccordions] = useState({\r\n    devices: false,\r\n    online: false,\r\n    alerts: false,\r\n    battery: false,\r\n    alertsAction: false,\r\n    batteryAction: false,\r\n    unassigned: false\r\n  })\r\n  \r\n  const toggleAccordion = (key) => {\r\n    setKpiAccordions(prev => ({\r\n      ...prev,\r\n      [key]: !prev[key]\r\n    }))\r\n  }\r\n  \r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q2",
      "metrics": {
        "Complexity": 0,
        "Lines": 556
      },
      "description": "Fichier volumineux: 556 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\page.js",
      "context": {
        "file_exists": true,
        "total_lines": 557
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 556 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\documentation\\page.js",
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useEffect, useMemo, useState, useRef, useCallback } from 'react'\r\nimport { useSearchParams } from 'next/navigation'\r\nimport { withBasePath } from '@/lib/utils'\r\nimport logger from '@/lib/logger'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { Bar, Doughnut, Line } from 'react-chartjs-2'\r\nimport MetadataCard from '@/components/MetadataCard'\r\nimport DayDetailsModal from '@/components/DayDetailsModal'\r\nimport {\r\n  Chart as ChartJS,\r\n  CategoryScale,\r\n  LinearScale,\r\n  BarElement,\r\n  ArcElement,\r\n  PointElement,\r\n  LineElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  Filler\r\n} from 'chart.js'\r\n\r\nChartJS.register(\r\n  CategoryScale,\r\n  LinearScale,\r\n  BarElement,\r\n  ArcElement,\r\n  PointElement,\r\n  LineElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  Filler\r\n)\r\n\r\nconst DOCUMENTATION_FILES = {\r\n  presentation: 'DOCUMENTATION_PRESENTATION.html',\r\n  developpeurs: 'DOCUMENTATION_DEVELOPPEURS.html',\r\n  commerciale: 'DOCUMENTATION_COMMERCIALE.html',\r\n  'suivi-temps': 'SUIVI_TEMPS_FACTURATION.md'\r\n}\r\n\r\nexport default function DocumentationPage() {\r\n  const searchParams = useSearchParams()\r\n  const docType = searchParams.get('doc') || 'presentation'\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q3",
      "metrics": {
        "Complexity": 0,
        "Lines": 1444
      },
      "description": "Fichier volumineux: 1444 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\documentation\\page.js",
      "context": {
        "file_exists": true,
        "total_lines": 1445
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1444 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\patients\\page.js",
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useMemo, useState } from 'react'\r\nimport { useEntityPage, useAutoRefresh, useDevicesUpdateListener, useToggle } from '@/hooks'\r\nimport { fetchJson } from '@/lib/api'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport SuccessMessage from '@/components/SuccessMessage'\r\nimport SearchBar from '@/components/SearchBar'\r\nimport UserPatientModal from '@/components/UserPatientModal'\r\nimport Modal from '@/components/Modal'\r\nimport logger from '@/lib/logger'\r\n\r\nexport default function PatientsPage() {\r\n  // Utiliser le hook unifié pour toute la logique commune\r\n  const {\r\n    allItems: allPatients,\r\n    items: patients,\r\n    filteredItems: filteredPatients,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    loading,\r\n    error,\r\n    success,\r\n    actionError,\r\n    setSuccess,\r\n    setActionError,\r\n    resetMessages,\r\n    showArchived,\r\n    toggleShowArchived,\r\n    showModal,\r\n    editingItem,\r\n    openCreateModal,\r\n    openEditModal,\r\n    closeModal,\r\n    restore: handleRestorePatient,\r\n    restoring: restoringPatient,\r\n    archive: handleArchive,\r\n    archiving,\r\n    permanentDelete: handlePermanentDelete,\r\n    deleting: deletingPermanent,\r\n    hasPermission,\r\n    isArchived,\r\n    currentUser,\r\n    fetchWithAuth,\r\n    API_URL,\r\n    refetch,\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q4",
      "metrics": {
        "Complexity": 0,
        "Lines": 573
      },
      "description": "Fichier volumineux: 573 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\patients\\page.js",
      "context": {
        "file_exists": true,
        "total_lines": 574
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 573 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceMeasurementsModal.js",
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useCallback } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport ConfirmModal from '@/components/ConfirmModal'\r\nimport logger from '@/lib/logger'\r\nimport Modal from '@/components/Modal'\r\n\r\n/**\r\n * Modal pour afficher l'historique des mesures d'un dispositif\r\n */\r\nexport default function DeviceMeasurementsModal({ isOpen, onClose, device }) {\r\n  const { fetchWithAuth, API_URL, user } = useAuth()\r\n  const [measurements, setMeasurements] = useState([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState(null)\r\n  const [showArchived, setShowArchived] = useState(false)\r\n  const [deletingMeasurement, setDeletingMeasurement] = useState(null)\r\n  const [archivingMeasurement, setArchivingMeasurement] = useState(null)\r\n  const [restoringMeasurement, setRestoringMeasurement] = useState(null)\r\n  const [selectedMeasurements, setSelectedMeasurements] = useState(new Set())\r\n  const [deletingMultiple, setDeletingMultiple] = useState(false)\r\n  const [archivingMultiple, setArchivingMultiple] = useState(false)\r\n  \r\n  // États pour les modals de confirmation\r\n  const [confirmArchiveModal, setConfirmArchiveModal] = useState({ isOpen: false, measurementId: null })\r\n  const [confirmDeleteModal, setConfirmDeleteModal] = useState({ isOpen: false, measurementId: null })\r\n  const [confirmRestoreModal, setConfirmRestoreModal] = useState({ isOpen: false, measurementId: null })\r\n  const [confirmDeleteMultipleModal, setConfirmDeleteMultipleModal] = useState(false)\r\n\r\n  const loadMeasurements = useCallback(async () => {\r\n    if (!device?.id) return\r\n\r\n    setLoading(true)\r\n    setError(null)\r\n    \r\n    try {\r\n      const url = `/api.php/devices/${device.id}/history${showArchived ? '?show_archived=true' : ''}`\r\n      const data = await fetchJson(\r\n        fetchWithAuth,\r\n        API_URL,\r\n        url,\r\n        { method: 'GET' },\r\n        { requiresAuth: true }\r\n      )\r\n      \r\n      if (data.success && data.measurements) {\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q5",
      "metrics": {
        "Complexity": 0,
        "Lines": 781
      },
      "description": "Fichier volumineux: 781 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceMeasurementsModal.js",
      "context": {
        "file_exists": true,
        "total_lines": 780
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 781 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceModal.js",
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useRef, useMemo } from 'react'\r\nimport { fetchJson } from '@/lib/api'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport Tooltip from '@/components/Tooltip'\r\nimport logger from '@/lib/logger'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport { buildUpdateConfigPayload } from '@/lib/deviceCommands'\r\n\r\n// Composant Accordéon simple\r\nfunction Accordion({ title, children, defaultOpen = false }) {\r\n  const [isOpen, setIsOpen] = useState(defaultOpen)\r\n  \r\n  return (\r\n    <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg\">\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setIsOpen(!isOpen)}\r\n        className=\"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors\"\r\n      >\r\n        <span className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">{title}</span>\r\n        <span className=\"text-gray-500 dark:text-gray-400\">{isOpen ? '▼' : '▶'}</span>\r\n      </button>\r\n      {isOpen && (\r\n        <div className=\"px-4 pb-4 pt-2\">\r\n          {children}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n/**\r\n * Composant modal réutilisable pour créer/modifier des dispositifs\r\n * @param {Object} props\r\n * @param {boolean} props.isOpen - Si le modal est ouvert\r\n * @param {Function} props.onClose - Fonction pour fermer le modal\r\n * @param {Object|null} props.editingItem - Le dispositif en cours d'édition (null pour création)\r\n * @param {Function} props.onSave - Fonction appelée après sauvegarde réussie\r\n * @param {Object} props.fetchWithAuth - Fonction fetch avec authentification\r\n * @param {string} props.API_URL - URL de l'API\r\n * @param {Array} props.patients - Liste des patients disponibles\r\n * @param {Array} props.allDevices - Liste de tous les dispositifs (pour vérifier les doublons)\r\n * @param {Function} props.appendLog - Fonction pour ajouter un log au terminal USB (optionnel)\r\n */\r\nexport default function DeviceModal({\r\n  isOpen,\r\n  onClose,\r\n  editingItem,\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q6",
      "metrics": {
        "Complexity": 0,
        "Lines": 1669
      },
      "description": "Fichier volumineux: 1669 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceModal.js",
      "context": {
        "file_exists": true,
        "total_lines": 1670
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1669 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\FlashModal.js",
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport { useSerialPort } from '@/components/SerialPortManager'\r\nimport { useTimers } from '@/hooks'\r\nimport { ESPLoader } from 'esptool-js'\r\nimport logger from '@/lib/logger'\r\n\r\n/**\r\n * Modal unifié pour le flash USB et OTA\r\n * Avec barre de progression, logs et stats\r\n */\r\nexport default function FlashModal({ isOpen, onClose, device, preselectedFirmwareVersion = null, flashMode = 'usb' }) {\r\n  const { fetchWithAuth, API_URL } = useAuth()\r\n  const [firmwares, setFirmwares] = useState([])\r\n  const [selectedFirmware, setSelectedFirmware] = useState(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n  const [flashing, setFlashing] = useState(false)\r\n  const [flashProgress, setFlashProgress] = useState(0)\r\n  const [terminalLogs, setTerminalLogs] = useState([])\r\n  const [flashComplete, setFlashComplete] = useState(false)\r\n  const [deviceAlive, setDeviceAlive] = useState(null)\r\n  const [flashModeState, setFlashModeState] = useState(flashMode) // 'usb' ou 'ota'\r\n  const [otaStatus, setOtaStatus] = useState(null) // { status: 'pending'|'executing'|'executed'|'error', command: {...} }\r\n  const [otaStats, setOtaStats] = useState({ lastCheck: null, attempts: 0 })\r\n  const [downloadProgress, setDownloadProgress] = useState(0) // Progression du téléchargement (0-100)\r\n  const [cacheUsed, setCacheUsed] = useState(false) // Indique si le cache navigateur a été utilisé\r\n  const [downloadStatus, setDownloadStatus] = useState(null) // Message de statut du téléchargement\r\n  const stopReadingRef = useRef(null)\r\n  const otaCheckIntervalRef = useRef(null)\r\n  \r\n  // Utiliser le hook useTimers pour gérer les timers avec cleanup automatique\r\n  const { createTimeout: createTimeoutWithCleanup, createInterval } = useTimers()\r\n  \r\n  // Nettoyer l'interval OTA au démontage\r\n  useEffect(() => {\r\n    return () => {\r\n      if (otaCheckIntervalRef.current) {\r\n        clearInterval(otaCheckIntervalRef.current)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // Utiliser le contexte USB partagé\r\n  const {\r\n    isConnected: usbIsConnected,\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q7",
      "metrics": {
        "Complexity": 0,
        "Lines": 883
      },
      "description": "Fichier volumineux: 883 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\FlashModal.js",
      "context": {
        "file_exists": true,
        "total_lines": 884
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 883 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\SerialPortManager.js",
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { getUsbDeviceLabel, getUsbRequestFilters } from '@/lib/usbDevices'\r\nimport logger from '@/lib/logger'\r\nimport { getUsbPortSharing } from '@/lib/usbPortSharing'\r\n\r\n/**\r\n * Gestionnaire de port série utilisant Web Serial API\r\n * Permet de détecter, connecter et communiquer avec des dispositifs USB\r\n */\r\nexport function useSerialPort() {\r\n  const [port, setPort] = useState(null)\r\n  const [isConnected, setIsConnected] = useState(false)\r\n  const [availablePorts, setAvailablePorts] = useState([])\r\n  const [error, setError] = useState(null)\r\n  const readerRef = useRef(null)\r\n  const writerRef = useRef(null)\r\n  const portSharingRef = useRef(null)\r\n  const isMasterRef = useRef(false)\r\n  const sharedDataRef = useRef(null)\r\n\r\n  // Vérifier le support de Web Serial API\r\n  const isSupported = typeof navigator !== 'undefined' && 'serial' in navigator\r\n  \r\n  // Initialiser le système de partage\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined') {\r\n      portSharingRef.current = getUsbPortSharing()\r\n      \r\n      // Écouter les changements d'état\r\n      const unsubscribeState = portSharingRef.current.on('state-changed', async (data) => {\r\n        const wasMaster = isMasterRef.current\r\n        isMasterRef.current = data.isMaster\r\n        logger.debug('[SerialPortManager] State changed:', data)\r\n        \r\n        // Si on n'est plus master mais qu'on a un port ouvert, le fermer automatiquement\r\n        if (!data.isMaster && wasMaster && isConnected && port) {\r\n          logger.warn('[SerialPortManager] No longer master, closing port automatically...')\r\n          try {\r\n            // Fermer le port sans notifier le système de partage (car on n'est plus master)\r\n            if (readerRef.current) {\r\n              try {\r\n                await readerRef.current.cancel()\r\n                // Note: reader n'a pas de méthode release() dans Web Serial API\r\n              } catch (e) {\r\n                // Ignorer les erreurs\r\n              }\r\n              readerRef.current = null\r\n            }\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q8",
      "metrics": {
        "Complexity": 0,
        "Lines": 650
      },
      "description": "Fichier volumineux: 650 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\SerialPortManager.js",
      "context": {
        "file_exists": true,
        "total_lines": 651
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 650 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\UserPatientModal.js",
        "content": "'use client'\n\nimport { useState, useEffect, useRef, useMemo } from 'react'\nimport { fetchJson } from '@/lib/api'\nimport ErrorMessage from '@/components/ErrorMessage'\nimport { isValidEmail, isValidPhone } from '@/lib/utils'\nimport logger from '@/lib/logger'\n\n// Composant Accordéon simple (réutilisé depuis DeviceModal)\nfunction Accordion({ title, children, defaultOpen = false }) {\n  const [isOpen, setIsOpen] = useState(defaultOpen)\n  \n  return (\n    <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg\">\n      <button\n        type=\"button\"\n        onClick={() => setIsOpen(!isOpen)}\n        className=\"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors\"\n      >\n        <span className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">{title}</span>\n        <span className=\"text-gray-500 dark:text-gray-400\">{isOpen ? '▼' : '▶'}</span>\n      </button>\n      {isOpen && (\n        <div className=\"px-4 pb-4 pt-2\">\n          {children}\n        </div>\n      )}\n    </div>\n  )\n}\n\n/**\n * Composant modal réutilisable pour créer/modifier des utilisateurs ou patients\n * @param {Object} props\n * @param {boolean} props.isOpen - Si le modal est ouvert\n * @param {Function} props.onClose - Fonction pour fermer le modal\n * @param {Object|null} props.editingItem - L'item en cours d'édition (null pour création)\n * @param {string} props.type - 'user' ou 'patient'\n * @param {Function} props.onSave - Fonction appelée après sauvegarde réussie\n * @param {Object} props.fetchWithAuth - Fonction fetch avec authentification\n * @param {string} props.API_URL - URL de l'API\n * @param {Array} props.roles - Liste des rôles (pour type='user')\n */\nexport default function UserPatientModal({\n  isOpen,\n  onClose,\n  editingItem,\n  type,\n  onSave,\n  fetchWithAuth,",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q9",
      "metrics": {
        "Complexity": 0,
        "Lines": 1289
      },
      "description": "Fichier volumineux: 1289 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\UserPatientModal.js",
      "context": {
        "file_exists": true,
        "total_lines": 1290
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1289 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\InoEditorTab.js",
        "content": "'use client'\r\n\r\nimport { useState, useCallback, useRef, useEffect, useMemo } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport { useApiData, useTimers } from '@/hooks'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport Modal from '@/components/Modal'\r\nimport logger from '@/lib/logger'\r\n\r\nexport default function InoEditorTab({ onUploadSuccess }) {\r\n  const { fetchWithAuth, API_URL, token } = useAuth()\r\n  const [selectedFile, setSelectedFile] = useState(null)\r\n  const [inoContent, setInoContent] = useState('')\r\n  const [originalContent, setOriginalContent] = useState('')\r\n  const [isEdited, setIsEdited] = useState(false)\r\n  const [uploading, setUploading] = useState(false)\r\n  const [uploadProgress, setUploadProgress] = useState(0)\r\n  const [currentStep, setCurrentStep] = useState(null)\r\n  const [error, setError] = useState(null)\r\n  const [success, setSuccess] = useState(null)\r\n  const [showVersionExistsModal, setShowVersionExistsModal] = useState(false)\r\n  const [existingFirmware, setExistingFirmware] = useState(null)\r\n  const [pendingFile, setPendingFile] = useState(null)\r\n  const [editingFirmwareId, setEditingFirmwareId] = useState(null)\r\n  const [loadingIno, setLoadingIno] = useState(false)\r\n  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false)\r\n  const [firmwareToDelete, setFirmwareToDelete] = useState(null)\r\n  const [deletingFirmware, setDeletingFirmware] = useState(null)\r\n  \r\n  // Utiliser le hook useTimers pour gérer les timers avec cleanup automatique\r\n  const { createTimeout: createTimeoutWithCleanup } = useTimers()\r\n  const [editorMinimized, setEditorMinimized] = useState(true)\r\n  const fileInputRef = useRef(null)\r\n  const textareaRef = useRef(null)\r\n\r\n  // États pour la compilation\r\n  const [compiling, setCompiling] = useState(false)\r\n  const [compileProgress, setCompileProgress] = useState(0)\r\n  const [compileLogs, setCompileLogs] = useState([])\r\n  const [compilingFirmwareId, setCompilingFirmwareId] = useState(null)\r\n  const [compileWindowMinimized, setCompileWindowMinimized] = useState(false)\r\n  const [copyLogsSuccess, setCopyLogsSuccess] = useState(false)\r\n  const eventSourceRef = useRef(null)\r\n  const compileLogsRef = useRef(null)\r\n  const statusCheckIntervalRef = useRef(null)\r\n\r\n  const { data, loading, refetch, invalidateCache } = useApiData(\r\n    ['/api.php/firmwares'],\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q10",
      "metrics": {
        "Complexity": 0,
        "Lines": 1362
      },
      "description": "Fichier volumineux: 1362 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\InoEditorTab.js",
      "context": {
        "file_exists": true,
        "total_lines": 1363
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1362 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\UsbStreamingTab.js",
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useRef, useCallback, useMemo } from 'react'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport { useApiData, useTimers, useEntityRestore, useSmartDeviceRefresh } from '@/hooks'\r\nimport { createUpdateConfigCommand } from '@/lib/deviceCommands'\r\nimport { getUsbDeviceLabel } from '@/lib/usbDevices'\r\nimport { isArchived } from '@/lib/utils'\r\nimport logger from '@/lib/logger'\r\nimport Modal from '@/components/Modal'\r\nimport ConfirmModal from '@/components/ConfirmModal'\r\nimport FlashModal from '@/components/FlashModal'\r\nimport DeviceModal from '@/components/DeviceModal'\r\nimport DeviceMeasurementsModal from '@/components/DeviceMeasurementsModal'\r\nimport SuccessMessage from '@/components/SuccessMessage'\r\n\r\nexport default function DebugTab() {\r\n  const usbContext = useUsb()\r\n  \r\n  // Références pour gérer les timeouts avec cleanup\r\n  const timeoutRefs = useRef([])\r\n  const isMountedRef = useRef(true)\r\n  \r\n  // Nettoyer tous les timeouts au démontage\r\n  useEffect(() => {\r\n    isMountedRef.current = true\r\n    return () => {\r\n      isMountedRef.current = false\r\n      timeoutRefs.current.forEach(timeoutId => clearTimeout(timeoutId))\r\n      timeoutRefs.current = []\r\n    }\r\n  }, [])\r\n  \r\n  // Fonction utilitaire pour créer un timeout avec cleanup\r\n  const createTimeoutWithCleanup = (callback, delay) => {\r\n    if (!isMountedRef.current) return null\r\n    const timeoutId = setTimeout(() => {\r\n      if (isMountedRef.current) {\r\n        callback()\r\n      }\r\n      timeoutRefs.current = timeoutRefs.current.filter(id => id !== timeoutId)\r\n    }, delay)\r\n    timeoutRefs.current.push(timeoutId)\r\n    return timeoutId\r\n  }\r\n  \r\n  const {\r\n    usbConnectedDevice,\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q11",
      "metrics": {
        "Complexity": 0,
        "Lines": 2517
      },
      "description": "Fichier volumineux: 2517 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\UsbStreamingTab.js",
      "context": {
        "file_exists": true,
        "total_lines": 2518
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 2517 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\contexts\\UsbContext.js",
        "content": "'use client'\r\n\r\nimport { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react'\r\nimport { useSerialPort } from '@/components/SerialPortManager'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport logger from '@/lib/logger'\r\nimport { getUsbPortSharing } from '@/lib/usbPortSharing'\r\n\r\nconst UsbContext = createContext()\r\n\r\nexport function UsbProvider({ children }) {\r\n  const { port, isConnected, isSupported, requestPort, connect, disconnect, startReading, write } = useSerialPort()\r\n  const { fetchWithAuth, API_URL } = useAuth()\r\n  \r\n  // État USB global\r\n  const [usbConnectedDevice, setUsbConnectedDevice] = useState(null)\r\n  const [usbVirtualDevice, setUsbVirtualDevice] = useState(null)\r\n  const [usbPortInfo, setUsbPortInfo] = useState(null)\r\n  const [autoDetecting, setAutoDetecting] = useState(true)\r\n  const [checkingUSB, setCheckingUSB] = useState(false)\r\n  \r\n  // Données reçues du dispositif USB en temps réel (uniquement depuis le dispositif, pas de la base de données)\r\n  const [usbDeviceInfo, setUsbDeviceInfo] = useState(null) // { sim_iccid, device_serial, firmware_version, etc. }\r\n  \r\n  // État streaming USB\r\n  const [usbStreamStatus, setUsbStreamStatus] = useState('idle') // 'idle', 'connecting', 'waiting', 'running', 'paused'\r\n  const [usbStreamMeasurements, setUsbStreamMeasurements] = useState([])\r\n  const [usbStreamLogs, setUsbStreamLogs] = useState([])\r\n  const [usbStreamError, setUsbStreamError] = useState(null)\r\n  const [usbStreamLastMeasurement, setUsbStreamLastMeasurement] = useState(null)\r\n  const [usbStreamLastUpdate, setUsbStreamLastUpdate] = useState(null)\r\n  \r\n  const usbStreamStopRef = useRef(null)\r\n  const usbStreamBufferRef = useRef('')\r\n  const sendMeasurementToApiRef = useRef(null) // Callback pour envoyer les mesures à l'API\r\n  const updateDeviceFirmwareRef = useRef(null) // Callback pour mettre à jour les informations du dispositif dans la base (firmware_version, last_battery, last_seen, status)\r\n  const portSharingRef = useRef(null)\r\n  const streamTimeoutRefs = useRef([]) // Références pour les timeouts de streaming\r\n  \r\n  // Batch des logs pour envoi au serveur (pour monitoring à distance)\r\n  const logsToSendRef = useRef([])\r\n  const sentCommandsCacheRef = useRef(new Set()) // Cache pour éviter de renvoyer les mêmes commandes\r\n  \r\n  // Initialiser le système de partage\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined') {\r\n      portSharingRef.current = getUsbPortSharing()\r\n      \r\n      // Écouter les données partagées depuis un autre onglet\r\n      const unsubscribeData = portSharingRef.current.on('data-received', (data) => {\r",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q12",
      "metrics": {
        "Complexity": 0,
        "Lines": 1889
      },
      "description": "Fichier volumineux: 1889 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\contexts\\UsbContext.js",
      "context": {
        "file_exists": true,
        "total_lines": 1890
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1889 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api.php",
        "content": "<?php\n/**\n * API REST V2.0 - HAPPLYZ MEDICAL OTT\n * Version complète avec JWT, multi-users, OTA, notifications, audit\n */\n\n// Mode DEBUG activable via variable d'environnement (désactivé par défaut)\n// Pour activer : mettre DEBUG_ERRORS=true dans .env ou variable d'environnement\n\nrequire_once __DIR__ . '/bootstrap/env_loader.php';\nrequire_once __DIR__ . '/bootstrap/database.php';\nrequire_once __DIR__ . '/api/helpers.php';\nrequire_once __DIR__ . '/api/helpers_sql.php';\nrequire_once __DIR__ . '/api/validators.php';\nrequire_once __DIR__ . '/api/cache.php';\nrequire_once __DIR__ . '/api/handlers/auth.php';\n// Handlers Devices (modulaires)\nrequire_once __DIR__ . '/api/handlers/devices/utils.php';\nrequire_once __DIR__ . '/api/handlers/devices/crud.php';\nrequire_once __DIR__ . '/api/handlers/devices/patients.php';\nrequire_once __DIR__ . '/api/handlers/devices/measurements.php';\nrequire_once __DIR__ . '/api/handlers/devices/commands.php';\nrequire_once __DIR__ . '/api/handlers/devices/alerts.php';\nrequire_once __DIR__ . '/api/handlers/devices/logs.php';\nrequire_once __DIR__ . '/api/handlers/devices/config.php';\nrequire_once __DIR__ . '/api/handlers/devices/ota.php';\nrequire_once __DIR__ . '/api/handlers/devices/reports.php';\n// require_once __DIR__ . '/api/handlers/devices/demo.php'; // SUPPRIMÉ: Fonctionnalité Reset Demo retirée (dangereuse)\nrequire_once __DIR__ . '/api/handlers/firmwares.php';\nrequire_once __DIR__ . '/api/handlers/notifications.php';\nrequire_once __DIR__ . '/api/handlers/usb_logs.php';\nrequire_once __DIR__ . '/api/handlers/database_audit.php';\n\n// Démarrer le buffer de sortie pour capturer toute sortie HTML accidentelle\nob_start();\n\n// Headers CORS (DOIT être en tout premier)\n// Origines par défaut (production + développement local)\n$defaultAllowedOrigins = [\n    'https://ymora.github.io',\n    'https://ymora.github.io/OTT',  // GitHub Pages avec basePath\n    'http://localhost:3000',  // Développement local Next.js\n    'http://localhost:3003',  // Autres ports locaux\n    'http://localhost:5173'   // Vite dev server\n];\n\n// Origines supplémentaires via variable d'environnement\n$extraOrigins = array_filter(array_map('trim', explode(',', getenv('CORS_ALLOWED_ORIGINS') ?: '')));\n$allowedOrigins = array_unique(array_merge($defaultAllowedOrigins, $extraOrigins));\n$origin = $_SERVER['HTTP_ORIGIN'] ?? '';",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q13",
      "metrics": {
        "Complexity": 0,
        "Lines": 1654
      },
      "description": "Fichier volumineux: 1654 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api.php",
      "context": {
        "file_exists": true,
        "total_lines": 1655
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1654 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\helpers.php",
        "content": "<?php\n/**\n * API Helpers - Fonctions utilitaires\n * Extracted from api.php during refactoring\n */\n\n// ============================================================================\n// HELPERS - IP & Geolocation\n// ============================================================================\n\n/**\n * Fonction helper pour obtenir la position depuis l'IP du client (pour dispositifs USB)\n */\nfunction getLocationFromIp($ip) {\n    // Ignorer les IPs locales/privées\n    if (empty($ip) || $ip === '127.0.0.1' || $ip === '::1' || \n        strpos($ip, '192.168.') === 0 || strpos($ip, '10.') === 0 || \n        strpos($ip, '172.') === 0 || strpos($ip, 'localhost') !== false) {\n        return null;\n    }\n    \n    try {\n        // Utiliser ip-api.com (gratuit, sans clé API, limite 45 req/min)\n        $url = \"http://ip-api.com/json/$ip?fields=status,lat,lon\";\n        $context = stream_context_create([\n            'http' => [\n                'timeout' => 2,\n                'method' => 'GET'\n            ]\n        ]);\n        $response = @file_get_contents($url, false, $context);\n        \n        if ($response) {\n            $data = json_decode($response, true);\n            if ($data && $data['status'] === 'success' && isset($data['lat']) && isset($data['lon'])) {\n                return [\n                    'latitude' => floatval($data['lat']),\n                    'longitude' => floatval($data['lon'])\n                ];\n            }\n        }\n    } catch (Exception $e) {\n        // Ignorer les erreurs de géolocalisation IP (non critique)\n        if (getenv('DEBUG_ERRORS') === 'true') {\n            error_log('[getLocationFromIp] Erreur: ' . $e->getMessage());\n        }\n    }\n    \n    return null;\n}",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q14",
      "metrics": {
        "Complexity": 0,
        "Lines": 1006
      },
      "description": "Fichier volumineux: 1006 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\helpers.php",
      "context": {
        "file_exists": true,
        "total_lines": 1007
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1006 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    },
    {
      "code_snippet": {
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\auth.php",
        "content": "<?php\n/**\n * API Handlers - Authentication & Users\n * Extracted from api.php during refactoring\n */\n\n// ============================================================================\n// HANDLERS - AUTHENTICATION\n// ============================================================================\n\n/**\n * Vérifie le rate limiting pour les tentatives de connexion\n * @param string $email Email de l'utilisateur\n * @param int $maxAttempts Nombre maximum de tentatives\n * @param int $windowMinutes Fenêtre de temps en minutes\n * @return bool true si autorisé, false si bloqué\n */\nfunction checkRateLimit($email, $maxAttempts = 5, $windowMinutes = 5) {\n    $lockFile = sys_get_temp_dir() . '/ott_login_' . md5($email) . '.lock';\n    $attempts = [];\n    \n    if (file_exists($lockFile)) {\n        $data = file_get_contents($lockFile);\n        if ($data !== false) {\n            $attempts = json_decode($data, true) ?: [];\n        }\n        // Nettoyer les tentatives anciennes (hors de la fenêtre de temps)\n        $now = time();\n        $windowSeconds = $windowMinutes * 60;\n        $attempts = array_filter($attempts, function($timestamp) use ($now, $windowSeconds) {\n            return ($now - $timestamp) < $windowSeconds;\n        });\n    }\n    \n    // Vérifier si le nombre de tentatives dépasse la limite\n    if (count($attempts) >= $maxAttempts) {\n        return false; // Trop de tentatives\n    }\n    \n    // Enregistrer cette tentative\n    $attempts[] = time();\n    file_put_contents($lockFile, json_encode($attempts));\n    \n    return true;\n}\n\nfunction handleLogin() {\n    global $pdo;\n    \n    // S'assurer que le Content-Type est JSON et nettoyer le buffer",
        "start_line": 1,
        "end_line": 50
      },
      "severity": "medium",
      "line": 0,
      "id": "q15",
      "metrics": {
        "Complexity": 0,
        "Lines": 648
      },
      "description": "Fichier volumineux: 648 lignes (max recommandé: 500)",
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\auth.php",
      "context": {
        "file_exists": true,
        "total_lines": 649
      },
      "question": "Fichier/fonction très complexe: Fichier volumineux: 648 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity"
    }
  ]
}