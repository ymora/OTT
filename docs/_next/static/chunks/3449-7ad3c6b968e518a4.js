"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3449,2617],{9723:function(e,t,r){r.d(t,{Z:function(){return o}});var n=r(7437),a=r(2265);function o(e){let{error:t,onRetry:r=null,onClose:o=null,autoClose:l=null,className:u=""}=e;return((0,a.useEffect)(()=>{if(l&&o&&t){let e=setTimeout(()=>{o()},l);return()=>clearTimeout(e)}},[l,o,t]),t)?(0,n.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg animate-slide-down ".concat(u),children:(0,n.jsxs)("div",{className:"flex items-start justify-between",children:[(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("p",{className:"text-sm font-medium",children:"❌ Erreur"}),(0,n.jsx)("p",{className:"text-sm mt-1",children:t})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[r&&(0,n.jsx)("button",{onClick:r,className:"ml-4 text-red-700 hover:text-red-900 underline text-sm",children:"R\xe9essayer"}),o&&(0,n.jsx)("button",{onClick:o,className:"ml-4 text-red-700 hover:text-red-900 text-sm","aria-label":"Fermer",children:"✕"})]})]})}):null}},832:function(e,t,r){r.d(t,{Z:function(){return a}});var n=r(7437);function a(e){let{size:t="md",text:r="Chargement...",fullScreen:a=!1}=e,o=(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center gap-4",children:[(0,n.jsx)("div",{className:"".concat({sm:"w-4 h-4 border-2",md:"w-8 h-8 border-3",lg:"w-16 h-16 border-4",xl:"w-24 h-24 border-4"}[t]," border-primary-500 border-t-transparent rounded-full animate-spin")}),r&&(0,n.jsx)("p",{className:"text-gray-600 dark:text-[rgb(var(--night-text-secondary))]",children:r})]});return a?(0,n.jsx)("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 dark:bg-[rgb(var(--night-bg-start))]",children:o}):o}},9999:function(e,t,r){r.d(t,{AuthProvider:function(){return d},a:function(){return f}});var n=r(7437),a=r(2265),o=r(8828);let l=(0,a.createContext)(),u="https://ott-jbln.onrender.com".replace(/\/$/,""),i=e=>/^https?:\/\//i.test(e),s=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e?i(e)?e:e.startsWith("/")?"".concat(u).concat(e):"".concat(u,"/").concat(e):u},c=e=>s(e);function d(e){let{children:t}=e,[r,i]=(0,a.useState)(null),[s,d]=(0,a.useState)(null),[f,h]=(0,a.useState)(!0);(0,a.useEffect)(()=>{o.Z.debug("[AuthContext] Initialisation...");try{let e=localStorage.getItem("ott_token"),t=localStorage.getItem("ott_user");if(o.Z.debug("[AuthContext] localStorage:",{hasToken:!!e,hasUser:!!t,tokenLength:(null==e?void 0:e.length)||0}),e&&t)try{let r=JSON.parse(t);d(e),i(r),o.Z.debug("[AuthContext] Utilisateur restaur\xe9:",r.email||r.username)}catch(e){o.Z.error("[AuthContext] Erreur parsing user:",e),localStorage.removeItem("ott_token"),localStorage.removeItem("ott_user")}else o.Z.debug("[AuthContext] Aucun utilisateur stock\xe9")}catch(e){o.Z.error("[AuthContext] Erreur lors de l'initialisation:",e)}finally{h(!1),o.Z.debug("[AuthContext] Initialisation termin\xe9e, loading=false")}},[]);let p=async(e,t)=>{try{let r=await fetch(c("/api.php/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),n=r.headers.get("content-type")||"",a=n.includes("application/json");if(!r.ok||!a){let e=await r.text();o.Z.error("[AuthContext] ❌ Erreur serveur"),o.Z.error("[AuthContext] Status:",r.status),o.Z.error("[AuthContext] Content-Type:",n),o.Z.error("[AuthContext] R\xe9ponse compl\xe8te:",e);let t="Erreur serveur (".concat(r.status,")");try{let r=JSON.parse(e);t=r.error||r.message||t}catch(n){if(e.includes("Parse error")||e.includes("Fatal error")||e.includes("Warning")){let n=e.match(/(?:Parse error|Fatal error|Warning):\s*(.+?)(?:\n|$)/i);t=n?"Erreur PHP: ".concat(n[1].substring(0,200)):"Erreur serveur (".concat(r.status,"). L'API distante ne r\xe9pond pas correctement.")}else e.includes("Database")||e.includes("Connection")?t="Erreur de connexion \xe0 la base de donn\xe9es":500===r.status&&(t="Erreur serveur interne. L'API distante rencontre un probl\xe8me.")}{let t="[".concat(new Date().toISOString(),"] ERREUR API\n")+"URL: ".concat(c("/api.php/auth/login"),"\n")+"Status: ".concat(r.status,"\n")+"Content-Type: ".concat(n,"\n")+"R\xe9ponse: ".concat(e.substring(0,1e3),"\n\n");try{localStorage.setItem("api_error_log",t),o.Z.debug("[AuthContext] \uD83D\uDCBE Log sauvegard\xe9 dans localStorage")}catch(e){o.Z.error("[AuthContext] Erreur sauvegarde log:",e)}}throw Error(t)}let l=await r.json();if(!l.success)throw Error(l.error||"Erreur de connexion");return d(l.token),i(l.user),localStorage.setItem("ott_token",l.token),localStorage.setItem("ott_user",JSON.stringify(l.user)),l}catch(e){if(e.message&&e.message.includes("Erreur serveur"))throw e;throw o.Z.error("[AuthContext] ❌ Erreur lors de la connexion:",e),Error("Erreur de connexion au serveur. V\xe9rifiez votre connexion internet.")}},m=()=>{d(null),i(null),localStorage.removeItem("ott_token"),localStorage.removeItem("ott_user")},g=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{requiresAuth:n=!1}=r,a={...t},o={...t.headers||{}};if(a.body&&!o["Content-Type"]&&(o["Content-Type"]="application/json"),s)o.Authorization="Bearer ".concat(s);else throw Error("Non authentifi\xe9");a.headers=o;let l=c(e),u=await fetch(l,a);if(401===u.status&&s)throw m(),Error("Session expir\xe9e");return u};return(0,n.jsx)(l.Provider,{value:{user:r,token:s,loading:f,login:p,logout:m,fetchWithAuth:g,API_URL:u},children:t})}let f=()=>{let e=(0,a.useContext)(l);if(!e)throw Error("useAuth doit \xeatre utilis\xe9 dans AuthProvider");return e}},3072:function(e,t,r){r.d(t,{m_:function(){return i},w3:function(){return h},Nr:function(){return s},iq:function(){return p},EJ:function(){return v},f7:function(){return f},MY:function(){return E},O5:function(){return g},L0:function(){return c},H2:function(){return m},Eg:function(){return d}});var n=r(2265),a=r(9999),o=r(2617),l=r(8828);let u=new Map;function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{fetchWithAuth:r,API_URL:i}=(0,a.a)(),{autoLoad:s=!0,requiresAuth:c=!1,fetchOptions:d={},cacheTTL:f=3e4}=t,h=(0,n.useRef)(null),p=Array.isArray(e),[m,g]=(0,n.useState)(p?{}:null),[v,E]=(0,n.useState)(s),[y,x]=(0,n.useState)(null),w=(0,n.useMemo)(()=>p?JSON.stringify(e):e,[e,p]),b=(0,n.useMemo)(()=>d,[]),S=(0,n.useCallback)(async function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{x(null);let n=p?JSON.stringify(e):e;if(h.current=n,f>0&&!t){let e=u.get(n);if(e&&Date.now()-e.timestamp<f){g(e.data),E(!1);return}}E(!0);let a=p?e:[e];if(p){let e=a.map(e=>(0,o.fetchJson)(r,i,e,b,{requiresAuth:c}).catch(t=>(l.Z.error("Erreur chargement ".concat(e,":"),t),{success:!1,error:t.message||"Erreur lors du chargement",data:null}))),t=await Promise.all(e),s={};a.forEach((e,r)=>{s[e.split("?")[0].split("/").pop()||"data"]=t[r]}),f>0&&u.set(n,{data:s,timestamp:Date.now()}),g(s)}else{let e=await (0,o.fetchJson)(r,i,a[0],b,{requiresAuth:c});f>0&&u.set(n,{data:e,timestamp:Date.now()}),g(e)}}catch(e){l.Z.error("Erreur chargement donn\xe9es:",e),x(e.message||"Erreur lors du chargement des donn\xe9es"),g(p?{}:null)}finally{E(!1)}},[e,r,i,c,p,b,f]);(0,n.useEffect)(()=>{s&&S()},[s,w]);let C=(0,n.useCallback)(()=>{h.current&&u.delete(h.current)},[]);return{data:m,loading:v,error:y,refetch:(0,n.useCallback)(()=>S(!0),[S]),setData:g,invalidateCache:C}}function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,[r,a]=(0,n.useState)(e);return(0,n.useEffect)(()=>{let r=setTimeout(()=>{a(e)},t);return()=>{clearTimeout(r)}},[e,t]),r}function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{searchFn:r,filterFn:a,debounceDelay:o=300}=t,[l,u]=(0,n.useState)(""),[i,c]=(0,n.useState)({}),d=s(l,o),f=(0,n.useMemo)(()=>{let t=e;if(d){if(r)t=r(t,d);else{let e=d.toLowerCase();t=t.filter(t=>Object.values(t).some(t=>"string"==typeof t&&t.toLowerCase().includes(e)))}}return a?t=a(t,i):Object.entries(i).forEach(e=>{let[r,n]=e;n&&"ALL"!==n&&(t=t.filter(e=>String(e[r])===String(n)))}),t},[e,d,i,r,a]);return{searchTerm:l,setSearchTerm:u,filters:i,setFilter:(e,t)=>{c(r=>({...r,[e]:t}))},filteredItems:f,debouncedSearchTerm:d,resetFilters:()=>{u(""),c({})}}}function d(e,t,r,a,o){(0,n.useEffect)(()=>{if(!e){r(!1);return}a||o||t||(r(!0),l.Z.log("\uD83D\uDD04 Activation de la d\xe9tection automatique USB"))},[e,t,r,a,o])}function f(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],[t,r]=(0,n.useState)(e),[a,o]=(0,n.useState)(null);return{isOpen:t,editingItem:a,openCreate:(0,n.useCallback)(()=>{o(null),r(!0)},[]),openEdit:(0,n.useCallback)(e=>{null!=e&&e.deleted_at||(o(e),r(!0))},[]),close:(0,n.useCallback)(()=>{r(!1),o(null)},[]),setEditingItem:o,setIsOpen:r}}function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e4,r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],a=(0,n.useRef)(e);(0,n.useEffect)(()=>{a.current=e},[e]),(0,n.useEffect)(()=>{if(!r||!a.current)return;let e=setInterval(()=>{a.current()},t);return()=>clearInterval(e)},[t,r])}function p(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=(0,n.useRef)(e);(0,n.useEffect)(()=>{r.current=e},[e]),(0,n.useEffect)(()=>{if(!t||!r.current)return;let e=()=>{r.current()},n=e=>{"ott-devices-last-update"===e.key&&r.current()};return window.addEventListener("ott-devices-updated",e),window.addEventListener("storage",n),()=>{window.removeEventListener("ott-devices-updated",e),window.removeEventListener("storage",n)}},[t])}function m(){let e=(0,n.useRef)([]);return(0,n.useEffect)(()=>()=>{e.current.forEach(e=>{"timeout"===e.type?clearTimeout(e.id):"interval"===e.type&&clearInterval(e.id)}),e.current=[]},[]),{createTimeout:(0,n.useCallback)((t,r)=>{let n=setTimeout(()=>{t(),e.current=e.current.filter(e=>e.id!==n)},r);return e.current.push({id:n,type:"timeout"}),n},[]),createInterval:(0,n.useCallback)((t,r)=>{let n=setInterval(t,r);return e.current.push({id:n,type:"interval"}),n},[]),clearAll:(0,n.useCallback)(()=>{e.current.forEach(e=>{"timeout"===e.type?clearTimeout(e.id):"interval"===e.type&&clearInterval(e.id)}),e.current=[]},[])}}function g(e){let{onSuccess:t,onError:r,invalidateCache:o,refetch:u}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{fetchWithAuth:i,API_URL:s}=(0,a.a)(),[c,d]=(0,n.useState)(null),[f,h]=(0,n.useState)(null);return{restore:(0,n.useCallback)(async n=>{if(!(null==n?void 0:n.id)){h("Entit\xe9 invalide");return}try{d(n.id),h(null);let a=await i("".concat(s,"/api.php/").concat(e,"/").concat(n.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({deleted_at:null})},{requiresAuth:!0});if(a.ok)o&&o(),u&&await u(),t&&t(n);else{let t=(await a.json().catch(()=>({}))).error||"Erreur lors de la restauration";h(t),r?r(t,n):l.Z.error("Erreur restauration ".concat(e,":"),t)}}catch(a){let t=a.message||"Erreur lors de la restauration";h(t),r?r(t,n):l.Z.error("Erreur restauration ".concat(e,":"),a)}finally{d(null)}},[e,i,s,o,u,t,r]),restoring:c,error:f}}function v(e){let{fetchWithAuth:t,API_URL:r,entityType:a,refetch:u,onSuccess:i,onError:s,invalidateCache:c,currentUser:d=null,onCloseModal:f=null,editingItem:h=null}=e,[p,m]=(0,n.useState)(null),[g,v]=(0,n.useState)(null);return{archive:(0,n.useCallback)(async e=>{if(!(null==e?void 0:e.id)){v("Entit\xe9 invalide");return}try{m(e.id),v(null);let n=e.id,p=(null==d?void 0:d.role_name)==="admin"?"/api.php/".concat(a,"/").concat(n,"?archive=true"):"/api.php/".concat(a,"/").concat(n),g=await (0,o.fetchJson)(t,r,p,{method:"DELETE"},{requiresAuth:!0});if(g.success)c&&c(),u&&await u(),f&&h&&h.id===e.id&&f(),i&&i(e);else{let t=g.error||"Erreur lors de l'archivage";v(t),s?s(t,e):l.Z.error("Erreur archivage ".concat(a,":"),t)}}catch(r){let t=r.message||"Erreur lors de l'archivage";v(t),s?s(t,e):l.Z.error("Erreur archivage ".concat(a,":"),r)}finally{m(null)}},[t,r,a,u,c,d,i,s,f,h]),archiving:p,error:g}}function E(e){let{fetchWithAuth:t,API_URL:r,entityType:a,refetch:u,onSuccess:i,onError:s,invalidateCache:c,onCloseModal:d=null,editingItem:f=null}=e,[h,p]=(0,n.useState)(null),[m,g]=(0,n.useState)(null);return{permanentDelete:(0,n.useCallback)(async e=>{if(!(null==e?void 0:e.id)){g("Entit\xe9 invalide");return}try{p(e.id),g(null);let n=await (0,o.fetchJson)(t,r,"/api.php/".concat(a,"/").concat(e.id,"?permanent=true"),{method:"DELETE"},{requiresAuth:!0});if(n.success)c&&c(),u&&await u(),d&&f&&f.id===e.id&&d(),i&&i(e);else{let t=n.error||"Erreur lors de la suppression";g(t),s?s(t,e):l.Z.error("Erreur suppression ".concat(a,":"),t)}}catch(r){let t=r.message||"Erreur lors de la suppression";g(t),s?s(t,e):l.Z.error("Erreur suppression ".concat(a,":"),r)}finally{p(null)}},[t,r,a,u,c,i,s,d,f]),deleting:h,error:m}}},2617:function(e,t,r){r.d(t,{fetchJson:function(){return n}});async function n(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};try{let o;let l=await e("".concat(t).concat(r),n,a);if(!l.ok){let e={},t=l.headers.get("content-type");if(t&&t.includes("application/json"))try{let t=await l.text();t&&t.trim()&&(e=JSON.parse(t))}catch(e){}throw Error(e.error||"Erreur HTTP ".concat(l.status))}let u=l.headers.get("content-type");if(!u||!u.includes("application/json")){let e=await l.text();if(!e||!e.trim())throw Error("R\xe9ponse vide de l'endpoint ".concat(r));throw Error("R\xe9ponse non-JSON de l'endpoint ".concat(r,": ").concat(e.substring(0,100)))}let i=await l.text();if(!i||!i.trim())throw Error("R\xe9ponse JSON vide de l'endpoint ".concat(r));try{o=JSON.parse(i)}catch(e){throw Error("R\xe9ponse JSON invalide de l'endpoint ".concat(r,": ").concat(e.message))}if(!o.success)throw Error(o.error||"Erreur API");return o}catch(e){if(e instanceof Error)throw e;throw Error(e.message||"Erreur lors de l'appel API")}}},8828:function(e,t,r){r.d(t,{k:function(){return n}}),r(257);let n={log:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r]},error:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];console.error("[ERROR]",...t)},warn:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r]},debug:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r]}};t.Z=n}}]);