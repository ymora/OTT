(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4345],{4345:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return E}});var r,a,l,i,s,o,u=n(7437),c=n(2265);let d=(0,c.createContext)(null),f=d.Provider;function m(){let e=(0,c.useContext)(d);if(null==e)throw Error("No context provided: useLeafletContext() can only be used in a descendant of <MapContainer>");return e}var p=n(4887);function b(e,t,n){return Object.freeze({instance:e,context:t,container:n})}function x(e,t){return null==t?function(t,n){let r=(0,c.useRef)();return r.current||(r.current=e(t,n)),r}:function(n,r){let a=(0,c.useRef)();a.current||(a.current=e(n,r));let l=(0,c.useRef)(n),{instance:i}=a.current;return(0,c.useEffect)(function(){l.current!==n&&(t(i,n,l.current),l.current=n)},[i,n,r]),a}}function g(e,t){let n=(0,c.useRef)(t);(0,c.useEffect)(function(){t!==n.current&&null!=e.attributionControl&&(null!=n.current&&e.attributionControl.removeAttribution(n.current),null!=t&&e.attributionControl.addAttribution(t)),n.current=t},[e,t])}function h(e,t){let n=(0,c.useRef)();(0,c.useEffect)(function(){return null!=t&&e.instance.on(t),n.current=t,function(){null!=n.current&&e.instance.off(n.current),n.current=null}},[e,t])}function v(e,t){let n=e.pane??t.pane;return n?{...e,pane:n}:e}function y(e){return function(t){var n;let r=m(),a=e(v(t,r),r);return g(r.map,t.attribution),h(a.current,t.eventHandlers),n=a.current,(0,c.useEffect)(function(){return(r.layerContainer??r.map).addLayer(n.instance),function(){r.layerContainer?.removeLayer(n.instance),r.map.removeLayer(n.instance)}},[r,n]),a}}var N=n(759),j=n.n(N);let w=(r=y(x(function({position:e,...t},n){var r;let a=new N.Marker(e,t);return b(a,(r={overlayContainer:a},Object.freeze({...n,...r})))},function(e,t,n){t.position!==n.position&&e.setLatLng(t.position),null!=t.icon&&t.icon!==n.icon&&e.setIcon(t.icon),null!=t.zIndexOffset&&t.zIndexOffset!==n.zIndexOffset&&e.setZIndexOffset(t.zIndexOffset),null!=t.opacity&&t.opacity!==n.opacity&&e.setOpacity(t.opacity),null!=e.dragging&&t.draggable!==n.draggable&&(!0===t.draggable?e.dragging.enable():e.dragging.disable())})),(0,c.forwardRef)(function(e,t){let{instance:n,context:a}=r(e).current;return(0,c.useImperativeHandle)(t,()=>n),null==e.children?null:c.createElement(f,{value:a},e.children)})),D=(a=function(e,t){return b(new N.Popup(e,t.overlayContainer),t)},l=function(e,t,{position:n},r){(0,c.useEffect)(function(){let{instance:a}=e;function l(e){e.popup===a&&(a.update(),r(!0))}function i(e){e.popup===a&&r(!1)}return t.map.on({popupopen:l,popupclose:i}),null==t.overlayContainer?(null!=n&&a.setLatLng(n),a.openOn(t.map)):t.overlayContainer.bindPopup(a),function(){t.map.off({popupopen:l,popupclose:i}),t.overlayContainer?.unbindPopup(),t.map.removeLayer(a)}},[e,t,r,n])},i=x(a),s=function(e,t){let n=m(),r=i(v(e,n),n);return g(n.map,e.attribution),h(r.current,e.eventHandlers),l(r.current,n,e,t),r},(0,c.forwardRef)(function(e,t){let[n,r]=(0,c.useState)(!1),{instance:a}=s(e,r).current;(0,c.useImperativeHandle)(t,()=>a),(0,c.useEffect)(function(){n&&a.update()},[a,n,e.children]);let l=a._contentNode;return l?(0,p.createPortal)(e.children,l):null}));function _(){return(_=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}let F=(0,c.forwardRef)(function({bounds:e,boundsOptions:t,center:n,children:r,className:a,id:l,placeholder:i,style:s,whenReady:o,zoom:u,...d},m){let[p]=(0,c.useState)({className:a,id:l,style:s}),[b,x]=(0,c.useState)(null);(0,c.useImperativeHandle)(m,()=>b?.map??null,[b]);let g=(0,c.useCallback)(r=>{if(null!==r&&null===b){let a=new N.Map(r,d);null!=n&&null!=u?a.setView(n,u):null!=e&&a.fitBounds(e,t),null!=o&&a.whenReady(o),x(Object.freeze({__version:1,map:a}))}},[]);(0,c.useEffect)(()=>()=>{b?.map.remove()},[b]);let h=b?c.createElement(f,{value:b},r):i??null;return c.createElement("div",_({},p,{ref:g}),h)}),S=(o=y(x(function({url:e,...t},n){return b(new N.TileLayer(e,v(t,n)),n)},function(e,t,n){!function(e,t,n){let{opacity:r,zIndex:a}=t;null!=r&&r!==n.opacity&&e.setOpacity(r),null!=a&&a!==n.zIndex&&e.setZIndex(a)}(e,t,n);let{url:r}=t;null!=r&&r!==n.url&&e.setUrl(r)})),(0,c.forwardRef)(function(e,t){let{instance:n}=o(e).current;return(0,c.useImperativeHandle)(t,()=>n),null}));n(5046);let I={online:"#22c55e",warning:"#f97316",offline:"#ef4444"},L={online:"text-green-700 bg-green-50 border-green-100",warning:"text-amber-700 bg-amber-50 border-amber-100",offline:"text-red-700 bg-red-50 border-red-100"};function C(e){let{devices:t,focusDeviceId:n,onSelect:r}=e,a=m().map,[l,i]=(0,c.useState)(null);(0,c.useEffect)(()=>{if(!n||!a)return;let e=t.find(e=>String(e.id)===String(n));e&&e.latitude&&e.longitude&&a.flyTo([e.latitude,e.longitude],9,{duration:.8})},[n,t,a]);let s=(0,c.useMemo)(()=>t.map(e=>{var t;let n=function(e){let t=function(e){if(!e)return Number.POSITIVE_INFINITY;let t=new Date(e).getTime();return Number.isNaN(t)?Number.POSITIVE_INFINITY:(Date.now()-t)/36e5}(e.last_seen);return Number.isFinite(t)?t<2?{status:"online",label:"En ligne",lastSeenLabel:new Date(e.last_seen).toLocaleString("fr-FR")}:t<6?{status:"warning",label:"Inactif r\xe9cent",lastSeenLabel:new Date(e.last_seen).toLocaleString("fr-FR")}:{status:"offline",label:"Hors ligne",lastSeenLabel:new Date(e.last_seen).toLocaleString("fr-FR")}:{status:"offline",label:"Jamais vu",lastSeenLabel:"Jamais"}}(e),r="number"!=typeof(t=e.last_battery)?{label:"N/A",status:"unknown"}:t<20?{label:"".concat(t.toFixed(0),"%"),status:"critical"}:t<50?{label:"".concat(t.toFixed(0),"%"),status:"low"}:{label:"".concat(t.toFixed(0),"%"),status:"ok"},a="number"==typeof e.latitude?e.latitude:parseFloat(e.latitude),l="number"==typeof e.longitude?e.longitude:parseFloat(e.longitude);if(!(!isNaN(a)&&!isNaN(l)&&isFinite(a)&&isFinite(l)&&a>=-90&&a<=90&&l>=-180&&l<=180)){let t=e.id||0,n=.05+t%5*.02,r=137.508*t%360*Math.PI/180;a=46.2276+n*Math.cos(r),l=2.2137+n*Math.sin(r)}return{...e,latitude:a,longitude:l,hasRealCoordinates:!!(e.latitude&&e.longitude),connectionStatus:n.status,connectionLabel:n.label,lastSeenLabel:n.lastSeenLabel,batteryLabel:r.label,batteryStatus:r.status}}),[t]),o=(0,c.useMemo)(()=>{let e={};return s.forEach(t=>{e[t.id]=function(e){var t,n,r;let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"online",l=I[a]||I.online,i="\uD83D\uDCCD",s=l,o=e.last_battery;null!=o&&(o<20?(i="\uD83D\uDD34",s="#ef4444"):o<30?(i="\uD83D\uDFE0",s="#f97316"):(i=o>=80?"\uD83D\uDFE2":"\uD83D\uDD0B",s="#22c55e")),e.unresolved_alerts_count>0&&(i="⚠️",s="#f97316");let u=e.device_name?(null===(t=e.device_name.split("-").pop())||void 0===t?void 0:t.substring(0,3))||(null===(n=e.id)||void 0===n?void 0:n.toString().slice(-2))||"":(null===(r=e.id)||void 0===r?void 0:r.toString().slice(-2))||"";return j().divIcon({className:"custom-marker",html:'\n      <div class="marker-container" style="\n        position: relative;\n        width: '.concat(34,"px;\n        height: ").concat(34,'px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n      ">\n        <!-- Ic\xf4ne principale -->\n        <div class="marker-icon" style="\n          font-size: ').concat(22,'px;\n          filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));\n        transition: all 0.3s ease;\n        position: relative;\n        z-index: 2;\n        ">').concat(i,"</div>\n        \n        <!-- Label avec nom du dispositif -->\n        ").concat(u?'\n        <div class="marker-label" style="\n          position: absolute;\n          bottom: -18px;\n          left: 50%;\n          transform: translateX(-50%);\n          background: white;\n          color: '.concat(s,";\n          font-size: 9px;\n          font-weight: bold;\n          padding: 2px 5px;\n          border-radius: 8px;\n          border: 1px solid ").concat(s,';\n          box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n          z-index: 3;\n          white-space: nowrap;\n        ">').concat(u,"</div>\n        "):"","\n      </div>\n      \n      <style>\n        .marker-container:hover .marker-icon {\n          transform: scale(1.3);\n        }\n        .marker-container:hover .marker-label {\n          font-size: 10px;\n          padding: 3px 6px;\n        }\n      </style>\n    "),iconSize:[40,40],iconAnchor:[20,35]})}(t,t.connectionStatus)}),e},[s]);return(0,u.jsx)(u.Fragment,{children:s.map(e=>(0,u.jsx)(w,{position:[e.latitude,e.longitude],icon:o[e.id],eventHandlers:{click:()=>null==r?void 0:r(e),mouseover:t=>{let n=t.target.getElement();n&&n.classList.add("marker-hovered"),i(e.id)},mouseout:e=>{let t=e.target.getElement();t&&t.classList.remove("marker-hovered"),hoverTimeoutRef.current&&clearTimeout(hoverTimeoutRef.current),hoverTimeoutRef.current=setTimeout(()=>i(null),150)}},children:(0,u.jsx)(D,{maxWidth:320,children:(0,u.jsxs)("div",{className:"space-y-2 p-2",children:[(0,u.jsxs)("div",{className:"flex items-center justify-between gap-2 border-b pb-2",children:[(0,u.jsx)("p",{className:"font-semibold text-base",children:e.device_name||e.sim_iccid}),(0,u.jsx)("span",{className:"text-xs font-medium px-2 py-1 rounded-full border ".concat(L[e.connectionStatus]||L.online),children:e.connectionLabel})]}),!e.hasRealCoordinates&&(0,u.jsx)("div",{className:"bg-amber-50 border border-amber-200 rounded p-2 mb-2",children:(0,u.jsx)("p",{className:"text-xs text-amber-800 font-medium",children:"⚠️ Position estim\xe9e (pas de coordonn\xe9es GPS)"})}),(0,u.jsxs)("div",{className:"space-y-1.5 text-sm",children:[(0,u.jsxs)("div",{className:"flex items-center justify-between",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDCCD Localisation:"}),(0,u.jsx)("span",{className:"font-medium",children:e.city||"Non localis\xe9"})]}),(0,u.jsxs)("div",{className:"flex items-center justify-between",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDD0B Batterie:"}),(0,u.jsxs)("span",{className:"font-semibold ".concat("critical"===e.batteryStatus?"text-red-600":"low"===e.batteryStatus?"text-amber-600":"text-green-600"),children:[e.batteryLabel,"critical"===e.batteryStatus&&" \uD83D\uDD34","low"===e.batteryStatus&&" \uD83D\uDFE0"]})]}),null!==e.last_flowrate&&void 0!==e.last_flowrate&&(0,u.jsxs)("div",{className:"flex items-center justify-between",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDCA8 D\xe9bit:"}),(0,u.jsxs)("span",{className:"font-medium",children:[Number(e.last_flowrate).toFixed(2)," L/min"]})]}),e.firmware_version&&(0,u.jsxs)("div",{className:"flex items-center justify-between",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDCBE Firmware:"}),(0,u.jsx)("span",{className:"font-mono text-xs font-medium",children:e.firmware_version})]}),e.unresolved_alerts_count>0&&(0,u.jsxs)("div",{className:"flex items-center justify-between bg-orange-50 border border-orange-200 rounded px-2 py-1",children:[(0,u.jsx)("span",{className:"text-orange-700 font-semibold",children:"⚠️ Alertes:"}),(0,u.jsx)("span",{className:"font-bold text-orange-700",children:e.unresolved_alerts_count})]}),(0,u.jsxs)("div",{className:"flex items-center justify-between",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDD52 Dernier contact:"}),(0,u.jsx)("span",{className:"font-medium text-xs",children:e.lastSeenLabel})]}),e.first_name&&(0,u.jsxs)("div",{className:"flex items-center justify-between border-t pt-1.5 mt-1.5",children:[(0,u.jsx)("span",{className:"text-gray-600",children:"\uD83D\uDC64 Patient:"}),(0,u.jsxs)("span",{className:"font-medium",children:[e.first_name," ",e.last_name]})]}),e.sim_iccid&&(0,u.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500 pt-1 border-t",children:[(0,u.jsx)("span",{children:"ICCID:"}),(0,u.jsx)("span",{className:"font-mono",children:e.sim_iccid})]}),e.firmware_version&&(0,u.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[(0,u.jsx)("span",{children:"Firmware:"}),(0,u.jsx)("span",{className:"font-mono",children:e.firmware_version})]})]})]})})},e.id))})}function E(e){let{devices:t=[],focusDeviceId:n,onSelect:r}=e,a=(0,c.useRef)(null);(0,c.useEffect)(()=>()=>{a.current&&clearTimeout(a.current)},[]);let l=(0,c.useMemo)(()=>{if(0===t.length)return[46.2276,2.2137];let e=t.filter(e=>{let t="number"==typeof e.latitude?e.latitude:parseFloat(e.latitude),n="number"==typeof e.longitude?e.longitude:parseFloat(e.longitude);return!isNaN(t)&&!isNaN(n)&&isFinite(t)&&isFinite(n)&&t>=-90&&t<=90&&n>=-180&&n<=180});if(e.length>0){let t=e.map(e=>{let t="number"==typeof e.latitude?e.latitude:parseFloat(e.latitude);return isNaN(t)?null:t}).filter(e=>null!==e),n=e.map(e=>{let t="number"==typeof e.longitude?e.longitude:parseFloat(e.longitude);return isNaN(t)?null:t}).filter(e=>null!==e);if(t.length>0&&n.length>0){let e=t.reduce((e,t)=>e+t,0)/t.length,r=n.reduce((e,t)=>e+t,0)/n.length;if(!isNaN(e)&&!isNaN(r)&&isFinite(e)&&isFinite(r))return[e,r]}}return[46.2276,2.2137]},[t]),i=(0,c.useMemo)(()=>{let e=t.filter(e=>{let t="number"==typeof e.latitude?e.latitude:parseFloat(e.latitude),n="number"==typeof e.longitude?e.longitude:parseFloat(e.longitude);return!isNaN(t)&&!isNaN(n)&&isFinite(t)&&isFinite(n)&&t>=-90&&t<=90&&n>=-180&&n<=180});return 0===e.length?5.5:1===e.length?9:6},[t]);return(0,u.jsxs)(F,{center:l,zoom:i,style:{height:600,width:"100%"},scrollWheelZoom:!0,children:[(0,u.jsx)(S,{attribution:'\xa9 <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),(0,u.jsx)(C,{devices:t,focusDeviceId:n,onSelect:r})]})}},5046:function(){}}]);