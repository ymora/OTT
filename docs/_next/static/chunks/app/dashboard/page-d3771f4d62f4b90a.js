(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{6565:function(e,t,a){Promise.resolve().then(a.bind(a,9779))},9779:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return m}});var r=a(7437),s=a(2265),l=a(9999);function n(e){let{title:t,value:a,icon:l,color:n="primary",delay:i=0}=e,[o,c]=(0,s.useState)(0);return(0,s.useEffect)(()=>{let e=parseInt(a)||0,t=0,r=e/30,s=setInterval(()=>{(t+=r)>=e?(c(e),clearInterval(s)):c(Math.floor(t))},20);return()=>clearInterval(s)},[a]),(0,r.jsx)("div",{className:"card group hover:scale-105 cursor-pointer animate-slide-up",style:{animationDelay:"".concat(i,"s")},children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 mb-1",children:t}),(0,r.jsx)("p",{className:"text-3xl font-bold text-gray-900 mb-2",children:"string"==typeof a&&a.includes("%")?a:o})]}),(0,r.jsx)("div",{className:"w-14 h-14 bg-gradient-to-br ".concat({primary:"from-primary-500 to-primary-600",green:"from-green-500 to-green-600",red:"from-red-500 to-red-600",blue:"from-blue-500 to-blue-600",orange:"from-orange-500 to-orange-600"}[n]," rounded-xl flex items-center justify-center text-2xl shadow-lg group-hover:scale-110 transition-transform"),children:l})]})})}var i=a(9004),o=a(7293),c=a(4526),d=a(2617),u=a(9376);function m(){let e=(0,u.useRouter)(),{fetchWithAuth:t,API_URL:a}=(0,l.a)(),[m,g]=(0,s.useState)([]),[x,h]=(0,s.useState)([]),[f,p]=(0,s.useState)([]),[v,b]=(0,s.useState)(!0),[y,D]=(0,s.useState)(null),j=(0,s.useCallback)(async()=>{try{D(null);let[e,r,s]=await Promise.all([(0,d.r)(t,a,"/api.php/devices"),(0,d.r)(t,a,"/api.php/alerts"),(0,d.r)(t,a,"/api.php/measurements/latest")]);g(e.devices||[]),h((r.alerts||[]).filter(e=>"unresolved"===e.status)),p(s.measurements||[])}catch(e){console.error(e),D(e.message)}finally{b(!1)}},[a,t]);(0,s.useEffect)(()=>{j()},[j]);let N={totalDevices:m.length,activeDevices:m.filter(e=>{let t=new Date(e.last_seen);return(new Date-t)/36e5<2}).length,criticalAlerts:x.filter(e=>"critical"===e.severity).length,avgBattery:m.length>0?(m.reduce((e,t)=>e+(t.last_battery||0),0)/m.length).toFixed(1):0};return v?(0,r.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[1,2,3,4].map(e=>(0,r.jsx)("div",{className:"card animate-shimmer h-32"},e))}):(0,r.jsxs)("div",{className:"space-y-6 animate-fade-in",children:[(0,r.jsxs)("div",{className:"animate-slide-up",children:[(0,r.jsx)("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Vue d'Ensemble"}),(0,r.jsx)("p",{className:"text-gray-600",children:"Tableau de bord en temps r\xe9el des dispositifs OTT"})]}),y&&(0,r.jsxs)("div",{className:"alert alert-warning",children:[(0,r.jsx)("strong",{children:"Erreur API :"})," ",y]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[(0,r.jsx)(n,{title:"Dispositifs Totaux",value:N.totalDevices,icon:"\uD83D\uDD0C",color:"primary",delay:0}),(0,r.jsx)(n,{title:"Dispositifs Actifs",value:N.activeDevices,icon:"✅",color:"green",delay:.1}),(0,r.jsx)(n,{title:"Alertes Critiques",value:N.criticalAlerts,icon:"⚠️",color:"red",delay:.2}),(0,r.jsx)(n,{title:"Batterie Moyenne",value:"".concat(N.avgBattery,"%"),icon:"\uD83D\uDD0B",color:"blue",delay:.3})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"card animate-slide-up",style:{animationDelay:"0.4s"},children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDCC8 D\xe9bits Derni\xe8res 24h"}),(0,r.jsx)(c.Z,{data:f,type:"flowrate"})]}),(0,r.jsxs)("div",{className:"card animate-slide-up",style:{animationDelay:"0.5s"},children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDD0B Niveaux Batterie"}),(0,r.jsx)(c.Z,{data:m,type:"battery"})]})]}),x.length>0&&(0,r.jsxs)("div",{className:"card animate-slide-up",style:{animationDelay:"0.6s"},children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDD14 Alertes R\xe9centes"}),(0,r.jsx)("div",{className:"space-y-3",children:x.slice(0,5).map((e,t)=>(0,r.jsx)(o.Z,{alert:e,delay:.05*t},e.id))})]}),(0,r.jsxs)("div",{className:"card animate-slide-up",style:{animationDelay:"0.7s"},children:[(0,r.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"\uD83D\uDD0C Dispositifs"}),(0,r.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:m.slice(0,6).map((t,a)=>(0,r.jsx)(i.Z,{device:t,delay:.05*a,onSelect:t=>e.push("/dashboard/map?deviceId=".concat(t.id))},t.id))}),(0,r.jsx)("div",{className:"text-right mt-4",children:(0,r.jsx)("button",{className:"btn-secondary",onClick:()=>e.push("/dashboard/map"),children:"Voir tous les dispositifs sur la carte →"})})]})]})}},7293:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(7437);function s(e){let{alert:t,delay:a=0}=e,s={critical:{color:"border-red-500 bg-red-50",icon:"\uD83D\uDEA8",textColor:"text-red-700"},high:{color:"border-orange-500 bg-orange-50",icon:"⚠️",textColor:"text-orange-700"},medium:{color:"border-yellow-500 bg-yellow-50",icon:"⚡",textColor:"text-yellow-700"},low:{color:"border-blue-500 bg-blue-50",icon:"ℹ️",textColor:"text-blue-700"}},l=s[t.severity]||s.low;return(0,r.jsx)("div",{className:"border-l-4 ".concat(l.color," p-4 rounded-r-lg animate-slide-up hover:shadow-md transition-all"),style:{animationDelay:"".concat(a,"s")},children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("span",{className:"text-2xl",children:l.icon}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-semibold ".concat(l.textColor),children:t.message}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:new Date(t.created_at).toLocaleString("fr-FR")})]}),(0,r.jsx)("span",{className:"badge ".concat(l.textColor," bg-white"),children:t.severity})]})})}},4526:function(e,t,a){"use strict";a.d(t,{Z:function(){return n}});var r=a(7437),s=a(6705),l=a(4084);function n(e){let{data:t=[],type:a}=e;if(!t||0===t.length)return(0,r.jsx)("div",{className:"h-64 flex items-center justify-center text-gray-400",children:(0,r.jsx)("p",{children:"\uD83D\uDCCA Pas de donn\xe9es disponibles"})});let l=[...t].sort((e,t)=>new Date(e.timestamp||e.created_at||0)-new Date(t.timestamp||t.created_at||0)).slice(-20),n={labels:l.map(e=>e.timestamp||e.created_at?new Date(e.timestamp||e.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}):e.device_name||""),datasets:[{label:"flowrate"===a?"D\xe9bit (L/min)":"Batterie (%)",data:l.map(e=>{var t,r,s,l;return"flowrate"===a?Number(null!==(r=null!==(t=e.flowrate)&&void 0!==t?t:e.value)&&void 0!==r?r:0):Number(null!==(l=null!==(s=e.battery)&&void 0!==s?s:e.last_battery)&&void 0!==l?l:0)}),borderColor:"flowrate"===a?"rgb(102, 126, 234)":"rgb(81, 207, 102)",backgroundColor:"flowrate"===a?"rgba(102, 126, 234, 0.1)":"rgba(81, 207, 102, 0.1)",fill:!0,tension:.4}]};return(0,r.jsx)("div",{className:"h-64",children:(0,r.jsx)(s.x1,{data:n,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleFont:{size:14},bodyFont:{size:13}}},scales:{y:{beginAtZero:!0,grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:!1}}},animation:{duration:1e3,easing:"easeInOutQuart"}}})})}l.kL.register(l.uw,l.f$,l.od,l.jn,l.Dx,l.u,l.De,l.Gu)},9004:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(7437);function s(e){var t;let{device:a,delay:s=0,onSelect:l}=e,n=()=>{if(!a.last_seen)return!1;let e=new Date(a.last_seen);return(Date.now()-e.getTime())/36e5<2},i="number"==typeof a.last_battery?a.last_battery:null;return(0,r.jsxs)("div",{className:"card group hover:scale-102 cursor-pointer animate-scale-in",style:{animationDelay:"".concat(s,"s")},onClick:()=>null==l?void 0:l(a),role:l?"button":void 0,tabIndex:l?0:void 0,children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 ".concat(n()?"text-green-600":"text-gray-400"),children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(n()?"bg-green-500 animate-pulse":"bg-gray-400")}),(0,r.jsx)("span",{className:"text-xs font-medium",children:n()?"En ligne":"Hors ligne"})]}),(0,r.jsxs)("span",{className:"text-2xl ".concat(null===i?"text-gray-400":i>60?"text-green-600":i>20?"text-orange-600":"text-red-600"),children:["\uD83D\uDD0B ",null!==i?"".concat(i.toFixed(0),"%"):"N/A"]})]}),(0,r.jsx)("h3",{className:"font-semibold text-gray-900 mb-2 group-hover:text-primary-600 transition-colors",children:a.device_name||"OTT-".concat(null===(t=a.sim_iccid)||void 0===t?void 0:t.substr(-8))}),a.first_name&&(0,r.jsxs)("p",{className:"text-sm text-gray-600 mb-2",children:["\uD83D\uDC64 ",a.first_name," ",a.last_name]}),(0,r.jsxs)("p",{className:"text-xs text-gray-500",children:["\uD83D\uDCCD ",a.city||"Non localis\xe9"," | \uD83D\uDC41️ ",a.last_seen?new Date(a.last_seen).toLocaleString("fr-FR"):"n/a"]})]})}},9999:function(e,t,a){"use strict";a.d(t,{H:function(){return i},a:function(){return o}});var r=a(7437),s=a(2265);let l=(0,s.createContext)(),n="https://ott-jbln.onrender.com";function i(e){let{children:t}=e,[a,i]=(0,s.useState)(null),[o,c]=(0,s.useState)(null),[d,u]=(0,s.useState)(!0);(0,s.useEffect)(()=>{let e=localStorage.getItem("ott_token"),t=localStorage.getItem("ott_user");e&&t&&(c(e),i(JSON.parse(t))),u(!1)},[]);let m=async(e,t)=>{let a=await fetch("".concat(n,"/api.php/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),r=await a.json();if(!r.success)throw Error(r.error||"Erreur de connexion");return c(r.token),i(r.user),localStorage.setItem("ott_token",r.token),localStorage.setItem("ott_user",JSON.stringify(r.user)),r},g=()=>{c(null),i(null),localStorage.removeItem("ott_token"),localStorage.removeItem("ott_user")},x=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{requiresAuth:r=!1}=a,s={...t},l={...t.headers||{}};if(s.body&&!l["Content-Type"]&&(l["Content-Type"]="application/json"),o)l.Authorization="Bearer ".concat(o);else throw Error("Non authentifi\xe9");s.headers=l;let n=await fetch(e,s);if(401===n.status&&o)throw g(),Error("Session expir\xe9e");return n};return(0,r.jsx)(l.Provider,{value:{user:a,token:o,loading:d,login:m,logout:g,fetchWithAuth:x,API_URL:n},children:t})}let o=()=>{let e=(0,s.useContext)(l);if(!e)throw Error("useAuth doit \xeatre utilis\xe9 dans AuthProvider");return e}},2617:function(e,t,a){"use strict";async function r(e,t,a){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},l=await e("".concat(t).concat(a),r,s),n=await l.json();if(!n.success)throw Error(n.error||"Erreur API");return n}a.d(t,{r:function(){return r}})},9376:function(e,t,a){"use strict";var r=a(5475);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[674,840,971,117,744],function(){return e(e.s=6565)}),_N_E=e.O()}]);