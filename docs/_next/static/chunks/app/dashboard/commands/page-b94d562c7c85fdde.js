(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[154],{8488:function(e,a,t){Promise.resolve().then(t.bind(t,7672))},7672:function(e,a,t){"use strict";t.r(a),t.d(a,{default:function(){return d}});var s=t(7437),l=t(2265),i=t(9999),n=t(2617);let r=[{value:"SET_SLEEP_SECONDS",label:"Modifier intervalle de sommeil"},{value:"PING",label:"Ping / Diagnostic rapide"},{value:"UPDATE_CONFIG",label:"Mettre \xe0 jour la configuration"},{value:"UPDATE_CALIBRATION",label:"Recalibrer le capteur"},{value:"OTA_REQUEST",label:"D\xe9clencher une mise \xe0 jour OTA"}],c=[{value:"low",label:"Basse"},{value:"normal",label:"Normale"},{value:"high",label:"Haute"},{value:"critical",label:"Critique"}],o={pending:"bg-yellow-100 text-yellow-800",executing:"bg-blue-100 text-blue-800",executed:"bg-green-100 text-green-800",error:"bg-red-100 text-red-800",expired:"bg-gray-100 text-gray-600",cancelled:"bg-gray-200 text-gray-700"};function d(){let{fetchWithAuth:e,API_URL:a,user:t,loading:d}=(0,i.a)(),[m,u]=(0,l.useState)([]),[g,p]=(0,l.useState)([]),[h,x]=(0,l.useState)(!0),[f,v]=(0,l.useState)(!1),[N,j]=(0,l.useState)(null),[b,y]=(0,l.useState)(0),[S,_]=(0,l.useState)({iccid:"",command:"SET_SLEEP_SECONDS",sleepSeconds:300,message:"",priority:"normal",expiresInMinutes:60,configApn:"",configJwt:"",configIccid:"",configSerial:"",configSimPin:"",configSleepMinutes:"",configAirflowPasses:"",configAirflowSamples:"",configAirflowDelay:"",configWatchdogSeconds:"",configModemBootTimeout:"",configSimReadyTimeout:"",configNetworkAttachTimeout:"",configModemReboots:"",configOtaPrimaryUrl:"",configOtaFallbackUrl:"",configOtaMd5:"",calA0:"",calA1:"",calA2:"",otaUrl:"",otaChannel:"primary",otaMd5:""}),C=(0,l.useCallback)(async()=>{try{var t;j(null),x(!0);let[s,l]=await Promise.all([(0,n.r)(e,a,"/api.php/devices/commands?limit=200"),(0,n.r)(e,a,"/api.php/devices")]);u(s.commands||[]),p(l.devices||[]),!S.iccid&&(null===(t=l.devices)||void 0===t?void 0:t.length)&&_(e=>({...e,iccid:l.devices[0].sim_iccid}))}catch(e){console.error(e),j(e.message)}finally{x(!1)}},[a,e,S.iccid]);(0,l.useEffect)(()=>{!d&&(t&&"admin"!==t.role_name||C())},[C,b,d,t]);let w=async t=>{var s,l,i;if(t.preventDefault(),!S.iccid){j("Veuillez s\xe9lectionner un dispositif");return}let r={};if("SET_SLEEP_SECONDS"===S.command)r.seconds=Number(S.sleepSeconds)||300;else if("PING"===S.command)r.message=(null===(s=S.message)||void 0===s?void 0:s.trim())||"PING";else if("UPDATE_CONFIG"===S.command){let e=(e,a)=>{let t=(null!=a?a:"").trim();t&&(r[e]=t)},a=(e,a)=>{if(""===a||null==a)return;let t=Number(a);Number.isFinite(t)&&(r[e]=t)};if(e("apn",S.configApn),e("jwt",S.configJwt),e("iccid",S.configIccid),e("serial",S.configSerial),e("sim_pin",S.configSimPin),a("sleep_minutes_default",S.configSleepMinutes),a("airflow_passes",S.configAirflowPasses),a("airflow_samples_per_pass",S.configAirflowSamples),a("airflow_delay_ms",S.configAirflowDelay),a("watchdog_seconds",S.configWatchdogSeconds),a("modem_boot_timeout_ms",S.configModemBootTimeout),a("sim_ready_timeout_ms",S.configSimReadyTimeout),a("network_attach_timeout_ms",S.configNetworkAttachTimeout),a("modem_max_reboots",S.configModemReboots),e("ota_primary_url",S.configOtaPrimaryUrl),e("ota_fallback_url",S.configOtaFallbackUrl),e("ota_md5",S.configOtaMd5),0===Object.keys(r).length){j("Veuillez renseigner au moins un champ de configuration");return}}else if("UPDATE_CALIBRATION"===S.command){if(""===S.calA0||""===S.calA1||""===S.calA2){j("Veuillez fournir les coefficients a0, a1 et a2");return}if(r.a0=Number(S.calA0),r.a1=Number(S.calA1),r.a2=Number(S.calA2),[r.a0,r.a1,r.a2].some(e=>Number.isNaN(e))){j("Les coefficients doivent \xeatre num\xe9riques");return}}else if("OTA_REQUEST"===S.command){r.channel=S.otaChannel;let e=null===(l=S.otaUrl)||void 0===l?void 0:l.trim();e&&(r.url=e);let a=null===(i=S.otaMd5)||void 0===i?void 0:i.trim();a&&(r.md5=a)}let c={command:S.command,payload:r,priority:S.priority,expires_in_seconds:Number(S.expiresInMinutes)>0?60*Number(S.expiresInMinutes):void 0};try{v(!0),j(null),await (0,n.r)(e,a,"/api.php/devices/".concat(S.iccid,"/commands"),{method:"POST",body:JSON.stringify(c)},{requiresAuth:!0}),y(e=>e+1)}catch(e){console.error(e),j(e.message)}finally{v(!1)}},A=(0,l.useMemo)(()=>({pending:m.filter(e=>"pending"===e.status).length,executed:m.filter(e=>"executed"===e.status).length,errors:m.filter(e=>"error"===e.status).length}),[m]);return!d&&t&&"admin"!==t.role_name?(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"Commandes descendantes"}),(0,s.jsx)("p",{className:"text-gray-600 mt-2",children:"Seuls les administrateurs peuvent programmer ou consulter les commandes critiques. Veuillez contacter un administrateur si vous avez besoin d’ex\xe9cuter une action."})]}):(0,s.jsxs)("div",{className:"space-y-6 animate-fade-in",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Commandes descendantes"}),(0,s.jsxs)("p",{className:"text-gray-600 mt-1",children:[m.length," commande(s) enregistr\xe9es – ",A.pending," en attente"]})]}),(0,s.jsx)("button",{className:"btn-primary",onClick:()=>y(e=>e+1),children:"\uD83D\uDD04 Rafra\xeechir"})]}),N&&(0,s.jsxs)("div",{className:"alert alert-warning",children:[(0,s.jsx)("strong",{children:"Erreur :"})," ",N]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"En attente"}),(0,s.jsx)("p",{className:"text-3xl font-semibold text-yellow-500",children:A.pending})]}),(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Ex\xe9cut\xe9es"}),(0,s.jsx)("p",{className:"text-3xl font-semibold text-green-600",children:A.executed})]}),(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Erreurs"}),(0,s.jsx)("p",{className:"text-3xl font-semibold text-red-500",children:A.errors})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[(0,s.jsxs)("div",{className:"card lg:col-span-2 overflow-x-auto",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Historique des commandes"}),h?(0,s.jsx)("p",{className:"text-gray-500",children:"Chargement..."}):(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"text-left text-gray-500 border-b",children:[(0,s.jsx)("th",{className:"py-2",children:"Commande"}),(0,s.jsx)("th",{className:"py-2",children:"Dispositif"}),(0,s.jsx)("th",{className:"py-2",children:"Priorit\xe9"}),(0,s.jsx)("th",{className:"py-2",children:"Statut"}),(0,s.jsx)("th",{className:"py-2",children:"Cr\xe9\xe9e"})]})}),(0,s.jsxs)("tbody",{children:[m.map(e=>{var a;return(0,s.jsxs)("tr",{className:"border-b last:border-0",children:[(0,s.jsx)("td",{className:"py-2 font-medium",children:e.command}),(0,s.jsxs)("td",{className:"py-2 text-gray-600",children:[(0,s.jsx)("div",{children:e.device_name||"—"}),(0,s.jsx)("div",{className:"text-xs text-gray-500",children:e.sim_iccid})]}),(0,s.jsx)("td",{className:"py-2 capitalize",children:e.priority}),(0,s.jsx)("td",{className:"py-2",children:(0,s.jsx)("span",{className:"px-2 py-1 rounded-full text-xs font-semibold ".concat(o[e.status]||"bg-gray-100 text-gray-700"),children:e.status})}),(0,s.jsx)("td",{className:"py-2 text-gray-500",children:new Date(null!==(a=e.created_at)&&void 0!==a?a:e.execute_after).toLocaleString()})]},e.id)}),0===m.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:5,className:"py-6 text-center text-gray-500",children:"Aucune commande enregistr\xe9e"})})]})]})]}),(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Nouvelle commande"}),(0,s.jsxs)("form",{className:"space-y-4",onSubmit:w,children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Dispositif"}),(0,s.jsx)("select",{className:"input",value:S.iccid,onChange:e=>_(a=>({...a,iccid:e.target.value})),children:g.map(e=>(0,s.jsx)("option",{value:e.sim_iccid,children:e.device_name||e.sim_iccid},e.sim_iccid))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Commande"}),(0,s.jsx)("select",{className:"input",value:S.command,onChange:e=>_(a=>({...a,command:e.target.value})),children:r.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),"SET_SLEEP_SECONDS"===S.command&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Intervalle sommeil (secondes)"}),(0,s.jsx)("input",{type:"number",min:30,max:7200,className:"input",value:S.sleepSeconds,onChange:e=>_(a=>({...a,sleepSeconds:e.target.value}))})]}),"PING"===S.command&&(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Message (optionnel)"}),(0,s.jsx)("input",{type:"text",className:"input",value:S.message,onChange:e=>_(a=>({...a,message:e.target.value}))})]}),"UPDATE_CONFIG"===S.command&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Remplir uniquement les champs \xe0 modifier. Les valeurs num\xe9riques sont optionnelles."}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Identit\xe9 & secrets"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsx)("input",{className:"input",placeholder:"APN",value:S.configApn,onChange:e=>_(a=>({...a,configApn:e.target.value}))}),(0,s.jsx)("input",{className:"input",placeholder:"JWT Bearer...",value:S.configJwt,onChange:e=>_(a=>({...a,configJwt:e.target.value}))}),(0,s.jsx)("input",{className:"input",placeholder:"ICCID",value:S.configIccid,onChange:e=>_(a=>({...a,configIccid:e.target.value}))}),(0,s.jsx)("input",{className:"input",placeholder:"Num\xe9ro de s\xe9rie",value:S.configSerial,onChange:e=>_(a=>({...a,configSerial:e.target.value}))}),(0,s.jsx)("input",{className:"input",placeholder:"PIN SIM",value:S.configSimPin,onChange:e=>_(a=>({...a,configSimPin:e.target.value}))})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Mesures & sommeil"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsx)("input",{type:"number",min:1,className:"input",placeholder:"Sommeil par d\xe9faut (minutes)",value:S.configSleepMinutes,onChange:e=>_(a=>({...a,configSleepMinutes:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1,className:"input",placeholder:"Passes capteur",value:S.configAirflowPasses,onChange:e=>_(a=>({...a,configAirflowPasses:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1,className:"input",placeholder:"\xc9chantillons / passe",value:S.configAirflowSamples,onChange:e=>_(a=>({...a,configAirflowSamples:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1,className:"input",placeholder:"D\xe9lai \xe9chantillons (ms)",value:S.configAirflowDelay,onChange:e=>_(a=>({...a,configAirflowDelay:e.target.value}))})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"Watchdog & modem"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsx)("input",{type:"number",min:5,className:"input",placeholder:"Watchdog (secondes)",value:S.configWatchdogSeconds,onChange:e=>_(a=>({...a,configWatchdogSeconds:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1e3,className:"input",placeholder:"Timeout boot modem (ms)",value:S.configModemBootTimeout,onChange:e=>_(a=>({...a,configModemBootTimeout:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1e3,className:"input",placeholder:"Timeout SIM pr\xeate (ms)",value:S.configSimReadyTimeout,onChange:e=>_(a=>({...a,configSimReadyTimeout:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1e3,className:"input",placeholder:"Timeout attache r\xe9seau (ms)",value:S.configNetworkAttachTimeout,onChange:e=>_(a=>({...a,configNetworkAttachTimeout:e.target.value}))}),(0,s.jsx)("input",{type:"number",min:1,className:"input",placeholder:"Red\xe9marrages modem max",value:S.configModemReboots,onChange:e=>_(a=>({...a,configModemReboots:e.target.value}))})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase tracking-wide text-gray-500 mb-2",children:"OTA par d\xe9faut"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,s.jsx)("input",{className:"input",placeholder:"URL primaire",value:S.configOtaPrimaryUrl,onChange:e=>_(a=>({...a,configOtaPrimaryUrl:e.target.value}))}),(0,s.jsx)("input",{className:"input",placeholder:"URL fallback",value:S.configOtaFallbackUrl,onChange:e=>_(a=>({...a,configOtaFallbackUrl:e.target.value}))}),(0,s.jsx)("input",{className:"input md:col-span-2",placeholder:"MD5 attendu (optionnel)",value:S.configOtaMd5,onChange:e=>_(a=>({...a,configOtaMd5:e.target.value}))})]})]})]}),"UPDATE_CALIBRATION"===S.command&&(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:["a0","a1","a2"].map(e=>(0,s.jsxs)("div",{children:[(0,s.jsxs)("label",{className:"label",children:["Coefficient ",e.toUpperCase()]}),(0,s.jsx)("input",{type:"number",step:"any",className:"input",value:S["cal".concat(e.toUpperCase())],onChange:a=>_(t=>({...t,["cal".concat(e.toUpperCase())]:a.target.value}))})]},e))}),"OTA_REQUEST"===S.command&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"Laisser l’URL vide pour utiliser la valeur primaire/fallback stock\xe9e dans le bo\xeetier."}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Canal"}),(0,s.jsxs)("select",{className:"input",value:S.otaChannel,onChange:e=>_(a=>({...a,otaChannel:e.target.value})),children:[(0,s.jsx)("option",{value:"primary",children:"Primaire"}),(0,s.jsx)("option",{value:"fallback",children:"Fallback"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"URL binaire (optionnel)"}),(0,s.jsx)("input",{type:"text",className:"input",value:S.otaUrl,onChange:e=>_(a=>({...a,otaUrl:e.target.value}))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"MD5 attendu (optionnel)"}),(0,s.jsx)("input",{type:"text",className:"input",value:S.otaMd5,onChange:e=>_(a=>({...a,otaMd5:e.target.value}))})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Priorit\xe9"}),(0,s.jsx)("select",{className:"input",value:S.priority,onChange:e=>_(a=>({...a,priority:e.target.value})),children:c.map(e=>(0,s.jsx)("option",{value:e.value,children:e.label},e.value))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"label",children:"Expiration (minutes)"}),(0,s.jsx)("input",{type:"number",min:5,className:"input",value:S.expiresInMinutes,onChange:e=>_(a=>({...a,expiresInMinutes:e.target.value}))})]}),(0,s.jsx)("button",{type:"submit",className:"btn-primary w-full",disabled:f,children:f?"Envoi...":"Programmer"})]})]})]})]})}},9999:function(e,a,t){"use strict";t.d(a,{H:function(){return r},a:function(){return c}});var s=t(7437),l=t(2265);let i=(0,l.createContext)(),n="https://ott-jbln.onrender.com";function r(e){let{children:a}=e,[t,r]=(0,l.useState)(null),[c,o]=(0,l.useState)(null),[d,m]=(0,l.useState)(!0);(0,l.useEffect)(()=>{let e=localStorage.getItem("ott_token"),a=localStorage.getItem("ott_user");e&&a&&(o(e),r(JSON.parse(a))),m(!1)},[]);let u=async(e,a)=>{let t=await fetch("".concat(n,"/api.php/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:a})}),s=await t.json();if(!s.success)throw Error(s.error||"Erreur de connexion");return o(s.token),r(s.user),localStorage.setItem("ott_token",s.token),localStorage.setItem("ott_user",JSON.stringify(s.user)),s},g=()=>{o(null),r(null),localStorage.removeItem("ott_token"),localStorage.removeItem("ott_user")},p=async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{requiresAuth:s=!1}=t,l={...a},i={...a.headers||{}};if(l.body&&!i["Content-Type"]&&(i["Content-Type"]="application/json"),c)i.Authorization="Bearer ".concat(c);else throw Error("Non authentifi\xe9");l.headers=i;let n=await fetch(e,l);if(401===n.status&&c)throw g(),Error("Session expir\xe9e");return n};return(0,s.jsx)(i.Provider,{value:{user:t,token:c,loading:d,login:u,logout:g,fetchWithAuth:p,API_URL:n},children:a})}let c=()=>{let e=(0,l.useContext)(i);if(!e)throw Error("useAuth doit \xeatre utilis\xe9 dans AuthProvider");return e}},2617:function(e,a,t){"use strict";async function s(e,a,t){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=await e("".concat(a).concat(t),s,l),n=await i.json();if(!n.success)throw Error(n.error||"Erreur API");return n}t.d(a,{r:function(){return s}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=8488)}),_N_E=e.O()}]);