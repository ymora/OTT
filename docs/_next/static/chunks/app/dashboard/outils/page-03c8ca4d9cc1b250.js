(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[637],{5176:function(e,t,a){Promise.resolve().then(a.bind(a,3140))},3140:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return _},dynamic:function(){return j}});var r=a(7437),s=a(2265),i=a(9999),l=a(4767),n=a(5506),c=a(8828),o=a(2617),d=a(832),u=a(9723),m=a(798);function x(e){var t,a;let{onUploadSuccess:l}=e,{fetchWithAuth:x,API_URL:p,token:g}=(0,i.a)(),[h,v]=(0,s.useState)(null),[f,b]=(0,s.useState)(""),[y,j]=(0,s.useState)(""),[_,w]=(0,s.useState)(!1),[N,k]=(0,s.useState)(!1),[D,E]=(0,s.useState)(0),[S,T]=(0,s.useState)(null),[C,A]=(0,s.useState)(null),[I,Z]=(0,s.useState)(null),[O,F]=(0,s.useState)(!1),[U,L]=(0,s.useState)(null),[B,P]=(0,s.useState)(null),[R,q]=(0,s.useState)(null),[M,V]=(0,s.useState)(!1),[z,H]=(0,s.useState)(!1),[J,G]=(0,s.useState)(null),[W,X]=(0,s.useState)(null),[$,K]=(0,s.useState)(!0),Q=(0,s.useRef)(null),Y=(0,s.useRef)(null),[ee,et]=(0,s.useState)(!1),[ea,er]=(0,s.useState)(0),[es,ei]=(0,s.useState)([]),[el,en]=(0,s.useState)(null),[ec,eo]=(0,s.useState)(!1),[ed,eu]=(0,s.useState)(!1),em=(0,s.useRef)(null),ex=(0,s.useRef)(null),{data:ep,loading:eg,refetch:eh,invalidateCache:ev}=(0,n.m_)(["/api.php/firmwares"],{requiresAuth:!0,cacheTTL:0}),ef=(null==ep?void 0:null===(t=ep.firmwares)||void 0===t?void 0:t.firmwares)||[],eb=(0,s.useMemo)(()=>ef.filter(e=>!!("pending_compilation"===e.status||e.file_path&&e.file_path.endsWith(".ino")||e.file_path&&e.file_path.includes(".ino"))).sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),[ef]),ey=(0,s.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=e||h,r=null!==t?t:f;if(!a&&!r){A("Veuillez s\xe9lectionner un fichier .ino ou entrer du contenu");return}c.Z.log("[InoEditorTab] \uD83D\uDCE4 D\xe9marrage upload firmware:",(null==a?void 0:a.name)||"contenu \xe9dit\xe9"),k(!0),T("upload"),A(null),Z(null),E(0);try{let e=new FormData;if(a)c.Z.debug("[InoEditorTab] Ajout fichier au FormData:",a.name,a.size,"bytes"),e.append("firmware_ino",a);else if(r){c.Z.debug("[InoEditorTab] Cr\xe9ation blob depuis contenu, taille:",r.length);let t=new Blob([r],{type:"text/plain"}),a="firmware_"+Date.now()+".ino";e.append("firmware_ino",t,a)}if(e.append("type","ino"),c.Z.debug("[InoEditorTab] FormData cr\xe9\xe9, envoi vers:","".concat(p,"/api.php/firmwares/upload-ino")),!g)throw c.Z.error("[InoEditorTab] Token manquant!"),Error("Token manquant. Veuillez vous reconnecter.");c.Z.debug("[InoEditorTab] Token pr\xe9sent, cr\xe9ation XMLHttpRequest...");let t=new XMLHttpRequest;t.timeout=3e4,t.upload.addEventListener("progress",e=>{if(e.lengthComputable){let t=Math.round(e.loaded/e.total*100);E(t)}}),t.addEventListener("load",()=>{var e,r;if(200===t.status){let r;try{r=JSON.parse(t.responseText)}catch(e){A("R\xe9ponse invalide du serveur"),k(!1);return}r.success?(E(100),Z("Firmware upload\xe9 avec succ\xe8s !"),l&&r.firmware_id&&l(r.firmware_id),ev(),k(!1),v(null),b(""),j(""),w(!1),Q.current&&(Q.current.value=""),setTimeout(()=>{eh().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement:",e)})},300)):(null===(e=r.error)||void 0===e?void 0:e.includes("existe d\xe9j\xe0"))||409===t.status?(L(r.existing_firmware||{version:r.version||"inconnue",id:r.firmware_id}),P(a),F(!0),k(!1),T(null),E(0)):(A(r.error||"Erreur lors de l'upload"),k(!1),T(null))}else{try{let e=JSON.parse(t.responseText);(null===(r=e.error)||void 0===r?void 0:r.includes("existe d\xe9j\xe0"))||409===t.status?(L(e.existing_firmware||{}),P(a),F(!0),k(!1),T(null),E(0)):A(e.error||"Erreur HTTP ".concat(t.status))}catch(e){A("Erreur HTTP ".concat(t.status,": ").concat(t.statusText))}k(!1),T(null)}}),t.addEventListener("error",()=>{A("Erreur r\xe9seau lors de l'upload."),k(!1),T(null)}),t.addEventListener("timeout",()=>{A("La requ\xeate a pris trop de temps (30s)."),k(!1),T(null),t.abort()}),t.open("POST","".concat(p,"/api.php/firmwares/upload-ino")),t.setRequestHeader("Authorization","Bearer ".concat(g)),c.Z.debug("[InoEditorTab] Envoi requ\xeate XHR..."),t.send(e),c.Z.debug("[InoEditorTab] Requ\xeate XHR envoy\xe9e, attente r\xe9ponse...")}catch(e){c.Z.error("❌ Exception lors de l'upload:",e),A(e.message||"Erreur lors de l'upload"),k(!1),T(null)}},[h,f,p,g,eh]),ej=e=>{let t=e.match(/FIRMWARE_VERSION_STR\s+"([^"]+)"/),a=e.match(/FIRMWARE_VERSION\s*=\s*"([^"]+)"/);return t?t[1]:a?a[1]:null},e_=async e=>{try{let t=await x("".concat(p,"/api.php/firmwares/check-version/").concat(encodeURIComponent(e)),{method:"GET"},{requiresAuth:!0});if(404===t.status){let e=await t.json().catch(()=>({}));throw Error(e.error||"Endpoint de v\xe9rification non disponible")}if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur API");return a.exists?a.firmware:null}catch(e){throw c.Z.error("Erreur v\xe9rification version:",e),e}},ew=(0,s.useCallback)(async e=>{var t;c.Z.debug("[InoEditorTab] handleFileSelect appel\xe9",e.target.files);let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a){c.Z.debug("[InoEditorTab] Aucun fichier s\xe9lectionn\xe9");return}if(c.Z.debug("[InoEditorTab] Fichier s\xe9lectionn\xe9:",a.name,a.size,"bytes"),!a.name.endsWith(".ino")){c.Z.error("[InoEditorTab] Fichier non .ino:",a.name),A("Seuls les fichiers .ino sont accept\xe9s"),v(null);return}c.Z.debug("[InoEditorTab] Fichier .ino valide, lecture du contenu..."),v(a),A(null),Z(null);try{let e=new FileReader;e.onload=async e=>{var t,r,s;c.Z.debug("[InoEditorTab] Fichier lu avec succ\xe8s, taille:",null===(t=e.target.result)||void 0===t?void 0:t.length);let i=e.target.result;b(i),j(i),w(!1),c.Z.debug("[InoEditorTab] Extraction de la version depuis le contenu...");let l=ej(i);if(c.Z.debug("[InoEditorTab] Version extraite:",l),!l){c.Z.error("[InoEditorTab] Version non trouv\xe9e dans le fichier"),A("Version non trouv\xe9e dans le fichier .ino. Assurez-vous que FIRMWARE_VERSION_STR est d\xe9fini."),v(null),b(""),j("");return}c.Z.debug("[InoEditorTab] V\xe9rification si la version existe d\xe9j\xe0:",l);let n=null,o=!1;try{if(n=await e_(l),c.Z.debug("[InoEditorTab] R\xe9sultat v\xe9rification version:",n?"existe d\xe9j\xe0":"n'existe pas"),n){c.Z.debug("[InoEditorTab] Version existe d\xe9j\xe0, affichage du modal"),o=!0,L(n),P(a),F(!0),Q.current&&(Q.current.value="");return}}catch(t){c.Z.error("[InoEditorTab] Erreur lors de la v\xe9rification version:",t),c.Z.warn("Erreur lors de la v\xe9rification version via API:",t);let e=ef.find(e=>e.version===l);if(e){o=!0,L(e),P(a),F(!0),Q.current&&(Q.current.value="");return}(null===(r=t.message)||void 0===r?void 0:r.includes("404"))||(null===(s=t.message)||void 0===s?void 0:s.includes("Endpoint not found"))?(c.Z.warn("Endpoint de v\xe9rification non disponible, continuation de l'upload"),A("⚠️ L'endpoint de v\xe9rification n'est pas disponible. L'upload continue sans v\xe9rification.")):A("⚠️ Erreur lors de la v\xe9rification: ".concat(t.message,". L'upload continue."))}o||n?c.Z.debug("[InoEditorTab] Upload non lanc\xe9 (versionExists:",o,", existingFirmware:",!!n,")"):(c.Z.debug("[InoEditorTab] Version n'existe pas, lancement automatique de l'upload..."),setTimeout(()=>{c.Z.debug("[InoEditorTab] Appel handleUpload avec file et content"),ey(a,i)},100))},e.onerror=e=>{c.Z.error("[InoEditorTab] Erreur FileReader:",e),A("Erreur lors de la lecture du fichier"),v(null)},c.Z.debug("[InoEditorTab] D\xe9marrage lecture fichier avec FileReader..."),e.readAsText(a)}catch(e){c.Z.error("Erreur lors de la lecture du fichier:",e),A("Erreur lors de la lecture du fichier"),v(null)}},[x,p,ef,e_,ey]),eN=(0,s.useCallback)(e=>{let t=e.target.value;b(t),w(t!==y)},[y]),ek=(0,s.useCallback)(async()=>{if(!f.trim()){A("Le contenu est vide");return}if(!ej(f)){A("Version non trouv\xe9e dans le fichier .ino. Assurez-vous que FIRMWARE_VERSION_STR est d\xe9fini.");return}if(R){let e=f!==y;k(!0),T("upload"),A(null),Z(null),E(0);try{let t=await x("".concat(p,"/api.php/firmwares/").concat(R,"/ino"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:f})},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur lors de la mise \xe0 jour");E(100),Z(e?"Fichier .ino mis \xe0 jour avec succ\xe8s !":"Fichier .ino upload\xe9 avec succ\xe8s !"),ev(),k(!1),j(f),w(!1),q(null),setTimeout(()=>{eh().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement:",e)})},300)}catch(e){c.Z.error("❌ Erreur lors de la mise \xe0 jour:",e),A(e.message||"Erreur lors de la mise \xe0 jour"),k(!1),T(null)}}else ey(null,f)},[f,R,ey,p,x,eh]),eD=(0,s.useCallback)(()=>{b(y),w(!1),A(null)},[y]),eE=(0,s.useCallback)(async e=>{V(!0),A(null),Z(null),q(e);try{let t=await x("".concat(p,"/api.php/firmwares/").concat(e,"/ino"),{method:"GET"},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur lors du chargement");b(a.content),j(a.content),w(!1),K(!1),setTimeout(()=>{Y.current&&(Y.current.scrollIntoView({behavior:"smooth",block:"start"}),Y.current.focus())},100)}catch(e){c.Z.error("Erreur lors du chargement du fichier .ino:",e),A(e.message||"Erreur lors du chargement du fichier .ino"),q(null)}finally{V(!1)}},[p,x]),eS=(0,s.useCallback)(async()=>{if(J){X(J.id);try{let e=await x("".concat(p,"/api.php/firmwares/").concat(J.id),{method:"DELETE"},{requiresAuth:!0});if(404===e.status){let t=await e.json().catch(()=>({}));throw Error("Erreur syst\xe8me: ".concat(t.error||"Endpoint non disponible"))}if(!e.ok){let t=await e.json().catch(()=>({}));throw Error(t.error||"Erreur HTTP ".concat(e.status))}let t=await e.json();if(!t.success)throw Error(t.error||"Erreur lors de la suppression");H(!1),G(null),R===J.id&&(b(""),j(""),w(!1),q(null)),ev(),setTimeout(()=>{eh().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement apr\xe8s suppression:",e)})},300)}catch(a){var e,t;A((null===(e=a.message)||void 0===e?void 0:e.includes("404"))||(null===(t=a.message)||void 0===t?void 0:t.includes("Endpoint not found"))?"⚠️ L'endpoint de suppression n'est pas disponible sur le serveur.":"Erreur lors de la suppression : ".concat(a.message)),H(!1),G(null)}finally{X(null)}}},[J,R,p,x,eh]);(0,s.useEffect)(()=>{if(I){let e=setTimeout(()=>{Z(null)},4e3);return()=>clearTimeout(e)}},[I]),(0,s.useEffect)(()=>{if(C){let e=setTimeout(()=>{A(null)},4e3);return()=>clearTimeout(e)}},[C]);let eT=(0,s.useCallback)(()=>{em.current&&(em.current.close(),em.current=null)},[]),eC=(0,s.useCallback)(()=>{et(!1),en(null),er(0),eT()},[eT]),eA=(0,s.useCallback)(async e=>{if(!e){A("ID du firmware manquant pour la compilation.");return}if(ee&&el===e){A("Compilation d\xe9j\xe0 en cours pour ce firmware.");return}eT(),et(!0),en(e),er(0),A(null),Z(null),eo(!1),ei([{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⏳ D\xe9marrage de la compilation...",level:"info"}]),eh();try{let t=encodeURIComponent(g),a="".concat(p,"/api.php/firmwares/compile/").concat(e,"?token=").concat(t),r=new EventSource(a);em.current=r,r.onopen=()=>{ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Connexion SSE \xe9tablie, d\xe9marrage de la compilation...",level:"info"}])},r.onmessage=e=>{if(!(!e.data||""===e.data.trim()||e.data.trim().startsWith(":")))try{let t=JSON.parse(e.data);"log"===t.type?ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:t.message,level:t.level||"info"}]):"progress"===t.type?er(t.progress||0):"success"===t.type?(Z("✅ Compilation r\xe9ussie ! Firmware v".concat(t.version," disponible")),ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Compilation termin\xe9e avec succ\xe8s !",level:"info"}]),eC(),r.close(),eh()):"error"===t.type&&(A(t.message||"Erreur lors de la compilation"),ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"❌ Erreur de compilation: ".concat(t.message||"Inconnue"),level:"error"}]),eC(),r.close(),eh())}catch(e){ei(t=>[...t,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"❌ Erreur de traitement du message SSE: ".concat(e.message),level:"error"}])}},r.onerror=t=>{let a=t.message||"Connexion interrompue";ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⚠️ Connexion SSE interrompue: ".concat(a),level:"warning"}]),ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"ℹ️ La compilation continue en arri\xe8re-plan. V\xe9rification du statut...",level:"info"}]),setTimeout(()=>{r.readyState===EventSource.CLOSED&&setTimeout(async()=>{try{let t=await x("/api.php/firmwares"),a=await t.json();if(a.success&&a.firmwares){let t=a.firmwares.find(t=>t.id===e);t&&("compiled"===t.status?(Z("✅ Compilation r\xe9ussie ! Firmware v".concat(t.version," disponible")),ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Compilation termin\xe9e avec succ\xe8s (v\xe9rifi\xe9e apr\xe8s reconnexion)",level:"info"}]),eC(),eh()):"compiling"===t.status?ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⏳ La compilation est toujours en cours. R\xe9essayez dans quelques instants.",level:"info"}]):"error"===t.status&&(A("Erreur de compilation: ".concat(t.error_message||"Erreur inconnue")),eC(),eh()))}}catch(e){ei(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⚠️ Impossible de v\xe9rifier le statut. La compilation peut continuer en arri\xe8re-plan.",level:"warning"}])}},5e3)},3e3)}}catch(e){A(e.message||"Erreur lors du d\xe9marrage de la compilation."),eC()}},[p,g,ee,el,eT,eC,eh]);(0,s.useEffect)(()=>()=>{em.current&&eT()},[eT]),(0,s.useEffect)(()=>{ex.current&&ee&&es.length>0&&(ex.current.scrollTop=ex.current.scrollHeight)},[es.length,ee]);let eI=(0,s.useCallback)(()=>{if(0===es.length)return;let e=es.map(e=>"[".concat(e.timestamp,"] ").concat(e.message)).join("\n");navigator.clipboard.writeText(e).then(()=>{eu(!0),setTimeout(()=>eu(!1),2e3)}).catch(e=>{A("Erreur lors de la copie des logs")})},[es]);return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCE6 Fichiers INO existants"}),eg?(0,r.jsx)(d.Z,{}):0===eb.length?(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Aucun fichier .ino disponible"}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[(0,r.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-800",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Version"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Taille"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Statut"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Date"}),(0,r.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Actions"})]})}),(0,r.jsx)("tbody",{children:eb.map(e=>(0,r.jsxs)("tr",{className:"table-row",children:[(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("span",{className:"font-mono font-semibold text-primary",children:["v",e.version]})})}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm text-gray-600 dark:text-gray-400",children:e.file_size?"".concat((e.file_size/1024).toFixed(2)," KB"):"-"}),(0,r.jsx)("td",{className:"py-3 px-4",children:e.status&&(0,r.jsx)("span",{className:"badge ".concat("pending_compilation"===e.status?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":"compiling"===e.status?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":"compiled"===e.status?"badge-success":"error"===e.status?"badge-danger":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300"," text-xs"),children:"pending_compilation"===e.status?"✅ Upload\xe9":"compiling"===e.status?"Compilation":"compiled"===e.status?"Compil\xe9":"error"===e.status?"Erreur":e.status})}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm text-gray-600 dark:text-gray-400",children:new Date(e.created_at).toLocaleDateString("fr-FR")}),(0,r.jsx)("td",{className:"py-3 px-4 text-center",children:(0,r.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>eA(e.id),disabled:ee&&el===e.id,className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:ee&&el===e.id?"Compilation en cours...":"Compiler le firmware",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDD28"})}),(0,r.jsx)("button",{onClick:()=>{R===e.id&&""!==f.trim()?(b(""),j(""),w(!1),q(null),A(null),Z(null),K(!0)):eE(e.id)},disabled:M,className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors disabled:opacity-50",title:R===e.id&&""!==f.trim()?"Fermer l'\xe9diteur":"\xc9diter le fichier .ino",children:(0,r.jsx)("span",{className:"text-lg",children:"✏️"})}),(0,r.jsx)("button",{onClick:()=>{G(e),H(!0)},disabled:W===e.id,className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors disabled:opacity-50",title:"Supprimer le fichier .ino",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDDD1️"})})]})})]},e.id))})]})})]}),(ee||es.length>0)&&(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"\uD83D\uDD28 Compilation en cours"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[ea>0&&(0,r.jsxs)("span",{className:"text-sm font-semibold text-primary-600 dark:text-primary-400",children:[ea,"%"]}),es.length>0&&(0,r.jsx)("button",{onClick:eI,className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",title:"Copier les logs",children:ed?"✅ Copi\xe9!":"\uD83D\uDCCB Copier"}),(0,r.jsx)("button",{onClick:()=>eo(!ec),className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200",title:ec?"Afficher les logs":"Masquer les logs",children:ec?"⬆️":"⬇️"})]})]}),!ec&&(0,r.jsxs)(r.Fragment,{children:[ea>0&&(0,r.jsx)("div",{className:"space-y-2 mb-4",children:(0,r.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,r.jsx)("div",{className:"h-3 rounded-full transition-all duration-300 ".concat(ee?"bg-blue-500":100===ea?"bg-green-500":"bg-gray-300 dark:bg-gray-600"),style:{width:"".concat(Math.max(0,Math.min(100,ea)),"%")}})})}),(0,r.jsx)("div",{ref:ex,className:"bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-96 overflow-y-auto",children:0===es.length?(0,r.jsx)("div",{className:"text-gray-500",children:"En attente des logs..."}):es.map((e,t)=>(0,r.jsxs)("div",{className:"mb-1",children:[(0,r.jsx)("span",{className:"text-gray-500 pr-3",children:e.timestamp}),(0,r.jsx)("span",{className:"error"===e.level?"text-red-400":"warning"===e.level?"text-yellow-400":"text-green-300",children:e.message})]},t))})]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("input",{ref:Q,type:"file",accept:".ino",onChange:ew,disabled:N,className:"hidden",id:"file-upload-input"}),(0,r.jsx)("label",{htmlFor:"file-upload-input",className:"\n            block w-full py-4 px-6 text-center text-lg font-semibold rounded-lg\n            bg-purple-600 hover:bg-purple-700 text-white\n            transition-all duration-200 cursor-pointer\n            disabled:opacity-50 disabled:cursor-not-allowed\n            ".concat(N?"opacity-50 cursor-not-allowed":"hover:shadow-lg","\n          "),children:N?"⏳ Upload en cours...":"➕ Ajouter"})]}),R&&(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"\uD83D\uDCDD \xc9diteur INO"}),(0,r.jsx)("button",{onClick:()=>K(!$),className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200",title:$?"Afficher l'\xe9diteur":"Masquer l'\xe9diteur",children:$?"⬆️":"⬇️"})]}),!$&&(0,r.jsx)("div",{className:"space-y-4",children:f?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:R?"Fichier .ino - Version v".concat((null===(a=eb.find(e=>e.id===R))||void 0===a?void 0:a.version)||""):"Contenu du fichier .ino"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[_&&(0,r.jsx)("button",{onClick:eD,className:"btn-secondary text-sm",disabled:N,children:"↺ R\xe9initialiser"}),(!R||_)&&(0,r.jsx)("button",{onClick:ek,disabled:N,className:"btn-primary text-sm ".concat(N?"opacity-50 cursor-not-allowed":""),children:_?"\uD83D\uDCBE Enregistrer et Uploader":"\uD83D\uDCE4 Uploader"})]})]}),(0,r.jsx)("textarea",{ref:Y,value:f,onChange:eN,disabled:N,className:"w-full h-96 font-mono text-sm p-4 border border-gray-300 dark:border-gray-600    rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100   disabled:opacity-50 disabled:cursor-not-allowed resize-y",placeholder:"Le contenu du fichier .ino appara\xeetra ici..."}),_&&(0,r.jsx)("p",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:"⚠️ Le fichier a \xe9t\xe9 modifi\xe9. N'oubliez pas d'enregistrer !"})]}):(0,r.jsxs)("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[(0,r.jsx)("p",{className:"mb-2",children:"Aucun fichier charg\xe9"}),(0,r.jsx)("p",{className:"text-sm",children:"S\xe9lectionnez un fichier .ino ci-dessus ou cliquez sur un fichier existant pour l'\xe9diter"})]})})]}),C&&(0,r.jsx)(u.Z,{error:C,onClose:()=>A(null),autoClose:4e3}),(0,r.jsx)(m.Z,{isOpen:z,onClose:()=>{H(!1),G(null)},title:"Confirmer la suppression",maxWidth:"max-w-md",children:J&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["\xcates-vous s\xfbr de vouloir supprimer le fichier .ino ",(0,r.jsxs)("strong",{children:["v",J.version]})," ?"]}),(0,r.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Cette action est irr\xe9versible."}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>{H(!1),G(null)},className:"btn-secondary",children:"Annuler"}),(0,r.jsx)("button",{onClick:eS,disabled:W===(null==J?void 0:J.id),className:"btn-danger",children:W===(null==J?void 0:J.id)?"⏳ Suppression...":"\uD83D\uDDD1️ Supprimer"})]})]})}),O&&(0,r.jsx)(m.Z,{isOpen:O,onClose:()=>{F(!1),L(null),P(null)},title:"Version de firmware d\xe9j\xe0 existante",maxWidth:"max-w-lg",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["La version ",(0,r.jsxs)("strong",{children:["v",null==U?void 0:U.version]})," existe d\xe9j\xe0."]}),U&&(0,r.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:(0,r.jsx)("strong",{children:"Firmware existant :"})}),(0,r.jsxs)("ul",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[(0,r.jsxs)("li",{children:["Version : ",(0,r.jsxs)("strong",{children:["v",U.version]})]}),(0,r.jsxs)("li",{children:["Date : ",U.created_at?new Date(U.created_at).toLocaleString("fr-FR"):"Inconnue"]})]})]}),(0,r.jsx)("p",{className:"text-gray-700 dark:text-gray-300",children:"Voulez-vous supprimer le firmware existant et le remplacer par le nouveau ?"}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>{F(!1),L(null),P(null)},className:"btn-secondary",children:"Annuler"}),(0,r.jsx)("button",{onClick:async()=>{if(U)try{await (0,o.r)(x,p,"/api.php/firmwares/".concat(U.id),{method:"DELETE"},{requiresAuth:!0}),F(!1),L(null),P(null),B?setTimeout(()=>{ey(B)},500):f&&setTimeout(()=>{ey(null,f)},500)}catch(e){A("Erreur lors de la suppression : "+e.message)}},className:"btn-danger",children:"Supprimer et remplacer"})]})]})})]})}var p=a(542),g=a(4807),h=a(8139);function v(e){let{isOpen:t,onClose:a,device:n,preselectedFirmwareVersion:d=null,flashMode:u="usb"}=e,{fetchWithAuth:m,API_URL:x}=(0,i.a)(),[p,v]=(0,s.useState)([]),[f,b]=(0,s.useState)(null),[y,j]=(0,s.useState)(!0),[_,w]=(0,s.useState)(null),[N,k]=(0,s.useState)(!1),[D,E]=(0,s.useState)(0),[S,T]=(0,s.useState)([]),[C,A]=(0,s.useState)(!1),[I,Z]=(0,s.useState)(null),[O,F]=(0,s.useState)(u),[U,L]=(0,s.useState)(null),[B,P]=(0,s.useState)({lastCheck:null,attempts:0}),R=(0,s.useRef)(null),q=(0,s.useRef)(null),{isConnected:M,isSupported:V,usbStreamStatus:z,pauseUsbStreaming:H}=(0,l.l)(),{port:J,isConnected:G,isSupported:W,error:X,requestPort:$,connect:K,disconnect:Q,startReading:Y,write:ee}=(0,g.s)();(0,s.useEffect)(()=>{let e="running"===z||"waiting"===z||"connecting"===z;t&&M&&e&&H&&(c.Z.log("⏸️ Mise en pause du streaming USB pour lib\xe9rer le port pour le flash"),H())},[t,M,z,H]);let et=(0,s.useCallback)(async()=>{try{let e=await (0,o.r)(m,x,"/api.php/firmwares",{},{requiresAuth:!0});v(e.firmwares||[])}catch(e){w(e.message)}finally{j(!1)}},[x,m]);(0,s.useEffect)(()=>{t&&(et(),F(u),E(0),A(!1),Z(null),L(null),P({lastCheck:null,attempts:0}),T([]),w(null))},[t,et,u]),(0,s.useEffect)(()=>{if(d&&p.length>0){let e=p.find(e=>e.version===d);e&&b(e)}},[d,p]);let ea=(0,s.useCallback)(async()=>{try{await (0,o.r)(m,x,"/api.php/devices",{method:"GET"},{requiresAuth:!0}),c.Z.log("✅ Dispositifs rafra\xeechis apr\xe8s mise \xe0 jour firmware")}catch(e){c.Z.warn("⚠️ Erreur rafra\xeechissement dispositifs:",e)}},[m,x]),er=(0,s.useCallback)(async()=>{try{("running"===z||"waiting"===z||"connecting"===z)&&H&&(c.Z.log("⏸️ Mise en pause du streaming USB avant connexion pour flash"),H(),await new Promise(e=>setTimeout(e,500)));let e=await $();if(e){if(await K(e,115200)){let e=await Y(e=>{T(t=>[...t,{raw:e,timestamp:new Date}])});e&&(R.current=e)}else X&&w(X)}}catch(e){c.Z.error("Erreur connexion port pour flash:",e),w("Erreur de connexion: ".concat(e.message))}},[$,K,Y,H,X,z]),es=(0,s.useCallback)(async()=>{R.current&&(R.current(),R.current=null),await Q(),T([])},[Q]),ei=(0,s.useCallback)(async e=>{let t=localStorage.getItem("token");if(!t)throw Error("Token manquant");let a=await fetch("".concat(x,"/api.php/firmwares/").concat(e.id,"/download"),{headers:{Authorization:"Bearer ".concat(t)}});if(!a.ok)throw Error("Erreur t\xe9l\xe9chargement");return await a.blob()},[x]),el=(0,s.useCallback)(async()=>{if(null==n?void 0:n.id)try{let e=((await (0,o.r)(m,x,"/api.php/devices/".concat(n.id,"/commands"),{method:"GET"},{requiresAuth:!0})).commands||[]).filter(e=>"OTA_REQUEST"===e.command).sort((e,t)=>new Date(t.created_at)-new Date(e.created_at))[0];if(e){if(L({status:e.status,command:e,message:en(e.status)}),P(e=>({lastCheck:new Date,attempts:e.attempts+1})),"executed"===e.status){if(A(!0),E(100),T(e=>[...e,{raw:"[OTA] ✅ Flash OTA termin\xe9 avec succ\xe8s !",timestamp:new Date}]),f)try{await (0,o.r)(m,x,"/api.php/devices/".concat(n.id),{method:"PUT",body:JSON.stringify({firmware_version:f.version})},{requiresAuth:!0}),await ea()}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour version firmware:",e)}q.current&&(clearInterval(q.current),q.current=null)}else"error"===e.status&&(A(!0),w("Erreur lors du flash OTA"),T(e=>[...e,{raw:"[OTA] ❌ Erreur lors du flash OTA",timestamp:new Date}]),q.current&&(clearInterval(q.current),q.current=null))}}catch(e){c.Z.warn("⚠️ Erreur v\xe9rification statut OTA:",e)}},[n,m,x,f,ea]),en=e=>{switch(e){case"pending":return"En attente d'ex\xe9cution";case"executing":return"Flash en cours...";case"executed":return"Flash termin\xe9 avec succ\xe8s";case"error":return"Erreur lors du flash";case"expired":return"Commande expir\xe9e";case"cancelled":return"Commande annul\xe9e";default:return"Statut inconnu"}},ec=(0,s.useCallback)(async()=>{if(!f||!G||!J){w("S\xe9lectionnez un firmware et connectez un port");return}k(!0),w(null),E(0),A(!1);try{E(5),ed("[USB] T\xe9l\xe9chargement du firmware...");let e=await ei(f);E(10);let t=await e.arrayBuffer();E(20),ed("[USB] Connexion au dispositif...");let a=new h.pq(J,{clean:()=>{},writeLine:e=>ed("[ESPTOOL] ".concat(e)),write:e=>ed("[ESPTOOL] ".concat(e))},115200);E(25),await a.connect(),E(30),ed("[USB] Connexion \xe9tablie, d\xe9but du flash...");let r=new Uint8Array(t);if(E(40),"function"==typeof a.flashData)await a.flashData(r,4096);else if("function"==typeof a.flash_file)await a.flash_file(r,4096);else if("function"==typeof a.write)await a.write(4096,r);else throw Error("M\xe9thode de flash non trouv\xe9e");if(E(90),"function"==typeof a.verify&&(ed("[USB] V\xe9rification du flash..."),await a.verify(4096,r)),E(100),A(!0),ed("[USB] ✅ Flash r\xe9ussi !"),f)try{ed("[UPDATE] Recherche du dispositif dans la base...");let e=null;if(null==n?void 0:n.id)e=n.id;else{let t=(await (0,o.r)(m,x,"/api.php/devices",{method:"GET"},{requiresAuth:!0})).devices||[];if(null==n?void 0:n.sim_iccid){let a=t.find(e=>e.sim_iccid===n.sim_iccid);a&&(e=a.id)}if(!e&&(null==n?void 0:n.device_serial)){let a=t.find(e=>e.device_serial===n.device_serial);a&&(e=a.id)}if(!e&&(null==n?void 0:n.device_name)){let a=n.device_name.match(/USB-([a-f0-9:]+)/i);if(a){let r=a[1].toLowerCase(),s=t.find(e=>{if(e.device_name){let t=e.device_name.match(/USB-([a-f0-9:]+)/i);if(t&&t[1].toLowerCase()===r||e.device_name.toLowerCase().includes(r))return!0}return!!(e.device_serial&&e.device_serial.toLowerCase().includes(r)||e.sim_iccid&&e.sim_iccid.includes(r.replace(":","")))});s&&(e=s.id)}else{let a=t.find(e=>!!(e.device_name&&(e.device_name.includes(n.device_name)||n.device_name.includes(e.device_name))));a&&(e=a.id)}}if(!e&&(null==n?void 0:n.sim_iccid)){let a=n.sim_iccid.match(/TEMP-([0-9a-f]+)/i);if(a){let r=a[1],s=t.find(e=>!!(e.sim_iccid&&e.sim_iccid.includes(r)||e.device_serial&&e.device_serial.includes(r)||e.device_name&&e.device_name.includes(r)));s&&(e=s.id)}}}e?(ed("[UPDATE] Dispositif trouv\xe9 (ID: ".concat(e,"), mise \xe0 jour version firmware...")),await (0,o.r)(m,x,"/api.php/devices/".concat(e),{method:"PUT",body:JSON.stringify({firmware_version:f.version})},{requiresAuth:!0}),ed("[UPDATE] ✅ Version firmware mise \xe0 jour: v".concat(f.version)),await ea()):(ed("[UPDATE] ⚠️ Dispositif non trouv\xe9 en base - la version sera mise \xe0 jour lors de la prochaine connexion USB"),c.Z.warn("Dispositif non trouv\xe9 pour mise \xe0 jour firmware:",n))}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour version firmware:",e),ed("[UPDATE] ⚠️ Erreur mise \xe0 jour: ".concat(e.message))}ed("[TEST] Attente red\xe9marrage (3 secondes)..."),await new Promise(e=>setTimeout(e,3e3));try{ed("[TEST] Envoi commande AT pour v\xe9rifier..."),await ee("AT\r\n");let e=!1,t=setInterval(()=>{S.slice(-10).some(e=>e.raw&&(e.raw.includes("OK")||e.raw.includes("device_info")||e.raw.includes("AT")||e.raw.includes("ready")))&&!e&&(e=!0,Z(!0),ed("[TEST] ✅ Dispositif r\xe9pond !"))},500);setTimeout(()=>{clearInterval(t),e||(Z(!1),ed("[TEST] ⚠️ Pas de r\xe9ponse d\xe9tect\xe9e"))},5e3)}catch(e){ed("[TEST] ⚠️ Erreur test: ".concat(e.message))}}catch(e){w(e.message),ed("[USB] ❌ Erreur: ".concat(e.message))}finally{k(!1)}},[f,G,J,ei,n,m,x,ee,ea,S]),eo=(0,s.useCallback)(async()=>{if(!f||!(null==n?void 0:n.id)){w("S\xe9lectionnez un firmware et un dispositif");return}k(!0),w(null),E(0),A(!1),L(null),P({lastCheck:null,attempts:0});try{ed("[OTA] D\xe9clenchement du flash OTA..."),E(10),await (0,o.r)(m,x,"/api.php/devices/".concat(n.id,"/ota"),{method:"POST",body:JSON.stringify({firmware_version:f.version})},{requiresAuth:!0}),E(30),ed("[OTA] ✅ Commande OTA programm\xe9e pour v".concat(f.version)),ed("[OTA] Attente de l'ex\xe9cution par le dispositif..."),L({status:"pending",message:"En attente d'ex\xe9cution"}),q.current=setInterval(()=>{el()},2e3),setTimeout(()=>{q.current&&(clearInterval(q.current),q.current=null),C||(w("Timeout: Le flash OTA n'a pas \xe9t\xe9 ex\xe9cut\xe9 dans les 5 minutes"),ed("[OTA] ⚠️ Timeout: Flash OTA non ex\xe9cut\xe9"))},3e5)}catch(e){w(e.message),ed("[OTA] ❌ Erreur: ".concat(e.message)),k(!1)}},[f,n,m,x,el,C]),ed=(0,s.useCallback)(e=>{T(t=>[...t,{raw:e,timestamp:new Date}])},[]);if((0,s.useEffect)(()=>()=>{q.current&&clearInterval(q.current)},[]),!t)return null;let eu="usb"===O&&G&&f,em="ota"===O&&(null==n?void 0:n.id)&&f;return(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,r.jsxs)("div",{className:"flex-shrink-0 p-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-bold",children:"usb"===O?"\uD83D\uDD0C Flash USB":"\uD83D\uDCE1 Flash OTA"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:n?"".concat(n.device_name||n.sim_iccid):"Flasher un dispositif"})]}),(0,r.jsx)("button",{onClick:a,className:"flex items-center justify-center w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors",title:"Fermer","aria-label":"Fermer",children:(0,r.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>F("usb"),className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat("usb"===O?"bg-primary-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"),children:"\uD83D\uDD0C USB"}),(0,r.jsx)("button",{onClick:()=>F("ota"),className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat("ota"===O?"bg-primary-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"),children:"\uD83D\uDCE1 OTA"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:["usb"===O&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCE1 Port s\xe9rie"}),G?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded p-2 text-sm",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"● Connect\xe9"})}),(0,r.jsx)("button",{onClick:es,disabled:N,className:"btn-secondary w-full text-xs",children:"D\xe9connecter"})]}):(0,r.jsx)("button",{onClick:er,disabled:!W||N,className:"btn-primary w-full text-sm",children:"\uD83D\uDD0C S\xe9lectionner"})]}),(0,r.jsxs)("div",{className:"usb"===O?"":"col-span-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCE6 Firmware"}),y?(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Chargement..."}):(0,r.jsxs)("select",{value:(null==f?void 0:f.id)||"",onChange:e=>{b(p.find(t=>t.id===parseInt(e.target.value))||null)},disabled:N,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 text-sm",children:[(0,r.jsx)("option",{value:"",children:"S\xe9lectionner..."}),p.filter(e=>"compiled"===e.status).map(e=>(0,r.jsxs)("option",{value:e.id,children:["v",e.version," ",e.is_stable?"✅":"⚠️"]},e.id))]})]})]}),(eu||em)&&(0,r.jsxs)("div",{children:[(0,r.jsx)("button",{onClick:"usb"===O?ec:eo,disabled:N,className:"btn-primary w-full",children:N?"⏳ Flash en cours... ".concat(D,"%"):"\uD83D\uDE80 Flasher v".concat(f.version," (").concat(O.toUpperCase(),")")}),N&&(0,r.jsx)("div",{className:"mt-3 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,r.jsx)("div",{className:"bg-primary-500 h-3 rounded-full transition-all duration-300",style:{width:"".concat(D,"%")}})}),"ota"===O&&U&&(0,r.jsx)("div",{className:"mt-3 p-3 rounded-lg border-2 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"font-semibold text-blue-800 dark:text-blue-300",children:["Statut: ",U.message]}),U.command&&(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:["Commande cr\xe9\xe9e: ",new Date(U.command.created_at).toLocaleString("fr-FR")]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["V\xe9rifications: ",B.attempts]}),B.lastCheck&&(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["Derni\xe8re: ",B.lastCheck.toLocaleTimeString("fr-FR")]})]})]})}),C&&(0,r.jsxs)("div",{className:"mt-3 p-3 rounded-lg border-2",children:[!0===I&&(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"✅ Dispositif vivant et r\xe9pond"})}),!1===I&&(0,r.jsx)("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800",children:(0,r.jsx)("p",{className:"text-yellow-800 dark:text-yellow-300 font-semibold",children:"⚠️ Pas de r\xe9ponse d\xe9tect\xe9e"})}),"ota"===O&&(null==U?void 0:U.status)==="executed"&&(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"✅ Flash OTA termin\xe9 avec succ\xe8s"})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCDF Console"}),(0,r.jsx)("div",{className:"bg-black text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto",children:0===S.length?(0,r.jsx)("p",{className:"text-gray-500",children:"En attente de logs..."}):S.map((e,t)=>(0,r.jsxs)("div",{className:"mb-1",children:[(0,r.jsx)("span",{className:"text-gray-500",children:e.timestamp.toLocaleTimeString("fr-FR")})," ",(0,r.jsx)("span",{children:e.raw})]},t))})]}),(_||X)&&(0,r.jsx)("div",{className:"alert alert-warning text-sm",children:_||X})]})]})})}function f(e){let{title:t,children:a,defaultOpen:i=!1}=e,[l,n]=(0,s.useState)(i);return(0,r.jsxs)("div",{className:"border border-gray-200 dark:border-slate-700 rounded-lg",children:[(0,r.jsxs)("button",{type:"button",onClick:()=>n(!l),className:"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors",children:[(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300",children:t}),(0,r.jsx)("span",{className:"text-gray-500 dark:text-gray-400",children:l?"▼":"▶"})]}),l&&(0,r.jsx)("div",{className:"px-4 pb-4 pt-2",children:a})]})}function b(e){let{isOpen:t,onClose:a,editingItem:i,onSave:l,fetchWithAuth:n,API_URL:d,patients:m=[],allDevices:x=[]}=e,[p,g]=(0,s.useState)({device_name:"",sim_iccid:"",device_serial:"",firmware_version:"",status:"inactive",patient_id:null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0]}),[h,v]=(0,s.useState)({}),[b,y]=(0,s.useState)(null),[j,_]=(0,s.useState)(!1),[w,N]=(0,s.useState)(!1),k=(0,s.useRef)(!1);(0,s.useEffect)(()=>{t&&!k.current?(k.current=!0,i&&i.id&&!i.isVirtual?(g({device_name:i.device_name||"",sim_iccid:i.sim_iccid||"",device_serial:i.device_serial||"",firmware_version:i.firmware_version||"",status:i.status||"inactive",patient_id:i.patient_id||null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0]}),D(i.id)):g({device_name:"",sim_iccid:"",device_serial:"",firmware_version:"",status:"inactive",patient_id:null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0]}),v({}),y(null)):!t&&k.current&&(k.current=!1)},[t]);let D=async e=>{if(e)try{N(!0);let t=await (0,o.r)(n,d,"/api.php/devices/".concat(e,"/config"),{},{requiresAuth:!0});t.config&&g(e=>({...e,sleep_minutes:t.config.sleep_minutes||null,measurement_duration_ms:t.config.measurement_duration_ms||null,send_every_n_wakeups:t.config.send_every_n_wakeups||1,calibration_coefficients:t.config.calibration_coefficients||[0,1,0]}))}catch(e){c.Z.warn("Erreur chargement configuration:",e)}finally{N(!1)}},E=e=>{let{name:t,value:a,type:r,checked:s}=e.target;g({...p,[t]:"checkbox"===r?s:"number"===r?""===a?null:parseFloat(a):a}),h[t]&&v(e=>{let a={...e};return delete a[t],a})},S=(e,t)=>{let a=[...p.calibration_coefficients];a[e]=""===t?0:parseFloat(t),g(e=>({...e,calibration_coefficients:a}))},T=()=>{let e={};return p.device_name&&0!==p.device_name.trim().length||(e.device_name="Le nom du dispositif est requis"),p.sim_iccid&&p.sim_iccid.trim().length>0&&(p.sim_iccid.trim().length<4||p.sim_iccid.trim().length>20?e.sim_iccid="Le SIM ICCID doit contenir entre 4 et 20 caract\xe8res":/^\d+$/.test(p.sim_iccid.trim())||(e.sim_iccid="Le SIM ICCID doit contenir uniquement des chiffres")),p.device_serial&&p.device_serial.trim().length>0&&(p.device_serial.trim().length<4||p.device_serial.trim().length>50)&&(e.device_serial="Le num\xe9ro de s\xe9rie doit contenir entre 4 et 50 caract\xe8res"),v(e),0===Object.keys(e).length},C=async e=>{if(e.preventDefault(),!T()){y("Veuillez corriger les erreurs dans le formulaire");return}_(!0),y(null);try{let e={device_name:p.device_name.trim(),sim_iccid:!i&&p.sim_iccid&&p.sim_iccid.trim().length>0&&"N/A"!==p.sim_iccid?p.sim_iccid.trim():void 0,device_serial:p.device_serial&&p.device_serial.trim().length>0?p.device_serial.trim():null,status:p.status||"inactive",patient_id:p.patient_id||null};!i&&p.firmware_version&&p.firmware_version.trim().length>0&&"N/A"!==p.firmware_version&&(e.firmware_version=p.firmware_version.trim());let s={};if(null!=p.sleep_minutes&&(s.sleep_minutes=parseInt(p.sleep_minutes)),null!=p.measurement_duration_ms&&(s.measurement_duration_ms=parseInt(p.measurement_duration_ms)),null!=p.send_every_n_wakeups&&(s.send_every_n_wakeups=parseInt(p.send_every_n_wakeups)),p.calibration_coefficients&&Array.isArray(p.calibration_coefficients)&&(s.calibration_coefficients=p.calibration_coefficients),i){let t="/api.php/devices/".concat(i.id);if(await (0,o.r)(n,d,t,{method:"PUT",body:JSON.stringify(e)},{requiresAuth:!0}),Object.keys(s).length>0)try{await (0,o.r)(n,d,"/api.php/devices/".concat(i.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0})}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour configuration:",e)}c.Z.log("✅ Dispositif modifi\xe9: ".concat(e.device_name))}else{let i=x.find(t=>e.sim_iccid&&t.sim_iccid===e.sim_iccid||e.device_serial&&t.device_serial===e.device_serial);if(i){if(c.Z.log("ℹ️ Dispositif existant trouv\xe9, mise \xe0 jour au lieu de cr\xe9ation"),await (0,o.r)(n,d,"/api.php/devices/".concat(i.id),{method:"PUT",body:JSON.stringify(e)},{requiresAuth:!0}),Object.keys(s).length>0)try{await (0,o.r)(n,d,"/api.php/devices/".concat(i.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0})}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour configuration:",e)}c.Z.log("✅ Dispositif mis \xe0 jour: ".concat(e.device_name))}else{var t,r;let i=await n("".concat(d).concat("/api.php/devices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},{requiresAuth:!0});if(!i.ok){let e=(await i.json().catch(()=>({}))).error||"Erreur HTTP ".concat(i.status);if(e.includes("d\xe9j\xe0")||e.includes("existe")||e.includes("already")||e.includes("utilis\xe9")){c.Z.log('⚠️ API indique "d\xe9j\xe0 utilis\xe9", le dispositif devrait appara\xeetre apr\xe8s rafra\xeechissement'),await l(),a();return}throw Error(e)}let u=await i.json();if(!u.success)throw Error(u.error||"Erreur API");if(u.device&&Object.keys(s).length>0)try{await (0,o.r)(n,d,"/api.php/devices/".concat(u.device.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0})}catch(e){c.Z.warn("⚠️ Erreur sauvegarde configuration:",e)}c.Z.log("✅ Dispositif cr\xe9\xe9: ".concat((null===(t=u.device)||void 0===t?void 0:t.device_name)||(null===(r=u.device)||void 0===r?void 0:r.sim_iccid)))}}await l(),a()}catch(e){c.Z.error("Erreur sauvegarde dispositif:",e),y(e.message||"Erreur lors de la sauvegarde du dispositif")}finally{_(!1)}};return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"sticky top-0 bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:i?"✏️ Modifier le dispositif":"➕ Cr\xe9er un nouveau dispositif"}),(0,r.jsx)("button",{className:"text-gray-500 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-100 text-2xl transition-colors",onClick:a,children:"✖"})]}),(0,r.jsxs)("form",{onSubmit:C,className:"p-6 space-y-4",children:[b&&(0,r.jsx)(u.Z,{message:b}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:["Nom du dispositif ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"text",name:"device_name",value:p.device_name,onChange:E,className:"input w-full ".concat(h.device_name?"border-red-500":""),placeholder:"Ex: Dispositif OTT-001",required:!0}),h.device_name&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.device_name})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Statut"}),(0,r.jsxs)("select",{name:"status",value:p.status,onChange:E,className:"input w-full",children:[(0,r.jsx)("option",{value:"inactive",children:"Inactif"}),(0,r.jsx)("option",{value:"active",children:"Actif"}),(0,r.jsx)("option",{value:"usb_connected",children:"Connect\xe9 USB"}),(0,r.jsx)("option",{value:"maintenance",children:"Maintenance"})]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"SIM ICCID"}),(0,r.jsx)("input",{type:"text",name:"sim_iccid",value:p.sim_iccid||"N/A",readOnly:!0,disabled:!0,className:"input w-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Ex: 89314404000012345678"}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Lecture seule (vient de la SIM)"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Num\xe9ro de s\xe9rie"}),(0,r.jsx)("input",{type:"text",name:"device_serial",value:p.device_serial,onChange:E,className:"input w-full ".concat(h.device_serial?"border-red-500":""),placeholder:"Ex: ESP32-001"}),h.device_serial&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:h.device_serial})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Version du firmware"}),(0,r.jsx)("input",{type:"text",name:"firmware_version",value:p.firmware_version||"N/A",readOnly:!0,disabled:!0,className:"input w-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Ex: 3.8-unified"}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Lecture seule"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Patient"}),(0,r.jsxs)("select",{name:"patient_id",value:p.patient_id||"",onChange:E,className:"input w-full",children:[(0,r.jsx)("option",{value:"",children:"— Aucun patient —"}),m.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," ",e.email?"(".concat(e.email,")"):""]},e.id))]})]})]}),(0,r.jsx)(f,{title:"⚙️ Configuration",defaultOpen:!!i,children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"⏰ Intervalle de veille (minutes)"}),(0,r.jsx)("input",{type:"number",name:"sleep_minutes",value:p.sleep_minutes||"",onChange:E,className:"input w-full",placeholder:"Ex: 5",min:"1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"⏱️ Dur\xe9e de mesure (ms)"}),(0,r.jsx)("input",{type:"number",name:"measurement_duration_ms",value:p.measurement_duration_ms||"",onChange:E,className:"input w-full",placeholder:"Ex: 5000",min:"1"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"\uD83D\uDCE4 Envoyer toutes les N r\xe9veils"}),(0,r.jsx)("input",{type:"number",name:"send_every_n_wakeups",value:p.send_every_n_wakeups||1,onChange:E,className:"input w-full",min:"1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"\uD83D\uDCD0 Calibration (a0, a1, a2)"}),(0,r.jsx)("div",{className:"grid grid-cols-3 gap-2",children:[0,1,2].map(e=>(0,r.jsx)("input",{type:"number",step:"any",value:p.calibration_coefficients[e]||0,onChange:t=>S(e,t.target.value),className:"input w-full",placeholder:"a".concat(e)},e))})]})]})}),(0,r.jsxs)("div",{className:"flex gap-2 justify-end pt-4 border-t border-gray-200 dark:border-slate-700",children:[(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:a,disabled:j,children:"Annuler"}),(0,r.jsx)("button",{type:"submit",className:"btn-primary",disabled:j||w,children:j?"⏳ Enregistrement...":i?"\uD83D\uDCBE Enregistrer les modifications":"✅ Cr\xe9er le dispositif"})]})]})]})}):null}function y(){var e,t,a;let{usbConnectedDevice:d,setUsbConnectedDevice:u,usbVirtualDevice:x,setUsbVirtualDevice:g,usbDeviceInfo:h,isSupported:f,isConnected:y,port:j,usbStreamStatus:_,usbStreamMeasurements:w,usbStreamLogs:N,usbStreamError:k,usbStreamLastMeasurement:D,usbStreamLastUpdate:E,requestPort:S,connect:T,startReading:C,write:A,startUsbStreaming:I,pauseUsbStreaming:Z,appendUsbStreamLog:O}=(0,l.l)();(0,s.useEffect)(()=>(c.Z.log("\uD83D\uDFE2\uD83D\uDFE2\uD83D\uDFE2 [USB-TAB] ========== COMPOSANT MONT\xc9 =========="),()=>{c.Z.log("\uD83D\uDD34 [USB-TAB] Composant d\xe9mont\xe9")}),[]),(0,s.useEffect)(()=>{c.Z.log("\uD83D\uDFE2 [USB-TAB] Contexte USB mis \xe0 jour:",{hasUsbDeviceInfo:!!h,usbDeviceInfo_iccid:null==h?void 0:h.sim_iccid,usbDeviceInfo_name:null==h?void 0:h.device_name,isConnected:y,isSupported:f,usbStreamStatus:_,usbConnectedDevice_name:null==d?void 0:d.device_name,usbVirtualDevice_name:null==x?void 0:x.device_name})},[h,y,_,d,x]);let{fetchWithAuth:F,API_URL:U,user:L}=(0,i.a)(),{data:B,loading:P,refetch:R,invalidateCache:q}=(0,n.m_)(["/api.php/devices"],{requiresAuth:!0,autoLoad:!!L}),M=(null==B?void 0:null===(e=B.devices)||void 0===e?void 0:e.devices)||[],V=(0,s.useCallback)(()=>{window.dispatchEvent(new Event("ott-devices-updated"));try{window.localStorage.setItem("ott-devices-last-update",Date.now().toString())}catch(e){}},[]),{data:z,loading:H}=(0,n.m_)(["/api.php/patients"],{requiresAuth:!0,autoLoad:!!L}),J=(null==z?void 0:null===(t=z.patients)||void 0===t?void 0:t.patients)||[],{data:G,loading:W}=(0,n.m_)(["/api.php/firmwares"],{requiresAuth:!0,autoLoad:!!L}),X=((null==G?void 0:null===(a=G.firmwares)||void 0===a?void 0:a.firmwares)||[]).filter(e=>"compiled"===e.status),[$,K]=(0,s.useState)(null),[Q,Y]=(0,s.useState)(!1),[ee,et]=(0,s.useState)(!1),[ea,er]=(0,s.useState)(!1),[es,ei]=(0,s.useState)(null),[el,en]=(0,s.useState)(!1),[ec,eo]=(0,s.useState)(!1),[ed,eu]=(0,s.useState)(null),[em,ex]=(0,s.useState)(!1),[ep,eg]=(0,s.useState)(null),[eh,ev]=(0,s.useState)([]),[ef,eb]=(0,s.useState)(""),[ey,ej]=(0,s.useState)(!1),[e_,ew]=(0,s.useState)(!1),[eN,ek]=(0,s.useState)(!1),[eD,eE]=(0,s.useState)(Date.now()),[eS,eT]=(0,s.useState)(null),[eC,eA]=(0,s.useState)(!1),[eI,eZ]=(0,s.useState)(null),eO=(0,s.useMemo)(()=>"running"===_||"waiting"===_||"connecting"===_,[_]),eF=(0,s.useMemo)(()=>"paused"===_,[_]),eU=(0,s.useMemo)(()=>y||eO||eF||eS,[y,eO,eF,eS]);(0,s.useMemo)(()=>!y,[y]);let eL=(0,s.useRef)(!1);(0,s.useEffect)(()=>{if(c.Z.log("\uD83D\uDD35 [USB-TAB] useEffect D\xc9CLENCH\xc9",{hasUsbDeviceInfo:!!h,isConnected:y,showDeviceModal:em,creating:eL.current}),!h||!y||em||eL.current){c.Z.log("❌ [USB-TAB] STOP -",{noInfo:!h,notConnected:!y,modalOpen:em,alreadyCreating:eL.current});return}let e=h.sim_iccid,t=h.device_serial,a=e&&"N/A"!==e&&e.trim().length>=4&&/^\d+$/.test(e.trim()),r=t&&"N/A"!==t&&t.trim().length>=4&&/^[A-Z0-9\-]+$/i.test(t.trim());if(c.Z.log("\uD83D\uDD0D [USB-TAB] Validation",{simIccid:e,deviceSerial:t,validIccid:a,validSerial:r}),!a&&!r){c.Z.log("❌ [USB-TAB] Identifiants invalides");return}let s=M.find(s=>a&&s.sim_iccid===e||r&&s.device_serial===t);c.Z.log("\uD83D\uDD0D [USB-TAB] Recherche en BDD",{allDevicesCount:M.length,existingDevice:s?"".concat(s.device_name," (ID: ").concat(s.id,")"):"NON TROUV\xc9"}),eL.current=!0,(async()=>{try{if(s)await (0,o.r)(F,U,"/api.php/devices/".concat(s.id),{method:"PUT",body:JSON.stringify({status:"usb_connected",firmware_version:h.firmware_version})},{requiresAuth:!0}),u({...s,status:"usb_connected",isVirtual:!1});else{let s=h.device_name||(a?"OTT-".concat(e.slice(-4)):t);c.Z.log("\uD83D\uDCDD [USB-TAB] Tentative cr\xe9ation avec:",{device_name:s,sim_iccid:a?e:null,device_serial:r?t:null,firmware_version:h.firmware_version,status:"usb_connected"});let i=await (0,o.r)(F,U,"/api.php/devices",{method:"POST",body:JSON.stringify({device_name:s,sim_iccid:a?e:null,device_serial:r?t:null,firmware_version:h.firmware_version||null,status:"usb_connected"})},{requiresAuth:!0});i.device&&(c.Z.log("✅ [USB-TAB] Dispositif cr\xe9\xe9:",i.device.id),u({...i.device,isVirtual:!1}))}g(null),null==q||q(),await new Promise(e=>setTimeout(e,100)),await R(),V()}catch(s){if(c.Z.error("❌ [USB-TAB] Erreur compl\xe8te:",{message:s.message,error:s.error,details:s,stack:s.stack}),s.error&&(s.error.includes("d\xe9j\xe0 utilis\xe9")||s.error.includes("Database error"))){c.Z.log("\uD83D\uDD04 [USB-TAB] Recherche du dispositif existant apr\xe8s erreur...");try{var i;await R();let s=((null==B?void 0:null===(i=B.devices)||void 0===i?void 0:i.devices)||[]).find(s=>a&&s.sim_iccid===e||r&&s.device_serial===t||s.device_name&&s.device_name.includes(null==e?void 0:e.slice(-4)));s?(c.Z.log("✅ [USB-TAB] Dispositif existant trouv\xe9 apr\xe8s erreur:",s.device_name),u({...s,isVirtual:!1}),g(null),V()):c.Z.error("❌ [USB-TAB] Dispositif non trouv\xe9 malgr\xe9 erreur conflit")}catch(e){c.Z.error("❌ [USB-TAB] Erreur recherche:",e)}}}finally{eL.current=!1}})()},[h,y,M.length,em,F,U]);let eB=(0,s.useCallback)((e,t,a,r)=>null!=e?{value:e,source:"usb",timestamp:t||E||(null==h?void 0:h.last_seen)||null}:null!=a?{value:a,source:"database",timestamp:r||(null==eS?void 0:eS.last_seen)||null}:{value:null,source:null,timestamp:null},[E,null==h?void 0:h.last_seen,null==eS?void 0:eS.last_seen]),eP=(0,s.useCallback)(e=>{if(!e)return null;let t=new Date(e),a=Math.floor((new Date-t)/1e3),r=Math.floor(a/60),s=Math.floor(r/60);return a<60?"".concat(a,"s"):r<60?"".concat(r,"min"):s<24?"".concat(s,"h"):t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},[]);(0,s.useMemo)(()=>y&&((null==D?void 0:D.rssi)!=null||(null==h?void 0:h.rssi)!=null||(null==D?void 0:D.latitude)!=null)?"running":y?"starting":"stopped",[y,null==D?void 0:D.rssi,null==h?void 0:h.rssi,null==D?void 0:D.latitude]);let[eR,eq]=(0,s.useState)({flowrate:{min:null,max:null},battery:{min:null,max:null},rssi:{min:null,max:null}}),eM=(0,s.useCallback)(async()=>{if(f){ej(!0);try{let e=(await navigator.serial.getPorts()).map((e,t)=>({id:"port-".concat(t),label:(0,p.DE)(e),port:e}));ev(e)}catch(e){c.Z.error("[DebugTab] Erreur chargement ports:",e)}finally{ej(!1)}}},[f]);(0,s.useEffect)(()=>{if(!f)return;eM();let e=setInterval(eM,5e3);return()=>clearInterval(e)},[f,j,d,x]),(0,s.useEffect)(()=>{f&&y&&j&&(async()=>{try{await eM();let e=(await navigator.serial.getPorts()).findIndex(e=>e===j);e>=0&&eb("port-".concat(e))}catch(e){c.Z.debug("[DebugTab] Erreur synchronisation port:",e)}})()},[f,y,j,eM]),(0,s.useEffect)(()=>{if(f&&y&&j&&"idle"===_&&!e_){let e=setTimeout(async()=>{try{c.Z.log("[DebugTab] D\xe9marrage automatique du streaming..."),await I(j)}catch(e){c.Z.error("[DebugTab] Erreur d\xe9marrage automatique streaming:",e)}},300);return()=>clearTimeout(e)}},[f,y,j,_,e_,I]),(0,s.useEffect)(()=>{(async()=>{if(eC)return;let e=(null==h?void 0:h.sim_iccid)||(null==h?void 0:h.device_serial)||(null==h?void 0:h.device_name);if(!eS||!e||eS.sim_iccid!==e&&eS.device_serial!==e&&eS.device_name!==e){eA(!0);try{var t;let a=await (0,o.r)(F,U,"/api.php/devices",{method:"GET"},{requiresAuth:!0});if(null==a?void 0:null===(t=a.devices)||void 0===t?void 0:t.devices){let t=null;(t=e?a.devices.devices.find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e):a.devices.devices[0])&&(eT({device_name:t.device_name,sim_iccid:t.sim_iccid,device_serial:t.device_serial,firmware_version:t.firmware_version,last_battery:t.last_battery||null,last_flowrate:t.last_flowrate||null,last_rssi:t.last_rssi||null,last_latitude:t.latitude||null,last_longitude:t.longitude||null,last_seen:t.last_seen,status:t.status}),D||h||eZ("database"))}}catch(e){c.Z.error("[DebugTab] Erreur chargement donn\xe9es DB:",e)}finally{eA(!1)}}})()},[F,U]),(0,s.useEffect)(()=>{let e=(null==h?void 0:h.sim_iccid)||(null==h?void 0:h.device_serial)||(null==h?void 0:h.device_name);!e||eS&&(eS.sim_iccid===e||eS.device_serial===e||eS.device_name===e)||eC||(async()=>{eA(!0);try{var t;let a=await (0,o.r)(F,U,"/api.php/devices",{method:"GET"},{requiresAuth:!0});if(null==a?void 0:null===(t=a.devices)||void 0===t?void 0:t.devices){let t=a.devices.devices.find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e);t&&eT({device_name:t.device_name,sim_iccid:t.sim_iccid,device_serial:t.device_serial,firmware_version:t.firmware_version,last_battery:t.last_battery,last_flowrate:t.last_flowrate||null,last_rssi:t.last_rssi||null,last_latitude:t.latitude||null,last_longitude:t.longitude||null,last_seen:t.last_seen,status:t.status})}}catch(e){c.Z.error("[DebugTab] Erreur rechargement donn\xe9es DB:",e)}finally{eA(!1)}})()},[null==h?void 0:h.sim_iccid,null==h?void 0:h.device_serial,null==h?void 0:h.device_name,F,U,eC,eS]),(0,s.useEffect)(()=>{D||h&&(null!=h.flowrate||null!=h.last_battery)?eZ("usb"):eS&&!D&&eZ("database")},[D,h,eS]),(0,s.useEffect)(()=>{if(!eU||!E)return;let e=setInterval(()=>{eE(Date.now())},1e3);return()=>clearInterval(e)},[eU,E]),(0,s.useCallback)(async e=>{if(!y||!j){O("❌ Port non connect\xe9 - Connexion automatique en cours...","dashboard");return}if(eN){O("⏳ Commande d\xe9j\xe0 en cours...","dashboard");return}ek(!0);try{O("\uD83D\uDCE4 Envoi commande: ".concat(e),"dashboard");let t=await A(e+"\n");await new Promise(e=>setTimeout(e,100)),t?O('✅ Commande "'.concat(e,'" envoy\xe9e'),"dashboard"):O("❌ \xc9chec envoi commande: ".concat(e),"dashboard")}catch(e){c.Z.error("[DebugTab] Erreur envoi commande:",e),O("❌ Erreur envoi commande: ".concat(e.message||e),"dashboard")}finally{ek(!1)}},[y,j,eN,A,O]),(0,s.useCallback)(async()=>{if(!e_){ew(!0);try{eO?(Z(),O("⏸️ Visualisation des logs mise en pause - Port toujours connect\xe9","dashboard")):eF?y&&j&&(await I(j),O("▶️ Visualisation des logs reprise","dashboard")):y&&j&&await I(j)}catch(e){c.Z.error("[DebugTab] Erreur toggle streaming:",e),O("❌ Erreur: ".concat(e.message||e),"dashboard")}finally{ew(!1)}}},[e_,eO,eF,y,j,I,Z,O]),(0,s.useEffect)(()=>{if(!D)return;let{flowrate:e,battery:t,rssi:a}=D;eq(r=>{let s={...r},i=!1;return null!=e&&((null===s.flowrate.min||e<s.flowrate.min)&&(s.flowrate.min=e,i=!0),(null===s.flowrate.max||e>s.flowrate.max)&&(s.flowrate.max=e,i=!0)),null!=t&&((null===s.battery.min||t<s.battery.min)&&(s.battery.min=t,i=!0),(null===s.battery.max||t>s.battery.max)&&(s.battery.max=t,i=!0)),null!=a&&-999!==a&&((null===s.rssi.min||a<s.rssi.min)&&(s.rssi.min=a,i=!0),(null===s.rssi.max||a>s.rssi.max)&&(s.rssi.max=a,i=!0)),i?s:r})},[D]),(0,s.useEffect)(()=>{("connecting"===_||"waiting"===_)&&eq({flowrate:{min:null,max:null},battery:{min:null,max:null},rssi:{min:null,max:null}})},[_]);let eV=(0,s.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.patient_id&&!t){K(e),Y(!0);return}et(!0);try{let t=await (0,o.r)(F,U,"/api.php/devices/".concat(e.id),{method:"DELETE"},{requiresAuth:!0});t.success?(c.Z.log('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" supprim\xe9 avec succ\xe8s')),O('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" supprim\xe9'),"dashboard"),R(),Y(!1),K(null)):(c.Z.error("Erreur suppression dispositif:",t.error),O("❌ Erreur suppression: ".concat(t.error),"dashboard"))}catch(e){c.Z.error("Erreur suppression dispositif:",e),O("❌ Erreur suppression: ".concat(e.message||e),"dashboard")}finally{et(!1)}},[F,U,R,O]),ez=(0,s.useCallback)(()=>{$&&eV($,!0)},[$,eV]),[eH,eJ]=(0,s.useState)(!1);(0,s.useCallback)(async()=>{eJ(!0);try{let e="".concat(U,"/api.php/devices/test/create"),t=await F(e,{method:"POST"},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur API");t.success?(c.Z.log("✅ ".concat(a.message)),O("✅ ".concat(a.message),"dashboard"),a.errors&&a.errors.length>0&&a.errors.forEach(e=>{O("⚠️ ".concat(e),"dashboard")}),R()):(c.Z.error("Erreur cr\xe9ation dispositifs fictifs:",a.error),O("❌ Erreur: ".concat(a.error),"dashboard"))}catch(e){c.Z.error("Erreur cr\xe9ation dispositifs fictifs:",e),O("❌ Erreur: ".concat(e.message||e),"dashboard")}finally{eJ(!1)}},[F,U,R,O]);let eG=(0,s.useCallback)(async e=>{if(es&&e){en(!0);try{let t="".concat(U,"/api.php/devices/").concat(es.id),a=await F(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:e})},{requiresAuth:!0});if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(a.status))}let r=await a.json();if(!r.success)throw Error(r.error||"Erreur API");let s=J.find(t=>t.id===e);c.Z.log("✅ Dispositif assign\xe9 \xe0 ".concat(null==s?void 0:s.first_name," ").concat((null==s?void 0:s.last_name)||e)),O("✅ Dispositif assign\xe9 \xe0 ".concat(null==s?void 0:s.first_name," ").concat((null==s?void 0:s.last_name)||e),"dashboard"),er(!1),ei(null),R()}catch(e){c.Z.error("Erreur assignation patient:",e),O("❌ Erreur assignation patient: ".concat(e.message||e),"dashboard")}finally{en(!1)}}},[F,U,es,J,O,R]),eW=(0,s.useMemo)(()=>{let e=new Set(M.filter(e=>e.patient_id).map(e=>e.patient_id));return J.filter(t=>!e.has(t.id))},[J,M]),eX=(0,s.useCallback)(e=>{eu(e),eo(!0)},[]);return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(m.Z,{isOpen:ea,onClose:()=>{er(!1),ei(null)},title:es?"\uD83D\uDD17 Assigner un patient \xe0 ".concat(es.device_name||es.sim_iccid||es.device_serial||"Dispositif #".concat(es.id)):"Assigner un patient au dispositif",maxWidth:"max-w-md",children:es&&(0,r.jsx)(r.Fragment,{children:H?(0,r.jsx)("div",{className:"text-center py-4",children:(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Chargement des patients..."})}):0===eW.length?(0,r.jsxs)("div",{className:"text-center py-4",children:[(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aucun patient disponible"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-500 mb-4",children:"Tous les patients ont d\xe9j\xe0 un dispositif assign\xe9"}),(0,r.jsx)("button",{className:"btn-secondary",onClick:()=>{er(!1),ei(null)},children:"Fermer"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"S\xe9lectionner un patient libre :"}),(0,r.jsxs)("select",{id:"patient-select",className:"input w-full",defaultValue:"",children:[(0,r.jsx)("option",{value:"",children:"— S\xe9lectionner un patient —"}),eW.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," ",e.email?"(".concat(e.email,")"):""]},e.id))]})]}),(0,r.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,r.jsx)("button",{className:"btn-secondary",onClick:()=>{er(!1),ei(null)},disabled:el,children:"Annuler"}),(0,r.jsx)("button",{className:"btn-primary",onClick:()=>{let e=document.getElementById("patient-select"),t=e?parseInt(e.value,10):null;t?eG(t):(c.Z.warn("Veuillez s\xe9lectionner un patient"),O("⚠️ Veuillez s\xe9lectionner un patient","dashboard"))},disabled:el,children:el?"⏳ Assignation...":"\uD83D\uDD17 Assigner"})]})]})})}),(0,r.jsx)(v,{isOpen:ec,onClose:()=>{eo(!1),eu(null)},device:ed,flashMode:ed&&y&&((null==h?void 0:h.sim_iccid)===ed.sim_iccid||(null==h?void 0:h.device_serial)===ed.device_serial)?"usb":"ota"}),(0,r.jsx)(b,{isOpen:em,onClose:()=>{ex(!1),eg(null)},editingItem:ep||(h&&!ep?{sim_iccid:h.sim_iccid||"",device_serial:h.device_serial||"",device_name:h.device_name||"",firmware_version:h.firmware_version||""}:null),onSave:()=>{ex(!1);let e=(null==ep?void 0:ep.device_name)||(null==ep?void 0:ep.sim_iccid)||(null==h?void 0:h.device_name)||(null==h?void 0:h.sim_iccid)||"nouveau dispositif";R(),O('✅ Dispositif "'.concat(e,'" ').concat(ep?"mis \xe0 jour":"cr\xe9\xe9"),"dashboard"),eg(null)},fetchWithAuth:F,API_URL:U,patients:J,allDevices:M}),(0,r.jsx)(m.Z,{isOpen:Q,onClose:()=>{Y(!1),K(null)},title:"Confirmer la suppression",maxWidth:"max-w-md",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["\xcates-vous s\xfbr de vouloir supprimer le dispositif ",(0,r.jsx)("strong",{children:(null==$?void 0:$.device_name)||(null==$?void 0:$.sim_iccid)})," ?"]}),(null==$?void 0:$.patient_id)&&(0,r.jsxs)("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg",children:[(0,r.jsxs)("p",{className:"text-sm text-amber-800 dark:text-amber-300",children:["⚠️ ",(0,r.jsx)("strong",{children:"Attention :"})," Ce dispositif est assign\xe9 au patient ",(0,r.jsxs)("strong",{children:[null==$?void 0:$.first_name," ",null==$?void 0:$.last_name]}),"."]}),(0,r.jsx)("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2",children:"Le dispositif sera d\xe9sassign\xe9 automatiquement avant suppression."})]}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>{Y(!1),K(null)},disabled:ee,className:"px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors disabled:opacity-50",children:"Annuler"}),(0,r.jsx)("button",{onClick:ez,disabled:ee,className:"px-4 py-2 text-sm bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:ee?"⏳ Suppression...":"\uD83D\uDDD1️ Supprimer"})]})]})}),(0,r.jsxs)("div",{className:"card",children:[!f&&(0,r.jsx)("div",{className:"alert alert-warning mb-4",children:"Le navigateur utilis\xe9 ne supporte pas l'API Web Serial. Utilisez Chrome ou Edge (desktop)."}),k&&(0,r.jsx)("div",{className:"alert alert-warning mb-4",children:k}),(0,r.jsx)("div",{className:"mb-4 space-y-2"}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("h3",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2 mb-2",children:[(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDD0C"}),"Dispositifs",!P&&0===M.length&&(0,r.jsx)("span",{className:"ml-3 text-xs font-normal text-gray-500 dark:text-gray-400",children:"(Aucun dispositif trouv\xe9 dans la base de donn\xe9es)"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Tous les dispositifs de la base de donn\xe9es avec leurs donn\xe9es en temps r\xe9el (USB) ou depuis la base de donn\xe9es"})]}),(0,r.jsx)("button",{onClick:()=>{eg(null),ex(!0)},className:"btn-primary",title:"Cr\xe9er un nouveau dispositif",children:"➕ Nouveau Dispositif"})]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:P?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"Chargement des dispositifs..."}):(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("table",{className:"w-full border-collapse bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Identifiant"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Patient"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Firmware"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Modem"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"GPS"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"D\xe9bit"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Batterie"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"RSSI"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Mesures"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Derni\xe8re mise \xe0 jour"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Actions"})]})}),(0,r.jsx)("tbody",{children:0===M.length?(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:"11",className:"px-3 py-8 text-center text-gray-500 dark:text-gray-400",children:(0,r.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,r.jsx)("p",{className:"text-sm",children:"Aucun dispositif dans la base de donn\xe9es"}),(0,r.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:'Utilisez le bouton "➕ Nouveau Dispositif" ci-dessus pour cr\xe9er un dispositif'})]})})}):M.map(e=>{let t=y&&((null==h?void 0:h.sim_iccid)===e.sim_iccid||(null==h?void 0:h.device_serial)===e.device_serial);x&&(x.sim_iccid===e.sim_iccid||(x.device_serial,e.device_serial));let a=t?h:null,s=t?D:null;return(0,r.jsxs)("tr",{className:"border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors",children:[(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{let t=(null==a?void 0:a.device_name)||(null==e?void 0:e.device_name),s=(null==a?void 0:a.sim_iccid)||(null==a?void 0:a.device_serial)||(null==e?void 0:e.sim_iccid)||(null==e?void 0:e.device_serial);(null==a?void 0:a.device_name)||null==e||e.device_name;let i=(null==a?void 0:a.last_seen)||(null==e?void 0:e.last_seen);return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(t?"text-orange-600 dark:text-orange-400":"text-gray-400 dark:text-gray-500"),children:t||"N/A"})}),s&&(0,r.jsx)("span",{className:"text-xs font-mono text-gray-600 dark:text-gray-400",children:s}),i&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(i)})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{let t=(null==e?void 0:e.first_name)&&(null==e?void 0:e.last_name)?"".concat(e.first_name," ").concat(e.last_name):null,a=!!t;return(0,r.jsx)("div",{className:"flex items-center gap-1",children:a?(0,r.jsx)("span",{className:"badge badge-success text-xs",children:t}):(0,r.jsx)("button",{onClick:()=>{ei(e),er(!0)},className:"badge bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 text-xs hover:bg-orange-200 dark:hover:bg-orange-900/40 cursor-pointer transition-colors",title:"Cliquer pour assigner un patient",children:"Non assign\xe9"})})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{var t;let i=(null==s?void 0:null===(t=s.raw)||void 0===t?void 0:t.firmware_version)||(null==s?void 0:s.firmware_version)||(null==a?void 0:a.firmware_version)||(null==e?void 0:e.firmware_version);(null==s?void 0:s.firmware_version)||(null==a?void 0:a.firmware_version)||null==e||e.firmware_version;let l=(null==s?void 0:s.timestamp)||(null==a?void 0:a.last_seen)||(null==e?void 0:e.last_seen),n=X.length>0;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:n?(0,r.jsx)("button",{onClick:()=>eX(e),className:"text-xs font-semibold hover:underline transition-colors ".concat(i?"text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300 cursor-pointer":"text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300"),title:"Cliquer pour flasher un firmware",children:i||"N/A"}):(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(i?"text-cyan-600 dark:text-cyan-400":"text-gray-400 dark:text-gray-500"),children:i||"N/A"})}),i&&l&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(l)})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{let i=(null==s?void 0:s.rssi)!=null&&(null==s?void 0:s.rssi)!==-999||(null==a?void 0:a.rssi)!=null&&(null==a?void 0:a.rssi)!==-999||(null==s?void 0:s.latitude)!=null||(null==a?void 0:a.latitude)!=null||(null==e?void 0:e.last_rssi)!=null&&(null==e?void 0:e.last_rssi)!==-999;(null==s?void 0:s.rssi)!=null||(null==a?void 0:a.rssi)!=null||(null==s?void 0:s.latitude)!=null||(null==a?void 0:a.latitude)!=null||null==e||e.last_rssi;let l=(null==s?void 0:s.timestamp)||(null==a?void 0:a.last_seen)||(null==e?void 0:e.last_seen),n=t&&i?"running":t?"starting":"stopped";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat("running"===n?"text-green-600 dark:text-green-400":"starting"===n?"text-yellow-600 dark:text-yellow-400":"text-gray-400 dark:text-gray-500"),children:"running"===n?"Actif":"starting"===n?"D\xe9marrage...":"Arr\xeat\xe9"})}),i&&l&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(l)})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{var t,i,l,n,c,o,d,u;let m=null!==(t=null==s?void 0:s.latitude)&&void 0!==t?t:null==a?void 0:a.latitude,x=null!==(i=null==s?void 0:s.longitude)&&void 0!==i?i:null==a?void 0:a.longitude,p=eB(m,null==s?void 0:s.timestamp,null==e?void 0:e.latitude,null==e?void 0:e.last_seen),g=eB(x,null==s?void 0:s.timestamp,null==e?void 0:e.longitude,null==e?void 0:e.last_seen),h=null!==(c=null!==(n=null!==(l=p.value)&&void 0!==l?l:m)&&void 0!==n?n:null==e?void 0:e.latitude)&&void 0!==c?c:null,v=null!==(u=null!==(d=null!==(o=g.value)&&void 0!==o?o:x)&&void 0!==d?d:null==e?void 0:e.longitude)&&void 0!==u?u:null,f=null!=h&&null!=v&&0!==h&&0!==v&&!isNaN(h)&&!isNaN(v);p.source||g.source;let b=p.timestamp||g.timestamp||(null==s?void 0:s.timestamp);return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(!f||isNaN(h)||isNaN(v)?"text-gray-400 dark:text-gray-500":"text-green-600 dark:text-green-400"),children:!f||isNaN(h)||isNaN(v)?"N/A":"".concat(Number(h).toFixed(4),", ").concat(Number(v).toFixed(4))})}),f&&b&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(b)})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{var t,i,l,n;let c=null!==(t=null==s?void 0:s.flowrate)&&void 0!==t?t:null==a?void 0:a.flowrate,o=eB(c,null==s?void 0:s.timestamp,null==e?void 0:e.last_flowrate,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(i=o.value)&&void 0!==i?i:c)&&void 0!==l?l:null==e?void 0:e.last_flowrate)&&void 0!==n?n:null;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(null==d||isNaN(d)?"text-gray-400 dark:text-gray-500":"text-blue-600 dark:text-blue-400"),children:null==d||isNaN(d)?"N/A":"".concat(Number(d).toFixed(2)," L/min")})}),null!=d&&!isNaN(d)&&(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{var t,i,l,n;let c=null!==(t=null==s?void 0:s.battery)&&void 0!==t?t:null==a?void 0:a.last_battery,o=eB(c,null==s?void 0:s.timestamp,null==e?void 0:e.last_battery,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(i=o.value)&&void 0!==i?i:c)&&void 0!==l?l:null==e?void 0:e.last_battery)&&void 0!==n?n:null,u=null==d||isNaN(d)?0:d,m=null==d||isNaN(d)?"text-gray-400 dark:text-gray-500":u>=50?"text-green-600 dark:text-green-400":u>=20?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(m),children:null==d||isNaN(d)?"N/A":"".concat(Number(u).toFixed(0),"%")})}),null!=d&&!isNaN(d)&&(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{var t,i,l,n;let c=null!==(t=null==s?void 0:s.rssi)&&void 0!==t?t:null==a?void 0:a.rssi,o=eB(c,null==s?void 0:s.timestamp,null==e?void 0:e.last_rssi,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(i=o.value)&&void 0!==i?i:c)&&void 0!==l?l:null==e?void 0:e.last_rssi)&&void 0!==n?n:null,u=null!=d&&-999!==d&&!isNaN(d),m=u?d>=-70?"text-green-600 dark:text-green-400":d>=-90?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400":"text-gray-400 dark:text-gray-500";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(m),children:u?"".concat(Number(d)," dBm"):"N/A"})}),u&&(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(o.timestamp||(null==s?void 0:s.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{let a=t&&(null==w?void 0:w.length)||(e?1:0);return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(0===a?"text-gray-400 dark:text-gray-500":"text-purple-600 dark:text-purple-400"),children:a})}),t&&(null==s?void 0:s.timestamp)&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:eP(s.timestamp)})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(()=>{let i=t?E||(null==s?void 0:s.timestamp)||(null==a?void 0:a.last_seen):null,l=null==e?void 0:e.last_seen,n=i||l,c=n?Math.floor((eD-n)/1e3):null;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(null!=c&&c<60?"text-green-600 dark:text-green-400":"text-gray-400 dark:text-gray-500"),children:null!=c?"".concat(c,"s"):"Jamais"})}),n&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:new Date(n).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]})})()}),(0,r.jsx)("td",{className:"px-3 py-1.5",children:(0,r.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,r.jsx)("button",{onClick:()=>{eg(e),ex(!0)},className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors",title:"Modifier le dispositif (donn\xe9es et configuration)",children:(0,r.jsx)("span",{className:"text-lg",children:"✏️"})}),(0,r.jsx)("button",{onClick:()=>eX(e),disabled:0===X.length,className:"p-2 hover:bg-primary-100 dark:hover:bg-primary-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:0===X.length?"Aucun firmware compil\xe9 disponible. Compilez d'abord un firmware dans l'onglet \"Upload INO\".":"Flasher le firmware",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDE80"})}),(0,r.jsx)("button",{onClick:()=>eV(e),disabled:ee,className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:e.patient_id?"Supprimer (n\xe9cessite confirmation)":"Supprimer",children:(0,r.jsx)("span",{className:"text-lg",children:ee?"⏳":"\uD83D\uDDD1️"})})]})})]},e.id)})})]})})})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"mb-4 flex items-start justify-between gap-4",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100 mb-2",children:"\uD83D\uDCE1 Console de Logs USB"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Logs en temps r\xe9el du streaming USB et des actions du dashboard"})]}),(0,r.jsx)("div",{className:"px-3 py-1.5 bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-lg",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs",children:[(0,r.jsx)("span",{className:"font-semibold text-gray-700 dark:text-gray-300",children:"Statut USB:"}),(0,r.jsx)("span",{className:"px-2 py-0.5 rounded font-medium ".concat(y?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400":"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-400"),children:y?"\uD83D\uDD0C Connect\xe9":"⚪ Non connect\xe9"}),h&&(0,r.jsx)("span",{className:"text-gray-600 dark:text-gray-400",children:h.device_name||h.sim_iccid||h.device_serial||"Dispositif USB"}),x&&!h&&(0,r.jsxs)("span",{className:"text-orange-600 dark:text-orange-400",children:["Dispositif virtuel: ",x.device_name||x.sim_iccid||x.device_serial]})]})})]}),(0,r.jsx)("div",{className:"rounded-2xl border border-gray-200 dark:border-slate-700 bg-gray-900 p-4 shadow-inner overflow-y-auto",style:{minHeight:"500px",maxHeight:"600px"},children:0===N.length?(0,r.jsxs)("div",{className:"h-full flex flex-col items-center justify-center text-center space-y-2 text-gray-500",children:[(0,r.jsx)("span",{className:"text-4xl",children:"\uD83D\uDCE1"}),(0,r.jsx)("p",{className:"font-medium",children:"En attente de logs USB..."}),(0,r.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Connectez un dispositif USB et d\xe9marrez le streaming pour voir les logs"})]}):(0,r.jsx)("div",{className:"space-y-1 font-mono text-sm tracking-tight",children:[...N].reverse().map(e=>{let t="dashboard"===e.source;return(0,r.jsxs)("div",{className:"whitespace-pre-wrap",children:[(0,r.jsx)("span",{className:"text-gray-500 pr-3",children:new Date(e.timestamp).toLocaleTimeString("fr-FR")}),(0,r.jsx)("span",{className:t?"text-blue-400 dark:text-blue-300":"text-green-400 dark:text-green-300",children:e.line})]},e.id)})})})]})]})]})}let j="force-dynamic";function _(){let{user:e}=(0,i.a)(),{isSupported:t,autoDetecting:a,setAutoDetecting:o,usbConnectedDevice:d,usbVirtualDevice:u}=(0,l.l)();(0,n.Eg)(t,a,o,d,u),(0,s.useEffect)(()=>(c.Z.log("\uD83C\uDFC1 [OUTILS-PAGE] ========== PAGE OUTILS MONT\xc9E =========="),c.Z.log("\uD83C\uDFC1 [OUTILS-PAGE] URL:",window.location.href),c.Z.log("\uD83C\uDFC1 [OUTILS-PAGE] User:",null==e?void 0:e.email,"Role:",null==e?void 0:e.role_name),()=>{c.Z.log("\uD83D\uDD34 [OUTILS-PAGE] Page d\xe9mont\xe9e")}),[]);let m=(null==e?void 0:e.role_name)==="admin"||(null==e?void 0:e.role_name)==="technicien",[p,g]=(0,s.useState)("streaming");return((0,s.useEffect)(()=>{c.Z.log("\uD83D\uDCD1 [OUTILS-PAGE] Onglet actif:",p,"streaming"===p?"(UsbStreamingTab affich\xe9)":"(InoEditorTab affich\xe9)")},[p]),m)?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"border-b border-gray-200 dark:border-gray-700",children:(0,r.jsx)("nav",{className:"flex space-x-8",children:[{id:"streaming",label:"Dispositifs",icon:"\uD83D\uDD27"},{id:"ino",label:"Upload INO",icon:"\uD83D\uDCDD"}].map(e=>(0,r.jsxs)("button",{onClick:()=>g(e.id),className:"\n                py-4 px-1 border-b-2 font-medium text-sm transition-colors relative\n                ".concat(p===e.id?"border-primary-500 text-primary-600 dark:text-primary-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300","\n              "),children:[(0,r.jsx)("span",{className:"mr-2",children:e.icon}),e.label]},e.id))})}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("div",{style:{display:"ino"===p?"block":"none"},children:(0,r.jsx)(x,{})}),(0,r.jsx)("div",{style:{display:"streaming"===p?"block":"none"},children:(0,r.jsx)(y,{})})]})]}):(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)("div",{className:"alert alert-warning",children:"Acc\xe8s refus\xe9. Seuls les administrateurs et techniciens peuvent acc\xe9der aux outils."})})}},798:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(7437);function s(e){let{isOpen:t,onClose:a,title:s,children:i,maxWidth:l="max-w-md"}=e;return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",onClick:a,children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl ".concat(l," w-full mx-4 p-6"),onClick:e=>e.stopPropagation(),children:[(s||a)&&(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[s&&(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s}),a&&(0,r.jsx)("button",{onClick:a,className:"w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",title:"Fermer","aria-label":"Fermer",children:(0,r.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,r.jsx)("div",{className:"text-gray-700 dark:text-gray-300",children:i})]})}):null}}},function(e){e.O(0,[3125,9531,2200,4767,2971,2117,1744],function(){return e(e.s=5176)}),_N_E=e.O()}]);