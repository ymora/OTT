(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3668],{9200:function(e,s,t){Promise.resolve().then(t.bind(t,8434))},8434:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return g},dynamic:function(){return h}});var i=t(7437),a=t(2265),n=t(9999),l=t(2617),r=t(3072),c=t(832),d=t(9723),o=t(6601),u=t(2919),m=t(899),x=t(798);t(9131);var p=t(8828);let h="force-dynamic";function g(){var e,s;let{user:t,fetchWithAuth:h,API_URL:g}=(0,n.a)(),f=e=>{var s;return!e||(null==t?void 0:t.role_name)==="admin"||(null==t?void 0:null===(s=t.permissions)||void 0===s?void 0:s.includes(e))||!1},[j,b]=(0,a.useState)(null),[y,v]=(0,a.useState)(null),{isOpen:N,editingItem:D,openCreate:_,openEdit:k,close:C}=(0,r.f7)(),[w,A]=(0,a.useState)(null),[S,E]=(0,a.useState)(null),[P,F]=(0,a.useState)(!1),[Z,O]=(0,a.useState)(null),[M,J]=(0,a.useState)(!1),[T,L]=(0,a.useState)(null),[q,I]=(0,a.useState)(!1),{data:R,loading:U,error:V,refetch:z,invalidateCache:B}=(0,r.m_)((0,a.useMemo)(()=>[q?"/api.php/patients?include_deleted=true":"/api.php/patients","/api.php/devices"],[q]),{requiresAuth:!0}),{restore:W,restoring:Y}=(0,r.O5)("patients",{onSuccess:()=>{b("✅ Patient restaur\xe9 avec succ\xe8s")},onError:e=>{v(e)},invalidateCache:B,refetch:z}),{archive:G,archiving:H}=(0,r.EJ)({fetchWithAuth:h,API_URL:g,entityType:"patients",refetch:z,onSuccess:()=>{b("✅ Patient archiv\xe9 avec succ\xe8s")},onError:e=>{v(e)},invalidateCache:B,currentUser:t,onCloseModal:C,editingItem:D}),{permanentDelete:K,deleting:Q}=(0,r.MY)({fetchWithAuth:h,API_URL:g,entityType:"patients",refetch:z,onSuccess:()=>{b("✅ Patient supprim\xe9 d\xe9finitivement")},onError:e=>{v(e)},invalidateCache:B,onCloseModal:C,editingItem:D});(0,r.w3)(z,3e4),(0,r.iq)(z);let X=(null==R?void 0:null===(e=R.patients)||void 0===e?void 0:e.patients)||[],$=(null==R?void 0:null===(s=R.devices)||void 0===s?void 0:s.devices)||[],ee=(0,a.useMemo)(()=>X.filter(e=>!e.deleted_at),[X]);(0,a.useMemo)(()=>X.filter(e=>e.deleted_at),[X]);let es=(0,a.useMemo)(()=>($||[]).filter(e=>e.patient_id),[$]),et=(0,a.useMemo)(()=>($||[]).filter(e=>!e.patient_id&&!e.deleted_at),[$]),ei=q?X:ee,{searchTerm:ea,setSearchTerm:en,filteredItems:el}=(0,r.L0)(ei,{searchFn:(e,s)=>{let t=s.toLowerCase();return e.filter(e=>"".concat(e.first_name||""," ").concat(e.last_name||""," ").concat(e.email||""," ").concat(e.phone||""," ").concat(e.device_name||"").toLowerCase().includes(t))}}),er=async(e,s)=>{if(!s){v("Veuillez s\xe9lectionner un dispositif");return}try{E(s),v(null),await (0,l.fetchJson)(h,g,"/api.php/devices/".concat(s),{method:"PUT",body:JSON.stringify({patient_id:e.id})},{requiresAuth:!0}),F(!1),O(null),await z(),b("Dispositif assign\xe9 avec succ\xe8s \xe0 ".concat(e.first_name," ").concat(e.last_name))}catch(s){let e="Erreur lors de l'assignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),v(e),p.Z.error("Erreur assignation dispositif:",s)}finally{E(null)}},ec=async e=>{try{A(e.id),v(null),await (0,l.fetchJson)(h,g,"/api.php/devices/".concat(e.id),{method:"PUT",body:JSON.stringify({patient_id:null})},{requiresAuth:!0});try{await (0,l.fetchJson)(h,g,"/api.php/devices/".concat(e.id,"/config"),{method:"PUT",body:JSON.stringify({sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:null,calibration_coefficients:null})},{requiresAuth:!0})}catch(e){p.Z.warn("Erreur r\xe9initialisation config dispositif:",e)}J(!1),L(null),await z(),b("Dispositif d\xe9sassign\xe9 et r\xe9initialis\xe9 avec succ\xe8s")}catch(s){let e="Erreur lors de la d\xe9sassignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),v(e),p.Z.error("Erreur d\xe9sassignation dispositif:",s)}finally{A(null)}},ed=e=>{L(e),J(!0),v(null)},eo=()=>{J(!1),L(null),v(null)},eu=e=>{null!=e&&e.deleted_at||(O(e),v(null),z(),F(!0))},em=()=>{F(!1),O(null),v(null)},ex=async()=>{b(D?"Patient modifi\xe9 avec succ\xe8s":"Patient cr\xe9\xe9 avec succ\xe8s"),await new Promise(e=>setTimeout(e,100)),await z()};return(0,i.jsxs)("div",{className:"space-y-6 animate-fade-in",children:[(0,i.jsx)("div",{children:(0,i.jsx)("h1",{className:"text-3xl font-bold",children:"\uD83D\uDC65 Patients"})}),(0,i.jsxs)("div",{className:"flex flex-col md:flex-row gap-3",children:[(0,i.jsx)("div",{className:"flex-1",children:(0,i.jsx)(u.Z,{value:ea,onChange:en,placeholder:"Rechercher un patient..."})}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:(0,i.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,i.jsx)("input",{type:"checkbox",checked:q,onChange:e=>I(e.target.checked),className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),(0,i.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"\uD83D\uDDC4️ Afficher les archives"})]})}),(0,i.jsx)("button",{className:"btn-primary",onClick:_,children:"➕ Nouveau Patient"})]}),(0,i.jsxs)("div",{className:"card",children:[(0,i.jsx)(d.Z,{error:V,onRetry:z}),(0,i.jsx)(d.Z,{error:y,onClose:()=>v(null)}),(0,i.jsx)(o.Z,{message:j,onClose:()=>b(null)}),U?(0,i.jsx)(c.Z,{size:"lg",text:"Chargement des patients..."}):(0,i.jsx)("div",{className:"overflow-x-auto",children:(0,i.jsxs)("table",{className:"w-full",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{className:"border-b border-gray-200 dark:border-gray-700",children:[(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Nom"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Date Naissance"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Email"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"T\xe9l\xe9phone"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Ville"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Code Postal"}),(0,i.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Dispositif"}),(0,i.jsx)("th",{className:"text-right py-3 px-4 text-gray-700 dark:text-gray-300",children:"Actions"})]})}),(0,i.jsx)("tbody",{children:0===el.length?(0,i.jsx)("tr",{children:(0,i.jsx)("td",{colSpan:"8",className:"py-8 text-center text-gray-500 dark:text-gray-400",children:ea?"Aucun patient ne correspond \xe0 la recherche":"Aucun patient"})}):el.map((e,s)=>{let a=null!==e.deleted_at&&void 0!==e.deleted_at&&""!==e.deleted_at;return(0,i.jsxs)("tr",{className:"table-row animate-slide-up hover:bg-gray-50 dark:hover:bg-gray-800 ".concat(a?"opacity-60":""),style:{animationDelay:"".concat(.05*s,"s")},children:[(0,i.jsx)("td",{className:"table-cell py-3 px-4 font-medium text-primary",children:(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsxs)("span",{children:[e.first_name," ",e.last_name]}),a?(0,i.jsx)("span",{className:"badge bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 text-xs",children:"\uD83D\uDDC4️ Archiv\xe9"}):(0,i.jsx)("span",{className:"badge badge-success",children:"✅ Actif"})]})}),(0,i.jsx)("td",{className:"table-cell",children:e.birth_date?new Date(e.birth_date).toLocaleDateString("fr-FR"):"-"}),(0,i.jsx)("td",{className:"table-cell",children:e.email||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.phone||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.city||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.postal_code||"-"}),(0,i.jsx)("td",{className:"table-cell py-3 px-4",children:(0,i.jsx)("div",{className:"flex items-center gap-2",children:(()=>{if(a){let s=es.find(s=>s.patient_id===e.id);return s?(0,i.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,i.jsx)("p",{className:"font-medium text-primary",children:s.device_name||s.sim_iccid}),(0,i.jsx)("p",{className:"text-xs text-muted font-mono",children:s.sim_iccid})]}):(0,i.jsx)("span",{className:"flex-1 text-sm text-gray-500",children:"Non assign\xe9"})}let s=es.find(s=>s.patient_id===e.id);return s?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>ed(s),disabled:w===s.id,title:"D\xe9sassigner le dispositif du patient",children:(0,i.jsx)("span",{className:"text-lg",children:w===s.id?"⏳":"\uD83D\uDD13"})}),(0,i.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,i.jsx)("p",{className:"font-medium text-primary",children:s.device_name||s.sim_iccid}),(0,i.jsx)("p",{className:"text-xs text-muted font-mono",children:s.sim_iccid})]})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors",onClick:()=>eu(e),disabled:0===et.length,title:0===et.length?"Aucun dispositif libre disponible":"Assigner un dispositif libre au patient",children:(0,i.jsx)("span",{className:"text-lg",children:"\uD83D\uDD17"})}),(0,i.jsx)("span",{className:"flex-1 text-sm text-amber-600",children:"Non assign\xe9"})]})})()})}),(0,i.jsx)("td",{className:"table-cell py-3 px-4",children:(0,i.jsx)("div",{className:"flex items-center justify-end gap-2",children:a?(0,i.jsx)("button",{onClick:()=>W(e),disabled:Y===e.id,className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors disabled:opacity-50",title:"Restaurer le patient",children:(0,i.jsx)("span",{className:"text-lg",children:Y===e.id?"⏳":"♻️"})}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors",onClick:()=>k(e),title:"Modifier le patient",children:(0,i.jsx)("span",{className:"text-lg",children:"✏️"})}),f("patients.edit")&&(0,i.jsx)(i.Fragment,{children:(null==t?void 0:t.role_name)==="admin"?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>G(e),disabled:H===e.id,title:"Archiver le patient",children:(0,i.jsx)("span",{className:"text-lg",children:H===e.id?"⏳":"\uD83D\uDDC4️"})}),(0,i.jsx)("button",{className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors",onClick:()=>K(e),disabled:Q===e.id,title:"Supprimer d\xe9finitivement le patient",children:(0,i.jsx)("span",{className:"text-lg",children:Q===e.id?"⏳":"\uD83D\uDDD1️"})})]}):(0,i.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>G(e),disabled:H===e.id,title:"Archiver le patient",children:(0,i.jsx)("span",{className:"text-lg",children:H===e.id?"⏳":"\uD83D\uDDC4️"})})})]})})})]},e.id)})})]})})]}),(0,i.jsx)(m.Z,{isOpen:N,onClose:C,editingItem:D,type:"patient",onSave:ex,fetchWithAuth:h,API_URL:g,roles:[]}),(0,i.jsx)(x.Z,{isOpen:P,onClose:em,title:Z?"\uD83D\uDD17 Assigner un dispositif \xe0 ".concat(Z.first_name," ").concat(Z.last_name):"",children:Z&&(0,i.jsxs)(i.Fragment,{children:[y&&(0,i.jsx)("div",{className:"alert alert-warning mb-4",children:y}),0===et.length?(0,i.jsxs)("div",{className:"text-center py-4",children:[(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aucun dispositif libre disponible"}),(0,i.jsx)("button",{className:"btn-secondary",onClick:em,children:"Fermer"})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)("label",{className:"block text-sm font-medium mb-2",children:"S\xe9lectionner un dispositif libre :"}),(0,i.jsxs)("select",{id:"device-select",className:"input w-full",defaultValue:"",children:[(0,i.jsx)("option",{value:"",children:"— S\xe9lectionner un dispositif —"}),et.map(e=>(0,i.jsxs)("option",{value:e.id,children:[e.device_name||e.sim_iccid," ",e.sim_iccid?"(".concat(e.sim_iccid,")"):""]},e.id))]})]}),(0,i.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,i.jsx)("button",{className:"btn-secondary",onClick:em,disabled:null!==S,children:"Annuler"}),(0,i.jsx)("button",{className:"btn-primary",onClick:()=>{let e=document.getElementById("device-select"),s=e?parseInt(e.value,10):null;s?er(Z,s):v("Veuillez s\xe9lectionner un dispositif")},disabled:null!==S,children:S?"⏳ Assignation...":"\uD83D\uDD17 Assigner"})]})]})]})}),(0,i.jsx)(x.Z,{isOpen:M,onClose:eo,title:"\uD83D\uDD13 D\xe9sassigner le dispositif",children:T&&(0,i.jsxs)(i.Fragment,{children:[y&&(0,i.jsx)("div",{className:"alert alert-warning mb-4",children:y}),(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mb-2",children:"\xcates-vous s\xfbr de vouloir d\xe9sassigner le dispositif :"}),(0,i.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[(0,i.jsx)("p",{className:"font-medium text-primary",children:T.device_name||T.sim_iccid}),(0,i.jsx)("p",{className:"text-xs text-muted font-mono mt-1",children:T.sim_iccid})]}),(0,i.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-3",children:"⚠️ Le dispositif sera r\xe9initialis\xe9 avec les param\xe8tres d'origine et disponible pour une nouvelle assignation."})]}),(0,i.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,i.jsx)("button",{className:"btn-secondary",onClick:eo,disabled:w===T.id,children:"Annuler"}),(0,i.jsx)("button",{className:"btn-primary bg-orange-500 hover:bg-orange-600",onClick:()=>ec(T),disabled:w===T.id,children:w===T.id?"⏳ D\xe9sassignation...":"\uD83D\uDD13 D\xe9sassigner"})]})]})})]})}}},function(e){e.O(0,[3449,376,2971,2117,1744],function(){return e(e.s=9200)}),_N_E=e.O()}]);