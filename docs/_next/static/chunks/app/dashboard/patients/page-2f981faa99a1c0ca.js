(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3668],{9200:function(e,s,t){Promise.resolve().then(t.bind(t,8434))},8434:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return g},dynamic:function(){return p}});var a=t(7437),i=t(2265),l=t(9999),n=t(2617),r=t(5993),c=t(832),d=t(9723),o=t(6601),u=t(2919),m=t(899),x=t(798);t(9131);var h=t(8828);let p="force-dynamic";function g(){var e,s;let{user:t,fetchWithAuth:p,API_URL:g}=(0,l.a)(),f=e=>{var s;return!e||(null==t?void 0:t.role_name)==="admin"||(null==t?void 0:null===(s=t.permissions)||void 0===s?void 0:s.includes(e))||!1},[j,b]=(0,i.useState)(null),[y,v]=(0,i.useState)(null),{isOpen:N,editingItem:D,openCreate:_,openEdit:k,close:C}=(0,r.f7)(),[w,A]=(0,i.useState)(null),[S,E]=(0,i.useState)(null),[P,Z]=(0,i.useState)(!1),[F,O]=(0,i.useState)(null),[T,J]=(0,i.useState)(!1),[q,L]=(0,i.useState)(null),[M,R]=(0,i.useState)(!1),[I,U]=(0,i.useState)(!1),[V,z]=(0,i.useState)(null),{data:B,loading:H,error:W,refetch:G,invalidateCache:K}=(0,r.m_)((0,i.useMemo)(()=>[I?"/api.php/patients?include_deleted=true":"/api.php/patients","/api.php/devices"],[I]),{requiresAuth:!0});(0,r.w3)(G,3e4),(0,r.iq)(G);let Q=(null==B?void 0:null===(e=B.patients)||void 0===e?void 0:e.patients)||[],X=(null==B?void 0:null===(s=B.devices)||void 0===s?void 0:s.devices)||[],Y=(0,i.useMemo)(()=>Q.filter(e=>!e.deleted_at),[Q]);(0,i.useMemo)(()=>Q.filter(e=>e.deleted_at),[Q]);let $=(0,i.useMemo)(()=>(X||[]).filter(e=>e.patient_id),[X]),ee=(0,i.useMemo)(()=>(X||[]).filter(e=>!e.patient_id&&!e.deleted_at),[X]),es=I?Q:Y,{searchTerm:et,setSearchTerm:ea,filteredItems:ei}=(0,r.L0)(es,{searchFn:(e,s)=>{let t=s.toLowerCase();return e.filter(e=>"".concat(e.first_name||""," ").concat(e.last_name||""," ").concat(e.email||""," ").concat(e.phone||""," ").concat(e.device_name||"").toLowerCase().includes(t))}}),el=async(e,s)=>{if(!s){v("Veuillez s\xe9lectionner un dispositif");return}try{E(s),v(null),await (0,n.fetchJson)(p,g,"/api.php/devices/".concat(s),{method:"PUT",body:JSON.stringify({patient_id:e.id})},{requiresAuth:!0}),Z(!1),O(null),await G(),b("Dispositif assign\xe9 avec succ\xe8s \xe0 ".concat(e.first_name," ").concat(e.last_name))}catch(s){let e="Erreur lors de l'assignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),v(e),h.Z.error("Erreur assignation dispositif:",s)}finally{E(null)}},en=async e=>{try{A(e.id),v(null),await (0,n.fetchJson)(p,g,"/api.php/devices/".concat(e.id),{method:"PUT",body:JSON.stringify({patient_id:null})},{requiresAuth:!0});try{await (0,n.fetchJson)(p,g,"/api.php/devices/".concat(e.id,"/config"),{method:"PUT",body:JSON.stringify({sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:null,calibration_coefficients:null})},{requiresAuth:!0})}catch(e){h.Z.warn("Erreur r\xe9initialisation config dispositif:",e)}J(!1),L(null),await G(),b("Dispositif d\xe9sassign\xe9 et r\xe9initialis\xe9 avec succ\xe8s")}catch(s){let e="Erreur lors de la d\xe9sassignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),v(e),h.Z.error("Erreur d\xe9sassignation dispositif:",s)}finally{A(null)}},er=e=>{L(e),J(!0),v(null)},ec=()=>{J(!1),L(null),v(null)},ed=e=>{null!=e&&e.deleted_at||(O(e),v(null),G(),Z(!0))},eo=()=>{Z(!1),O(null),v(null)},eu=async()=>{b(D?"Patient modifi\xe9 avec succ\xe8s":"Patient cr\xe9\xe9 avec succ\xe8s"),await new Promise(e=>setTimeout(e,100)),await G()},em=async e=>{try{z(e.id),v(null);let s=await p("".concat(g,"/api.php/patients/").concat(e.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({deleted_at:null})},{requiresAuth:!0});if(s.ok)b("✅ Patient restaur\xe9 avec succ\xe8s"),K(),await G();else{let e=await s.json().catch(()=>({}));v(e.error||"Erreur lors de la restauration")}}catch(e){v(e.message||"Erreur lors de la restauration"),h.Z.error("Erreur restauration patient:",e)}finally{z(null)}},ex=(0,i.useRef)([]);return(0,i.useEffect)(()=>()=>{ex.current.forEach(e=>clearTimeout(e)),ex.current=[]},[]),(0,a.jsxs)("div",{className:"space-y-6 animate-fade-in",children:[(0,a.jsx)("div",{children:(0,a.jsx)("h1",{className:"text-3xl font-bold",children:"\uD83D\uDC65 Patients"})}),(0,a.jsxs)("div",{className:"flex flex-col md:flex-row gap-3",children:[(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsx)(u.Z,{value:et,onChange:ea,placeholder:"Rechercher un patient..."})}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:I,onChange:e=>U(e.target.checked),className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),(0,a.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"\uD83D\uDDC4️ Afficher les archives"})]})}),(0,a.jsx)("button",{className:"btn-primary",onClick:_,children:"➕ Nouveau Patient"})]}),(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)(d.Z,{error:W,onRetry:G}),(0,a.jsx)(d.Z,{error:y,onClose:()=>v(null)}),(0,a.jsx)(o.Z,{message:j,onClose:()=>b(null)}),H?(0,a.jsx)(c.Z,{size:"lg",text:"Chargement des patients..."}):(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{className:"border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Nom"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Date Naissance"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Email"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"T\xe9l\xe9phone"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Ville"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Code Postal"}),(0,a.jsx)("th",{className:"text-left py-3 px-4 text-gray-700 dark:text-gray-300",children:"Dispositif"}),(0,a.jsx)("th",{className:"text-right py-3 px-4 text-gray-700 dark:text-gray-300",children:"Actions"})]})}),(0,a.jsx)("tbody",{children:0===ei.length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:"8",className:"py-8 text-center text-gray-500 dark:text-gray-400",children:et?"Aucun patient ne correspond \xe0 la recherche":"Aucun patient"})}):ei.map((e,s)=>{let i=!!e.deleted_at;return(0,a.jsxs)("tr",{className:"table-row animate-slide-up hover:bg-gray-50 dark:hover:bg-gray-800 ".concat(i?"opacity-60":""),style:{animationDelay:"".concat(.05*s,"s")},children:[(0,a.jsx)("td",{className:"table-cell py-3 px-4 font-medium text-primary",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("span",{children:[e.first_name," ",e.last_name]}),i?(0,a.jsx)("span",{className:"badge bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 text-xs",children:"\uD83D\uDDC4️ Archiv\xe9"}):(0,a.jsx)("span",{className:"badge badge-success",children:"✅ Actif"})]})}),(0,a.jsx)("td",{className:"table-cell",children:e.birth_date?new Date(e.birth_date).toLocaleDateString("fr-FR"):"-"}),(0,a.jsx)("td",{className:"table-cell",children:e.email||"-"}),(0,a.jsx)("td",{className:"table-cell text-sm",children:e.phone||"-"}),(0,a.jsx)("td",{className:"table-cell text-sm",children:e.city||"-"}),(0,a.jsx)("td",{className:"table-cell text-sm",children:e.postal_code||"-"}),(0,a.jsx)("td",{className:"table-cell py-3 px-4",children:(0,a.jsx)("div",{className:"flex items-center gap-2",children:(()=>{if(i){let s=$.find(s=>s.patient_id===e.id);return s?(0,a.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,a.jsx)("p",{className:"font-medium text-primary",children:s.device_name||s.sim_iccid}),(0,a.jsx)("p",{className:"text-xs text-muted font-mono",children:s.sim_iccid})]}):(0,a.jsx)("span",{className:"flex-1 text-sm text-gray-500",children:"Non assign\xe9"})}let s=$.find(s=>s.patient_id===e.id);return s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>er(s),disabled:w===s.id,title:"D\xe9sassigner le dispositif du patient",children:(0,a.jsx)("span",{className:"text-lg",children:w===s.id?"⏳":"\uD83D\uDD13"})}),(0,a.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,a.jsx)("p",{className:"font-medium text-primary",children:s.device_name||s.sim_iccid}),(0,a.jsx)("p",{className:"text-xs text-muted font-mono",children:s.sim_iccid})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors",onClick:()=>ed(e),disabled:0===ee.length,title:0===ee.length?"Aucun dispositif libre disponible":"Assigner un dispositif libre au patient",children:(0,a.jsx)("span",{className:"text-lg",children:"\uD83D\uDD17"})}),(0,a.jsx)("span",{className:"flex-1 text-sm text-amber-600",children:"Non assign\xe9"})]})})()})}),(0,a.jsx)("td",{className:"table-cell py-3 px-4",children:(0,a.jsx)("div",{className:"flex items-center justify-end gap-2",children:i?(0,a.jsx)("button",{onClick:()=>em(e),disabled:V===e.id,className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors disabled:opacity-50",title:"Restaurer le patient",children:(0,a.jsx)("span",{className:"text-lg",children:V===e.id?"⏳":"♻️"})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors",onClick:()=>k(e),title:"Modifier le patient",children:(0,a.jsx)("span",{className:"text-lg",children:"✏️"})}),f("patients.edit")&&(0,a.jsx)(a.Fragment,{children:(null==t?void 0:t.role_name)==="admin"?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>handleArchive(e),disabled:M,title:"Archiver le patient",children:(0,a.jsx)("span",{className:"text-lg",children:M?"⏳":"\uD83D\uDDC4️"})}),(0,a.jsx)("button",{className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors",onClick:()=>handlePermanentDelete(e),disabled:M,title:"Supprimer d\xe9finitivement le patient",children:(0,a.jsx)("span",{className:"text-lg",children:M?"⏳":"\uD83D\uDDD1️"})})]}):(0,a.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>handleArchive(e),disabled:M,title:"Archiver le patient",children:(0,a.jsx)("span",{className:"text-lg",children:M?"⏳":"\uD83D\uDDC4️"})})})]})})})]},e.id)})})]})})]}),(0,a.jsx)(m.Z,{isOpen:N,onClose:C,editingItem:D,type:"patient",onSave:eu,fetchWithAuth:p,API_URL:g,roles:[]}),(0,a.jsx)(x.Z,{isOpen:P,onClose:eo,title:F?"\uD83D\uDD17 Assigner un dispositif \xe0 ".concat(F.first_name," ").concat(F.last_name):"",children:F&&(0,a.jsxs)(a.Fragment,{children:[y&&(0,a.jsx)("div",{className:"alert alert-warning mb-4",children:y}),0===ee.length?(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aucun dispositif libre disponible"}),(0,a.jsx)("button",{className:"btn-secondary",onClick:eo,children:"Fermer"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"S\xe9lectionner un dispositif libre :"}),(0,a.jsxs)("select",{id:"device-select",className:"input w-full",defaultValue:"",children:[(0,a.jsx)("option",{value:"",children:"— S\xe9lectionner un dispositif —"}),ee.map(e=>(0,a.jsxs)("option",{value:e.id,children:[e.device_name||e.sim_iccid," ",e.sim_iccid?"(".concat(e.sim_iccid,")"):""]},e.id))]})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{className:"btn-secondary",onClick:eo,disabled:null!==S,children:"Annuler"}),(0,a.jsx)("button",{className:"btn-primary",onClick:()=>{let e=document.getElementById("device-select"),s=e?parseInt(e.value,10):null;s?el(F,s):v("Veuillez s\xe9lectionner un dispositif")},disabled:null!==S,children:S?"⏳ Assignation...":"\uD83D\uDD17 Assigner"})]})]})]})}),(0,a.jsx)(x.Z,{isOpen:T,onClose:ec,title:"\uD83D\uDD13 D\xe9sassigner le dispositif",children:q&&(0,a.jsxs)(a.Fragment,{children:[y&&(0,a.jsx)("div",{className:"alert alert-warning mb-4",children:y}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mb-2",children:"\xcates-vous s\xfbr de vouloir d\xe9sassigner le dispositif :"}),(0,a.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[(0,a.jsx)("p",{className:"font-medium text-primary",children:q.device_name||q.sim_iccid}),(0,a.jsx)("p",{className:"text-xs text-muted font-mono mt-1",children:q.sim_iccid})]}),(0,a.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-3",children:"⚠️ Le dispositif sera r\xe9initialis\xe9 avec les param\xe8tres d'origine et disponible pour une nouvelle assignation."})]}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{className:"btn-secondary",onClick:ec,disabled:w===q.id,children:"Annuler"}),(0,a.jsx)("button",{className:"btn-primary bg-orange-500 hover:bg-orange-600",onClick:()=>en(q),disabled:w===q.id,children:w===q.id?"⏳ D\xe9sassignation...":"\uD83D\uDD13 D\xe9sassigner"})]})]})})]})}}},function(e){e.O(0,[7410,376,2971,2117,1744],function(){return e(e.s=9200)}),_N_E=e.O()}]);