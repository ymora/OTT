(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3668],{9200:function(e,s,t){Promise.resolve().then(t.bind(t,8434))},8434:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return g},dynamic:function(){return h}});var i=t(7437),a=t(2265),n=t(9999),l=t(2617),r=t(5506),c=t(832),d=t(9723),o=t(6601),u=t(2919),m=t(899),p=t(798),x=t(8828);let h="force-dynamic";function g(){var e,s;let{fetchWithAuth:t,API_URL:h}=(0,n.a)(),[g,f]=(0,a.useState)(null),[b,j]=(0,a.useState)(null),{isOpen:v,editingItem:N,openCreate:y,openEdit:_,close:D}=(0,r.f7)(),[k,C]=(0,a.useState)(null),[w,S]=(0,a.useState)(null),[A,E]=(0,a.useState)(!1),[P,Z]=(0,a.useState)(null),[F,O]=(0,a.useState)(!1),[q,L]=(0,a.useState)(null),[T,I]=(0,a.useState)(!1),[z,R]=(0,a.useState)(null),[U,V]=(0,a.useState)(!1),{data:J,loading:M,error:W,refetch:B}=(0,r.m_)(["/api.php/patients","/api.php/devices"],{requiresAuth:!0});(0,r.w3)(B,3e4),(0,r.iq)(B);let G=(null==J?void 0:null===(e=J.patients)||void 0===e?void 0:e.patients)||[],H=(null==J?void 0:null===(s=J.devices)||void 0===s?void 0:s.devices)||[],K=(0,a.useMemo)(()=>(H||[]).filter(e=>e.patient_id),[H]),Q=(0,a.useMemo)(()=>(H||[]).filter(e=>!e.patient_id&&!e.deleted_at),[H]),{searchTerm:X,setSearchTerm:Y,filteredItems:$}=(0,r.L0)(G,{searchFn:(e,s)=>{let t=s.toLowerCase();return e.filter(e=>"".concat(e.first_name||""," ").concat(e.last_name||""," ").concat(e.email||""," ").concat(e.phone||""," ").concat(e.device_name||"").toLowerCase().includes(t))}}),ee=async(e,s)=>{if(!s){j("Veuillez s\xe9lectionner un dispositif");return}try{S(s),j(null),await (0,l.r)(t,h,"/api.php/devices/".concat(s),{method:"PUT",body:JSON.stringify({patient_id:e.id})},{requiresAuth:!0}),E(!1),Z(null),await B(),f("Dispositif assign\xe9 avec succ\xe8s \xe0 ".concat(e.first_name," ").concat(e.last_name))}catch(s){let e="Erreur lors de l'assignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),j(e),x.Z.error("Erreur assignation dispositif:",s)}finally{S(null)}},es=async e=>{try{C(e.id),j(null),await (0,l.r)(t,h,"/api.php/devices/".concat(e.id),{method:"PUT",body:JSON.stringify({patient_id:null})},{requiresAuth:!0});try{await (0,l.r)(t,h,"/api.php/devices/".concat(e.id,"/config"),{method:"PUT",body:JSON.stringify({sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:null,calibration_coefficients:null})},{requiresAuth:!0})}catch(e){x.Z.warn("Erreur r\xe9initialisation config dispositif:",e)}O(!1),L(null),await B(),f("Dispositif d\xe9sassign\xe9 et r\xe9initialis\xe9 avec succ\xe8s")}catch(s){let e="Erreur lors de la d\xe9sassignation du dispositif";s.message?e=s.message:s.error&&(e=s.error),j(e),x.Z.error("Erreur d\xe9sassignation dispositif:",s)}finally{C(null)}},et=e=>{L(e),O(!0),j(null)},ei=()=>{O(!1),L(null),j(null)},ea=e=>{Z(e),j(null),B(),E(!0)},en=()=>{E(!1),Z(null),j(null)},el=async()=>{f(N?"Patient modifi\xe9 avec succ\xe8s":"Patient cr\xe9\xe9 avec succ\xe8s"),await new Promise(e=>setTimeout(e,100)),await B()},er=async function(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=K.some(s=>s.patient_id===e.id);if(!s&&i){R(e),I(!0);return}if(s||i||confirm('⚠️ \xcates-vous s\xfbr de vouloir supprimer le patient "'.concat(e.first_name," ").concat(e.last_name,'" ?\n\nCette action est irr\xe9versible.')))try{V(!0),j(null),f(null);let s=await (0,l.r)(t,h,"/api.php/patients/".concat(e.id),{method:"DELETE"},{requiresAuth:!0});s.success?(f(s.message||"Patient supprim\xe9 avec succ\xe8s"),s.devices_unassigned>0&&f("Patient supprim\xe9 avec succ\xe8s (".concat(s.devices_unassigned," dispositif(s) d\xe9sassign\xe9(s) automatiquement)")),B(),v&&N&&N.id===e.id&&D(),I(!1),R(null)):j(s.error||"Erreur lors de la suppression")}catch(s){let e="Erreur lors de la suppression du patient";s.message?e=s.message:s.error&&(e=s.error),j(e),x.Z.error("Erreur suppression patient:",s)}finally{V(!1)}},ec=(0,a.useCallback)(()=>{z&&er(z,!0)},[z]);return(0,i.jsxs)("div",{className:"space-y-6 animate-fade-in",children:[(0,i.jsx)("div",{children:(0,i.jsx)("h1",{className:"text-3xl font-bold",children:"\uD83D\uDC65 Patients"})}),(0,i.jsxs)("div",{className:"flex flex-col md:flex-row gap-3",children:[(0,i.jsx)("div",{className:"flex-1",children:(0,i.jsx)(u.Z,{value:X,onChange:Y,placeholder:"Rechercher un patient..."})}),(0,i.jsx)("button",{className:"btn-primary",onClick:y,children:"➕ Nouveau Patient"})]}),(0,i.jsxs)("div",{className:"card",children:[(0,i.jsx)(d.Z,{error:W,onRetry:B}),(0,i.jsx)(d.Z,{error:b,onClose:()=>j(null)}),(0,i.jsx)(o.Z,{message:g,onClose:()=>f(null)}),M?(0,i.jsx)(c.Z,{size:"lg",text:"Chargement des patients..."}):(0,i.jsx)("div",{className:"overflow-x-auto",children:(0,i.jsxs)("table",{className:"w-full",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{className:"border-b border-gray-200",children:[(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Nom"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Date Naissance"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Email"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"T\xe9l\xe9phone"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Ville"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Code Postal"}),(0,i.jsx)("th",{className:"text-left py-3 px-4",children:"Dispositif"}),(0,i.jsx)("th",{className:"text-right py-3 px-4",children:"Actions"})]})}),(0,i.jsx)("tbody",{children:0===$.length?(0,i.jsx)("tr",{children:(0,i.jsx)("td",{colSpan:"8",className:"py-8 text-center text-muted",children:X?"Aucun patient ne correspond \xe0 la recherche":"Aucun patient"})}):$.map((e,s)=>(0,i.jsxs)("tr",{className:"table-row animate-slide-up hover:bg-gray-50 dark:hover:bg-gray-800",style:{animationDelay:"".concat(.05*s,"s")},children:[(0,i.jsxs)("td",{className:"py-3 px-4 font-medium text-primary",children:[e.first_name," ",e.last_name]}),(0,i.jsx)("td",{className:"table-cell",children:e.birth_date?new Date(e.birth_date).toLocaleDateString("fr-FR"):"-"}),(0,i.jsx)("td",{className:"table-cell",children:e.email||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.phone||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.city||"-"}),(0,i.jsx)("td",{className:"table-cell text-sm",children:e.postal_code||"-"}),(0,i.jsx)("td",{className:"py-3 px-4",children:(0,i.jsx)("div",{className:"flex items-center gap-2",children:(()=>{let s=K.find(s=>s.patient_id===e.id);return s?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors",onClick:()=>et(s),disabled:k===s.id,title:"D\xe9sassigner le dispositif du patient",children:(0,i.jsx)("span",{className:"text-lg",children:k===s.id?"⏳":"\uD83D\uDD13"})}),(0,i.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,i.jsx)("p",{className:"font-medium text-primary",children:s.device_name||s.sim_iccid}),(0,i.jsx)("p",{className:"text-xs text-muted font-mono",children:s.sim_iccid})]})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("button",{className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors",onClick:()=>ea(e),disabled:0===Q.length,title:0===Q.length?"Aucun dispositif libre disponible":"Assigner un dispositif libre au patient",children:(0,i.jsx)("span",{className:"text-lg",children:"\uD83D\uDD17"})}),(0,i.jsx)("span",{className:"flex-1 text-sm text-amber-600",children:"Non assign\xe9"})]})})()})}),(0,i.jsx)("td",{className:"py-3 px-4",children:(0,i.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,i.jsx)("button",{className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors",onClick:()=>_(e),title:"Modifier le patient",children:(0,i.jsx)("span",{className:"text-lg",children:"✏️"})}),(0,i.jsx)("button",{className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors",onClick:()=>er(e),disabled:U,title:K.some(s=>s.patient_id===e.id)?"Supprimer le patient (le dispositif sera d\xe9sassign\xe9 automatiquement)":"Supprimer le patient",children:(0,i.jsx)("span",{className:"text-lg",children:U?"⏳":"\uD83D\uDDD1️"})})]})})]},e.id))})]})})]}),(0,i.jsx)(m.Z,{isOpen:v,onClose:D,editingItem:N,type:"patient",onSave:el,fetchWithAuth:t,API_URL:h,roles:[]}),(0,i.jsx)(p.Z,{isOpen:A,onClose:en,title:P?"\uD83D\uDD17 Assigner un dispositif \xe0 ".concat(P.first_name," ").concat(P.last_name):"",children:P&&(0,i.jsxs)(i.Fragment,{children:[b&&(0,i.jsx)("div",{className:"alert alert-warning mb-4",children:b}),0===Q.length?(0,i.jsxs)("div",{className:"text-center py-4",children:[(0,i.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aucun dispositif libre disponible"}),(0,i.jsx)("button",{className:"btn-secondary",onClick:en,children:"Fermer"})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)("label",{className:"block text-sm font-medium mb-2",children:"S\xe9lectionner un dispositif libre :"}),(0,i.jsxs)("select",{id:"device-select",className:"input w-full",defaultValue:"",children:[(0,i.jsx)("option",{value:"",children:"— S\xe9lectionner un dispositif —"}),Q.map(e=>(0,i.jsxs)("option",{value:e.id,children:[e.device_name||e.sim_iccid," ",e.sim_iccid?"(".concat(e.sim_iccid,")"):""]},e.id))]})]}),(0,i.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,i.jsx)("button",{className:"btn-secondary",onClick:en,disabled:null!==w,children:"Annuler"}),(0,i.jsx)("button",{className:"btn-primary",onClick:()=>{let e=document.getElementById("device-select"),s=e?parseInt(e.value,10):null;s?ee(P,s):j("Veuillez s\xe9lectionner un dispositif")},disabled:null!==w,children:w?"⏳ Assignation...":"\uD83D\uDD17 Assigner"})]})]})]})}),(0,i.jsx)(p.Z,{isOpen:F,onClose:ei,title:"\uD83D\uDD13 D\xe9sassigner le dispositif",children:q&&(0,i.jsxs)(i.Fragment,{children:[b&&(0,i.jsx)("div",{className:"alert alert-warning mb-4",children:b}),(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)("p",{className:"text-gray-700 dark:text-gray-300 mb-2",children:"\xcates-vous s\xfbr de vouloir d\xe9sassigner le dispositif :"}),(0,i.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 p-3 rounded-lg",children:[(0,i.jsx)("p",{className:"font-medium text-primary",children:q.device_name||q.sim_iccid}),(0,i.jsx)("p",{className:"text-xs text-muted font-mono mt-1",children:q.sim_iccid})]}),(0,i.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-3",children:"⚠️ Le dispositif sera r\xe9initialis\xe9 avec les param\xe8tres d'origine et disponible pour une nouvelle assignation."})]}),(0,i.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,i.jsx)("button",{className:"btn-secondary",onClick:ei,disabled:k===q.id,children:"Annuler"}),(0,i.jsx)("button",{className:"btn-primary bg-orange-500 hover:bg-orange-600",onClick:()=>es(q),disabled:k===q.id,children:k===q.id?"⏳ D\xe9sassignation...":"\uD83D\uDD13 D\xe9sassigner"})]})]})}),(0,i.jsx)(p.Z,{isOpen:T,onClose:()=>{I(!1),R(null)},title:"Confirmer la suppression",maxWidth:"max-w-md",children:(0,i.jsxs)("div",{className:"space-y-4",children:[(0,i.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["\xcates-vous s\xfbr de vouloir supprimer le patient ",(0,i.jsxs)("strong",{children:[null==z?void 0:z.first_name," ",null==z?void 0:z.last_name]})," ?"]}),z&&K.some(e=>e.patient_id===z.id)&&(0,i.jsxs)("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg",children:[(0,i.jsxs)("p",{className:"text-sm text-amber-800 dark:text-amber-300",children:["⚠️ ",(0,i.jsx)("strong",{children:"Attention :"})," Ce patient a un dispositif assign\xe9."]}),(0,i.jsx)("p",{className:"text-sm text-amber-700 dark:text-amber-400 mt-2",children:"Le dispositif sera d\xe9sassign\xe9 automatiquement avant suppression."})]}),(0,i.jsxs)("div",{className:"flex justify-end gap-3 mt-6",children:[(0,i.jsx)("button",{onClick:()=>{I(!1),R(null)},className:"btn-secondary",disabled:U,children:"Annuler"}),(0,i.jsx)("button",{onClick:ec,className:"btn-danger",disabled:U,children:U?"⏳ Suppression...":"\uD83D\uDDD1️ Supprimer"})]})]})})]})}},798:function(e,s,t){"use strict";t.d(s,{Z:function(){return a}});var i=t(7437);function a(e){let{isOpen:s,onClose:t,title:a,children:n,maxWidth:l="max-w-md"}=e;return s?(0,i.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",onClick:t,children:(0,i.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl ".concat(l," w-full mx-4 p-6"),onClick:e=>e.stopPropagation(),children:[(a||t)&&(0,i.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[a&&(0,i.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:a}),t&&(0,i.jsx)("button",{onClick:t,className:"w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",title:"Fermer","aria-label":"Fermer",children:(0,i.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,i.jsx)("div",{className:"text-gray-700 dark:text-gray-300",children:n})]})}):null}}},function(e){e.O(0,[2200,5223,2971,2117,1744],function(){return e(e.s=9200)}),_N_E=e.O()}]);