(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8014],{4408:function(e,t,a){Promise.resolve().then(a.bind(a,9921))},9921:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return w},dynamic:function(){return _}});var r=a(7437),s=a(2265),i=a(9999),l=a(4767),n=a(5993),c=a(8828),o=a(2617),d=a(832),u=a(9723),m=a(798);function x(e){var t,a;let{onUploadSuccess:l}=e,{fetchWithAuth:x,API_URL:p,token:g}=(0,i.a)(),[h,f]=(0,s.useState)(null),[v,b]=(0,s.useState)(""),[y,j]=(0,s.useState)(""),[_,w]=(0,s.useState)(!1),[N,k]=(0,s.useState)(!1),[E,D]=(0,s.useState)(0),[C,S]=(0,s.useState)(null),[T,A]=(0,s.useState)(null),[O,I]=(0,s.useState)(null),[Z,R]=(0,s.useState)(!1),[F,L]=(0,s.useState)(null),[U,P]=(0,s.useState)(null),[q,B]=(0,s.useState)(null),[M,J]=(0,s.useState)(!1),[V,z]=(0,s.useState)(!1),[H,G]=(0,s.useState)(null),[W,X]=(0,s.useState)(null),{createTimeout:Y}=(0,n.H2)(),[K,Q]=(0,s.useState)(!0),$=(0,s.useRef)(null),ee=(0,s.useRef)(null),[et,ea]=(0,s.useState)(!1),[er,es]=(0,s.useState)(0),[ei,el]=(0,s.useState)([]),[en,ec]=(0,s.useState)(null),[eo,ed]=(0,s.useState)(!1),[eu,em]=(0,s.useState)(!1),ex=(0,s.useRef)(null),ep=(0,s.useRef)(null),{data:eg,loading:eh,refetch:ef,invalidateCache:ev}=(0,n.m_)(["/api.php/firmwares"],{requiresAuth:!0,cacheTTL:0}),eb=(null==eg?void 0:null===(t=eg.firmwares)||void 0===t?void 0:t.firmwares)||[],ey=(0,s.useMemo)(()=>eb.filter(e=>!!("pending_compilation"===e.status||e.file_path&&e.file_path.endsWith(".ino")||e.file_path&&e.file_path.includes(".ino"))).sort((e,t)=>new Date(t.created_at)-new Date(e.created_at)),[eb]),ej=(0,s.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,a=e||h,r=null!==t?t:v;if(!a&&!r){A("Veuillez s\xe9lectionner un fichier .ino ou entrer du contenu");return}c.Z.log("[InoEditorTab] \uD83D\uDCE4 D\xe9marrage upload firmware:",(null==a?void 0:a.name)||"contenu \xe9dit\xe9"),k(!0),S("upload"),A(null),I(null),D(0);try{let e=new FormData;if(a)c.Z.debug("[InoEditorTab] Ajout fichier au FormData:",a.name,a.size,"bytes"),e.append("firmware_ino",a);else if(r){c.Z.debug("[InoEditorTab] Cr\xe9ation blob depuis contenu, taille:",r.length);let t=new Blob([r],{type:"text/plain"}),a="firmware_"+Date.now()+".ino";e.append("firmware_ino",t,a)}if(e.append("type","ino"),c.Z.debug("[InoEditorTab] FormData cr\xe9\xe9, envoi vers:","".concat(p,"/api.php/firmwares/upload-ino")),!g)throw c.Z.error("[InoEditorTab] Token manquant!"),Error("Token manquant. Veuillez vous reconnecter.");c.Z.debug("[InoEditorTab] Token pr\xe9sent, cr\xe9ation XMLHttpRequest...");let t=new XMLHttpRequest;t.timeout=3e4,t.upload.addEventListener("progress",e=>{if(e.lengthComputable){let t=Math.round(e.loaded/e.total*100);D(t)}}),t.addEventListener("load",()=>{var e,r;if(200===t.status){let r;try{r=JSON.parse(t.responseText)}catch(e){A("R\xe9ponse invalide du serveur"),k(!1);return}r.success?(D(100),I("Firmware upload\xe9 avec succ\xe8s !"),l&&r.firmware_id&&l(r.firmware_id),ev(),k(!1),f(null),b(""),j(""),w(!1),$.current&&($.current.value=""),Y(()=>{ef().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement:",e)})},300)):(null===(e=r.error)||void 0===e?void 0:e.includes("existe d\xe9j\xe0"))||409===t.status?(L(r.existing_firmware||{version:r.version||"inconnue",id:r.firmware_id}),P(a),R(!0),k(!1),S(null),D(0)):(A(r.error||"Erreur lors de l'upload"),k(!1),S(null))}else{try{let e=JSON.parse(t.responseText);(null===(r=e.error)||void 0===r?void 0:r.includes("existe d\xe9j\xe0"))||409===t.status?(L(e.existing_firmware||{}),P(a),R(!0),k(!1),S(null),D(0)):A(e.error||"Erreur HTTP ".concat(t.status))}catch(e){A("Erreur HTTP ".concat(t.status,": ").concat(t.statusText))}k(!1),S(null)}}),t.addEventListener("error",()=>{A("Erreur r\xe9seau lors de l'upload."),k(!1),S(null)}),t.addEventListener("timeout",()=>{A("La requ\xeate a pris trop de temps (30s)."),k(!1),S(null),t.abort()}),t.open("POST","".concat(p,"/api.php/firmwares/upload-ino")),t.setRequestHeader("Authorization","Bearer ".concat(g)),c.Z.debug("[InoEditorTab] Envoi requ\xeate XHR..."),t.send(e),c.Z.debug("[InoEditorTab] Requ\xeate XHR envoy\xe9e, attente r\xe9ponse...")}catch(e){c.Z.error("❌ Exception lors de l'upload:",e),A(e.message||"Erreur lors de l'upload"),k(!1),S(null)}},[h,v,p,g,ef]),e_=e=>{let t=e.match(/FIRMWARE_VERSION_STR\s+"([^"]+)"/),a=e.match(/FIRMWARE_VERSION\s*=\s*"([^"]+)"/);return t?t[1]:a?a[1]:null},ew=async e=>{try{let t=await x("".concat(p,"/api.php/firmwares/check-version/").concat(encodeURIComponent(e)),{method:"GET"},{requiresAuth:!0});if(404===t.status){let e=await t.json().catch(()=>({}));throw Error(e.error||"Endpoint de v\xe9rification non disponible")}if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur API");return a.exists?a.firmware:null}catch(e){throw c.Z.error("Erreur v\xe9rification version:",e),e}},eN=(0,s.useCallback)(async e=>{var t;c.Z.debug("[InoEditorTab] handleFileSelect appel\xe9",e.target.files);let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a){c.Z.debug("[InoEditorTab] Aucun fichier s\xe9lectionn\xe9");return}if(c.Z.debug("[InoEditorTab] Fichier s\xe9lectionn\xe9:",a.name,a.size,"bytes"),!a.name.endsWith(".ino")){c.Z.error("[InoEditorTab] Fichier non .ino:",a.name),A("Seuls les fichiers .ino sont accept\xe9s"),f(null);return}c.Z.debug("[InoEditorTab] Fichier .ino valide, lecture du contenu..."),f(a),A(null),I(null);try{let e=new FileReader;e.onload=async e=>{var t,r,s;c.Z.debug("[InoEditorTab] Fichier lu avec succ\xe8s, taille:",null===(t=e.target.result)||void 0===t?void 0:t.length);let i=e.target.result;b(i),j(i),w(!1),c.Z.debug("[InoEditorTab] Extraction de la version depuis le contenu...");let l=e_(i);if(c.Z.debug("[InoEditorTab] Version extraite:",l),!l){c.Z.error("[InoEditorTab] Version non trouv\xe9e dans le fichier"),A("Version non trouv\xe9e dans le fichier .ino. Assurez-vous que FIRMWARE_VERSION_STR est d\xe9fini."),f(null),b(""),j("");return}c.Z.debug("[InoEditorTab] V\xe9rification si la version existe d\xe9j\xe0:",l);let n=null,o=!1;try{if(n=await ew(l),c.Z.debug("[InoEditorTab] R\xe9sultat v\xe9rification version:",n?"existe d\xe9j\xe0":"n'existe pas"),n){c.Z.debug("[InoEditorTab] Version existe d\xe9j\xe0, affichage du modal"),o=!0,L(n),P(a),R(!0),$.current&&($.current.value="");return}}catch(t){c.Z.error("[InoEditorTab] Erreur lors de la v\xe9rification version:",t),c.Z.warn("Erreur lors de la v\xe9rification version via API:",t);let e=eb.find(e=>e.version===l);if(e){o=!0,L(e),P(a),R(!0),$.current&&($.current.value="");return}(null===(r=t.message)||void 0===r?void 0:r.includes("404"))||(null===(s=t.message)||void 0===s?void 0:s.includes("Endpoint not found"))?(c.Z.warn("Endpoint de v\xe9rification non disponible, continuation de l'upload"),A("⚠️ L'endpoint de v\xe9rification n'est pas disponible. L'upload continue sans v\xe9rification.")):A("⚠️ Erreur lors de la v\xe9rification: ".concat(t.message,". L'upload continue."))}o||n?c.Z.debug("[InoEditorTab] Upload non lanc\xe9 (versionExists:",o,", existingFirmware:",!!n,")"):(c.Z.debug("[InoEditorTab] Version n'existe pas, lancement automatique de l'upload..."),Y(()=>{c.Z.debug("[InoEditorTab] Appel handleUpload avec file et content"),ej(a,i)},100))},e.onerror=e=>{c.Z.error("[InoEditorTab] Erreur FileReader:",e),A("Erreur lors de la lecture du fichier"),f(null)},c.Z.debug("[InoEditorTab] D\xe9marrage lecture fichier avec FileReader..."),e.readAsText(a)}catch(e){c.Z.error("Erreur lors de la lecture du fichier:",e),A("Erreur lors de la lecture du fichier"),f(null)}},[x,p,eb,ew,ej]),ek=(0,s.useCallback)(e=>{let t=e.target.value;b(t),w(t!==y)},[y]),eE=(0,s.useCallback)(async()=>{if(!v.trim()){A("Le contenu est vide");return}if(!e_(v)){A("Version non trouv\xe9e dans le fichier .ino. Assurez-vous que FIRMWARE_VERSION_STR est d\xe9fini.");return}if(q){let e=v!==y;k(!0),S("upload"),A(null),I(null),D(0);try{let t=await x("".concat(p,"/api.php/firmwares/").concat(q,"/ino"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:v})},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur lors de la mise \xe0 jour");D(100),I(e?"Fichier .ino mis \xe0 jour avec succ\xe8s !":"Fichier .ino upload\xe9 avec succ\xe8s !"),ev(),k(!1),j(v),w(!1),B(null),Y(()=>{ef().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement:",e)})},300)}catch(e){c.Z.error("❌ Erreur lors de la mise \xe0 jour:",e),A(e.message||"Erreur lors de la mise \xe0 jour"),k(!1),S(null)}}else ej(null,v)},[v,q,ej,p,x,ef]),eD=(0,s.useCallback)(()=>{b(y),w(!1),A(null)},[y]),eC=(0,s.useCallback)(async e=>{J(!0),A(null),I(null),B(e);try{let t=await x("".concat(p,"/api.php/firmwares/").concat(e,"/ino"),{method:"GET"},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur lors du chargement");b(a.content),j(a.content),w(!1),Q(!1),Y(()=>{ee.current&&(ee.current.scrollIntoView({behavior:"smooth",block:"start"}),ee.current.focus())},100)}catch(e){c.Z.error("Erreur lors du chargement du fichier .ino:",e),A(e.message||"Erreur lors du chargement du fichier .ino"),B(null)}finally{J(!1)}},[p,x]),eS=(0,s.useCallback)(async()=>{if(H){X(H.id);try{let e=await x("".concat(p,"/api.php/firmwares/").concat(H.id),{method:"DELETE"},{requiresAuth:!0});if(404===e.status){let t=await e.json().catch(()=>({}));throw Error("Erreur syst\xe8me: ".concat(t.error||"Endpoint non disponible"))}if(!e.ok){let t=await e.json().catch(()=>({}));throw Error(t.error||"Erreur HTTP ".concat(e.status))}let t=await e.json();if(!t.success)throw Error(t.error||"Erreur lors de la suppression");z(!1),G(null),q===H.id&&(b(""),j(""),w(!1),B(null)),ev(),Y(()=>{ef().catch(e=>{c.Z.error("Erreur lors du rafra\xeechissement apr\xe8s suppression:",e)})},300)}catch(a){var e,t;A((null===(e=a.message)||void 0===e?void 0:e.includes("404"))||(null===(t=a.message)||void 0===t?void 0:t.includes("Endpoint not found"))?"⚠️ L'endpoint de suppression n'est pas disponible sur le serveur.":"Erreur lors de la suppression : ".concat(a.message)),z(!1),G(null)}finally{X(null)}}},[H,q,p,x,ef]);(0,s.useEffect)(()=>{if(O){let e=setTimeout(()=>{I(null)},4e3);return()=>clearTimeout(e)}},[O]),(0,s.useEffect)(()=>{if(T){let e=setTimeout(()=>{A(null)},4e3);return()=>clearTimeout(e)}},[T]);let eT=(0,s.useCallback)(()=>{ex.current&&(ex.current.close(),ex.current=null)},[]),eA=(0,s.useCallback)(()=>{ea(!1),ec(null),es(0),eT()},[eT]),eO=(0,s.useCallback)(async e=>{if(!e){A("ID du firmware manquant pour la compilation.");return}if(et&&en===e){A("Compilation d\xe9j\xe0 en cours pour ce firmware.");return}eT(),ea(!0),ec(e),es(0),A(null),I(null),ed(!1),el([{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⏳ D\xe9marrage de la compilation...",level:"info"}]),ef();try{let t=encodeURIComponent(g),a="".concat(p,"/api.php/firmwares/compile/").concat(e,"?token=").concat(t),r=new EventSource(a);ex.current=r,r.onopen=()=>{el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Connexion SSE \xe9tablie, d\xe9marrage de la compilation...",level:"info"}])},r.onmessage=e=>{if(!(!e.data||""===e.data.trim()||e.data.trim().startsWith(":")))try{let t=JSON.parse(e.data);"log"===t.type?el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:t.message,level:t.level||"info"}]):"progress"===t.type?es(t.progress||0):"success"===t.type?(I("✅ Compilation r\xe9ussie ! Firmware v".concat(t.version," disponible")),el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Compilation termin\xe9e avec succ\xe8s !",level:"info"}]),eA(),r.close(),ef()):"error"===t.type&&(A(t.message||"Erreur lors de la compilation"),el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"❌ Erreur de compilation: ".concat(t.message||"Inconnue"),level:"error"}]),eA(),r.close(),ef())}catch(e){el(t=>[...t,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"❌ Erreur de traitement du message SSE: ".concat(e.message),level:"error"}])}},r.onerror=t=>{let a=t.message||"Connexion interrompue";el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⚠️ Connexion SSE interrompue: ".concat(a),level:"warning"}]),el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"ℹ️ La compilation continue en arri\xe8re-plan. V\xe9rification du statut...",level:"info"}]),setTimeout(()=>{r.readyState===EventSource.CLOSED&&Y(async()=>{try{let t=await x("/api.php/firmwares"),a=await t.json();if(a.success&&a.firmwares){let t=a.firmwares.find(t=>t.id===e);t&&("compiled"===t.status?(I("✅ Compilation r\xe9ussie ! Firmware v".concat(t.version," disponible")),el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"✅ Compilation termin\xe9e avec succ\xe8s (v\xe9rifi\xe9e apr\xe8s reconnexion)",level:"info"}]),eA(),ef()):"compiling"===t.status?el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⏳ La compilation est toujours en cours. R\xe9essayez dans quelques instants.",level:"info"}]):"error"===t.status&&(A("Erreur de compilation: ".concat(t.error_message||"Erreur inconnue")),eA(),ef()))}}catch(e){el(e=>[...e,{timestamp:new Date().toLocaleTimeString("fr-FR"),message:"⚠️ Impossible de v\xe9rifier le statut. La compilation peut continuer en arri\xe8re-plan.",level:"warning"}])}},5e3)},3e3)}}catch(e){A(e.message||"Erreur lors du d\xe9marrage de la compilation."),eA()}},[p,g,et,en,eT,eA,ef]);(0,s.useEffect)(()=>()=>{ex.current&&eT()},[eT]),(0,s.useEffect)(()=>{ep.current&&et&&ei.length>0&&(ep.current.scrollTop=ep.current.scrollHeight)},[ei.length,et]);let eI=(0,s.useCallback)(()=>{if(0===ei.length)return;let e=ei.map(e=>"[".concat(e.timestamp,"] ").concat(e.message)).join("\n");navigator.clipboard.writeText(e).then(()=>{em(!0),Y(()=>em(!1),2e3)}).catch(e=>{A("Erreur lors de la copie des logs")})},[ei]);return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"\uD83D\uDCE6 Fichiers INO existants"}),eh?(0,r.jsx)(d.Z,{}):0===ey.length?(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Aucun fichier .ino disponible"}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[(0,r.jsx)("thead",{className:"bg-gray-50 dark:bg-gray-800",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Version"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Taille"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Statut"}),(0,r.jsx)("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Date"}),(0,r.jsx)("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase",children:"Actions"})]})}),(0,r.jsx)("tbody",{children:ey.map(e=>(0,r.jsxs)("tr",{className:"table-row",children:[(0,r.jsx)("td",{className:"py-3 px-4",children:(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("span",{className:"font-mono font-semibold text-primary",children:["v",e.version]})})}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm text-gray-600 dark:text-gray-400",children:e.file_size?"".concat((e.file_size/1024).toFixed(2)," KB"):"-"}),(0,r.jsx)("td",{className:"py-3 px-4",children:e.status&&(0,r.jsx)("span",{className:"badge ".concat("pending_compilation"===e.status?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300":"compiling"===e.status?"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300":"compiled"===e.status?"badge-success":"error"===e.status?"badge-danger":"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300"," text-xs"),children:"pending_compilation"===e.status?"✅ Upload\xe9":"compiling"===e.status?"Compilation":"compiled"===e.status?"Compil\xe9":"error"===e.status?"Erreur":e.status})}),(0,r.jsx)("td",{className:"py-3 px-4 text-sm text-gray-600 dark:text-gray-400",children:new Date(e.created_at).toLocaleDateString("fr-FR")}),(0,r.jsx)("td",{className:"py-3 px-4 text-center",children:(0,r.jsxs)("div",{className:"flex items-center justify-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>eO(e.id),disabled:et&&en===e.id,className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:et&&en===e.id?"Compilation en cours...":"Compiler le firmware",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDD28"})}),(0,r.jsx)("button",{onClick:()=>{q===e.id&&""!==v.trim()?(b(""),j(""),w(!1),B(null),A(null),I(null),Q(!0)):eC(e.id)},disabled:M,className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors disabled:opacity-50",title:q===e.id&&""!==v.trim()?"Fermer l'\xe9diteur":"\xc9diter le fichier .ino",children:(0,r.jsx)("span",{className:"text-lg",children:"✏️"})}),(0,r.jsx)("button",{onClick:()=>{G(e),z(!0)},disabled:W===e.id,className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors disabled:opacity-50",title:"Supprimer le fichier .ino",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDDD1️"})})]})})]},e.id))})]})})]}),(et||ei.length>0)&&(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"\uD83D\uDD28 Compilation en cours"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[er>0&&(0,r.jsxs)("span",{className:"text-sm font-semibold text-primary-600 dark:text-primary-400",children:[er,"%"]}),ei.length>0&&(0,r.jsx)("button",{onClick:eI,className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors",title:"Copier les logs",children:eu?"✅ Copi\xe9!":"\uD83D\uDCCB Copier"}),(0,r.jsx)("button",{onClick:()=>ed(!eo),className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200",title:eo?"Afficher les logs":"Masquer les logs",children:eo?"⬆️":"⬇️"})]})]}),!eo&&(0,r.jsxs)(r.Fragment,{children:[er>0&&(0,r.jsx)("div",{className:"space-y-2 mb-4",children:(0,r.jsx)("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,r.jsx)("div",{className:"h-3 rounded-full transition-all duration-300 ".concat(et?"bg-blue-500":100===er?"bg-green-500":"bg-gray-300 dark:bg-gray-600"),style:{width:"".concat(Math.max(0,Math.min(100,er)),"%")}})})}),(0,r.jsx)("div",{ref:ep,className:"bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-96 overflow-y-auto",children:0===ei.length?(0,r.jsx)("div",{className:"text-gray-500",children:"En attente des logs..."}):ei.map((e,t)=>(0,r.jsxs)("div",{className:"mb-1",children:[(0,r.jsx)("span",{className:"text-gray-500 pr-3",children:e.timestamp}),(0,r.jsx)("span",{className:"error"===e.level?"text-red-400":"warning"===e.level?"text-yellow-400":"text-green-300",children:e.message})]},t))})]})]}),(0,r.jsxs)("div",{className:"card",children:[(0,r.jsx)("input",{ref:$,type:"file",accept:".ino",onChange:eN,disabled:N,className:"hidden",id:"file-upload-input"}),(0,r.jsx)("label",{htmlFor:"file-upload-input",className:"\n            block w-full py-4 px-6 text-center text-lg font-semibold rounded-lg\n            bg-purple-600 hover:bg-purple-700 text-white\n            transition-all duration-200 cursor-pointer\n            disabled:opacity-50 disabled:cursor-not-allowed\n            ".concat(N?"opacity-50 cursor-not-allowed":"hover:shadow-lg","\n          "),children:N?"⏳ Upload en cours...":"➕ Ajouter"})]}),q&&(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"\uD83D\uDCDD \xc9diteur INO"}),(0,r.jsx)("button",{onClick:()=>Q(!K),className:"text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200",title:K?"Afficher l'\xe9diteur":"Masquer l'\xe9diteur",children:K?"⬆️":"⬇️"})]}),!K&&(0,r.jsx)("div",{className:"space-y-4",children:v?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:q?"Fichier .ino - Version v".concat((null===(a=ey.find(e=>e.id===q))||void 0===a?void 0:a.version)||""):"Contenu du fichier .ino"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[_&&(0,r.jsx)("button",{onClick:eD,className:"btn-secondary text-sm",disabled:N,children:"↺ R\xe9initialiser"}),(!q||_)&&(0,r.jsx)("button",{onClick:eE,disabled:N,className:"btn-primary text-sm ".concat(N?"opacity-50 cursor-not-allowed":""),children:_?"\uD83D\uDCBE Enregistrer et Uploader":"\uD83D\uDCE4 Uploader"})]})]}),(0,r.jsx)("textarea",{ref:ee,value:v,onChange:ek,disabled:N,className:"w-full h-96 font-mono text-sm p-4 border border-gray-300 dark:border-gray-600    rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-gray-100   disabled:opacity-50 disabled:cursor-not-allowed resize-y",placeholder:"Le contenu du fichier .ino appara\xeetra ici..."}),_&&(0,r.jsx)("p",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:"⚠️ Le fichier a \xe9t\xe9 modifi\xe9. N'oubliez pas d'enregistrer !"})]}):(0,r.jsxs)("div",{className:"text-center py-12 text-gray-500 dark:text-gray-400",children:[(0,r.jsx)("p",{className:"mb-2",children:"Aucun fichier charg\xe9"}),(0,r.jsx)("p",{className:"text-sm",children:"S\xe9lectionnez un fichier .ino ci-dessus ou cliquez sur un fichier existant pour l'\xe9diter"})]})})]}),T&&(0,r.jsx)(u.Z,{error:T,onClose:()=>A(null),autoClose:4e3}),(0,r.jsx)(m.Z,{isOpen:V,onClose:()=>{z(!1),G(null)},title:"Confirmer la suppression",maxWidth:"max-w-md",children:H&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["\xcates-vous s\xfbr de vouloir supprimer le fichier .ino ",(0,r.jsxs)("strong",{children:["v",H.version]})," ?"]}),(0,r.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Cette action est irr\xe9versible."}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>{z(!1),G(null)},className:"btn-secondary",children:"Annuler"}),(0,r.jsx)("button",{onClick:eS,disabled:W===(null==H?void 0:H.id),className:"btn-danger",children:W===(null==H?void 0:H.id)?"⏳ Suppression...":"\uD83D\uDDD1️ Supprimer"})]})]})}),Z&&(0,r.jsx)(m.Z,{isOpen:Z,onClose:()=>{R(!1),L(null),P(null)},title:"Version de firmware d\xe9j\xe0 existante",maxWidth:"max-w-lg",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("p",{className:"text-gray-700 dark:text-gray-300",children:["La version ",(0,r.jsxs)("strong",{children:["v",null==F?void 0:F.version]})," existe d\xe9j\xe0."]}),F&&(0,r.jsxs)("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg",children:[(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-2",children:(0,r.jsx)("strong",{children:"Firmware existant :"})}),(0,r.jsxs)("ul",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:[(0,r.jsxs)("li",{children:["Version : ",(0,r.jsxs)("strong",{children:["v",F.version]})]}),(0,r.jsxs)("li",{children:["Date : ",F.created_at?new Date(F.created_at).toLocaleString("fr-FR"):"Inconnue"]})]})]}),(0,r.jsx)("p",{className:"text-gray-700 dark:text-gray-300",children:"Voulez-vous supprimer le firmware existant et le remplacer par le nouveau ?"}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>{R(!1),L(null),P(null)},className:"btn-secondary",children:"Annuler"}),(0,r.jsx)("button",{onClick:async()=>{if(F)try{await (0,o.fetchJson)(x,p,"/api.php/firmwares/".concat(F.id),{method:"DELETE"},{requiresAuth:!0}),R(!1),L(null),P(null),U?Y(()=>{ej(U)},500):v&&Y(()=>{ej(null,v)},500)}catch(e){A("Erreur lors de la suppression : "+e.message)}},className:"btn-danger",children:"Supprimer et remplacer"})]})]})})]})}var p=a(542);a(9131);var g=a(4807),h=a(8139);function f(e){let{isOpen:t,onClose:a,device:d,preselectedFirmwareVersion:u=null,flashMode:m="usb"}=e,{fetchWithAuth:x,API_URL:p}=(0,i.a)(),[f,v]=(0,s.useState)([]),[b,y]=(0,s.useState)(null),[j,_]=(0,s.useState)(!0),[w,N]=(0,s.useState)(null),[k,E]=(0,s.useState)(!1),[D,C]=(0,s.useState)(0),[S,T]=(0,s.useState)([]),[A,O]=(0,s.useState)(!1),[I,Z]=(0,s.useState)(null),[R,F]=(0,s.useState)(m),[L,U]=(0,s.useState)(null),[P,q]=(0,s.useState)({lastCheck:null,attempts:0}),B=(0,s.useRef)(null),M=(0,s.useRef)(null),{createTimeout:J,createInterval:V}=(0,n.H2)();(0,s.useEffect)(()=>()=>{M.current&&clearInterval(M.current)},[]);let{isConnected:z,isSupported:H,usbStreamStatus:G,pauseUsbStreaming:W}=(0,l.l)(),{port:X,isConnected:Y,isSupported:K,error:Q,requestPort:$,connect:ee,disconnect:et,startReading:ea,write:er}=(0,g.s)();(0,s.useEffect)(()=>{let e="running"===G||"waiting"===G||"connecting"===G;t&&z&&e&&W&&(c.Z.log("⏸️ Mise en pause du streaming USB pour lib\xe9rer le port pour le flash"),W())},[t,z,G,W]);let es=(0,s.useCallback)(async()=>{try{let e=await (0,o.fetchJson)(x,p,"/api.php/firmwares",{},{requiresAuth:!0});v(e.firmwares||[])}catch(e){N(e.message)}finally{_(!1)}},[p,x]);(0,s.useEffect)(()=>{t&&(es(),F(m),C(0),O(!1),Z(null),U(null),q({lastCheck:null,attempts:0}),T([]),N(null))},[t,es,m]),(0,s.useEffect)(()=>{if(u&&f.length>0){let e=f.find(e=>e.version===u);e&&y(e)}},[u,f]);let ei=(0,s.useCallback)(async()=>{try{await (0,o.fetchJson)(x,p,"/api.php/devices",{method:"GET"},{requiresAuth:!0}),c.Z.log("✅ Dispositifs rafra\xeechis apr\xe8s mise \xe0 jour firmware")}catch(e){c.Z.warn("⚠️ Erreur rafra\xeechissement dispositifs:",e)}},[x,p]),el=(0,s.useCallback)(async()=>{try{("running"===G||"waiting"===G||"connecting"===G)&&W&&(c.Z.log("⏸️ Mise en pause du streaming USB avant connexion pour flash"),W(),await new Promise(e=>setTimeout(e,500)));let e=await $();if(e){if(await ee(e,115200)){let e=await ea(e=>{T(t=>[...t,{raw:e,timestamp:new Date}])});e&&(B.current=e)}else Q&&N(Q)}}catch(e){c.Z.error("Erreur connexion port pour flash:",e),N("Erreur de connexion: ".concat(e.message))}},[$,ee,ea,W,Q,G]),en=(0,s.useCallback)(async()=>{B.current&&(B.current(),B.current=null),await et(),T([])},[et]),ec=(0,s.useCallback)(async e=>{let t=localStorage.getItem("token");if(!t)throw Error("Token manquant");let a=await fetch("".concat(p,"/api.php/firmwares/").concat(e.id,"/download"),{headers:{Authorization:"Bearer ".concat(t)}});if(!a.ok)throw Error("Erreur t\xe9l\xe9chargement");return await a.blob()},[p]),eo=(0,s.useCallback)(async()=>{if(null==d?void 0:d.id)try{let e=((await (0,o.fetchJson)(x,p,"/api.php/devices/".concat(d.id,"/commands"),{method:"GET"},{requiresAuth:!0})).commands||[]).filter(e=>"OTA_REQUEST"===e.command).sort((e,t)=>new Date(t.created_at)-new Date(e.created_at))[0];if(e){if(U({status:e.status,command:e,message:ed(e.status)}),q(e=>({lastCheck:new Date,attempts:e.attempts+1})),"executed"===e.status){if(O(!0),C(100),T(e=>[...e,{raw:"[OTA] ✅ Flash OTA termin\xe9 avec succ\xe8s !",timestamp:new Date}]),b)try{await (0,o.fetchJson)(x,p,"/api.php/devices/".concat(d.id),{method:"PUT",body:JSON.stringify({firmware_version:b.version})},{requiresAuth:!0}),await ei()}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour version firmware:",e)}M.current&&(clearInterval(M.current),M.current=null)}else"error"===e.status&&(O(!0),N("Erreur lors du flash OTA"),T(e=>[...e,{raw:"[OTA] ❌ Erreur lors du flash OTA",timestamp:new Date}]),M.current&&(clearInterval(M.current),M.current=null))}}catch(e){c.Z.warn("⚠️ Erreur v\xe9rification statut OTA:",e)}},[d,x,p,b,ei]),ed=e=>{switch(e){case"pending":return"En attente d'ex\xe9cution";case"executing":return"Flash en cours...";case"executed":return"Flash termin\xe9 avec succ\xe8s";case"error":return"Erreur lors du flash";case"expired":return"Commande expir\xe9e";case"cancelled":return"Commande annul\xe9e";default:return"Statut inconnu"}},eu=(0,s.useCallback)(async()=>{if(!b||!Y||!X){N("S\xe9lectionnez un firmware et connectez un port");return}E(!0),N(null),C(0),O(!1);try{C(5),ex("[USB] T\xe9l\xe9chargement du firmware...");let e=await ec(b);C(10);let t=await e.arrayBuffer();C(20),ex("[USB] Connexion au dispositif...");let a=new h.pq(X,{clean:()=>{},writeLine:e=>ex("[ESPTOOL] ".concat(e)),write:e=>ex("[ESPTOOL] ".concat(e))},115200);C(25),await a.connect(),C(30),ex("[USB] Connexion \xe9tablie, d\xe9but du flash...");let r=new Uint8Array(t);if(C(40),"function"==typeof a.flashData)await a.flashData(r,4096);else if("function"==typeof a.flash_file)await a.flash_file(r,4096);else if("function"==typeof a.write)await a.write(4096,r);else throw Error("M\xe9thode de flash non trouv\xe9e");if(C(90),"function"==typeof a.verify&&(ex("[USB] V\xe9rification du flash..."),await a.verify(4096,r)),C(100),O(!0),ex("[USB] ✅ Flash r\xe9ussi !"),b)try{ex("[UPDATE] Recherche du dispositif dans la base...");let e=null;if(null==d?void 0:d.id)e=d.id;else{let t=(await (0,o.fetchJson)(x,p,"/api.php/devices",{method:"GET"},{requiresAuth:!0})).devices||[];if(null==d?void 0:d.sim_iccid){let a=t.find(e=>e.sim_iccid===d.sim_iccid);a&&(e=a.id)}if(!e&&(null==d?void 0:d.device_serial)){let a=t.find(e=>e.device_serial===d.device_serial);a&&(e=a.id)}if(!e&&(null==d?void 0:d.device_name)){let a=d.device_name.match(/USB-([a-f0-9:]+)/i);if(a){let r=a[1].toLowerCase(),s=t.find(e=>{if(e.device_name){let t=e.device_name.match(/USB-([a-f0-9:]+)/i);if(t&&t[1].toLowerCase()===r||e.device_name.toLowerCase().includes(r))return!0}return!!(e.device_serial&&e.device_serial.toLowerCase().includes(r)||e.sim_iccid&&e.sim_iccid.includes(r.replace(":","")))});s&&(e=s.id)}else{let a=t.find(e=>!!(e.device_name&&(e.device_name.includes(d.device_name)||d.device_name.includes(e.device_name))));a&&(e=a.id)}}if(!e&&(null==d?void 0:d.sim_iccid)){let a=d.sim_iccid.match(/TEMP-([0-9a-f]+)/i);if(a){let r=a[1],s=t.find(e=>!!(e.sim_iccid&&e.sim_iccid.includes(r)||e.device_serial&&e.device_serial.includes(r)||e.device_name&&e.device_name.includes(r)));s&&(e=s.id)}}}e?(ex("[UPDATE] Dispositif trouv\xe9 (ID: ".concat(e,"), mise \xe0 jour version firmware...")),await (0,o.fetchJson)(x,p,"/api.php/devices/".concat(e),{method:"PUT",body:JSON.stringify({firmware_version:b.version})},{requiresAuth:!0}),ex("[UPDATE] ✅ Version firmware mise \xe0 jour: v".concat(b.version)),await ei()):(ex("[UPDATE] ⚠️ Dispositif non trouv\xe9 en base - la version sera mise \xe0 jour lors de la prochaine connexion USB"),c.Z.warn("Dispositif non trouv\xe9 pour mise \xe0 jour firmware:",d))}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour version firmware:",e),ex("[UPDATE] ⚠️ Erreur mise \xe0 jour: ".concat(e.message))}ex("[TEST] Attente red\xe9marrage (3 secondes)..."),await new Promise(e=>setTimeout(e,3e3));try{ex("[TEST] Envoi commande AT pour v\xe9rifier..."),await er("AT\r\n");let e=!1,t=setInterval(()=>{S.slice(-10).some(e=>e.raw&&(e.raw.includes("OK")||e.raw.includes("device_info")||e.raw.includes("AT")||e.raw.includes("ready")))&&!e&&(e=!0,Z(!0),ex("[TEST] ✅ Dispositif r\xe9pond !"))},500);J(()=>{clearInterval(t),e||(Z(!1),ex("[TEST] ⚠️ Pas de r\xe9ponse d\xe9tect\xe9e"))},5e3)}catch(e){ex("[TEST] ⚠️ Erreur test: ".concat(e.message))}}catch(e){N(e.message),ex("[USB] ❌ Erreur: ".concat(e.message))}finally{E(!1)}},[b,Y,X,ec,d,x,p,er,ei,S]),em=(0,s.useCallback)(async()=>{if(!b||!(null==d?void 0:d.id)){N("S\xe9lectionnez un firmware et un dispositif");return}E(!0),N(null),C(0),O(!1),U(null),q({lastCheck:null,attempts:0});try{ex("[OTA] D\xe9clenchement du flash OTA..."),C(10),await (0,o.fetchJson)(x,p,"/api.php/devices/".concat(d.id,"/ota"),{method:"POST",body:JSON.stringify({firmware_version:b.version})},{requiresAuth:!0}),C(30),ex("[OTA] ✅ Commande OTA programm\xe9e pour v".concat(b.version)),ex("[OTA] Attente de l'ex\xe9cution par le dispositif..."),U({status:"pending",message:"En attente d'ex\xe9cution"}),M.current=setInterval(()=>{eo()},2e3),J(()=>{M.current&&(clearInterval(M.current),M.current=null),A||(N("Timeout: Le flash OTA n'a pas \xe9t\xe9 ex\xe9cut\xe9 dans les 5 minutes"),ex("[OTA] ⚠️ Timeout: Flash OTA non ex\xe9cut\xe9"))},3e5)}catch(e){N(e.message),ex("[OTA] ❌ Erreur: ".concat(e.message)),E(!1)}},[b,d,x,p,eo,A]),ex=(0,s.useCallback)(e=>{T(t=>[...t,{raw:e,timestamp:new Date}])},[]);if((0,s.useEffect)(()=>()=>{M.current&&clearInterval(M.current)},[]),!t)return null;let ep="usb"===R&&Y&&b,eg="ota"===R&&(null==d?void 0:d.id)&&b;return(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col",children:[(0,r.jsxs)("div",{className:"flex-shrink-0 p-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-bold",children:"usb"===R?"\uD83D\uDD0C Flash USB":"\uD83D\uDCE1 Flash OTA"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-1",children:d?"".concat(d.device_name||d.sim_iccid):"Flasher un dispositif"})]}),(0,r.jsx)("button",{onClick:a,className:"flex items-center justify-center w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors",title:"Fermer","aria-label":"Fermer",children:(0,r.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:()=>F("usb"),className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat("usb"===R?"bg-primary-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"),children:"\uD83D\uDD0C USB"}),(0,r.jsx)("button",{onClick:()=>F("ota"),className:"px-4 py-2 rounded-lg font-medium transition-colors ".concat("ota"===R?"bg-primary-500 text-white":"bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300"),children:"\uD83D\uDCE1 OTA"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:["usb"===R&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCE1 Port s\xe9rie"}),Y?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded p-2 text-sm",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"● Connect\xe9"})}),(0,r.jsx)("button",{onClick:en,disabled:k,className:"btn-secondary w-full text-xs",children:"D\xe9connecter"})]}):(0,r.jsx)("button",{onClick:el,disabled:!K||k,className:"btn-primary w-full text-sm",children:"\uD83D\uDD0C S\xe9lectionner"})]}),(0,r.jsxs)("div",{className:"usb"===R?"":"col-span-2",children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCE6 Firmware"}),j?(0,r.jsx)("p",{className:"text-sm text-gray-500",children:"Chargement..."}):(0,r.jsxs)("select",{value:(null==b?void 0:b.id)||"",onChange:e=>{y(f.find(t=>t.id===parseInt(e.target.value))||null)},disabled:k,className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 text-sm",children:[(0,r.jsx)("option",{value:"",children:"S\xe9lectionner..."}),f.filter(e=>"compiled"===e.status).map(e=>(0,r.jsxs)("option",{value:e.id,children:["v",e.version," ",e.is_stable?"✅":"⚠️"]},e.id))]})]})]}),(ep||eg)&&(0,r.jsxs)("div",{children:[(0,r.jsx)("button",{onClick:"usb"===R?eu:em,disabled:k,className:"btn-primary w-full",children:k?"⏳ Flash en cours... ".concat(D,"%"):"\uD83D\uDE80 Flasher v".concat(b.version," (").concat(R.toUpperCase(),")")}),k&&(0,r.jsx)("div",{className:"mt-3 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:(0,r.jsx)("div",{className:"bg-primary-500 h-3 rounded-full transition-all duration-300",style:{width:"".concat(D,"%")}})}),"ota"===R&&L&&(0,r.jsx)("div",{className:"mt-3 p-3 rounded-lg border-2 bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("p",{className:"font-semibold text-blue-800 dark:text-blue-300",children:["Statut: ",L.message]}),L.command&&(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400 mt-1",children:["Commande cr\xe9\xe9e: ",new Date(L.command.created_at).toLocaleString("fr-FR")]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["V\xe9rifications: ",P.attempts]}),P.lastCheck&&(0,r.jsxs)("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["Derni\xe8re: ",P.lastCheck.toLocaleTimeString("fr-FR")]})]})]})}),A&&(0,r.jsxs)("div",{className:"mt-3 p-3 rounded-lg border-2",children:[!0===I&&(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"✅ Dispositif vivant et r\xe9pond"})}),!1===I&&(0,r.jsx)("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800",children:(0,r.jsx)("p",{className:"text-yellow-800 dark:text-yellow-300 font-semibold",children:"⚠️ Pas de r\xe9ponse d\xe9tect\xe9e"})}),"ota"===R&&(null==L?void 0:L.status)==="executed"&&(0,r.jsx)("div",{className:"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800",children:(0,r.jsx)("p",{className:"text-green-800 dark:text-green-300 font-semibold",children:"✅ Flash OTA termin\xe9 avec succ\xe8s"})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2",children:"\uD83D\uDCDF Console"}),(0,r.jsx)("div",{className:"bg-black text-green-400 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto",children:0===S.length?(0,r.jsx)("p",{className:"text-gray-500",children:"En attente de logs..."}):S.map((e,t)=>(0,r.jsxs)("div",{className:"mb-1",children:[(0,r.jsx)("span",{className:"text-gray-500",children:e.timestamp.toLocaleTimeString("fr-FR")})," ",(0,r.jsx)("span",{children:e.raw})]},t))})]}),(w||Q)&&(0,r.jsx)("div",{className:"alert alert-warning text-sm",children:w||Q})]})]})})}function v(e){let{title:t,children:a,defaultOpen:i=!1}=e,[l,n]=(0,s.useState)(i);return(0,r.jsxs)("div",{className:"border border-gray-200 dark:border-gray-700 rounded-lg",children:[(0,r.jsxs)("button",{type:"button",onClick:()=>n(!l),className:"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors",children:[(0,r.jsx)("span",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300",children:t}),(0,r.jsx)("span",{className:"text-gray-500 dark:text-gray-400",children:l?"▼":"▶"})]}),l&&(0,r.jsx)("div",{className:"px-4 pb-4 pt-2",children:a})]})}function b(e){let{isOpen:t,onClose:a,editingItem:i,onSave:l,fetchWithAuth:n,API_URL:d,patients:m=[],allDevices:x=[],appendLog:p=null}=e,[g,h]=(0,s.useState)({device_name:"",sim_iccid:"",device_serial:"",firmware_version:"",status:"inactive",patient_id:null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0],gps_enabled:!1}),[f,b]=(0,s.useState)({}),[y,j]=(0,s.useState)(null),[_,w]=(0,s.useState)(!1),[N,k]=(0,s.useState)(!1),E=(0,s.useRef)(!1),D=(0,s.useRef)(null);(0,s.useEffect)(()=>{if(t&&!E.current){if(E.current=!0,i&&i.id&&!i.isVirtual){let e={device_name:i.device_name||"",sim_iccid:i.sim_iccid||"",device_serial:i.device_serial||"",firmware_version:i.firmware_version||"",status:i.status||"inactive",patient_id:i.patient_id||null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0],gps_enabled:!1};h(e),D.current=JSON.parse(JSON.stringify(e)),C(i.id)}else h({device_name:"",sim_iccid:"",device_serial:"",firmware_version:"",status:"inactive",patient_id:null,sleep_minutes:null,measurement_duration_ms:null,send_every_n_wakeups:1,calibration_coefficients:[0,1,0],gps_enabled:!1}),D.current=null;b({}),j(null)}else!t&&E.current&&(E.current=!1,D.current=null)},[t]);let C=async e=>{if(e)try{k(!0);let t=await (0,o.fetchJson)(n,d,"/api.php/devices/".concat(e,"/config"),{},{requiresAuth:!0});if(t.config){let e={sleep_minutes:t.config.sleep_minutes||null,measurement_duration_ms:t.config.measurement_duration_ms||null,send_every_n_wakeups:t.config.send_every_n_wakeups||1,calibration_coefficients:t.config.calibration_coefficients||[0,1,0],gps_enabled:t.config.gps_enabled||!1};h(t=>({...t,...e})),D.current&&(D.current=JSON.parse(JSON.stringify({...D.current,...e})))}}catch(e){c.Z.warn("Erreur chargement configuration:",e)}finally{k(!1)}},S=e=>{let{name:t,value:a,type:r,checked:s}=e.target;h({...g,[t]:"checkbox"===r?s:"number"===r?""===a?null:parseFloat(a):a}),f[t]&&b(e=>{let a={...e};return delete a[t],a})},T=(e,t)=>{let a=[...g.calibration_coefficients];a[e]=""===t?0:parseFloat(t),h(e=>({...e,calibration_coefficients:a}))},A=(0,s.useMemo)(()=>!i||!D.current||JSON.stringify(g)!==JSON.stringify(D.current),[g,i]),O=()=>{let e={};return g.device_name&&0!==g.device_name.trim().length||(e.device_name="Le nom du dispositif est requis"),g.sim_iccid&&g.sim_iccid.trim().length>0&&(g.sim_iccid.trim().length<4||g.sim_iccid.trim().length>20?e.sim_iccid="Le SIM ICCID doit contenir entre 4 et 20 caract\xe8res":/^\d+$/.test(g.sim_iccid.trim())||(e.sim_iccid="Le SIM ICCID doit contenir uniquement des chiffres")),g.device_serial&&g.device_serial.trim().length>0&&(g.device_serial.trim().length<4||g.device_serial.trim().length>50)&&(e.device_serial="Le num\xe9ro de s\xe9rie doit contenir entre 4 et 50 caract\xe8res"),b(e),0===Object.keys(e).length},I=async e=>{if(e.preventDefault(),!O()){j("Veuillez corriger les erreurs dans le formulaire");return}w(!0),j(null);try{let e={device_name:g.device_name.trim(),sim_iccid:!i&&g.sim_iccid&&g.sim_iccid.trim().length>0&&"N/A"!==g.sim_iccid?g.sim_iccid.trim():void 0,device_serial:g.device_serial&&g.device_serial.trim().length>0?g.device_serial.trim():null,status:g.status||"inactive",patient_id:g.patient_id||null};!i&&g.firmware_version&&g.firmware_version.trim().length>0&&"N/A"!==g.firmware_version&&(e.firmware_version=g.firmware_version.trim());let s={};if(null!=g.sleep_minutes&&(s.sleep_minutes=parseInt(g.sleep_minutes)),null!=g.measurement_duration_ms&&(s.measurement_duration_ms=parseInt(g.measurement_duration_ms)),null!=g.send_every_n_wakeups&&(s.send_every_n_wakeups=parseInt(g.send_every_n_wakeups)),g.calibration_coefficients&&Array.isArray(g.calibration_coefficients)&&(s.calibration_coefficients=g.calibration_coefficients),null!=g.gps_enabled&&(s.gps_enabled=g.gps_enabled),i){let t="/api.php/devices/".concat(i.id);if(await (0,o.fetchJson)(n,d,t,{method:"PUT",body:JSON.stringify(e)},{requiresAuth:!0}),Object.keys(s).length>0)try{if(await (0,o.fetchJson)(n,d,"/api.php/devices/".concat(i.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0}),p){let e=Object.entries(s).map(e=>{let[t,a]=e;return"gps_enabled"===t?"GPS: ".concat(a?"ON":"OFF"):"sleep_minutes"===t?"Sleep: ".concat(a,"min"):"measurement_duration_ms"===t?"Mesure: ".concat(a,"ms"):"calibration_coefficients"===t?"Cal: [".concat(a.join(","),"]"):"".concat(t,": ").concat(a)}).join(", ");p("\uD83D\uDCE4 [CONFIG] UPDATE_CONFIG → ".concat(e),"dashboard")}}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour configuration:",e)}c.Z.log("✅ Dispositif modifi\xe9: ".concat(e.device_name))}else{let i=x.find(t=>e.sim_iccid&&t.sim_iccid===e.sim_iccid||e.device_serial&&t.device_serial===e.device_serial);if(i){if(c.Z.log("ℹ️ Dispositif existant trouv\xe9, mise \xe0 jour au lieu de cr\xe9ation"),await (0,o.fetchJson)(n,d,"/api.php/devices/".concat(i.id),{method:"PUT",body:JSON.stringify(e)},{requiresAuth:!0}),Object.keys(s).length>0)try{await (0,o.fetchJson)(n,d,"/api.php/devices/".concat(i.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0})}catch(e){c.Z.warn("⚠️ Erreur mise \xe0 jour configuration:",e)}c.Z.log("✅ Dispositif mis \xe0 jour: ".concat(e.device_name))}else{var t,r;let i=await n("".concat(d).concat("/api.php/devices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},{requiresAuth:!0});if(!i.ok){let e=(await i.json().catch(()=>({}))).error||"Erreur HTTP ".concat(i.status);if(e.includes("d\xe9j\xe0")||e.includes("existe")||e.includes("already")||e.includes("utilis\xe9")){c.Z.log('⚠️ API indique "d\xe9j\xe0 utilis\xe9", le dispositif devrait appara\xeetre apr\xe8s rafra\xeechissement'),await l(),a();return}throw Error(e)}let u=await i.json();if(!u.success)throw Error(u.error||"Erreur API");if(u.device&&Object.keys(s).length>0)try{await (0,o.fetchJson)(n,d,"/api.php/devices/".concat(u.device.id,"/config"),{method:"PUT",body:JSON.stringify(s)},{requiresAuth:!0})}catch(e){c.Z.warn("⚠️ Erreur sauvegarde configuration:",e)}c.Z.log("✅ Dispositif cr\xe9\xe9: ".concat((null===(t=u.device)||void 0===t?void 0:t.device_name)||(null===(r=u.device)||void 0===r?void 0:r.sim_iccid)))}}await l(),a()}catch(e){c.Z.error("Erreur sauvegarde dispositif:",e),j(e.message||"Erreur lors de la sauvegarde du dispositif")}finally{w(!1)}};return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"bg-white dark:bg-[rgb(var(--night-surface))] rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[(0,r.jsxs)("div",{className:"sticky top-0 bg-white dark:bg-[rgb(var(--night-surface))] border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex items-center justify-between",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:i?"✏️ Modifier le dispositif":"➕ Cr\xe9er un nouveau dispositif"}),(0,r.jsx)("button",{className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 w-8 h-8 flex items-center justify-center rounded-full transition-colors",onClick:a,title:"Fermer","aria-label":"Fermer",disabled:_,children:(0,r.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,r.jsxs)("form",{onSubmit:I,className:"p-6 space-y-4",children:[y&&(0,r.jsx)(u.Z,{message:y}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:["Nom du dispositif ",(0,r.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,r.jsx)("input",{type:"text",name:"device_name",value:g.device_name,onChange:S,className:"input w-full ".concat(f.device_name?"border-red-500":""),placeholder:"Ex: Dispositif OTT-001",required:!0}),f.device_name&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:f.device_name})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Statut"}),(0,r.jsxs)("select",{name:"status",value:g.status,onChange:S,className:"input w-full",children:[(0,r.jsx)("option",{value:"inactive",children:"⏸️ Inactif"}),(0,r.jsx)("option",{value:"active",children:"✅ Actif"})]}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Le statut USB est d\xe9tect\xe9 automatiquement lors de la connexion"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"SIM ICCID"}),(0,r.jsx)("input",{type:"text",name:"sim_iccid",value:g.sim_iccid||"N/A",readOnly:!0,disabled:!0,className:"input w-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Ex: 89314404000012345678"}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Lecture seule (vient de la SIM)"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:["Num\xe9ro de s\xe9rie ",(null==i?void 0:i.id)&&(0,r.jsx)("span",{className:"text-xs text-gray-500",children:"(non modifiable)"})]}),(0,r.jsx)("input",{type:"text",name:"device_serial",value:g.device_serial||"OTT-XXX (auto-g\xe9n\xe9r\xe9)",onChange:S,disabled:!!(null==i?void 0:i.id),className:"input w-full ".concat(f.device_serial?"border-red-500":""," ").concat((null==i?void 0:i.id)?"bg-gray-100 dark:bg-gray-800 cursor-not-allowed":""),placeholder:"Auto-g\xe9n\xe9r\xe9 (OTT-001, OTT-002, etc.)",title:(null==i?void 0:i.id)?"Le num\xe9ro de s\xe9rie ne peut pas \xeatre modifi\xe9 (tra\xe7abilit\xe9 m\xe9dicale)":"Sera g\xe9n\xe9r\xe9 automatiquement"}),f.device_serial&&(0,r.jsx)("p",{className:"mt-1 text-sm text-red-600 dark:text-red-400",children:f.device_serial})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Version du firmware"}),(0,r.jsx)("input",{type:"text",name:"firmware_version",value:g.firmware_version||"N/A",readOnly:!0,disabled:!0,className:"input w-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-gray-400 cursor-not-allowed",placeholder:"Ex: 3.8-unified"}),(0,r.jsx)("p",{className:"mt-1 text-xs text-gray-500 dark:text-gray-400",children:"Lecture seule"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"Patient"}),(0,r.jsxs)("select",{name:"patient_id",value:g.patient_id||"",onChange:S,className:"input w-full",children:[(0,r.jsx)("option",{value:"",children:"— Aucun patient —"}),m.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," ",e.email?"(".concat(e.email,")"):""]},e.id))]})]})]}),(0,r.jsx)(v,{title:"⚙️ Configuration",defaultOpen:!!i,children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"⏰ Intervalle de veille (minutes)"}),(0,r.jsx)("input",{type:"number",name:"sleep_minutes",value:g.sleep_minutes||"",onChange:S,className:"input w-full",placeholder:"Ex: 5",min:"1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"⏱️ Dur\xe9e de mesure (ms)"}),(0,r.jsx)("input",{type:"number",name:"measurement_duration_ms",value:g.measurement_duration_ms||"",onChange:S,className:"input w-full",placeholder:"Ex: 5000",min:"1"})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-slate-800/50",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("span",{className:"text-2xl",children:"\uD83D\uDCCD"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-semibold text-gray-700 dark:text-gray-300",children:"GPS"}),(0,r.jsx)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-0.5",children:g.gps_enabled?"✅ G\xe9olocalisation active":"⚠️ OFF (\xe9conomie batterie)"})]})]}),(0,r.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",name:"gps_enabled",checked:g.gps_enabled||!1,onChange:e=>h(t=>({...t,gps_enabled:e.target.checked})),className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-11 h-6 bg-gray-300 dark:bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"\uD83D\uDCE4 Envoyer toutes les N r\xe9veils"}),(0,r.jsx)("input",{type:"number",name:"send_every_n_wakeups",value:g.send_every_n_wakeups||1,onChange:S,className:"input w-full",min:"1"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"\uD83D\uDCD0 Calibration (a0, a1, a2)"}),(0,r.jsx)("div",{className:"grid grid-cols-3 gap-2",children:[0,1,2].map(e=>(0,r.jsx)("input",{type:"number",step:"any",value:g.calibration_coefficients[e]||0,onChange:t=>T(e,t.target.value),className:"input w-full",placeholder:"a".concat(e)},e))})]})]})}),(0,r.jsxs)("div",{className:"flex gap-2 justify-end pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:a,disabled:_,children:"Annuler"}),(0,r.jsx)("button",{type:"submit",className:"btn-primary",disabled:_||N||i&&!A,title:i&&!A?"Aucune modification d\xe9tect\xe9e":void 0,children:_?"⏳ Enregistrement...":i?"\uD83D\uDCBE Enregistrer les modifications":"✅ Cr\xe9er le dispositif"})]})]})]})}):null}var y=a(6601);function j(){var e,t,a,d,u;let x=(0,l.l)(),g=(0,s.useRef)([]),h=(0,s.useRef)(!0);(0,s.useEffect)(()=>(h.current=!0,()=>{h.current=!1,g.current.forEach(e=>clearTimeout(e)),g.current=[]}),[]);let v=(e,t)=>{if(!h.current)return null;let a=setTimeout(()=>{h.current&&e(),g.current=g.current.filter(e=>e!==a)},t);return g.current.push(a),a},{usbConnectedDevice:j,setUsbConnectedDevice:_,usbVirtualDevice:w,setUsbVirtualDevice:N,usbDeviceInfo:k,isSupported:E,isConnected:D,port:C,usbStreamStatus:S,usbStreamMeasurements:T,usbStreamLogs:A,usbStreamError:O,usbStreamLastMeasurement:I,usbStreamLastUpdate:Z,requestPort:R,connect:F,startReading:L,write:U,startUsbStreaming:P,pauseUsbStreaming:q,appendUsbStreamLog:B,setSendMeasurementCallback:M,setUpdateDeviceFirmwareCallback:J}=x;(0,s.useEffect)(()=>()=>{c.Z.debug("[USB-TAB] Cleanup")},[]),(0,s.useEffect)(()=>{if(null==k?void 0:k.sim_iccid){var e;c.Z.debug("[USB-TAB] Device:",null===(e=k.sim_iccid)||void 0===e?void 0:e.slice(-4))}},[null==k?void 0:k.sim_iccid]);let{fetchWithAuth:V,API_URL:z,user:H}=(0,i.a)(),G=e=>{var t;return!e||(null==H?void 0:H.role_name)==="admin"||(null==H?void 0:null===(t=H.permissions)||void 0===t?void 0:t.includes(e))||!1},W=(0,s.useCallback)(e=>{if(!(null==e?void 0:e.trim().startsWith("{"))||!e.includes("usb_stream"))return null;try{let t=JSON.parse(e.trim()),a=[];return t.seq&&a.push("Seq=".concat(t.seq)),(null!=t.flow_lpm||null!=t.flowrate)&&a.push("Flow=".concat((t.flow_lpm||t.flowrate||0).toFixed(2)," L/min")),(null!=t.battery_percent||null!=t.battery)&&a.push("Bat=".concat((t.battery_percent||t.battery||0).toFixed(1),"%")),null!=t.rssi&&a.push("RSSI=".concat(t.rssi," dBm")),null!=t.latitude&&null!=t.longitude&&a.push("GPS=".concat(t.latitude.toFixed(4),",").concat(t.longitude.toFixed(4))),(t.device_name||t.device_serial)&&a.push("Device=".concat(t.device_name||t.device_serial||"N/A")),a.length>0?"[USB_STREAM] ".concat(a.join(" | ")):null}catch(e){return null}},[]),X=(0,s.useCallback)(e=>{if(!e)return"default";let t=e.toUpperCase();return["ERROR","❌","\xc9CHEC","FAIL","FATAL","EXCEPTION","ERREUR JSON","ERREUR PARSING","DATABASE ERROR"].some(a=>e.includes(a)||t.includes(a))?"error":["WARN","⚠️","WARNING","ATTENTION","TIMEOUT","COMMANDE INCONNUE","NON DISPONIBLE"].some(a=>e.includes(a)||t.includes(a))?"warning":["[GPS]","GPS","LATITUDE","LONGITUDE","SATELLITE","FIX","COORDONN\xc9ES","G\xc9OLOCALISATION"].some(e=>t.includes(e))?"gps":["[MODEM]","MODEM","SIM","CSQ","RSSI","SIGNAL","OP\xc9RATEUR","ATTACH\xc9","ENREGISTREMENT","APN"].some(e=>t.includes(e))?"modem":["[SENSOR]","AIRFLOW","FLOW","BATTERY","BATTERIE","MESURE","CAPTURE","ADC","V_ADC","V_BATT"].some(e=>t.includes(e))?"sensor":["USB_STREAM","USB STREAM","USB","SERIAL","S\xc9RIE"].some(e=>t.includes(e))?"usb":"default"},[]),Y=(0,s.useCallback)((e,t)=>{if(t)return"text-blue-400 dark:text-blue-300";switch(e){case"error":return"text-red-400 dark:text-red-300";case"warning":return"text-yellow-400 dark:text-yellow-300";case"gps":return"text-cyan-400 dark:text-cyan-300";case"modem":return"text-purple-400 dark:text-purple-300";case"sensor":return"text-green-400 dark:text-green-300";case"usb":return"text-blue-400 dark:text-blue-300";default:return"text-gray-300 dark:text-gray-400"}},[]),[K,Q]=(0,s.useState)(!1),[$,ee]=(0,s.useState)(null),{data:et,loading:ea,refetch:er,invalidateCache:es}=(0,n.m_)((0,s.useMemo)(()=>[K?"/api.php/devices?include_deleted=true":"/api.php/devices"],[K]),{requiresAuth:!0,autoLoad:!!H,cacheTTL:3e4}),ei=(null==et?void 0:null===(e=et.devices)||void 0===e?void 0:e.devices)||[],el=(0,s.useMemo)(()=>ei,[ei]),en=(0,s.useMemo)(()=>el.filter(e=>!e.deleted_at),[el]);(0,s.useMemo)(()=>el.filter(e=>e.deleted_at),[el]);let ec=K?el:en,[eo,ed]=(0,s.useState)([]),[eu,em]=(0,s.useState)(!1),ex=(0,s.useRef)(0),ep=(0,s.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(H&&"admin"===H.role_name&&V&&z)try{let a=t?"/api.php/usb-logs/".concat(encodeURIComponent(e),"?limit=100&since=").concat(t):"/api.php/usb-logs/".concat(encodeURIComponent(e),"?limit=100"),r=await (0,o.fetchJson)(V,z,a,{},{requiresAuth:!0});if(r.success&&r.logs){let e=r.logs.map(e=>({id:"remote-".concat(e.id),line:e.log_line,timestamp:e.timestamp_ms||new Date(e.created_at).getTime(),source:e.log_source,isRemote:!0}));if(t?ed(t=>[...t,...e].filter((e,t,a)=>t===a.findIndex(t=>t.id===e.id)).sort((e,t)=>e.timestamp-t.timestamp).slice(-100)):ed(e),e.length>0){let t=Math.max(...e.map(e=>e.timestamp));ex.current=t}}}catch(e){c.Z.error("Erreur chargement logs distants:",e)}},[H,V,z]);(0,s.useEffect)(()=>{(null==H?void 0:H.role_name)!=="admin"||D||w||0===el.length||(async()=>{try{let e=Date.now()-3e4;for(let t of el){let a=t.sim_iccid||t.device_serial||t.id,r=await (0,o.fetchJson)(V,z,"/api.php/usb-logs/".concat(encodeURIComponent(a),"?limit=1"),{},{requiresAuth:!0});if(r.success&&r.logs&&r.logs.length>0){let a=r.logs[0];if(new Date(a.created_at).getTime()>e){c.Z.log("\uD83D\uDD34 [AUTO-SELECT] Device LIVE d\xe9tect\xe9: ".concat(t.device_name," (logs < 30s)")),N({...t,isVirtual:!0});break}}}}catch(e){c.Z.debug("Erreur d\xe9tection device LIVE:",e)}})()},[H,D,w,el,N,V,z]);let eg=j||w,eh=(0,s.useMemo)(()=>(null==H?void 0:H.role_name)==="admin"&&!D&&eg,[H,D,eg]),ef=(0,s.useMemo)(()=>D||A.length>0?A:eh?eo:[],[A,eo,D,eh]);(0,s.useEffect)(()=>{if(!eh||!eg){em(!1),ed([]),ex.current=0;return}let e=eg.sim_iccid||eg.device_serial||eg.device_name;em(!0),ep(e,null);let t=setInterval(()=>{ep(e,ex.current)},2e3);return()=>{clearInterval(t),em(!1)}},[eh,eg,ep]),(0,s.useEffect)(()=>{if(!V||!z)return;let e=async function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};c.Z.log("\uD83D\uDE80 [CALLBACK] updateDevice APPEL\xc9 !",{identifier:e,firmwareVersion:t,updateData:a});try{let r=await V("".concat(z,"/api.php/devices"),{method:"GET"},{requiresAuth:!0});if(!r.ok)return;let s=((await r.json()).devices||[]).find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e);if(!s){c.Z.log("\uD83C\uDD95 [AUTO-CREATE] Dispositif non trouv\xe9 (".concat(e,"), cr\xe9ation automatique..."));let r={device_name:a.device_name||"USB-".concat(e.slice(-4)),sim_iccid:a.sim_iccid||(e.startsWith("89")?e:null),device_serial:a.device_serial||(e.startsWith("89")?null:e),firmware_version:t||null,status:a.status||"usb_connected",last_seen:a.last_seen||new Date().toISOString()};void 0!==a.last_battery&&(r.last_battery=a.last_battery),void 0!==a.last_flowrate&&(r.last_flowrate=a.last_flowrate),void 0!==a.last_rssi&&(r.last_rssi=a.last_rssi);try{let e=await V("".concat(z,"/api.php/devices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},{requiresAuth:!0});if(e.ok){let t=await e.json();return c.Z.log("✅ [AUTO-CREATE] Dispositif cr\xe9\xe9 avec succ\xe8s:",t.device),v(()=>{er(),ev()},500),t}c.Z.error("❌ [AUTO-CREATE] \xc9chec cr\xe9ation dispositif");return}catch(e){c.Z.error("❌ [AUTO-CREATE] Erreur:",e);return}}let i={...a};t&&""!==t&&(i.firmware_version=t);let l=await V("".concat(z,"/api.php/devices/").concat(s.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)},{requiresAuth:!0});return l.ok&&(c.Z.log("✅ [AUTO-UPDATE] Dispositif ".concat(s.id," mis \xe0 jour")),v(()=>{er(),ev()},500)),await l.json()}catch(e){c.Z.error("❌ Erreur mise \xe0 jour dispositif:",e)}};return M(async e=>{c.Z.log("\uD83D\uDE80 [CALLBACK] sendMeasurement APPEL\xc9 !",e);try{c.Z.log("\uD83D\uDCE4 Envoi mesure USB \xe0 l'API:",e);let t=await V("".concat(z,"/api.php/devices/measurements"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},{requiresAuth:!1});if(!t.ok){let e=await t.json().catch(()=>({}));throw c.Z.error("❌ R\xe9ponse API erreur:",t.status,e),Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();return c.Z.log("✅ Mesure USB enregistr\xe9e:",a),v(()=>{c.Z.log("\uD83D\uDD04 Rafra\xeechissement des dispositifs..."),er(),ev()},500),a}catch(e){throw c.Z.error("❌ Erreur envoi mesure USB:",e),e}}),J(e),c.Z.debug("[USB] Callbacks configur\xe9s"),()=>{M(null),J(null)}},[V,z,M,J]);let ev=(0,s.useCallback)(()=>{window.dispatchEvent(new Event("ott-devices-updated"));try{window.localStorage.setItem("ott-devices-last-update",Date.now().toString())}catch(e){}},[]),{data:eb,loading:ey}=(0,n.m_)(["/api.php/patients"],{requiresAuth:!0,autoLoad:!!H}),ej=(null==eb?void 0:null===(t=eb.patients)||void 0===t?void 0:t.patients)||[],{data:e_,loading:ew}=(0,n.m_)(["/api.php/firmwares"],{requiresAuth:!0,autoLoad:!!H}),eN=((null==e_?void 0:null===(a=e_.firmwares)||void 0===a?void 0:a.firmwares)||[]).filter(e=>"compiled"===e.status),[ek,eE]=(0,s.useState)(!1),[eD,eC]=(0,s.useState)(null),[eS,eT]=(0,s.useState)(!1),[eA,eO]=(0,s.useState)(!1),[eI,eZ]=(0,s.useState)(null),[eR,eF]=(0,s.useState)(!1),[eL,eU]=(0,s.useState)(!1),[eP,eq]=(0,s.useState)(null),[eB,eM]=(0,s.useState)(!1),[eJ,eV]=(0,s.useState)(null),[ez,eH]=(0,s.useState)([]),[eG,eW]=(0,s.useState)(""),[eX,eY]=(0,s.useState)(!1),[eK,eQ]=(0,s.useState)(!1),[e$,e0]=(0,s.useState)(!1),[e1,e3]=(0,s.useState)(Date.now()),[e4,e2]=(0,s.useState)(null),[e5,e8]=(0,s.useState)(!1),[e7,e6]=(0,s.useState)(null),e9=(0,s.useMemo)(()=>"running"===S||"waiting"===S||"connecting"===S,[S]),te=(0,s.useMemo)(()=>"paused"===S,[S]),tt=(0,s.useMemo)(()=>D||e9||te||e4,[D,e9,te,e4]);(0,s.useMemo)(()=>!D,[D]),(0,s.useEffect)(()=>{if(!k||!D){c.Z.debug("\uD83D\uDD35 [SYNC] Pas de sync - usbDeviceInfo ou isConnected manquant");return}let e=k.sim_iccid,t=k.device_serial;c.Z.log("\uD83D\uDD0D [SYNC] Recherche device:",{iccid:null==e?void 0:e.slice(-10),serial:t,allDevicesCount:el.length});let a=el.find(a=>a.sim_iccid===e||a.device_serial===t);if(c.Z.log(a?"✅ [SYNC] Trouv\xe9: ".concat(a.device_name):"\uD83D\uDCDD [SYNC] NOUVEAU → Cr\xe9ation auto..."),a)j&&j.id===a.id||(_({...a,isVirtual:!1}),N(null));else{c.Z.log("\uD83D\uDCDD [AUTO-SYNC] Cr\xe9ation device:",{iccid:null==e?void 0:e.slice(-10),serial:t});let a=k.device_name||"USB-".concat((null==e?void 0:e.slice(-4))||(null==t?void 0:t.slice(-4))||"XXXX");(async()=>{try{let r=await V("".concat(z,"/api.php/devices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({device_name:a,sim_iccid:e||null,device_serial:t||null,firmware_version:k.firmware_version||null,status:"active",last_seen:new Date().toISOString()})},{requiresAuth:!0});if(r.ok){let e=await r.json();if(e.success&&e.device){let t=e.was_created?"cr\xe9\xe9":"restaur\xe9";c.Z.log("✅ [AUTO-SYNC] Dispositif ".concat(t,":"),e.device.device_name),_({...e.device,isVirtual:!1}),N(null),v(()=>{er(),es()},1e3)}}else c.Z.warn("⚠️ [AUTO-SYNC] \xc9chec, dispositif affich\xe9 comme virtuel")}catch(e){c.Z.error("❌ [AUTO-SYNC] Erreur:",e.message)}})()}},[null==k?void 0:k.sim_iccid,null==k?void 0:k.device_serial,D]);let ta=(0,s.useCallback)((e,t,a,r)=>null!=e?{value:e,source:"usb",timestamp:t||Z||(null==k?void 0:k.last_seen)||null}:null!=a?{value:a,source:"database",timestamp:r||(null==e4?void 0:e4.last_seen)||null}:{value:null,source:null,timestamp:null},[Z,null==k?void 0:k.last_seen,null==e4?void 0:e4.last_seen]),tr=(0,s.useCallback)(e=>{if(!e)return null;let t=new Date(e),a=Math.floor((new Date-t)/1e3),r=Math.floor(a/60),s=Math.floor(r/60);return a<60?"".concat(a,"s"):r<60?"".concat(r,"min"):s<24?"".concat(s,"h"):t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},[]);(0,s.useMemo)(()=>D&&((null==I?void 0:I.rssi)!=null||(null==k?void 0:k.rssi)!=null||(null==I?void 0:I.latitude)!=null)?"running":D?"starting":"stopped",[D,null==I?void 0:I.rssi,null==k?void 0:k.rssi,null==I?void 0:I.latitude]);let[ts,ti]=(0,s.useState)({flowrate:{min:null,max:null},battery:{min:null,max:null},rssi:{min:null,max:null}}),tl=(0,s.useCallback)(async()=>{if(E){eY(!0);try{let e=(await navigator.serial.getPorts()).map((e,t)=>({id:"port-".concat(t),label:(0,p.DE)(e),port:e}));eH(e)}catch(e){c.Z.error("[DebugTab] Erreur chargement ports:",e)}finally{eY(!1)}}},[E]);(0,s.useEffect)(()=>{if(!E)return;tl();let e=setInterval(tl,5e3);return()=>clearInterval(e)},[E,C,j,w]),(0,s.useEffect)(()=>{E&&D&&C&&(async()=>{try{await tl();let e=(await navigator.serial.getPorts()).findIndex(e=>e===C);e>=0&&eW("port-".concat(e))}catch(e){c.Z.debug("[DebugTab] Erreur synchronisation port:",e)}})()},[E,D,C,tl]),(0,s.useEffect)(()=>{if(E&&D&&C&&"idle"===S&&!eK){let e=setTimeout(async()=>{try{c.Z.debug("[USB] Auto-start streaming"),await P(C)}catch(e){c.Z.error("[DebugTab] Erreur d\xe9marrage automatique streaming:",e)}},300);return()=>clearTimeout(e)}},[E,D,C,S,eK,P]),(0,s.useEffect)(()=>{(async()=>{if(e5)return;let e=(null==k?void 0:k.sim_iccid)||(null==k?void 0:k.device_serial)||(null==k?void 0:k.device_name);if(!e4||!e||e4.sim_iccid!==e&&e4.device_serial!==e&&e4.device_name!==e){e8(!0);try{var t;let a=await (0,o.fetchJson)(V,z,"/api.php/devices",{method:"GET"},{requiresAuth:!0});if(null==a?void 0:null===(t=a.devices)||void 0===t?void 0:t.devices){let t=null;(t=e?a.devices.devices.find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e):a.devices.devices[0])&&(e2({device_name:t.device_name,sim_iccid:t.sim_iccid,device_serial:t.device_serial,firmware_version:t.firmware_version,last_battery:t.last_battery||null,last_flowrate:t.last_flowrate||null,last_rssi:t.last_rssi||null,last_latitude:t.latitude||null,last_longitude:t.longitude||null,last_seen:t.last_seen,status:t.status}),I||k||e6("database"))}}catch(e){c.Z.error("[DebugTab] Erreur chargement donn\xe9es DB:",e)}finally{e8(!1)}}})()},[V,z]),(0,s.useEffect)(()=>{let e=(null==k?void 0:k.sim_iccid)||(null==k?void 0:k.device_serial)||(null==k?void 0:k.device_name);!e||e4&&(e4.sim_iccid===e||e4.device_serial===e||e4.device_name===e)||e5||(async()=>{e8(!0);try{var t;let a=await (0,o.fetchJson)(V,z,"/api.php/devices",{method:"GET"},{requiresAuth:!0});if(null==a?void 0:null===(t=a.devices)||void 0===t?void 0:t.devices){let t=a.devices.devices.find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e);t&&e2({device_name:t.device_name,sim_iccid:t.sim_iccid,device_serial:t.device_serial,firmware_version:t.firmware_version,last_battery:t.last_battery,last_flowrate:t.last_flowrate||null,last_rssi:t.last_rssi||null,last_latitude:t.latitude||null,last_longitude:t.longitude||null,last_seen:t.last_seen,status:t.status})}}catch(e){c.Z.error("[DebugTab] Erreur rechargement donn\xe9es DB:",e)}finally{e8(!1)}})()},[null==k?void 0:k.sim_iccid,null==k?void 0:k.device_serial,null==k?void 0:k.device_name,V,z,e5,e4]),(0,s.useEffect)(()=>{I||k&&(null!=k.flowrate||null!=k.last_battery)?e6("usb"):e4&&!I&&e6("database")},[I,k,e4]),(0,s.useEffect)(()=>{if(!tt||!Z)return;let e=setInterval(()=>{e3(Date.now())},1e3);return()=>clearInterval(e)},[tt,Z]),(0,s.useCallback)(async e=>{if(!D||!C){B("❌ Port non connect\xe9 - Connexion automatique en cours...","dashboard");return}if(e$){B("⏳ Commande d\xe9j\xe0 en cours...","dashboard");return}e0(!0);try{B("\uD83D\uDCE4 Envoi commande: ".concat(e),"dashboard");let t=await U(e+"\n");await new Promise(e=>{v(()=>{e()},100)||e()}),t?B('✅ Commande "'.concat(e,'" envoy\xe9e'),"dashboard"):B("❌ \xc9chec envoi commande: ".concat(e),"dashboard")}catch(e){c.Z.error("[DebugTab] Erreur envoi commande:",e),B("❌ Erreur envoi commande: ".concat(e.message||e),"dashboard")}finally{e0(!1)}},[D,C,e$,U,B]),(0,s.useCallback)(async()=>{if(!eK){eQ(!0);try{e9?(q(),B("⏸️ Visualisation des logs mise en pause - Port toujours connect\xe9","dashboard")):te?D&&C&&(await P(C),B("▶️ Visualisation des logs reprise","dashboard")):D&&C&&await P(C)}catch(e){c.Z.error("[DebugTab] Erreur toggle streaming:",e),B("❌ Erreur: ".concat(e.message||e),"dashboard")}finally{eQ(!1)}}},[eK,e9,te,D,C,P,q,B]),(0,s.useEffect)(()=>{if(!I)return;let{flowrate:e,battery:t,rssi:a}=I;ti(r=>{let s={...r},i=!1;return null!=e&&((null===s.flowrate.min||e<s.flowrate.min)&&(s.flowrate.min=e,i=!0),(null===s.flowrate.max||e>s.flowrate.max)&&(s.flowrate.max=e,i=!0)),null!=t&&((null===s.battery.min||t<s.battery.min)&&(s.battery.min=t,i=!0),(null===s.battery.max||t>s.battery.max)&&(s.battery.max=t,i=!0)),null!=a&&-999!==a&&((null===s.rssi.min||a<s.rssi.min)&&(s.rssi.min=a,i=!0),(null===s.rssi.max||a>s.rssi.max)&&(s.rssi.max=a,i=!0)),i?s:r})},[I]),(0,s.useEffect)(()=>{("connecting"===S||"waiting"===S)&&ti({flowrate:{min:null,max:null},battery:{min:null,max:null},rssi:{min:null,max:null}})},[S]);let tn=(0,s.useCallback)(async e=>{eE(!0);try{let t=(null==H?void 0:H.role_name)==="admin"?"/api.php/devices/".concat(e.id,"?archive=true"):"/api.php/devices/".concat(e.id),a=await (0,o.fetchJson)(V,z,t,{method:"DELETE"},{requiresAuth:!0});a.success?(c.Z.log('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" archiv\xe9')),B('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" archiv\xe9'),"dashboard"),eC("✅ Dispositif archiv\xe9"),es(),v(()=>{er()},500),v(()=>eC(null),5e3)):(c.Z.error("Erreur archivage dispositif:",a.error),B("❌ Erreur archivage: ".concat(a.error),"dashboard"))}catch(e){c.Z.error("Erreur archivage dispositif:",e),B("❌ Erreur archivage: ".concat(e.message||e),"dashboard")}finally{eE(!1)}},[V,z,er,B,H,v,eC]),tc=(0,s.useCallback)(async e=>{eE(!0);try{let t=await (0,o.fetchJson)(V,z,"/api.php/devices/".concat(e.id,"?permanent=true"),{method:"DELETE"},{requiresAuth:!0});t.success?(c.Z.log('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" supprim\xe9 d\xe9finitivement')),B('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" supprim\xe9 d\xe9finitivement'),"dashboard"),eC("✅ Dispositif supprim\xe9 d\xe9finitivement"),es(),v(()=>{er()},300),v(()=>eC(null),5e3)):(c.Z.error("Erreur suppression dispositif:",t.error),B("❌ Erreur suppression: ".concat(t.error),"dashboard"))}catch(e){c.Z.error("Erreur suppression dispositif:",e),B("❌ Erreur suppression: ".concat(e.message||e),"dashboard")}finally{eE(!1)}},[V,z,er,B,v,eC]),to=(0,s.useCallback)(async e=>{try{ee(e.id);let t=await V("".concat(z,"/api.php/devices/").concat(e.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({deleted_at:null})},{requiresAuth:!0});if(t.ok)c.Z.log('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" restaur\xe9 avec succ\xe8s')),B('✅ Dispositif "'.concat(e.device_name||e.sim_iccid,'" restaur\xe9'),"dashboard"),es(),v(async()=>{await er()},500);else{let e=(await t.json().catch(()=>({}))).error||"Erreur lors de la restauration";c.Z.error("Erreur restauration device:",e),B("❌ Erreur restauration: ".concat(e),"dashboard")}}catch(e){c.Z.error("Erreur restauration device:",e),B("❌ Erreur restauration: ".concat(e.message||e),"dashboard")}finally{ee(null)}},[V,z,er,es,B]),[td,tu]=(0,s.useState)(!1);(0,s.useCallback)(async()=>{tu(!0);try{let e="".concat(z,"/api.php/devices/test/create"),t=await V(e,{method:"POST"},{requiresAuth:!0});if(!t.ok){let e=await t.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(t.status))}let a=await t.json();if(!a.success)throw Error(a.error||"Erreur API");t.success?(c.Z.log("✅ ".concat(a.message)),B("✅ ".concat(a.message),"dashboard"),a.errors&&a.errors.length>0&&a.errors.forEach(e=>{B("⚠️ ".concat(e),"dashboard")}),er()):(c.Z.error("Erreur cr\xe9ation dispositifs fictifs:",a.error),B("❌ Erreur: ".concat(a.error),"dashboard"))}catch(e){c.Z.error("Erreur cr\xe9ation dispositifs fictifs:",e),B("❌ Erreur: ".concat(e.message||e),"dashboard")}finally{tu(!1)}},[V,z,er,B]);let tm=(0,s.useCallback)(async e=>{if(eI&&e){eF(!0);try{let t="".concat(z,"/api.php/devices/").concat(eI.id),a=await V(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({patient_id:e})},{requiresAuth:!0});if(!a.ok){let e=await a.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(a.status))}let r=await a.json();if(!r.success)throw Error(r.error||"Erreur API");let s=ej.find(t=>t.id===e);c.Z.log("✅ Dispositif assign\xe9 \xe0 ".concat(null==s?void 0:s.first_name," ").concat((null==s?void 0:s.last_name)||e)),B("✅ Dispositif assign\xe9 \xe0 ".concat(null==s?void 0:s.first_name," ").concat((null==s?void 0:s.last_name)||e),"dashboard"),eO(!1),eZ(null),er()}catch(e){c.Z.error("Erreur assignation patient:",e),B("❌ Erreur assignation patient: ".concat(e.message||e),"dashboard")}finally{eF(!1)}}},[V,z,eI,ej,B,er]),tx=(0,s.useMemo)(()=>{let e=new Set(el.filter(e=>e.patient_id).map(e=>e.patient_id));return ej.filter(t=>!t.deleted_at&&!e.has(t.id))},[ej,el]),tp=(0,s.useCallback)(e=>{if(null==e?void 0:e.deleted_at){c.Z.warn("Tentative de flash d'un dispositif archiv\xe9");return}eq(e),eU(!0)},[]);return(0,r.jsxs)("div",{className:"space-y-6",children:[eD&&(0,r.jsx)(y.Z,{message:eD,onDismiss:()=>eC(null)}),(0,r.jsx)(m.Z,{isOpen:eA,onClose:()=>{eO(!1),eZ(null)},title:eI?"\uD83D\uDD17 Assigner un patient \xe0 ".concat(eI.device_name||eI.sim_iccid||eI.device_serial||"Dispositif #".concat(eI.id)):"Assigner un patient au dispositif",maxWidth:"max-w-md",children:eI&&(0,r.jsx)(r.Fragment,{children:ey?(0,r.jsx)("div",{className:"text-center py-4",children:(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400",children:"Chargement des patients..."})}):0===tx.length?(0,r.jsxs)("div",{className:"text-center py-4",children:[(0,r.jsx)("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Aucun patient disponible"}),(0,r.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-500 mb-4",children:"Tous les patients ont d\xe9j\xe0 un dispositif assign\xe9"}),(0,r.jsx)("button",{className:"btn-secondary",onClick:()=>{eO(!1),eZ(null)},children:"Fermer"})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium mb-2 text-gray-700 dark:text-gray-300",children:"S\xe9lectionner un patient libre :"}),(0,r.jsxs)("select",{id:"patient-select",className:"input w-full",defaultValue:"",children:[(0,r.jsx)("option",{value:"",children:"— S\xe9lectionner un patient —"}),tx.map(e=>(0,r.jsxs)("option",{value:e.id,children:[e.first_name," ",e.last_name," ",e.email?"(".concat(e.email,")"):""]},e.id))]})]}),(0,r.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,r.jsx)("button",{className:"btn-secondary",onClick:()=>{eO(!1),eZ(null)},disabled:eR,children:"Annuler"}),(0,r.jsx)("button",{className:"btn-primary",onClick:()=>{let e=document.getElementById("patient-select"),t=e?parseInt(e.value,10):null;t?tm(t):(c.Z.warn("Veuillez s\xe9lectionner un patient"),B("⚠️ Veuillez s\xe9lectionner un patient","dashboard"))},disabled:eR,children:eR?"⏳ Assignation...":"\uD83D\uDD17 Assigner"})]})]})})}),(0,r.jsx)(f,{isOpen:eL,onClose:()=>{eU(!1),eq(null)},device:eP,flashMode:eP&&D&&((null==k?void 0:k.sim_iccid)===eP.sim_iccid||(null==k?void 0:k.device_serial)===eP.device_serial)?"usb":"ota"}),(0,r.jsx)(b,{isOpen:eB,onClose:()=>{eM(!1),eV(null)},editingItem:eJ||(k&&!eJ?{sim_iccid:k.sim_iccid||"",device_serial:k.device_serial||"",device_name:k.device_name||"",firmware_version:k.firmware_version||""}:null),onSave:()=>{eM(!1);let e=(null==eJ?void 0:eJ.device_name)||(null==eJ?void 0:eJ.sim_iccid)||(null==k?void 0:k.device_name)||(null==k?void 0:k.sim_iccid)||"nouveau dispositif";er(),B('✅ Dispositif "'.concat(e,'" ').concat(eJ?"mis \xe0 jour":"cr\xe9\xe9"),"dashboard"),eV(null)},fetchWithAuth:V,API_URL:z,patients:ej,allDevices:el,appendLog:B}),(0,r.jsxs)("div",{className:"card",children:[!E&&(0,r.jsx)("div",{className:"alert alert-warning mb-4",children:"Le navigateur utilis\xe9 ne supporte pas l'API Web Serial. Utilisez Chrome ou Edge (desktop)."}),O&&(0,r.jsx)("div",{className:"alert alert-warning mb-4",children:O}),(0,r.jsx)("div",{className:"mb-4 space-y-2"}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"mb-4 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("h3",{className:"text-sm font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2 mb-2",children:[(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDD0C"}),"Dispositifs"]}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Derni\xe8res valeurs enregistr\xe9es en base de donn\xe9es."})]}),(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:K,onChange:e=>Q(e.target.checked),className:"w-4 h-4 text-blue-600 rounded focus:ring-blue-500"}),(0,r.jsx)("span",{className:"text-sm text-gray-700 dark:text-gray-300",children:"\uD83D\uDDC4️ Afficher les archives"})]})})]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:ea?(0,r.jsx)("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"Chargement des dispositifs..."}):(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("table",{className:"w-full border-collapse bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"bg-gray-50 dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Identifiant"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Patient"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Firmware"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Modem"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"GPS"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"D\xe9bit"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Batterie"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"RSSI"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Mesures"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Derni\xe8re mise \xe0 jour"}),(0,r.jsx)("th",{className:"px-3 py-1.5 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase",children:"Actions"})]})}),(0,r.jsxs)("tbody",{children:[w&&!el.find(e=>e.sim_iccid===w.sim_iccid||e.device_serial===w.device_serial)&&(0,r.jsxs)("tr",{className:"table-row bg-blue-50 dark:bg-blue-900/20 animate-pulse hover:bg-blue-100 dark:hover:bg-blue-900/30",children:[(0,r.jsxs)("td",{className:"table-cell px-3 py-3 text-sm text-gray-900 dark:text-gray-100",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-blue-500 text-lg animate-spin",children:"⏳"}),(0,r.jsx)("span",{className:"font-medium",children:w.device_name}),(0,r.jsx)("span",{className:"text-xs bg-blue-500 text-white px-2 py-0.5 rounded",children:"Enregistrement automatique..."})]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500 mt-1",children:["ICCID: ",w.sim_iccid||"N/A"]})]}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:"-"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:w.firmware_version||"N/A"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:"USB"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:"-"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:(null==I?void 0:null===(d=I.flowrate)||void 0===d?void 0:d.toFixed(2))||"-"}),(0,r.jsxs)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:[(null==I?void 0:null===(u=I.battery)||void 0===u?void 0:u.toFixed(0))||"-","%"]}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:(null==I?void 0:I.rssi)||"-"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:T.length}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:"Temps r\xe9el"}),(0,r.jsx)("td",{className:"table-cell px-3 py-3 text-sm text-gray-500 dark:text-gray-400",children:(0,r.jsx)("span",{className:"text-xs text-gray-500 italic",children:"Auto..."})})]},w.id),0!==el.length||w?ec.map(e=>{let t=!!e.deleted_at,a=D&&((null==k?void 0:k.sim_iccid)===e.sim_iccid||(null==k?void 0:k.device_serial)===e.device_serial||(null==j?void 0:j.id)===e.id);w&&(w.sim_iccid===e.sim_iccid||(w.device_serial,e.device_serial));let s=a?k:null,i=a?I:null;return(0,r.jsxs)("tr",{className:"table-row hover:bg-gray-50 dark:hover:bg-gray-800 ".concat(t?"opacity-60":""),children:[(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{let i=(null==s?void 0:s.device_name)||(null==e?void 0:e.device_name),l=(null==s?void 0:s.sim_iccid)||(null==s?void 0:s.device_serial)||(null==e?void 0:e.sim_iccid)||(null==e?void 0:e.device_serial);(null==s?void 0:s.device_name)||null==e||e.device_name;let n=(null==s?void 0:s.last_seen)||(null==e?void 0:e.last_seen);return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(i?"text-orange-600 dark:text-orange-400":"text-gray-400 dark:text-gray-500"),children:i||"N/A"}),t&&(0,r.jsx)("span",{className:"ml-2 badge bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 text-xs",children:"\uD83D\uDDC4️ Archiv\xe9"}),a&&(0,r.jsxs)("span",{className:"inline-flex items-center gap-0.5 px-1.5 py-0.5 text-[10px] font-medium bg-green-500 text-white rounded animate-pulse",children:[(0,r.jsx)("span",{className:"w-1 h-1 bg-white rounded-full"}),"LIVE"]})]}),l&&(0,r.jsx)("span",{className:"text-xs font-mono text-gray-600 dark:text-gray-400",children:l}),n&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(n)})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{let a=(null==e?void 0:e.first_name)&&(null==e?void 0:e.last_name)?"".concat(e.first_name," ").concat(e.last_name):null,s=!!a;return(0,r.jsx)("div",{className:"flex items-center gap-1",children:s?(0,r.jsx)("span",{className:"badge badge-success text-xs",children:a}):(0,r.jsx)("span",{className:"badge ".concat(t?"bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400":"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300"," text-xs"),children:"Non assign\xe9"})})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{var a;let l=(null==i?void 0:null===(a=i.raw)||void 0===a?void 0:a.firmware_version)||(null==i?void 0:i.firmware_version)||(null==s?void 0:s.firmware_version)||(null==e?void 0:e.firmware_version);(null==i?void 0:i.firmware_version)||(null==s?void 0:s.firmware_version)||null==e||e.firmware_version;let n=(null==i?void 0:i.timestamp)||(null==s?void 0:s.last_seen)||(null==e?void 0:e.last_seen),c=eN.length>0;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:t?(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(l?"text-cyan-600 dark:text-cyan-400":"text-gray-400 dark:text-gray-500"),children:l||"N/A"}):c?(0,r.jsx)("button",{onClick:()=>tp(e),className:"text-xs font-semibold hover:underline transition-colors ".concat(l?"text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300 cursor-pointer":"text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300"),title:"Cliquer pour flasher un firmware",children:l||"N/A"}):(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(l?"text-cyan-600 dark:text-cyan-400":"text-gray-400 dark:text-gray-500"),children:l||"N/A"})}),l&&n&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(n)})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{let t=(null==i?void 0:i.rssi)!=null&&(null==i?void 0:i.rssi)!==-999||(null==s?void 0:s.rssi)!=null&&(null==s?void 0:s.rssi)!==-999||(null==i?void 0:i.latitude)!=null||(null==s?void 0:s.latitude)!=null||(null==e?void 0:e.last_rssi)!=null&&(null==e?void 0:e.last_rssi)!==-999;(null==i?void 0:i.rssi)!=null||(null==s?void 0:s.rssi)!=null||(null==i?void 0:i.latitude)!=null||(null==s?void 0:s.latitude)!=null||null==e||e.last_rssi;let l=(null==i?void 0:i.timestamp)||(null==s?void 0:s.last_seen)||(null==e?void 0:e.last_seen),n=a&&t?"running":a?"starting":"stopped";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat("running"===n?"text-green-600 dark:text-green-400":"starting"===n?"text-yellow-600 dark:text-yellow-400":"text-gray-400 dark:text-gray-500"),children:"running"===n?"Actif":"starting"===n?"D\xe9marrage...":"Arr\xeat\xe9"})}),t&&l&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(l)})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{var t,a,l,n,c,o,d,u,m;let x,p,g;let h=null!==(t=null==i?void 0:i.latitude)&&void 0!==t?t:null==s?void 0:s.latitude,f=null!==(a=null==i?void 0:i.longitude)&&void 0!==a?a:null==s?void 0:s.longitude,v=ta(h,null==i?void 0:i.timestamp,null==e?void 0:e.latitude,null==e?void 0:e.last_seen),b=ta(f,null==i?void 0:i.timestamp,null==e?void 0:e.longitude,null==e?void 0:e.last_seen),y=null!==(c=null!==(n=null!==(l=v.value)&&void 0!==l?l:h)&&void 0!==n?n:null==e?void 0:e.latitude)&&void 0!==c?c:null,j=null!==(u=null!==(d=null!==(o=b.value)&&void 0!==o?o:f)&&void 0!==d?d:null==e?void 0:e.longitude)&&void 0!==u?u:null,_=null!=y&&null!=j&&0!==y&&0!==j&&!isNaN(y)&&!isNaN(j),w=null!==(m=null==e?void 0:e.gps_enabled)&&void 0!==m&&m;v.source||b.source;let N=v.timestamp||b.timestamp||(null==i?void 0:i.timestamp);return w?_?(x="ON",p="text-green-600 dark:text-green-400",g="".concat(Number(y).toFixed(4),", ").concat(Number(j).toFixed(4))):(x="N/A",p="text-yellow-600 dark:text-yellow-400",g="GPS activ\xe9, fix en cours..."):(x="OFF",p="text-gray-400 dark:text-gray-500",g="D\xe9sactiv\xe9"),(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(p),children:"ON"===x?g:"".concat(x,": ").concat(g)})}),_&&N&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(N)})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{var t,a,l,n;let c=null!==(t=null==i?void 0:i.flowrate)&&void 0!==t?t:null==s?void 0:s.flowrate,o=ta(c,null==i?void 0:i.timestamp,null==e?void 0:e.last_flowrate,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(a=o.value)&&void 0!==a?a:c)&&void 0!==l?l:null==e?void 0:e.last_flowrate)&&void 0!==n?n:null;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(null==d||isNaN(d)?"text-gray-400 dark:text-gray-500":"text-blue-600 dark:text-blue-400"),children:null==d||isNaN(d)?"N/A":"".concat(Number(d).toFixed(2)," L/min")})}),null!=d&&!isNaN(d)&&(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{var t,a,l,n;let c=null!==(t=null==i?void 0:i.battery)&&void 0!==t?t:null==s?void 0:s.last_battery,o=ta(c,null==i?void 0:i.timestamp,null==e?void 0:e.last_battery,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(a=o.value)&&void 0!==a?a:c)&&void 0!==l?l:null==e?void 0:e.last_battery)&&void 0!==n?n:null,u=null==d||isNaN(d)?0:d,m=null==d||isNaN(d)?"text-gray-400 dark:text-gray-500":u>=50?"text-green-600 dark:text-green-400":u>=20?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(m),children:null==d||isNaN(d)?"N/A":"".concat(Number(u).toFixed(0),"%")})}),null!=d&&!isNaN(d)&&(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{var t,a,l,n;let c=null!==(t=null==i?void 0:i.rssi)&&void 0!==t?t:null==s?void 0:s.rssi,o=ta(c,null==i?void 0:i.timestamp,null==e?void 0:e.last_rssi,null==e?void 0:e.last_seen),d=null!==(n=null!==(l=null!==(a=o.value)&&void 0!==a?a:c)&&void 0!==l?l:null==e?void 0:e.last_rssi)&&void 0!==n?n:null,u=null!=d&&-999!==d&&!isNaN(d),m=u?d>=-70?"text-green-600 dark:text-green-400":d>=-90?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400":"text-gray-400 dark:text-gray-500";return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(m),children:u?"".concat(Number(d)," dBm"):"N/A"})}),u&&(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(o.timestamp||(null==i?void 0:i.timestamp)||(null==e?void 0:e.last_seen))})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{let t=a&&(null==T?void 0:T.length)||(e?1:0);return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(0===t?"text-gray-400 dark:text-gray-500":"text-purple-600 dark:text-purple-400"),children:t})}),a&&(null==i?void 0:i.timestamp)&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:tr(i.timestamp)})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(()=>{let t=a?Z||(null==i?void 0:i.timestamp)||(null==s?void 0:s.last_seen):null,l=null==e?void 0:e.last_seen,n=t||l,c=n?Math.floor((e1-n)/1e3):null;return(0,r.jsxs)("div",{className:"flex flex-col gap-0.5",children:[(0,r.jsx)("div",{className:"flex items-center gap-1",children:(0,r.jsx)("span",{className:"text-xs font-semibold ".concat(null!=c&&c<60?"text-green-600 dark:text-green-400":"text-gray-400 dark:text-gray-500"),children:null!=c?"".concat(c,"s"):"Jamais"})}),n&&(0,r.jsx)("span",{className:"text-[10px] text-gray-500 dark:text-gray-400",children:new Date(n).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]})})()}),(0,r.jsx)("td",{className:"table-cell px-3 py-1.5",children:(0,r.jsx)("div",{className:"flex items-center justify-end gap-2",children:t?(0,r.jsx)("button",{onClick:()=>to(e),disabled:$===e.id,className:"p-2 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg transition-colors disabled:opacity-50",title:"Restaurer le dispositif",children:(0,r.jsx)("span",{className:"text-lg",children:$===e.id?"⏳":"♻️"})}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>{eV(e),eM(!0)},className:"p-2 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg transition-colors",title:"Modifier le dispositif (donn\xe9es et configuration)",children:(0,r.jsx)("span",{className:"text-lg",children:"✏️"})}),(0,r.jsx)("button",{onClick:()=>tp(e),disabled:0===eN.length,className:"p-2 hover:bg-primary-100 dark:hover:bg-primary-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:0===eN.length?"Aucun firmware compil\xe9 disponible. Compilez d'abord un firmware dans l'onglet \"Upload INO\".":"Flasher le firmware",children:(0,r.jsx)("span",{className:"text-lg",children:"\uD83D\uDE80"})}),G("devices.edit")&&(0,r.jsx)(r.Fragment,{children:(null==H?void 0:H.role_name)==="admin"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{onClick:()=>tn(e),disabled:ek,className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Archiver le dispositif",children:(0,r.jsx)("span",{className:"text-lg",children:ek?"⏳":"\uD83D\uDDC4️"})}),(0,r.jsx)("button",{onClick:()=>tc(e),disabled:ek,className:"p-2 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Supprimer d\xe9finitivement le dispositif",children:(0,r.jsx)("span",{className:"text-lg",children:ek?"⏳":"\uD83D\uDDD1️"})})]}):(0,r.jsx)("button",{onClick:()=>tn(e),disabled:ek,className:"p-2 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Archiver le dispositif",children:(0,r.jsx)("span",{className:"text-lg",children:ek?"⏳":"\uD83D\uDDC4️"})})})]})})})]},e.id)}):(0,r.jsx)("tr",{className:"table-row hover:bg-gray-50 dark:hover:bg-gray-800",children:(0,r.jsx)("td",{colSpan:"11",className:"table-cell px-3 py-8 text-center text-gray-500 dark:text-gray-400",children:(0,r.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,r.jsx)("span",{className:"text-4xl",children:"\uD83D\uDD0C"}),(0,r.jsx)("p",{className:"text-sm font-medium",children:"Aucun dispositif enregistr\xe9"}),(0,r.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:"Connectez un dispositif USB pour l'enregistrer automatiquement"})]})})})]})]})})})]}),(0,r.jsxs)("div",{className:"mb-6",children:[(0,r.jsxs)("div",{className:"mb-4 flex items-start justify-between gap-4",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:"\uD83D\uDCE1 Console de Logs USB"}),(0,r.jsx)("span",{className:"px-2 py-1 rounded text-xs font-medium ".concat(D?"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400":"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-400"),children:D?"USB Connect\xe9":"USB D\xe9connect\xe9"})]}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Logs en temps r\xe9el du streaming USB et des actions du dashboard"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>{"running"===S?(q(),c.Z.log("⏸️ Logs en pause")):"paused"===S&&(P(C),c.Z.log("▶️ Logs reprennent"))},className:"px-3 py-1.5 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2 ".concat("paused"===S?"bg-green-500 hover:bg-green-600":"bg-orange-500 hover:bg-orange-600"),title:"paused"===S?"Reprendre les logs":"Mettre en pause les logs",disabled:!D,children:"paused"===S?"▶️":"⏸️"}),(0,r.jsx)("button",{onClick:()=>{let e=[...A,...eo].join("\n");navigator.clipboard.writeText(e).then(()=>{c.Z.log("\uD83D\uDCCB Logs copi\xe9s dans le presse-papiers")}).catch(e=>{c.Z.error("❌ Erreur copie:",e)})},className:"px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2",title:"Copier tous les logs",children:"\uD83D\uDCCB Copier"}),(0,r.jsx)("button",{onClick:()=>eT(!0),className:"px-3 py-1.5 bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2",title:"Effacer la console",children:"\uD83D\uDDD1️ RAZ"})]})]}),(0,r.jsxs)("div",{className:"rounded-2xl border border-gray-200 dark:border-slate-700 bg-gray-900 p-4 shadow-inner overflow-y-auto",style:{minHeight:"500px",maxHeight:"600px"},children:[eu&&(0,r.jsxs)("div",{className:"mb-3 flex items-center gap-2 text-xs",children:[(0,r.jsxs)("span",{className:"flex items-center gap-1 text-purple-400",children:[(0,r.jsx)("span",{className:"animate-pulse",children:"\uD83D\uDCE1"}),"Streaming distant en temps r\xe9el"]}),(0,r.jsxs)("span",{className:"text-gray-500",children:["(",eo.length," logs)"]})]}),0===ef.length?(0,r.jsxs)("div",{className:"h-full flex flex-col items-center justify-center text-center space-y-2 text-gray-500",children:[(0,r.jsx)("span",{className:"text-4xl",children:"\uD83D\uDCE1"}),(0,r.jsx)("p",{className:"font-medium",children:eu?"Chargement du streaming distant...":"En attente de logs USB..."}),(0,r.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:eu?"Les logs appara\xeetront ici d\xe8s qu'ils seront disponibles":"Connectez un dispositif USB et d\xe9marrez le streaming pour voir les logs"})]}):(0,r.jsx)("div",{className:"space-y-1 font-mono text-sm tracking-tight",children:[...ef].reverse().map(e=>{let t="dashboard"===e.source,a=e.isRemote,s=W(e.line)||e.line,i=Y(X(s),t);return(0,r.jsxs)("div",{className:"whitespace-pre-wrap",children:[(0,r.jsx)("span",{className:"text-gray-500 pr-3",children:new Date(e.timestamp).toLocaleTimeString("fr-FR")}),a&&(0,r.jsx)("span",{className:"text-purple-400 text-xs mr-2",children:"\uD83D\uDCE1"}),(0,r.jsx)("span",{className:i,children:s})]},e.id)})})]})]})]}),eS&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/70 flex items-center justify-center z-50 p-4",children:(0,r.jsx)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full border border-gray-200 dark:border-gray-700",children:(0,r.jsxs)("div",{className:"p-6",children:[(0,r.jsxs)("div",{className:"flex items-start gap-4 mb-4",children:[(0,r.jsx)("div",{className:"p-3 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg",children:(0,r.jsx)("span",{className:"text-3xl",children:"⚠️"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-gray-900 dark:text-gray-100 mb-2",children:"Effacer la console ?"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Cette action supprimera tous les logs affich\xe9s dans la console USB. Les logs ne seront pas supprim\xe9s de la base de donn\xe9es."})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:()=>eT(!1),className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors",children:"Annuler"}),(0,r.jsx)("button",{onClick:()=>{"function"==typeof clearUsbStreamLogs&&clearUsbStreamLogs(),ed([]),eT(!1),c.Z.log("\uD83D\uDDD1️ Console effac\xe9e")},className:"px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors",children:"\uD83D\uDDD1️ Effacer"})]})]})})})]})}let _="force-dynamic";function w(){let{user:e,fetchWithAuth:t,API_URL:a}=(0,i.a)(),{isSupported:o,autoDetecting:d,setAutoDetecting:u,usbConnectedDevice:m,usbVirtualDevice:p,setSendMeasurementCallback:g,setUpdateDeviceFirmwareCallback:h}=(0,l.l)();(0,n.Eg)(o,d,u,m,p),(0,s.useEffect)(()=>()=>{c.Z.debug("[OUTILS] Cleanup")},[]),(0,s.useEffect)(()=>{if(!t||!a)return;let e=async function(e,r){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{let i=await t("".concat(a,"/api.php/devices"),{method:"GET"},{requiresAuth:!0});if(!i.ok)return;let l=((await i.json()).devices||[]).find(t=>t.sim_iccid===e||t.device_serial===e||t.device_name===e);if(!l){c.Z.log("\uD83C\uDD95 [AUTO-CREATE] Dispositif non trouv\xe9 (".concat(e,"), cr\xe9ation automatique..."));let i={device_name:s.device_name||"USB-".concat(e.slice(-4)),sim_iccid:s.sim_iccid||(e.startsWith("89")?e:null),device_serial:s.device_serial||(e.startsWith("89")?null:e),firmware_version:r||null,status:s.status||"usb_connected",last_seen:s.last_seen||new Date().toISOString()};void 0!==s.last_battery&&(i.last_battery=s.last_battery),void 0!==s.last_flowrate&&(i.last_flowrate=s.last_flowrate),void 0!==s.last_rssi&&(i.last_rssi=s.last_rssi),await t("".concat(a,"/api.php/devices"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)},{requiresAuth:!0}),c.Z.log("✅ [AUTO-CREATE] Dispositif cr\xe9\xe9 avec succ\xe8s");return}let n={...s};r&&""!==r&&(n.firmware_version=r),await t("".concat(a,"/api.php/devices/").concat(l.id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},{requiresAuth:!0})}catch(e){}};return g(async e=>{try{let r=await t("".concat(a,"/api.php/devices/measurements"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},{requiresAuth:!1});if(!r.ok){let e=await r.json().catch(()=>({}));throw Error(e.error||"Erreur HTTP ".concat(r.status))}return await r.json()}catch(e){throw c.Z.error("❌ Erreur envoi mesure USB:",e),e}}),h(e),()=>{g(null),h(null)}},[t,a,g,h]);let f=(null==e?void 0:e.role_name)==="admin"||(null==e?void 0:e.role_name)==="technicien",[v,b]=(0,s.useState)("streaming");return((0,s.useEffect)(()=>{c.Z.debug("[OUTILS] Onglet:",v)},[v]),f)?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"border-b border-gray-200 dark:border-gray-700",children:(0,r.jsx)("nav",{className:"flex space-x-8",children:[{id:"streaming",label:"Dispositifs",icon:"\uD83D\uDD27"},{id:"ino",label:"Upload INO",icon:"\uD83D\uDCDD"}].map(e=>(0,r.jsxs)("button",{onClick:()=>b(e.id),className:"\n                py-4 px-1 border-b-2 font-medium text-sm transition-colors relative\n                ".concat(v===e.id?"border-primary-500 text-primary-600 dark:text-primary-400":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300","\n              "),children:[(0,r.jsx)("span",{className:"mr-2",children:e.icon}),e.label]},e.id))})}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("div",{style:{display:"ino"===v?"block":"none"},children:(0,r.jsx)(x,{})}),(0,r.jsx)("div",{style:{display:"streaming"===v?"block":"none"},children:(0,r.jsx)(j,{})})]})]}):(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)("div",{className:"alert alert-warning",children:"Acc\xe8s refus\xe9. Seuls les administrateurs et techniciens peuvent acc\xe9der aux outils."})})}},9131:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var r=a(7437),s=a(798);function i(e){let{isOpen:t,onClose:a,onConfirm:i,onSecondAction:l,title:n,message:c,confirmText:o="Confirmer",secondActionText:d,cancelText:u="Annuler",variant:m="info",secondActionVariant:x="danger",loading:p=!1}=e,g={danger:{icon:"⚠️",confirmClass:"bg-red-600 hover:bg-red-700 text-white",iconBg:"bg-red-100 dark:bg-red-900/30"},warning:{icon:"⚠️",confirmClass:"bg-yellow-600 hover:bg-yellow-700 text-white",iconBg:"bg-yellow-100 dark:bg-yellow-900/30"},info:{icon:"ℹ️",confirmClass:"bg-blue-600 hover:bg-blue-700 text-white",iconBg:"bg-blue-100 dark:bg-blue-900/30"},success:{icon:"✓",confirmClass:"bg-green-600 hover:bg-green-700 text-white",iconBg:"bg-green-100 dark:bg-green-900/30"}},h=g[m]||g.info;return(0,r.jsx)(s.Z,{isOpen:t,onClose:a,title:n,maxWidth:"max-w-lg",children:(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-start gap-4",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded-full ".concat(h.iconBg," flex items-center justify-center text-2xl"),children:h.icon}),(0,r.jsx)("div",{className:"flex-1 pt-1",children:(0,r.jsx)("p",{className:"text-gray-700 dark:text-gray-300 whitespace-pre-line",children:c})})]}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end pt-4 border-t border-gray-200 dark:border-gray-700",children:[(0,r.jsx)("button",{onClick:a,disabled:p,className:"px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u}),(0,r.jsxs)("button",{onClick:i,disabled:p,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 ".concat(h.confirmClass),children:[p&&(0,r.jsxs)("svg",{className:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),o]}),l&&d&&(0,r.jsxs)("button",{onClick:l,disabled:p,className:"px-4 py-2 text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 ".concat("danger"===x?"bg-red-600 hover:bg-red-700 text-white":"bg-yellow-600 hover:bg-yellow-700 text-white"),children:[p&&(0,r.jsxs)("svg",{className:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,r.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,r.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),d]})]})]})})}},798:function(e,t,a){"use strict";a.d(t,{Z:function(){return s}});var r=a(7437);function s(e){let{isOpen:t,onClose:a,title:s,children:i,maxWidth:l="max-w-md"}=e;return t?(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 dark:bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm",onClick:a,children:(0,r.jsxs)("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-2xl ".concat(l," w-full mx-4 p-6"),onClick:e=>e.stopPropagation(),children:[(s||a)&&(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[s&&(0,r.jsx)("h2",{className:"text-xl font-bold text-gray-900 dark:text-gray-100",children:s}),a&&(0,r.jsx)("button",{onClick:a,className:"w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200",title:"Fermer","aria-label":"Fermer",children:(0,r.jsx)("span",{className:"text-2xl font-bold leading-none",children:"\xd7"})})]}),(0,r.jsx)("div",{className:"text-gray-700 dark:text-gray-300",children:i})]})}):null}},6601:function(e,t,a){"use strict";a.d(t,{Z:function(){return i}});var r=a(7437),s=a(2265);function i(e){let{message:t,onClose:a=null,autoClose:i=5e3,className:l=""}=e;return((0,s.useEffect)(()=>{if(i&&a){let e=setTimeout(()=>{a()},i);return()=>clearTimeout(e)}},[i,a]),t)?(0,r.jsx)("div",{className:"bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg animate-slide-down ".concat(l),children:(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"text-sm font-medium",children:"✅ Succ\xe8s"}),(0,r.jsx)("p",{className:"text-sm mt-1",children:t})]}),a&&(0,r.jsx)("button",{onClick:a,className:"ml-4 text-green-700 hover:text-green-900 text-sm","aria-label":"Fermer",children:"✕"})]})}):null}}},function(e){e.O(0,[3125,9531,7410,4767,2971,2117,1744],function(){return e(e.s=4408)}),_N_E=e.O()}]);