"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7546],{7546:function(e,t,r){r.d(t,{sendMeasurementWithRetry:function(){return c}});var a=r(8828);let n="measurements",s=null;async function i(){return s||new Promise((e,t)=>{let r=indexedDB.open("ott_measurements_queue",1);r.onerror=()=>t(r.error),r.onsuccess=()=>{e(s=r.result)},r.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains(n)){let e=t.createObjectStore(n,{keyPath:"id",autoIncrement:!0});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("device_id","device_id",{unique:!1})}}})}async function u(e){try{let t=(await i()).transaction([n],"readwrite").objectStore(n),r={...e,timestamp:Date.now(),retryCount:0,lastRetry:null};return await t.add(r),!0}catch(e){return a.Z.error("Erreur ajout mesure \xe0 la queue:",e),!1}}let o=[1e3,2e3,5e3,1e4,3e4];async function c(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{maxRetries:n=5,retryDelays:s=o}=r,i={sim_iccid:String(e.sim_iccid||"").trim(),flowrate:null!==e.flowrate&&void 0!==e.flowrate?Number(e.flowrate):0,battery:null!==e.battery&&void 0!==e.battery?Number(e.battery):null,rssi:null!==e.rssi&&void 0!==e.rssi?Number(e.rssi):null,firmware_version:e.firmware_version||null,timestamp:e.timestamp||new Date().toISOString(),status:e.status||"USB"},c=function(e){let t=[];if(e.sim_iccid&&"string"==typeof e.sim_iccid?e.sim_iccid.length>20&&t.push("ICCID trop long (max 20 caract\xe8res)"):t.push("ICCID manquant ou invalide"),null!==e.flowrate&&void 0!==e.flowrate){let r=Number(e.flowrate);(isNaN(r)||r<0||r>1e3)&&t.push("Flowrate invalide: ".concat(e.flowrate," (attendu: 0-1000 L/min)"))}if(null!==e.battery&&void 0!==e.battery){let r=Number(e.battery);(isNaN(r)||r<0||r>100)&&t.push("Batterie invalide: ".concat(e.battery," (attendu: 0-100%)"))}if(null!==e.rssi&&void 0!==e.rssi){let r=Number(e.rssi);(isNaN(r)||-999!==r&&(r<-150||r>0))&&t.push("RSSI invalide: ".concat(e.rssi,' (attendu: -150 \xe0 0 dBm, ou -999 pour "pas de signal")'))}return{valid:0===t.length,errors:t}}(i);if(!c.valid)return a.Z.error("Mesure invalide:",c.errors,i),{success:!1,error:c.errors.join(", ")};for(let e=0;e<=n;e++)try{return await t(i),a.Z.debug("✅ Mesure envoy\xe9e (tentative ".concat(e+1,")"),i),{success:!0}}catch(o){let t=e===n,r=s[e]||s[s.length-1];if(t)return a.Z.error("❌ \xc9chec envoi mesure apr\xe8s toutes les tentatives:",o),await u(i),{success:!1,error:o.message,queued:!0};a.Z.warn("⚠️ Tentative ".concat(e+1,"/").concat(n+1," \xe9chou\xe9e, retry dans ").concat(r,"ms:"),o.message),await new Promise(e=>setTimeout(e,r))}return{success:!1,error:"Toutes les tentatives ont \xe9chou\xe9"}}}}]);