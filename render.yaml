# ================================================================================
# Configuration Render - OTT API Backend
# ================================================================================
# HAPPLYZ MEDICAL SAS
# Configuration pour d√©ploiement sur Render.com
# ================================================================================
#
# ‚ö†Ô∏è IMPORTANT : Configuration du Persistent Disk
# Pour √©viter de ret√©l√©charger le core ESP32 (~430MB) √† chaque d√©ploiement,
# configurez un Persistent Disk dans le dashboard Render :
# 1. Allez dans votre service ott-api > Disks
# 2. Cliquez sur "Add Disk"
# 3. Mount Path: /opt/render/project/src/arduino-data
# 4. Size: 1 GB (minimum recommand√©)
# 5. Enregistrez et d√©ployez
#
# üìñ Documentation compl√®te : docs/RENDER_PERSISTENT_DISK.md
# ================================================================================

services:
  - type: web
    name: ott-api
    env: php
    buildCommand: |
      # ‚ö†Ô∏è CRITIQUE: arduino-cli est OBLIGATOIRE - la compilation ne doit JAMAIS √™tre simul√©e
      echo "üîß Installation d'arduino-cli (OBLIGATOIRE)..."
      export PATH="${HOME}/.local/bin:${PATH}"
      bash scripts/install_arduino_cli.sh
      # S'assurer que le PATH inclut ~/.local/bin pour cette session
      export PATH="${HOME}/.local/bin:${PATH}"
      # V√©rifier que arduino-cli est disponible et fonctionnel
      if ! command -v arduino-cli &> /dev/null; then
        echo "‚ùå ERREUR CRITIQUE: arduino-cli n'est pas disponible apr√®s installation"
        echo "‚ùå Le build est interrompu - la compilation ne peut pas √™tre simul√©e"
        exit 1
      fi
      # V√©rifier que arduino-cli fonctionne
      if ! arduino-cli version &> /dev/null; then
        echo "‚ùå ERREUR CRITIQUE: arduino-cli est install√© mais ne fonctionne pas"
        exit 1
      fi
      echo "‚úÖ arduino-cli disponible et fonctionnel: $(arduino-cli version)"
      # Pr√©parer le r√©pertoire arduino-data avec le core ESP32 d√©j√† install√©
      echo "üîß Pr√©paration du r√©pertoire arduino-data avec le core ESP32..."
      bash scripts/prepare_arduino_core.sh
      echo "‚úÖ Le core ESP32 est maintenant install√© et pr√™t dans arduino-data/"
      echo "‚úÖ Les compilations futures utiliseront ce core directement (pas de ret√©l√©chargement)"
      echo "‚úÖ La compilation sera R√âELLE, jamais simul√©e"
    startCommand: |
      export PATH="${HOME}/.local/bin:${PATH}"
      php -S 0.0.0.0:$PORT -t .
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDGRID_FROM_EMAIL
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_FROM_NUMBER
        sync: false

