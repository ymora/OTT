# ================================================================================
# Configuration Render - OTT API Backend
# ================================================================================
# HAPPLYZ MEDICAL SAS
# Configuration pour d√©ploiement sur Render.com
# ================================================================================
#
# ‚ö†Ô∏è IMPORTANT : Configuration du Persistent Disk
# Pour √©viter de ret√©l√©charger le core ESP32 (~430MB) √† chaque d√©ploiement,
# configurez un Persistent Disk dans le dashboard Render :
# 1. Allez dans votre service ott-api > Disks
# 2. Cliquez sur "Add Disk"
# 3. Mount Path: /opt/render/project/src/hardware/arduino-data
# 4. Size: 1 GB (minimum recommand√©)
# 5. Enregistrez et d√©ployez
#
# üìñ Documentation compl√®te : docs/RENDER_PERSISTENT_DISK.md
# ================================================================================

services:
  - type: web
    name: ott-api
    env: php
    buildCommand: |
      # ‚ö†Ô∏è CRITIQUE: arduino-cli est OBLIGATOIRE - la compilation ne doit JAMAIS √™tre simul√©e
      echo "üîß Installation d'arduino-cli (OBLIGATOIRE)..."
      export PATH="${HOME}/.local/bin:${PATH}"
      bash scripts/hardware/install_arduino_cli.sh
      # S'assurer que le PATH inclut ~/.local/bin pour cette session
      export PATH="${HOME}/.local/bin:${PATH}"
      # V√©rifier que arduino-cli est disponible et fonctionnel
      if ! command -v arduino-cli &> /dev/null; then
        echo "‚ùå ERREUR CRITIQUE: arduino-cli n'est pas disponible apr√®s installation"
        echo "‚ùå Le build est interrompu - la compilation ne peut pas √™tre simul√©e"
        exit 1
      fi
      # V√©rifier que arduino-cli fonctionne
      if ! arduino-cli version &> /dev/null; then
        echo "‚ùå ERREUR CRITIQUE: arduino-cli est install√© mais ne fonctionne pas"
        exit 1
      fi
      echo "‚úÖ arduino-cli disponible et fonctionnel: $(arduino-cli version)"
      echo "üîß Pr√©paration du core ESP32 (cache non versionn√©)..."
      if [ ! -d "hardware/arduino-data" ]; then
        mkdir -p hardware/arduino-data
      fi
      export ARDUINO_DIRECTORIES_USER="$(pwd)/hardware/arduino-data"
      if [ -d "hardware/arduino-data/packages/esp32/hardware/esp32" ]; then
        echo "‚úÖ Core ESP32 trouv√© dans hardware/arduino-data (cache local/persistant)"
      else
        echo "‚öôÔ∏è Core ESP32 absent - installation en cours (une seule fois, ~430MB)..."
        bash scripts/hardware/prepare_arduino_core.sh
      fi
      echo "‚úÖ La compilation sera R√âELLE, jamais simul√©e"
    startCommand: |
      export PATH="${HOME}/.local/bin:${PATH}"
      # Utiliser router.php pour √©viter que les fichiers HTML de documentation soient servis directement
      php -S 0.0.0.0:$PORT router.php
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: SENDGRID_FROM_EMAIL
        sync: false
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_FROM_NUMBER
        sync: false
      - key: DEBUG_ERRORS
        sync: false
      - key: CORS_ALLOWED_ORIGINS
        sync: false
      - key: APP_ENV
        sync: false

