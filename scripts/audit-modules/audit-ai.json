{
  "instructions": "Ce fichier contient des questions pour l'IA concernant des problèmes détectés dans le code.\r\nPour chaque question, l'IA doit:\r\n1. Analyser le code fourni\r\n2. Comprendre le contexte du projet\r\n3. Proposer une solution concrète avec code corrigé si applicable\r\n4. Indiquer un niveau de confiance (0.0 à 1.0)\r\n5. Recommander une action (delete, refactor, fix, ignore, manual_review)",
  "timestamp": "2025-12-06T18:26:55.1144494Z",
  "questions": [
    {
      "line": 1,
      "severity": "high",
      "context": {
        "total_lines": 168,
        "file_exists": true
      },
      "id": "q1",
      "code_snippet": {
        "end_line": 16,
        "start_line": 1,
        "content": "'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { useRouter } from 'next/navigation'\r\nimport ConfirmModal from '@/components/ConfirmModal'\r\nimport logger from '@/lib/logger'\r\n\r\nexport default function Topbar() {\r\n  const { user, logout } = useAuth()\r\n  const router = useRouter()\r\n  const [showMenu, setShowMenu] = useState(false)\r\n  const [isDark, setIsDark] = useState(false)\r\n  const [showClearCacheModal, setShowClearCacheModal] = useState(false)\r\n\r\n  useEffect(() => {\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\Topbar.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\Topbar.js",
      "question": "Ce fichier 'C:\\Users\\ymora\\Desktop\\maxime\\components\\Topbar.js' n'est utilisé/importé nulle part dans le projet.\r\n- Dois-je le supprimer ou est-il prévu pour un usage futur ?\r\n- Y a-t-il un équivalent/remplacement dans le code ?\r\n- Analyse le code et recommande une action (supprimer, garder avec documentation, refactorer).\r\n\r\nProjet: Unknown / Unknown",
      "type": "dead_code",
      "description": "Composant non utilisé: Topbar"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 518,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 519,
        "file_exists": true
      },
      "id": "q2",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useMemo, useState } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport dynamicImport from 'next/dynamic'\r\nimport { useApiData, useAutoRefresh } from '@/hooks'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport { formatDate } from '@/lib/dateUtils'\r\n\r\n// Lazy load de la carte pour accélérer le chargement\r\nconst LeafletMap = dynamicImport(() => import('@/components/LeafletMap'), { ssr: false })\r\n\r\nexport default function DashboardPage() {\r\n  const router = useRouter()\r\n  const { user } = useAuth()\r\n  const { isConnected, usbConnectedDevice, usbVirtualDevice, usbDeviceInfo, usbStreamLastMeasurement } = useUsb()\r\n  \r\n  // Charger les données avec useApiData\r\n  const { data, loading, error, refetch } = useApiData(\r\n    [\r\n      '/api.php/devices',\r\n      '/api.php/alerts',\r\n      '/api.php/users',\r\n      '/api.php/patients',\r\n      '/api.php/firmwares'\r\n    ],\r\n    { requiresAuth: true }\r\n  )\r\n  \r\n  const [selectedDeviceOnMap, setSelectedDeviceOnMap] = useState(null)\r\n  const [focusDeviceId, setFocusDeviceId] = useState(null)\r\n  \r\n  // États pour les accordéons des KPIs\r\n  const [kpiAccordions, setKpiAccordions] = useState({\r\n    devices: false,\r\n    online: false,\r\n    alerts: false,\r\n    battery: false,\r\n    alertsAction: false,\r\n    batteryAction: false,\r\n    unassigned: false\r\n  })\r\n  \r\n  const toggleAccordion = (key) => {\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\page.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\page.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 518 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 518 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 1687,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 1688,
        "file_exists": true
      },
      "id": "q3",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useEffect, useMemo, useState, useRef, useCallback } from 'react'\r\nimport { useSearchParams } from 'next/navigation'\r\nimport { withBasePath } from '@/lib/utils'\r\nimport logger from '@/lib/logger'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { Bar, Doughnut, Line } from 'react-chartjs-2'\r\nimport MetadataCard from '@/components/MetadataCard'\r\nimport DayDetailsModal from '@/components/DayDetailsModal'\r\nimport {\r\n  Chart as ChartJS,\r\n  CategoryScale,\r\n  LinearScale,\r\n  BarElement,\r\n  ArcElement,\r\n  PointElement,\r\n  LineElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  Filler\r\n} from 'chart.js'\r\n\r\nChartJS.register(\r\n  CategoryScale,\r\n  LinearScale,\r\n  BarElement,\r\n  ArcElement,\r\n  PointElement,\r\n  LineElement,\r\n  Title,\r\n  Tooltip,\r\n  Legend,\r\n  Filler\r\n)\r\n\r\nconst DOCUMENTATION_FILES = {\r\n  presentation: 'DOCUMENTATION_PRESENTATION.html',\r\n  developpeurs: 'DOCUMENTATION_DEVELOPPEURS.html',\r\n  commerciale: 'DOCUMENTATION_COMMERCIALE.html',\r\n  'suivi-temps': 'SUIVI_TEMPS_FACTURATION.md',\r\n  database: null // Géré par un composant spécial\r\n}\r\n\r\nexport default function DocumentationPage() {\r\n  const searchParams = useSearchParams()\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\documentation\\page.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\documentation\\page.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1687 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 1687 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 580,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 581,
        "file_exists": true
      },
      "id": "q4",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\n// Désactiver le pré-rendu statique\r\nexport const dynamic = 'force-dynamic'\r\n\r\nimport { useMemo, useState } from 'react'\r\nimport { useEntityPage, useAutoRefresh, useDevicesUpdateListener, useToggle } from '@/hooks'\r\nimport { fetchJson } from '@/lib/api'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport SuccessMessage from '@/components/SuccessMessage'\r\nimport SearchBar from '@/components/SearchBar'\r\nimport UserPatientModal from '@/components/UserPatientModal'\r\nimport Modal from '@/components/Modal'\r\nimport logger from '@/lib/logger'\r\n\r\nexport default function PatientsPage() {\r\n  // Utiliser le hook unifié pour toute la logique commune\r\n  const {\r\n    allItems: allPatients,\r\n    items: patients,\r\n    filteredItems: filteredPatients,\r\n    searchTerm,\r\n    setSearchTerm,\r\n    loading,\r\n    error,\r\n    success,\r\n    actionError,\r\n    setSuccess,\r\n    setActionError,\r\n    resetMessages,\r\n    showArchived,\r\n    toggleShowArchived,\r\n    showModal,\r\n    editingItem,\r\n    openCreateModal,\r\n    openEditModal,\r\n    closeModal,\r\n    restore: handleRestorePatient,\r\n    restoring: restoringPatient,\r\n    archive: handleArchive,\r\n    archiving,\r\n    permanentDelete: handlePermanentDelete,\r\n    deleting: deletingPermanent,\r\n    hasPermission,\r\n    isArchived,\r\n    currentUser,\r\n    fetchWithAuth,\r\n    API_URL,\r\n    refetch,\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\patients\\page.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\app\\dashboard\\patients\\page.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 580 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 580 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 720,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 721,
        "file_exists": true
      },
      "id": "q5",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useRef, useMemo } from 'react'\r\nimport { fetchJson } from '@/lib/api'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport logger from '@/lib/logger'\r\n\r\n// Composant Accordéon simple\r\nfunction Accordion({ title, children, defaultOpen = false }) {\r\n  const [isOpen, setIsOpen] = useState(defaultOpen)\r\n  \r\n  return (\r\n    <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg\">\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => setIsOpen(!isOpen)}\r\n        className=\"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors\"\r\n      >\r\n        <span className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">{title}</span>\r\n        <span className=\"text-gray-500 dark:text-gray-400\">{isOpen ? '▼' : '▶'}</span>\r\n      </button>\r\n      {isOpen && (\r\n        <div className=\"px-4 pb-4 pt-2\">\r\n          {children}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n/**\r\n * Composant modal réutilisable pour créer/modifier des dispositifs\r\n * @param {Object} props\r\n * @param {boolean} props.isOpen - Si le modal est ouvert\r\n * @param {Function} props.onClose - Fonction pour fermer le modal\r\n * @param {Object|null} props.editingItem - Le dispositif en cours d'édition (null pour création)\r\n * @param {Function} props.onSave - Fonction appelée après sauvegarde réussie\r\n * @param {Object} props.fetchWithAuth - Fonction fetch avec authentification\r\n * @param {string} props.API_URL - URL de l'API\r\n * @param {Array} props.patients - Liste des patients disponibles\r\n * @param {Array} props.allDevices - Liste de tous les dispositifs (pour vérifier les doublons)\r\n * @param {Function} props.appendLog - Fonction pour ajouter un log au terminal USB (optionnel)\r\n */\r\nexport default function DeviceModal({\r\n  isOpen,\r\n  onClose,\r\n  editingItem,\r\n  onSave,\r\n  fetchWithAuth,\r\n  API_URL,\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceModal.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\DeviceModal.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 720 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 720 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 776,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 777,
        "file_exists": true
      },
      "id": "q6",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport { useUsb } from '@/contexts/UsbContext'\r\nimport { useSerialPort } from '@/components/SerialPortManager'\r\nimport { useTimers } from '@/hooks'\r\nimport { ESPLoader } from 'esptool-js'\r\nimport logger from '@/lib/logger'\r\n\r\n/**\r\n * Modal unifié pour le flash USB et OTA\r\n * Avec barre de progression, logs et stats\r\n */\r\nexport default function FlashModal({ isOpen, onClose, device, preselectedFirmwareVersion = null, flashMode = 'usb' }) {\r\n  const { fetchWithAuth, API_URL } = useAuth()\r\n  const [firmwares, setFirmwares] = useState([])\r\n  const [selectedFirmware, setSelectedFirmware] = useState(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [error, setError] = useState(null)\r\n  const [flashing, setFlashing] = useState(false)\r\n  const [flashProgress, setFlashProgress] = useState(0)\r\n  const [terminalLogs, setTerminalLogs] = useState([])\r\n  const [flashComplete, setFlashComplete] = useState(false)\r\n  const [deviceAlive, setDeviceAlive] = useState(null)\r\n  const [flashModeState, setFlashModeState] = useState(flashMode) // 'usb' ou 'ota'\r\n  const [otaStatus, setOtaStatus] = useState(null) // { status: 'pending'|'executing'|'executed'|'error', command: {...} }\r\n  const [otaStats, setOtaStats] = useState({ lastCheck: null, attempts: 0 })\r\n  const stopReadingRef = useRef(null)\r\n  const otaCheckIntervalRef = useRef(null)\r\n  \r\n  // Utiliser le hook useTimers pour gérer les timers avec cleanup automatique\r\n  const { createTimeout: createTimeoutWithCleanup, createInterval } = useTimers()\r\n  \r\n  // Nettoyer l'interval OTA au démontage\r\n  useEffect(() => {\r\n    return () => {\r\n      if (otaCheckIntervalRef.current) {\r\n        clearInterval(otaCheckIntervalRef.current)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // Utiliser le contexte USB partagé\r\n  const {\r\n    isConnected: usbIsConnected,\r\n    isSupported: usbIsSupported,\r\n    usbStreamStatus,\r\n    pauseUsbStreaming\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\FlashModal.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\FlashModal.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 776 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 776 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 670,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 671,
        "file_exists": true
      },
      "id": "q7",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react'\r\nimport { getUsbDeviceLabel, getUsbRequestFilters } from '@/lib/usbDevices'\r\nimport logger from '@/lib/logger'\r\nimport { getUsbPortSharing } from '@/lib/usbPortSharing'\r\n\r\n/**\r\n * Gestionnaire de port série utilisant Web Serial API\r\n * Permet de détecter, connecter et communiquer avec des dispositifs USB\r\n */\r\nexport function useSerialPort() {\r\n  const [port, setPort] = useState(null)\r\n  const [isConnected, setIsConnected] = useState(false)\r\n  const [availablePorts, setAvailablePorts] = useState([])\r\n  const [error, setError] = useState(null)\r\n  const readerRef = useRef(null)\r\n  const writerRef = useRef(null)\r\n  const portSharingRef = useRef(null)\r\n  const isMasterRef = useRef(false)\r\n  const sharedDataRef = useRef(null)\r\n\r\n  // Vérifier le support de Web Serial API\r\n  const isSupported = typeof navigator !== 'undefined' && 'serial' in navigator\r\n  \r\n  // Initialiser le système de partage\r\n  useEffect(() => {\r\n    if (typeof window !== 'undefined') {\r\n      portSharingRef.current = getUsbPortSharing()\r\n      \r\n      // Écouter les changements d'état\r\n      const unsubscribeState = portSharingRef.current.on('state-changed', async (data) => {\r\n        const wasMaster = isMasterRef.current\r\n        isMasterRef.current = data.isMaster\r\n        logger.debug('[SerialPortManager] State changed:', data)\r\n        \r\n        // Si on n'est plus master mais qu'on a un port ouvert, le fermer automatiquement\r\n        if (!data.isMaster && wasMaster && isConnected && port) {\r\n          logger.warn('[SerialPortManager] No longer master, closing port automatically...')\r\n          try {\r\n            // Fermer le port sans notifier le système de partage (car on n'est plus master)\r\n            if (readerRef.current) {\r\n              try {\r\n                await readerRef.current.cancel()\r\n                await readerRef.current.release()\r\n              } catch (e) {\r\n                // Ignorer les erreurs\r\n              }\r\n              readerRef.current = null\r\n            }\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\SerialPortManager.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\SerialPortManager.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 670 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 670 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 1289,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 1290,
        "file_exists": true
      },
      "id": "q8",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\n\nimport { useState, useEffect, useRef, useMemo } from 'react'\nimport { fetchJson } from '@/lib/api'\nimport ErrorMessage from '@/components/ErrorMessage'\nimport { isValidEmail, isValidPhone } from '@/lib/utils'\nimport logger from '@/lib/logger'\n\n// Composant Accordéon simple (réutilisé depuis DeviceModal)\nfunction Accordion({ title, children, defaultOpen = false }) {\n  const [isOpen, setIsOpen] = useState(defaultOpen)\n  \n  return (\n    <div className=\"border border-gray-200 dark:border-gray-700 rounded-lg\">\n      <button\n        type=\"button\"\n        onClick={() => setIsOpen(!isOpen)}\n        className=\"w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors\"\n      >\n        <span className=\"text-sm font-semibold text-gray-700 dark:text-gray-300\">{title}</span>\n        <span className=\"text-gray-500 dark:text-gray-400\">{isOpen ? '▼' : '▶'}</span>\n      </button>\n      {isOpen && (\n        <div className=\"px-4 pb-4 pt-2\">\n          {children}\n        </div>\n      )}\n    </div>\n  )\n}\n\n/**\n * Composant modal réutilisable pour créer/modifier des utilisateurs ou patients\n * @param {Object} props\n * @param {boolean} props.isOpen - Si le modal est ouvert\n * @param {Function} props.onClose - Fonction pour fermer le modal\n * @param {Object|null} props.editingItem - L'item en cours d'édition (null pour création)\n * @param {string} props.type - 'user' ou 'patient'\n * @param {Function} props.onSave - Fonction appelée après sauvegarde réussie\n * @param {Object} props.fetchWithAuth - Fonction fetch avec authentification\n * @param {string} props.API_URL - URL de l'API\n * @param {Array} props.roles - Liste des rôles (pour type='user')\n */\nexport default function UserPatientModal({\n  isOpen,\n  onClose,\n  editingItem,\n  type,\n  onSave,\n  fetchWithAuth,",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\UserPatientModal.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\UserPatientModal.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1289 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 1289 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 1220,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 1221,
        "file_exists": true
      },
      "id": "q9",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\r\n\r\nimport { useState, useCallback, useRef, useEffect, useMemo } from 'react'\r\nimport { useAuth } from '@/contexts/AuthContext'\r\nimport { fetchJson } from '@/lib/api'\r\nimport { useApiData, useTimers } from '@/hooks'\r\nimport LoadingSpinner from '@/components/LoadingSpinner'\r\nimport ErrorMessage from '@/components/ErrorMessage'\r\nimport Modal from '@/components/Modal'\r\nimport logger from '@/lib/logger'\r\n\r\nexport default function InoEditorTab({ onUploadSuccess }) {\r\n  const { fetchWithAuth, API_URL, token } = useAuth()\r\n  const [selectedFile, setSelectedFile] = useState(null)\r\n  const [inoContent, setInoContent] = useState('')\r\n  const [originalContent, setOriginalContent] = useState('')\r\n  const [isEdited, setIsEdited] = useState(false)\r\n  const [uploading, setUploading] = useState(false)\r\n  const [uploadProgress, setUploadProgress] = useState(0)\r\n  const [currentStep, setCurrentStep] = useState(null)\r\n  const [error, setError] = useState(null)\r\n  const [success, setSuccess] = useState(null)\r\n  const [showVersionExistsModal, setShowVersionExistsModal] = useState(false)\r\n  const [existingFirmware, setExistingFirmware] = useState(null)\r\n  const [pendingFile, setPendingFile] = useState(null)\r\n  const [editingFirmwareId, setEditingFirmwareId] = useState(null)\r\n  const [loadingIno, setLoadingIno] = useState(false)\r\n  const [showDeleteConfirmModal, setShowDeleteConfirmModal] = useState(false)\r\n  const [firmwareToDelete, setFirmwareToDelete] = useState(null)\r\n  const [deletingFirmware, setDeletingFirmware] = useState(null)\r\n  \r\n  // Utiliser le hook useTimers pour gérer les timers avec cleanup automatique\r\n  const { createTimeout: createTimeoutWithCleanup } = useTimers()\r\n  const [editorMinimized, setEditorMinimized] = useState(true)\r\n  const fileInputRef = useRef(null)\r\n  const textareaRef = useRef(null)\r\n\r\n  // États pour la compilation\r\n  const [compiling, setCompiling] = useState(false)\r\n  const [compileProgress, setCompileProgress] = useState(0)\r\n  const [compileLogs, setCompileLogs] = useState([])\r\n  const [compilingFirmwareId, setCompilingFirmwareId] = useState(null)\r\n  const [compileWindowMinimized, setCompileWindowMinimized] = useState(false)\r\n  const [copyLogsSuccess, setCopyLogsSuccess] = useState(false)\r\n  const eventSourceRef = useRef(null)\r\n  const compileLogsRef = useRef(null)\r\n\r\n  const { data, loading, refetch, invalidateCache } = useApiData(\r\n    ['/api.php/firmwares'],\r\n    { requiresAuth: true, cacheTTL: 0 } // Désactiver le cache pour avoir les données en temps réel\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\InoEditorTab.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\InoEditorTab.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1220 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 1220 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 2206,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 2207,
        "file_exists": true
      },
      "id": "q10",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\n\nimport { useState, useEffect, useRef, useCallback, useMemo } from 'react'\nimport { useUsb } from '@/contexts/UsbContext'\nimport { useAuth } from '@/contexts/AuthContext'\nimport { fetchJson } from '@/lib/api'\nimport { useApiData, useTimers, useEntityRestore } from '@/hooks'\nimport { createUpdateConfigCommand, createUpdateCalibrationCommand } from '@/lib/deviceCommands'\nimport { getUsbDeviceLabel } from '@/lib/usbDevices'\nimport logger from '@/lib/logger'\nimport Modal from '@/components/Modal'\nimport ConfirmModal from '@/components/ConfirmModal'\nimport FlashModal from '@/components/FlashModal'\nimport DeviceModal from '@/components/DeviceModal'\nimport SuccessMessage from '@/components/SuccessMessage'\n\nexport default function DebugTab() {\n  const usbContext = useUsb()\n  \n  // Références pour gérer les timeouts avec cleanup\n  const timeoutRefs = useRef([])\n  const isMountedRef = useRef(true)\n  \n  // Nettoyer tous les timeouts au démontage\n  useEffect(() => {\n    isMountedRef.current = true\n    return () => {\n      isMountedRef.current = false\n      timeoutRefs.current.forEach(timeoutId => clearTimeout(timeoutId))\n      timeoutRefs.current = []\n    }\n  }, [])\n  \n  // Fonction utilitaire pour créer un timeout avec cleanup\n  const createTimeoutWithCleanup = (callback, delay) => {\n    if (!isMountedRef.current) return null\n    const timeoutId = setTimeout(() => {\n      if (isMountedRef.current) {\n        callback()\n      }\n      timeoutRefs.current = timeoutRefs.current.filter(id => id !== timeoutId)\n    }, delay)\n    timeoutRefs.current.push(timeoutId)\n    return timeoutId\n  }\n  \n  const {\n    usbConnectedDevice,\n    setUsbConnectedDevice,\n    usbVirtualDevice,",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\UsbStreamingTab.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\components\\configuration\\UsbStreamingTab.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 2206 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 2206 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 1550,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 1551,
        "file_exists": true
      },
      "id": "q11",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "'use client'\n\nimport { createContext, useContext, useState, useEffect, useCallback, useRef } from 'react'\nimport { useSerialPort } from '@/components/SerialPortManager'\nimport { useAuth } from '@/contexts/AuthContext'\nimport logger from '@/lib/logger'\nimport { getUsbPortSharing } from '@/lib/usbPortSharing'\n\nconst UsbContext = createContext()\n\nexport function UsbProvider({ children }) {\n  const { port, isConnected, isSupported, requestPort, connect, disconnect, startReading, write } = useSerialPort()\n  const { fetchWithAuth, API_URL } = useAuth()\n  \n  // État USB global\n  const [usbConnectedDevice, setUsbConnectedDevice] = useState(null)\n  const [usbVirtualDevice, setUsbVirtualDevice] = useState(null)\n  const [usbPortInfo, setUsbPortInfo] = useState(null)\n  const [autoDetecting, setAutoDetecting] = useState(true)\n  const [checkingUSB, setCheckingUSB] = useState(false)\n  \n  // Données reçues du dispositif USB en temps réel (uniquement depuis le dispositif, pas de la base de données)\n  const [usbDeviceInfo, setUsbDeviceInfo] = useState(null) // { sim_iccid, device_serial, firmware_version, etc. }\n  \n  // État streaming USB\n  const [usbStreamStatus, setUsbStreamStatus] = useState('idle') // 'idle', 'connecting', 'waiting', 'running', 'paused'\n  const [usbStreamMeasurements, setUsbStreamMeasurements] = useState([])\n  const [usbStreamLogs, setUsbStreamLogs] = useState([])\n  const [usbStreamError, setUsbStreamError] = useState(null)\n  const [usbStreamLastMeasurement, setUsbStreamLastMeasurement] = useState(null)\n  const [usbStreamLastUpdate, setUsbStreamLastUpdate] = useState(null)\n  \n  const usbStreamStopRef = useRef(null)\n  const usbStreamBufferRef = useRef('')\n  const sendMeasurementToApiRef = useRef(null) // Callback pour envoyer les mesures à l'API\n  const updateDeviceFirmwareRef = useRef(null) // Callback pour mettre à jour les informations du dispositif dans la base (firmware_version, last_battery, last_seen, status)\n  const portSharingRef = useRef(null)\n  const streamTimeoutRefs = useRef([]) // Références pour les timeouts de streaming\n  \n  // Batch des logs pour envoi au serveur (pour monitoring à distance)\n  const logsToSendRef = useRef([])\n  \n  // Initialiser le système de partage\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      portSharingRef.current = getUsbPortSharing()\n      \n      // Écouter les données partagées depuis un autre onglet\n      const unsubscribeData = portSharingRef.current.on('data-received', (data) => {\n        logger.debug('[UsbContext] Data received from master tab:', data)",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\contexts\\UsbContext.js"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\contexts\\UsbContext.js",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1550 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 1550 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 1225,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 1226,
        "file_exists": true
      },
      "id": "q12",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "<?php\r\n/**\r\n * API REST V2.0 - HAPPLYZ MEDICAL OTT\r\n * Version complète avec JWT, multi-users, OTA, notifications, audit\r\n */\r\n\r\n// Mode DEBUG activable via variable d'environnement (désactivé par défaut)\r\n// Pour activer : mettre DEBUG_ERRORS=true dans .env ou variable d'environnement\r\n\r\nrequire_once __DIR__ . '/bootstrap/env_loader.php';\r\nrequire_once __DIR__ . '/bootstrap/database.php';\r\nrequire_once __DIR__ . '/api/helpers.php';\r\nrequire_once __DIR__ . '/api/helpers_sql.php';\r\nrequire_once __DIR__ . '/api/validators.php';\r\nrequire_once __DIR__ . '/api/cache.php';\r\nrequire_once __DIR__ . '/api/handlers/auth.php';\r\nrequire_once __DIR__ . '/api/handlers/devices.php';\r\nrequire_once __DIR__ . '/api/handlers/firmwares.php';\r\nrequire_once __DIR__ . '/api/handlers/notifications.php';\r\nrequire_once __DIR__ . '/api/handlers/usb_logs.php';\r\n\r\n// Démarrer le buffer de sortie pour capturer toute sortie HTML accidentelle\r\nob_start();\r\n\r\n// Headers CORS (DOIT être en tout premier)\r\n// Origines par défaut (production + développement local)\r\n$defaultAllowedOrigins = [\r\n    'https://ymora.github.io',\r\n    'http://localhost:3000',  // Développement local Next.js\r\n    'http://localhost:3003',  // Autres ports locaux\r\n    'http://localhost:5173'   // Vite dev server\r\n];\r\n\r\n// Origines supplémentaires via variable d'environnement\r\n$extraOrigins = array_filter(array_map('trim', explode(',', getenv('CORS_ALLOWED_ORIGINS') ?: '')));\r\n$allowedOrigins = array_unique(array_merge($defaultAllowedOrigins, $extraOrigins));\r\n$origin = $_SERVER['HTTP_ORIGIN'] ?? '';\r\n\r\nif ($origin && in_array($origin, $allowedOrigins, true)) {\r\n    header(\"Access-Control-Allow-Origin: {$origin}\");\r\n    header('Access-Control-Allow-Credentials: true');\r\n} elseif (empty($origin)) {\r\n    // Si pas d'origine (requête directe), autoriser toutes les origines\r\n    header('Access-Control-Allow-Origin: *');\r\n} else {\r\n    // Si origine non autorisée, quand même autoriser pour éviter les erreurs CORS\r\n    // (la sécurité est gérée par l'authentification JWT)\r\n    header(\"Access-Control-Allow-Origin: {$origin}\");\r\n    header('Access-Control-Allow-Credentials: true');\r\n}\r",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api.php"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api.php",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 1225 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 1225 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 531,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 532,
        "file_exists": true
      },
      "id": "q13",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "<?php\n/**\n * API Helpers - Fonctions utilitaires\n * Extracted from api.php during refactoring\n */\n\n// ============================================================================\n// HELPERS - IP & Geolocation\n// ============================================================================\n\n/**\n * Fonction helper pour obtenir la position depuis l'IP du client (pour dispositifs USB)\n */\nfunction getLocationFromIp($ip) {\n    // Ignorer les IPs locales/privées\n    if (empty($ip) || $ip === '127.0.0.1' || $ip === '::1' || \n        strpos($ip, '192.168.') === 0 || strpos($ip, '10.') === 0 || \n        strpos($ip, '172.') === 0 || strpos($ip, 'localhost') !== false) {\n        return null;\n    }\n    \n    try {\n        // Utiliser ip-api.com (gratuit, sans clé API, limite 45 req/min)\n        $url = \"http://ip-api.com/json/$ip?fields=status,lat,lon\";\n        $context = stream_context_create([\n            'http' => [\n                'timeout' => 2,\n                'method' => 'GET'\n            ]\n        ]);\n        $response = @file_get_contents($url, false, $context);\n        \n        if ($response) {\n            $data = json_decode($response, true);\n            if ($data && $data['status'] === 'success' && isset($data['lat']) && isset($data['lon'])) {\n                return [\n                    'latitude' => floatval($data['lat']),\n                    'longitude' => floatval($data['lon'])\n                ];\n            }\n        }\n    } catch (Exception $e) {\n        // Ignorer les erreurs de géolocalisation IP (non critique)\n        if (getenv('DEBUG_ERRORS') === 'true') {\n            error_log('[getLocationFromIp] Erreur: ' . $e->getMessage());\n        }\n    }\n    \n    return null;\n}",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\helpers.php"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\helpers.php",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 531 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 531 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 639,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 640,
        "file_exists": true
      },
      "id": "q14",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "<?php\n/**\n * API Handlers - Authentication & Users\n * Extracted from api.php during refactoring\n */\n\n// ============================================================================\n// HANDLERS - AUTHENTICATION\n// ============================================================================\n\n/**\n * Vérifie le rate limiting pour les tentatives de connexion\n * @param string $email Email de l'utilisateur\n * @param int $maxAttempts Nombre maximum de tentatives\n * @param int $windowMinutes Fenêtre de temps en minutes\n * @return bool true si autorisé, false si bloqué\n */\nfunction checkRateLimit($email, $maxAttempts = 5, $windowMinutes = 5) {\n    $lockFile = sys_get_temp_dir() . '/ott_login_' . md5($email) . '.lock';\n    $attempts = [];\n    \n    if (file_exists($lockFile)) {\n        $data = file_get_contents($lockFile);\n        if ($data !== false) {\n            $attempts = json_decode($data, true) ?: [];\n        }\n        // Nettoyer les tentatives anciennes (hors de la fenêtre de temps)\n        $now = time();\n        $windowSeconds = $windowMinutes * 60;\n        $attempts = array_filter($attempts, function($timestamp) use ($now, $windowSeconds) {\n            return ($now - $timestamp) < $windowSeconds;\n        });\n    }\n    \n    // Vérifier si le nombre de tentatives dépasse la limite\n    if (count($attempts) >= $maxAttempts) {\n        return false; // Trop de tentatives\n    }\n    \n    // Enregistrer cette tentative\n    $attempts[] = time();\n    file_put_contents($lockFile, json_encode($attempts));\n    \n    return true;\n}\n\nfunction handleLogin() {\n    global $pdo;\n    \n    $input = json_decode(file_get_contents('php://input'), true);",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\auth.php"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\auth.php",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 639 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 639 lignes (max recommandé: 500)"
    },
    {
      "line": 0,
      "metrics": {
        "Lines": 2627,
        "Complexity": 0
      },
      "severity": "medium",
      "context": {
        "total_lines": 2628,
        "file_exists": true
      },
      "id": "q15",
      "code_snippet": {
        "end_line": 50,
        "start_line": 1,
        "content": "<?php\n/**\n * API Handlers - Devices\n * Extracted from api.php during refactoring\n */\n\nrequire_once __DIR__ . '/../helpers.php';\nrequire_once __DIR__ . '/device_serial_generator.php';\n\nfunction handleGetDevices() {\n    global $pdo;\n    \n    // Permettre accès sans auth pour dispositifs IoT (rétrocompatibilité)\n    // OU avec auth JWT pour dashboard\n    $user = getCurrentUser();\n    \n    // Paramètre pour inclure les devices archivés (soft-deleted)\n    $includeDeleted = isset($_GET['include_deleted']) && $_GET['include_deleted'] === 'true';\n    \n    // Pagination\n    $limit = isset($_GET['limit']) ? min(intval($_GET['limit']), 500) : 100;\n    $offset = isset($_GET['offset']) ? max(0, intval($_GET['offset'])) : 0;\n    $page = isset($_GET['page']) ? max(1, intval($_GET['page'])) : 1;\n    \n    // Si page est fourni, calculer offset\n    if ($page > 1 && $offset === 0) {\n        $offset = ($page - 1) * $limit;\n    }\n    \n    // Cache: générer une clé basée sur les paramètres\n    $cacheKey = SimpleCache::key('devices', [\n        'limit' => $limit,\n        'offset' => $offset,\n        'include_deleted' => $includeDeleted,\n        'user_id' => $user ? $user ['id'] : null\n    ]);\n    \n    // Essayer de récupérer depuis le cache\n    $cached = SimpleCache::get($cacheKey);\n    if ($cached !== null) {\n        echo json_encode($cached);\n        return;\n    }\n    \n    try {\n        // Condition WHERE selon le paramètre include_deleted\n        $whereClause = $includeDeleted ? \"d.deleted_at IS NOT NULL\" : \"d.deleted_at IS NULL\";\n        \n        // Compter le total\n        $countStmt = $pdo->prepare(\"",
        "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\devices.php"
      },
      "file": "C:\\Users\\ymora\\Desktop\\maxime\\api\\handlers\\devices.php",
      "question": "Fichier/fonction très complexe: Fichier volumineux: 2627 lignes (max recommandé: 500)\r\n- Analyse la complexité\r\n- Propose une refactorisation en plusieurs fonctions/composants plus petits\r\n- Génère le code refactorisé\r\n\r\nProjet: Unknown / Unknown",
      "type": "complexity",
      "description": "Fichier volumineux: 2627 lignes (max recommandé: 500)"
    }
  ],
  "project_info": {
    "name": "maxime",
    "path": "C:\\Users\\ymora\\Desktop\\maxime",
    "framework": "Unknown",
    "type": "Unknown"
  }
}