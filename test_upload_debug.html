<!DOCTYPE html>
<html>
<head>
    <title>Test Upload Debug</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #0f0; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #0f0; }
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; border-color: #0f0; }
        button { padding: 10px 20px; margin: 10px; background: #0f0; color: #000; border: none; cursor: pointer; }
        button:hover { background: #0a0; }
    </style>
</head>
<body>
    <h1>ğŸ” Test Upload Debug</h1>
    <button onclick="testUpload()">Tester Upload</button>
    <button onclick="clearLogs()">Effacer Logs</button>
    <div id="logs"></div>

    <script>
        const API_URL = 'http://localhost:3000'; // Ajuster selon votre config
        const TOKEN = localStorage.getItem('token') || prompt('Token JWT:');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testUpload() {
            clearLogs();
            log('ğŸš€ DÃ©marrage test upload...', 'info');
            
            // CrÃ©er un fichier .ino de test
            const inoContent = `// Test firmware
#define FIRMWARE_VERSION_STR "3.0.0-test"

void setup() {
  Serial.begin(115200);
}

void loop() {
  delay(1000);
}`;
            
            const blob = new Blob([inoContent], { type: 'text/plain' });
            const file = new File([blob], 'test_firmware.ino', { type: 'text/plain' });
            
            log(`ğŸ“¦ Fichier crÃ©Ã©: ${file.name} (${file.size} bytes)`, 'info');
            
            const formData = new FormData();
            formData.append('firmware_ino', file);
            formData.append('type', 'ino');
            
            log(`ğŸ”— URL: ${API_URL}/api.php/firmwares/upload-ino`, 'info');
            log(`ğŸ”‘ Token: ${TOKEN ? TOKEN.substring(0, 20) + '...' : 'MANQUANT'}`, TOKEN ? 'success' : 'error');
            
            if (!TOKEN) {
                log('âŒ Token manquant!', 'error');
                return;
            }
            
            const xhr = new XMLHttpRequest();
            xhr.timeout = 30000; // 30 secondes
            
            // Ã‰vÃ©nements dÃ©taillÃ©s
            xhr.addEventListener('loadstart', () => {
                log('ğŸš€ loadstart - Upload dÃ©marrÃ©', 'info');
            });
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    log(`ğŸ“Š Progression: ${percent}% (${e.loaded}/${e.total} bytes)`, 'info');
                }
            });
            
            xhr.addEventListener('load', () => {
                log(`ğŸ“¥ load - RÃ©ponse reÃ§ue: Status ${xhr.status} ${xhr.statusText}`, xhr.status === 200 ? 'success' : 'error');
                log(`ğŸ“¥ ReadyState: ${xhr.readyState}`, 'info');
                log(`ğŸ“¥ ResponseText (premiers 500 chars): ${xhr.responseText.substring(0, 500)}`, 'info');
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        log(`âœ… RÃ©ponse JSON: ${JSON.stringify(response, null, 2)}`, 'success');
                    } catch (e) {
                        log(`âŒ Erreur parsing JSON: ${e.message}`, 'error');
                    }
                } else {
                    log(`âŒ Erreur HTTP ${xhr.status}`, 'error');
                    try {
                        const error = JSON.parse(xhr.responseText);
                        log(`âŒ Erreur: ${JSON.stringify(error)}`, 'error');
                    } catch (e) {
                        log(`âŒ RÃ©ponse non-JSON: ${xhr.responseText}`, 'error');
                    }
                }
            });
            
            xhr.addEventListener('error', (e) => {
                log(`âŒ error - Erreur rÃ©seau XHR`, 'error');
                log(`âŒ ReadyState: ${xhr.readyState}`, 'error');
                log(`âŒ Status: ${xhr.status}`, 'error');
                log(`âŒ Response: ${xhr.responseText?.substring(0, 200)}`, 'error');
            });
            
            xhr.addEventListener('timeout', () => {
                log(`â±ï¸ timeout - Timeout aprÃ¨s 30 secondes`, 'error');
                log(`â±ï¸ ReadyState: ${xhr.readyState}`, 'error');
            });
            
            xhr.addEventListener('abort', () => {
                log(`âš ï¸ abort - Upload annulÃ©`, 'error');
            });
            
            xhr.addEventListener('loadend', () => {
                log(`ğŸ loadend - Upload terminÃ©`, 'info');
            });
            
            try {
                log('ğŸ“¤ Ouverture requÃªte POST...', 'info');
                xhr.open('POST', `${API_URL}/api.php/firmwares/upload-ino`);
                
                log('ğŸ“¤ DÃ©finition header Authorization...', 'info');
                xhr.setRequestHeader('Authorization', `Bearer ${TOKEN}`);
                
                log('ğŸ“¤ Envoi FormData...', 'info');
                xhr.send(formData);
                
                log('âœ… RequÃªte envoyÃ©e, attente rÃ©ponse...', 'success');
            } catch (err) {
                log(`âŒ Exception: ${err.message}`, 'error');
                console.error(err);
            }
        }
    </script>
</body>
</html>

