<!DOCTYPE html>
<html>
<head>
    <title>Test V√©rification OTT-8837</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        .result { background: #000; padding: 15px; margin: 10px 0; border: 1px solid #0f0; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #ff0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç V√©rification Dispositif OTT-8837 en Base</h1>
    
    <button onclick="checkDevice()">Chercher OTT-8837</button>
    <button onclick="checkAll()">Liste TOUS les dispositifs</button>
    <button onclick="checkICCID()">Chercher par ICCID 8837</button>
    
    <div id="result" class="result"></div>

    <script>
        const API_URL = 'https://ott-jbln.onrender.com';
        
        async function login() {
            const response = await fetch(`${API_URL}/api.php/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'admin', password: 'admin' })
            });
            const data = await response.json();
            return data.token;
        }
        
        async function checkDevice() {
            const log = document.getElementById('result');
            log.innerHTML = '<div class="info">‚è≥ Connexion...</div>';
            
            try {
                const token = await login();
                log.innerHTML += '<div class="success">‚úÖ Connect√©</div>';
                
                log.innerHTML += '<div class="info">üîç Recherche OTT-8837...</div>';
                
                const response = await fetch(`${API_URL}/api.php/devices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const devices = data.devices || [];
                
                log.innerHTML += `<div class="info">üìä Total dispositifs en BDD: ${devices.length}</div>`;
                
                // Chercher OTT-8837
                const found = devices.filter(d => 
                    (d.device_name && d.device_name.includes('8837')) ||
                    (d.sim_iccid && d.sim_iccid.includes('8837')) ||
                    (d.device_serial && d.device_serial.includes('8837'))
                );
                
                if (found.length > 0) {
                    log.innerHTML += `<div class="success">‚úÖ TROUV√â ${found.length} dispositif(s):</div>`;
                    found.forEach(d => {
                        log.innerHTML += `<div class="success">
                            ID: ${d.id}<br>
                            Nom: ${d.device_name}<br>
                            ICCID: ${d.sim_iccid}<br>
                            Serial: ${d.device_serial}<br>
                            Status: ${d.status}<br>
                            Patient: ${d.patient_id || 'Non assign√©'}
                        </div>`;
                    });
                } else {
                    log.innerHTML += '<div class="error">‚ùå DISPOSITIF OTT-8837 NON TROUV√â EN BASE</div>';
                    log.innerHTML += '<div class="info">Liste des 5 derniers dispositifs:</div>';
                    devices.slice(-5).forEach(d => {
                        log.innerHTML += `<div class="info">
                            ${d.id}: ${d.device_name} (${d.sim_iccid})
                        </div>`;
                    });
                }
            } catch (err) {
                log.innerHTML += `<div class="error">‚ùå Erreur: ${err.message}</div>`;
            }
        }
        
        async function checkAll() {
            const log = document.getElementById('result');
            log.innerHTML = '<div class="info">‚è≥ R√©cup√©ration...</div>';
            
            try {
                const token = await login();
                const response = await fetch(`${API_URL}/api.php/devices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const devices = data.devices || [];
                
                log.innerHTML = `<div class="success">üìä ${devices.length} dispositifs en BDD:</div>`;
                devices.forEach(d => {
                    log.innerHTML += `<div class="info">
                        ${d.id}: ${d.device_name || 'Sans nom'} | ICCID: ${d.sim_iccid || 'N/A'} | Serial: ${d.device_serial || 'N/A'}
                    </div>`;
                });
            } catch (err) {
                log.innerHTML += `<div class="error">‚ùå Erreur: ${err.message}</div>`;
            }
        }
        
        async function checkICCID() {
            const log = document.getElementById('result');
            log.innerHTML = '<div class="info">‚è≥ Recherche ICCID contenant 8837...</div>';
            
            try {
                const token = await login();
                const response = await fetch(`${API_URL}/api.php/devices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                const devices = data.devices || [];
                
                // Chercher par ICCID complet ou partiel
                const found = devices.filter(d => 
                    d.sim_iccid && (
                        d.sim_iccid.endsWith('8837') || 
                        d.sim_iccid.includes('8837')
                    )
                );
                
                log.innerHTML = `<div class="info">üîç Recherche ICCID *8837:</div>`;
                
                if (found.length > 0) {
                    log.innerHTML += `<div class="success">‚úÖ Trouv√© ${found.length} dispositif(s):</div>`;
                    found.forEach(d => {
                        log.innerHTML += `<div class="success">
                            ID: ${d.id}<br>
                            Nom: ${d.device_name}<br>
                            ICCID: ${d.sim_iccid}<br>
                            Serial: ${d.device_serial}<br>
                            Status: ${d.status}
                        </div>`;
                    });
                } else {
                    log.innerHTML += '<div class="error">‚ùå Aucun ICCID se terminant par 8837</div>';
                }
            } catch (err) {
                log.innerHTML += `<div class="error">‚ùå Erreur: ${err.message}</div>`;
            }
        }
    </script>
</body>
</html>

