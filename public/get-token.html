<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©cup√©ration Token OTT</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .token-display {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button-success {
            background: #28a745;
        }
        .button-success:hover {
            background: #218838;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë R√©cup√©ration Token OTT</h1>
        
        <div class="info">
            <strong>Instructions:</strong><br>
            1. Assurez-vous d'√™tre connect√© √† l'application OTT<br>
            2. Cliquez sur "R√©cup√©rer le token"<br>
            3. Le token sera affich√© ci-dessous
        </div>
        
        <button class="button" onclick="getToken()">R√©cup√©rer le token</button>
        <button class="button button-success" onclick="copyToken()">Copier le token</button>
        <button class="button" onclick="testToken()">Tester le token</button>
        
        <div id="status"></div>
        
        <div id="tokenDisplay" class="token-display" style="display: none;">
            <strong>Token JWT:</strong><br>
            <span id="tokenValue"></span>
        </div>
        
        <div id="testResults" style="display: none; margin-top: 20px;">
            <h2>R√©sultats des tests API</h2>
            <div id="testResultsContent"></div>
        </div>
    </div>

    <script>
        let currentToken = null;
        
        function getToken() {
            const statusDiv = document.getElementById('status');
            const tokenDisplay = document.getElementById('tokenDisplay');
            const tokenValue = document.getElementById('tokenValue');
            
            try {
                // Essayer diff√©rentes cl√©s possibles
                const tokenKeys = ['ott_token', 'authToken', 'token', 'jwt_token'];
                let token = null;
                
                for (const key of tokenKeys) {
                    token = localStorage.getItem(key);
                    if (token) {
                        break;
                    }
                }
                
                if (!token) {
                    // Essayer sessionStorage
                    for (const key of tokenKeys) {
                        token = sessionStorage.getItem(key);
                        if (token) {
                            break;
                        }
                    }
                }
                
                if (token) {
                    currentToken = token;
                    tokenValue.textContent = token;
                    tokenDisplay.style.display = 'block';
                    statusDiv.innerHTML = '<div class="status ok">‚úÖ Token r√©cup√©r√© avec succ√®s!</div>';
                    
                    // Afficher aussi dans la console pour faciliter la copie
                    console.log('Token JWT:', token);
                    console.log('Pour utiliser dans PowerShell:');
                    console.log(`$token = "${token}"`);
                } else {
                    statusDiv.innerHTML = '<div class="status error">‚ùå Aucun token trouv√© dans localStorage ou sessionStorage</div>';
                    statusDiv.innerHTML += '<div class="info">Assurez-vous d\'√™tre connect√© √† l\'application OTT sur cette page.</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Erreur: ${error.message}</div>`;
            }
        }
        
        function copyToken() {
            if (!currentToken) {
                alert('Veuillez d\'abord r√©cup√©rer le token');
                return;
            }
            
            navigator.clipboard.writeText(currentToken).then(() => {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = '<div class="status ok">‚úÖ Token copi√© dans le presse-papiers!</div>';
            }).catch(err => {
                alert('Erreur lors de la copie: ' + err.message);
            });
        }
        
        async function testToken() {
            if (!currentToken) {
                alert('Veuillez d\'abord r√©cup√©rer le token');
                return;
            }
            
            const statusDiv = document.getElementById('status');
            const testResults = document.getElementById('testResults');
            const testResultsContent = document.getElementById('testResultsContent');
            
            statusDiv.innerHTML = '<div class="status">üîÑ Test des endpoints en cours...</div>';
            testResults.style.display = 'block';
            testResultsContent.innerHTML = '';
            
            // D√©terminer l'URL de l'API
            const apiUrl = window.location.origin.includes('localhost:3000') 
                ? (window.location.origin + '/api.php') 
                : 'https://ott-jbln.onrender.com/api.php';
            
            const endpoints = [
                { path: '/health', name: 'Health Check' },
                { path: '/devices', name: 'Liste Dispositifs' },
                { path: '/patients', name: 'Liste Patients' },
                { path: '/users', name: 'Liste Utilisateurs' },
                { path: '/firmwares', name: 'Liste Firmwares' }
            ];
            
            const results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${apiUrl}${endpoint.path}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${currentToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const status = response.status;
                    const ok = response.ok;
                    let data = null;
                    
                    try {
                        data = await response.json();
                    } catch (e) {
                        data = { error: 'R√©ponse non-JSON' };
                    }
                    
                    results.push({
                        name: endpoint.name,
                        path: endpoint.path,
                        status: status,
                        ok: ok,
                        hasData: data && !data.error
                    });
                } catch (error) {
                    results.push({
                        name: endpoint.name,
                        path: endpoint.path,
                        status: 'ERROR',
                        ok: false,
                        error: error.message
                    });
                }
            }
            
            // Afficher les r√©sultats
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f8f9fa;"><th style="padding: 10px; text-align: left;">Endpoint</th><th style="padding: 10px; text-align: left;">Status</th><th style="padding: 10px; text-align: left;">R√©sultat</th></tr>';
            
            results.forEach(result => {
                const statusColor = result.ok ? '#28a745' : '#dc3545';
                const statusText = result.ok ? '‚úÖ OK' : '‚ùå Erreur';
                html += `<tr>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${result.name}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6; color: ${statusColor};">${result.status}</td>
                    <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${statusText}</td>
                </tr>`;
            });
            
            html += '</table>';
            testResultsContent.innerHTML = html;
            
            const successCount = results.filter(r => r.ok).length;
            statusDiv.innerHTML = `<div class="status ${successCount === results.length ? 'ok' : 'error'}">‚úÖ Tests termin√©s: ${successCount}/${results.length} r√©ussis</div>`;
        }
        
        // R√©cup√©rer automatiquement le token au chargement de la page
        window.addEventListener('load', () => {
            setTimeout(getToken, 500);
        });
    </script>
</body>
</html>

